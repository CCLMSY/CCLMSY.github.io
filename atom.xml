<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>CCLMSYğŸ’«</title>
  
  
  <link href="https://www.cclmsy.cc/atom.xml" rel="self"/>
  
  <link href="https://www.cclmsy.cc/"/>
  <updated>2025-09-25T05:39:16.796Z</updated>
  <id>https://www.cclmsy.cc/</id>
  
  <author>
    <name>æ·±ç¿¼ğŸ’«</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æ¨å…å›å¿†å½•</title>
    <link href="https://www.cclmsy.cc/posts/tm.html"/>
    <id>https://www.cclmsy.cc/posts/tm.html</id>
    <published>2025-09-23T16:00:00.000Z</published>
    <updated>2025-09-25T05:39:16.796Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="null" data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="2e48942425a51b64916500d2219f74fa1e7a827ce75e9b8430bc4551f3401f6f">cd0f16c32634b4e80c9bfc2ecbe95c27e1d254a84a02c37e39add73f276cc750345da4c2e9b5bcc7e43ab3d7027a12640ee69628754224b94199ed96eb44324548854031c02eb4cc86091a8e61f4e8afa3946d0998eef7f60048ecc9f4ceb03372cb88807cd05859d0b7a4961f1685b12221baf92a2440b98277147d8fd7d4fad46c23124c783f9163db3057d1262c952f4ad69304caef75a2f69db328264dd5db8d999475d2aa84fb720e10807c35948c9b8a5d158d09ea78a5db0172478011225b92b08d7a7661db0b41ef7786c723e712af5e15e809c975dcd8b1414fecabb4cfc5a6db86610dbeb0acb4904ec0d4ded37f69714fd6fef6160a3ada88a19b75e1029e0ce54b4ecdc0fa928fb95defb3b3fe51a679e5de1a439eec40c02a7c9dd5fd863988cfa319dc6377c4ecb40b491a3775caa404b173b38d68f89dfa0d59519458f79a135cb5ab031e72d7f77fe67fc24aa553854a7a1b2eebf4c3456672c73df2bcf7f619f5dab39fb67cdf68dcf0a83abd76f40cab05b1d9fee16b476e0803ff5c60e3f779ad205c852cf2505f0d142f714557df7373026ca720d9da011b2319fee147755b37530c50afa856f02e3496368b45f2fd445b7a7d9258333a004ecf9b2a2591e3e1e06d1c9145ade816fd9e6e2ede178d2f60b1aca518afb67a65e7b1ff904c6144da7a46aaa9a0ca577677e3afe1862abcc6b01e42671c2633b774a7173b66d63e51122005f11ffd111aa3afb2fc21fa97230e152201838d780e6b1679127fe1b6aebfdefabe4c4d08b379bed8a6c2c86a82260eb526812cdc45e35afa511d00244e41bfd510d9b3e667683d9083fa979f10a5029380028460292aba8c942b2a80e1fa9b9bf38bb08cf8d36dcfa3bcf196e522b4148a68ad2f8caba6dbfc138f93643e61a08562fb4538e4788b3da9d6d5a38255e3fd5c39725a12fbde3e0b1d0e676a8785c64c04b942990553ae4da6a744cea4f33852c3450140739cddefcd8d29f920309f7744c6830c118e710dfc799bb7370725de9027055f3ecfce8e322e9d391feee010964eb7c41aed8990427490d0bf35af4241721816ba4bb048b683fc5f22dfc055acd786cad8e734ab56b7b8b0fad24c617b02b6b1e759a411cc6839c6eee0e2c9356890d3379f1be442e721cc372aa8ac37495b9c378874f8f59a5d6052db88b7f8fb4a3e7e32eebeffa8a24327c248da6dad44465a35cb5cf27363d2f9fed8db247bde54e6718391e3750418e83abbe98ba9a57f78d8f6e0b9eb908d9bdb66b20cd507d0cca09f78a922198743f2072c9e610fbdfcfe97fd254bef67dd5f01a445acd0f8545bbea46166a98f14260730214bdaed2163ac37ce92cdefd0653a9b6b7cab336c6a1594b515984cefa2f3cff2946f2b68fbfbe1d9745477a80323a839015b1828b3c512170ca2767798c7b30535f58f9ebb0e355e3f415a7d2a88c87eecc454a2d3f5fd8781e033bdaf8a1bd78fc1bd706c6795ca8a27e810a1edd1335937e7ffa4e0eb3ea9dcc05229834cc5e79500be6c19163c67f015c9c5abe3807e6dd687e4cfd52673f0d425497a38867d397f22131959ed9db35e7fcd0267b9012f8a043e26641bf1e886e9b6074b4df764d2055f3ec4d3fd76c1f4ebe9d01da6a71fca01faae09baa18ecac690ea6c4bc1c698fd0eb08bdae2de1821ee1b717bfb98a14c2fecd94b5d65fe3b8529538cbcb4058ebe76db48b6af4918a1a05668f94af963683e0447dd4b4cf399da4d8907c6fd4562c3c94a6c7f055cab74bf2ab97e8746c83d75ad25ee1e4e29da9609446016f277b2a02b6a042533d3bac84615cfdfef4299fee891e1011eb0442906fb44d00dc155847437ca33021de83b6084126b2667eddd584a1764059d0ae5079ce35319fb75b01bcf0212771553094c5b336ab8451de8eed396dfdae47b0a5c8249f0c1f221f3e02665d8167ea4eddf60e39f855593e48bf6d5e5616eddb0b0d0f129e02cfe8a5a6bb75869e65d4d483ce619e206ca4aa22e4906cea9b3532ae5e34a70439ede5e889fb4d8f989497a4b3c634f719961d8be95d206b21b480b37a6ae70f6d8e05c37c450977c6a635c52ed6f2eb71ab4a54ff95798238174cd720665ec0d24bf79e9d9e535ed4bc9c0609417377a273b24f6d41240d03d6eeb98eea42854d2e615a366c2cebb8f412b96730c41ce01211b1ec3f400e520fae9ee0cc3c46ec9827b285cd49441f7b53002c8da9cdd6517be7599e1929e9a78adeab34790cf1ed2079c8d901e9183adf17eb61a06b14253edd55957763a0aaa795cb876d2707cb7cf5215ca3610170aec17697e5e1e9bc5e1c2e268b2307839ef670832a68e2e265d34b26c106edafc7939442d4f692364e88c299f1340431b4fb9f524377f79d944ef5a29a99609026b968a4d734ea38452c5aec84c6c57e548352dd19e610b470be41f174d464d6e84650ee526bd5c5de23e7fcff998cfffef07f9213fe02bf4600c9bb20bd266a9cbb1f1da214ef1efeb0b2cbb078f514869d5fd636c30eb8eee1977ba695424493f86229edf5253f1e189ff57282bae26d4e69eafa018ee84e2af495d23b951a78a07c8f5db959dbb608a7f9929c7092de10eec4001e92d21c0bfd08b218e913212a4c5c4b8f7a378962aa21219d4791b5dee27056b3d592c3d65c915a535769c3efa3f1c22a2033e9e8affea967cd7f19badf0163789494e3531a67d5c39eacbf7a4106ca4f5f2eece84654a3e5b598df14d956e43d2202aace00c1fefe961eed9f547daa447907d433f4f98e9163689e3b731a4b795de43b74d67e5d579de101eabf29a9ed0cc3fe1ed53fba58277c4c4494cb44f00e8785d80c70b0a825de4fb5da7aa9b958576f0a86cc5217456c5c8f7873c01e8a4f0b30afd41330c0580369386ef7e00f29f1ba3b4b3e0f6d5f19aa1b8364031686a64e4ad52e98c41598898600e89c21159218f23998d1f63f198d129949ec3e36d8f7b635bce767570e6133824abeeb514d101819be9298d5fd0463bcc7669d6484c723cc4c300cba784fb9914ad4597e85e910cedec8093811bd6485ad9057bbd6eee5c4dbaf3a92ae89ec3c0b37982e23ee9fb3bbab357653997b2e96448ca8bc4665f4390d113ce3627698dd93e99490f4e9a0f6e399aa0c51f223b6852f918c1abf742e865a870e42e8f878fe4b28fa0cfeeac6f3f3d714b39dea7738e4e4c8af32096974e9e2674742f669992361d7649199b33d50965a7f673ebdab029e6be1f3b8a634b42062080e18bd8a1ae64d171883e2d8e6edc665bb3a414a4e8aa35f8503df9469bb78c0f55b8bb81dde56159c6a855aa539faf253046c7477f6ecb65747bd1c3f2e18b7cb6d321b76945c1e39de81b059b55c4855d85593ee31245af6cb248766b34e3e3d0a04857630c668027adf8cb88d694e2b4295b5f7dd91404a927a139e50edc514f983c03a41eebe6877f95f84366097c0cd495500f51ae491a9db24de2aa1bc8647d5e2d7c58c2d19f8d5537a195c666ae7099e14368655d49ec89e613c118bd31e92c18a4befdd83ffa11b1359a75df28ca01bebe626478570666c56258a7be1e15e2ff1790af9ddc2ac32901567332b8d2f11a6a49004c7efad7673d20bc386c4a789b1e5541f396b4adfdab76a328f879bde7f68bbda8227409ed44eb0d8ee722a17e5851694912c59f361489ee2210c4432ba1f772d3a89f6198f01e96928efd7578a075e5ae3a6e503070b8cffbc35fc41e662aa87669f5f1daf2356d3abd7091ceb39850193b5cc500cae351a7fced907f968d699e8c7b5e9830e07fc19473f0f286acef77b811ee274511fe258aae0193fba5a4b9b05b3d83e036366c1691bbd7dd24b7c3c2f853a6f08e29f7cf182c00d5dc58838ffe5945ea886bc9a298d4709a6c5946ffcd3935172495bd168031dfad06bc004e3a0718cc24213d3701b27e2355cfabcefe9603c5a5d1fe7b8a87adde27452412fed54f2fd52eb1e80fb8cfc1aece9cae129e63ac234b38308579d49570cde420f3cd3708a1a23692fde18e6099551164a16b544f5d43dfeb35a2751d8ac8791ad663350715d7d1873110b5f7d31fc4cea087c89644e1844f39499a8108ee602c25a9da0c0afa57b2598487e881d449ec0bba2904f02dd6418c6d4a4bdb0a785ed5409be1f1803dbe4a277733d80bdcd94b9f9cecf38c9f6365f692d9493d8120a790bc9765bc560d59c7accf60ec43cffa380d339871eecce1347360dd1f460ece7f4ba64417a57a705a562b5d855bd7b012f8a97544514a2ccc36ffb0af081bb64ad0bd90752e8141b2d2891f463ae6b6be58ab2529492b549d68fe8d7bc6503b16223a16422bd2c73a03f3fa2868926bec17b61301fea887b6f943388d772b783df232b9a949a38d11f2385a47b685fb4bc0d947a5863368a6b7276e757786d8916c9adc81b81e759f63638f61e07681355e71fd0dc28491ed02de3004d5458cf5498c223ee1701fc8f9a90a7bba18ae523fe1725a5018753e46364ca583769e6be96f37505557c145bbf4587ca8450613242d698d815bc0e6610027f9c119c979d0f7a16a4e268a1ed5923f8753cd42ae5404017cd8d5bba73775c25b0ea56137b182ba1db543792c5ca7e1c75297c13f521d04f5189284a4f9ad34f2521ce06b2cb6e2538c2ce140f9db9ceeec7e7f12a093e483dec54de6743a4123a1857ea4b2fd9f4fa1d6fe46f6cda817448ede02c6781bd50ed7d8af4bfb949e11c8481374763e67539a8165f96b8da283d12fd6b50ed84789d3293594ae96324ece2e63190e5c849630be80944c8176e351a9f1ec1ac4f81fc8171e38138e3fc525b3c569d2c9b642ee9795ed6fb952a72f1bc62bfca2e2c318afa63503dc518d7727816da6e766a737a75f1c4cbc196d6d33d6772c8be650a769021052f125c1479b3de9feda5b11ed551eec30a8ef018d6b468eead535390720521edf3eaef203bbe2e960667707f8a5fa747ffa7c6f80cf401326c3bdbd69bf3c1e3ad278382cd7013744048e45cf0321c64f62c1a23c7f499999de43e1b57f7b44eff9f19c82f170b2614139942c4ddd6c3df912570600ee65a509f623f34d059a8d00ba1c39f1b72883d958c30c8fa023092f2bbf2ecf80c5d22ce761375e92886dd9b56cba18a6f815e9070656036f64fefc2ab4437b05e6c5fadeea4eb4df4eb34bc422584f08cb9f999e5098d8fcf74d2ad36549249d36d8a1c226c53981b7a99c51602a9d195099a1b0f3d56d7e032cea1a594c4c610af060533b2dc08ed160c41a7f21be636cc5e069f18dceae1e850b131d6c8da58a1aa7b5ddd3fd3733393d3b3c89a20316e61fae7176b372500a8ac226897b7b8a7eaeae1524ac0342acec13aac3e4d7e992642341e450924616493867a16c1fb70c50440906551e205b123d9654c7607b81c289d956c3f7bcda7e1166a824d1ab18e0847115cc1143a83e5a242f1c27fb43ff205a41fab1f3d4da49ec3d64e780182f85b9182db4cc3edda9400e49a633df449c51c4c32337b3ba051b670e8eb4c07b127c61481257d46c6cb9e48e123b1c4b463f76bf685f11bef14c0f8549ffe04c4b6ee824aadb8e124478c72e17d9d7b1380cf101667ae4b0a3891bf5a6a481689a0d86b22cd0b7280136dfcb8d0af8115c4eeb79157f13a01573ad77f5e25a0521ff1635aa2f75c58d81c9cce89c3b66b0a77a06d2a6fbb06cdf05268eb77f9701296f58f71f1ca586664d87cba61129d9298113ced794b6a1dfafc27ad2f43f3a190e293201977d5b93a73da3128f059f73b79c2e81475573cbf81ed6fa2dd1c3361b9907149117fced6065469a94118487ba5497cf160128d8d4f08014a9c566415511cf00012820ac290e05991495e11bda72da975d2786dcc495654fde1e06ca7346be08dc398b5e2d31beac195a3b5de2fc109d9d9bae0cbe0fc31a1f530d8fc80f9d0880229ea13a0fe9600a66dec8550805bda5bac600217bcad387ed16cccf6dd895faa3965a21816eb98f912b005cb10443204b4d01d9cee6aa4e6401e9f6ddb38cdcd925e4dd791cc52206b18d839489270f75004abe72d1df187fe26d49ddc541208f940bb164042a8b9f122432a63b052162ba881221cf1667f6b56f248f85ff96266bf7377b579f9fd4a3f7febf677bf81deda4d7aaffb17ebf2d0b2c6cc3e15da308691d907a6928a8baca8b0b26076f766dd7cba8e31788cd1a2bd32237d775cf7f6f17ce916165f947f0ccb454fb161d8475c33047526781836fc7ef41398b56c2f955725e226aa81f99fdc1c98d3a1a6bbf8be43dcd3cb2a6823a20ae1dae238d84e6254d37f81c062fe2d1d5ad35b9ff76d9d84e9101e7d3480889ff12cddc475356a21e17e573ad2288b6cc6543c02bd6c52bc1450109b640dbdb7395bc8781dcff65ad1c25a91e42da54aa2102d116a306cbfe2061362b0f623d59adc7f703b995c715df6e8697a68ddad97d83ca3502b2ae421927e3aa578ab78cb09b5e7d6aa7280105959e701ed842360e5aa3a2eddc763eeca0053f5f160369087f9e355033be2ddacd282d1b92c41b4c29c7b6e65db05d970043c02ce7827e38ee206a72979d1585abcc5dc41111381fbcc95a023becafff2925c9502f49f92af602c5ec4c47e30337348132cf7b6a8c0eb3bd0aea680164567c99878e54c27cd2aa4ae777d0fdb983e94700f39f0ab1d9d64b1f73ae798265d7476aab93902ab5699c05c2b884aa8442ef6a5d0ba6d4fdb0d6f0d0806ab8db33d13a7cd825c21c2bf006cf079eb2ad99d7722081b224ecb963f70ecbfb0b1705be6c9d9381193d04b7ea47a336d9bf3f1aa2cdc3762207a8807684e48a56f6ec50a045dbb540a12a3deef498932bc4da273c8127e9423fa264c9731220935a317c516cb15ac216346a61ffbf4bea2f904bcd300ab4a1978997617903c4e3b4518d8963f8e988c3f0338c8631105df3ec48239f0c0f9478a96459f40fddffdd73a4e8aab09b4c12b61e31cde7edd11e8d6814ff8db19ceed874728430281a3a8365ed7fab96182d675497fccb7349aba9cc8b82f0034caf0969c1aaa784c4e94a1d9797a4f8573194602abe46a1c61c478e5717ac6ceec6bbdf0f2d64f4952828375ec4fbbcde34263af1117c688760bfce2bda0fcf407df0be2683ce56edae1688dd8a0936492cfde7acf88d009528412443721adac9fb056d1f09107ac7c61e30c167a059daa4184bf0e494c2f8848ef1e5df9d7b3d45759578ed2c9942ace6ef85302188216caec2d46e2a817921451c763c1a5fcfdef27960989527409b5bc76518c5a3d1ffaf1651f7bf5e8902f6024b7e8d3ae4c7b6880fc6894c902c3f9d8a79676f1793ced4dd186caff3b00011a57f62f97b42064b8553876ab63cf2ecb08154fa40df8cbcf23e0e1a1f016d2b107511f51356370626726581fc9ce0139846bbfaa6c84c74163c48e8124b41b05c87ac5f14e125901f2eeee35c6de76667b4c99ef59ba57347a9f20e4117ff8b7780ef63fe8277dfe09e9b70603309596572575a4ed99e2e02f089fd14f8e40c382da00ab904445c0dc261fca2009cf180e786dc648a6361ba74ffac7a95687f29acbc72cdbd6b722864649559aa53fdb74edc5a355d56a6ab4b74399910be0b77929dd67961d3ca5ca8a497f039e02e6243ea0288a9741f559e7ecb93fe5529ca4b676533e92dedde79603d37315cc2fe4f858df0121b8cfac169880247d55b793bf76eb857270f0644787a79659928178a1cedecd26e6be69835a48b088617a6a4c5c22115a372c407c00cf38407bac5f502e13a1c176c016907a0dd788416b710556850e005918a62a5150048768122f0b065be1920e494f2acc98f578481962ccaf3c23d4a383de640205d58110f3ca287c498da1f5c7224c9ca24d126ff461c3ad4cb3306326a3f906f6424ed022aaf9db288ddc1a7f715f2b7af4df5074ee51ef2cb8c8c4829a0251f7ae70d459f0bc5a899e8f62e87ef2902378fa44162b8c9c35b2701efadcd2a1d2961e607e2cf976fa50bc6ff5ec4bedd7d6cffee823b275a584d15d4c6d99168b3928f7767065383b9d18c076eea64544de71f75814263f58c9878bd48ef3400455c51db7d110ce0b11af11aa50b96606591168f17da74bb5cb17a10f782fd3918c7b6af554bba93d9e7ec30dc98b9a0ab311b256f9bbc3ccbf17401db1fae2c554606320ee063c5888c3b4c9046aa9bd586c41dca4bb117becc917a74125e45c763a13fbb6f25ca0ef9defd384311b4ef20552fb0b2ffd33385ee325cb50e1e308e85095dbd83ad2158cdcaaaacf9be62a8edb2225e7feaecdf30624a0eb3652d7f71c9c0dc5a15bc39817dc0b1498fc1d163cea24bced6fb312bbeb4a4ee942aa3c676119c69c2afca3a66f8ce0f2db37f88540239a9e402360f3a50cc3634e54b8a6bdc1561519251f456aea8d41d6dcd77afa6c6ae47513cd77b538d30e86e64afc8bc0a20bd815a527b912882db3b9d163c116f1990af96e51c66d1a89064adb72dcc1be3e60a18f47f33d7b23465f6ac8da2524bda6199b95b08be11f70efb27819c1ac55eccfcd521e2a287b105874f4f98c4b918659cc8083e7224b9ca1f330a99761eb9d686e47e982a8b27a7684fd4688ae190fa7f61c24f22941253eadc626ac5d31cac323889f99eba14cba6e265fb10848920f5c3f14f4723dbe543b2afe6550e599016218a761cae5b8846021509a4f6f5e5aad231764d6ffc9250621b979b1e83e0270bb582bc45992c5eaa1866c5624b4ff92eaab9e7d4317f25b6be36c4a71cc773f0d4d06df844e15a9392c33aa167dc69c0725abbda30f6fac28a446b0a6b8f3ab042fc8f36b243f5177a4d63fc70443c0691c56aa4d559fa34903d244258ceacf0433ca25d453eda2071cc6b5471570b0329e4ce600eb2b3b7075993f598a0722adeb90329f143bbaa20ee38f2c5c0263c63f5b30be5c1a5f6dc2410925e7733f1ffcafb7c1ffde39cd57756c52f97771d3766d91d96490f86a407e750bba43cf1d3b3d58838474b86385b609c6c8226924aee7c2909214f0308ddecb4d27f239943587ada0961afd46efd0eb87d8172252cf2ca3dc849a4a1373339bd9409a55fb37d535fc4799a0d1647ea484cb169018b5d29dc690622c455529e5b31c181b6d2a1774045f751869263791521beb29b004a9ccbda614ad4e56598095a3a4f79537bfdb85e35bfa87926228fcd1a7a79dc9a8c8ea1ea57a300357ad0a7e5880e96fa02e1c71a71b572134c2a5cec446b61dfe2a28ecf890c4419480bc65741d7729ff20335679f38ccc89f1c7283d78e049788bca0abad99948930e12c539bf68a0c52e5e309fe9aa9ede23111ad61a5c0c6a7008549dbcbe78a0a35dfc810b627ca06c12394866f55874d8c2468d7eb56a2f779c28235250ea50a071c317b95ae804cb088d644c9723c55014b4bbd73e19714fd2bef57b2b3f4c12f119fd80e27ee64dc4594260b3571e9f72913944de861c2e4c5bf5107bed18a7c392c65475452e9afccc68ba27bbdfac3ba9232a4b59c6fcec59d72de7d0189c85fb5f1a1722811494751d7bb411f6a552ca49b7a7ef8fee61986d200ad562580883f29913a4fd4913729050876efa6bd1ee2d231a3d10d05c9e1830f20c0f78da0af21afb539b952544d8419a28cdae3c8bc3fbb428bc850c228051ac2062711d3f4ce42fef101bc37eeb1aca636c257eae7eef91940ecba5b054bd27b25bbdd871919b54b2e395a55fa2a2f74c0d430efda1e88e8895b09b03a2974948302a6041155382987d8272357ea56620d808117e172766df074efa8b97a6a95d4c2e967cb5ff1312b651310347a49b4f95f2f5143a34b6407bf403537442e929e5af93ca47ecc19f8f035b00b9182fd691f4023b054131e940eb5b4cce70f14e7c68b7ac760847b2046b3cd2031d576004fc56b25d789923b85b39a1be743d4febff5598b1bc3abfee03364d09107743b854d695116d99d4fa57183b4bc8fbcd69fea8cb9c95e00b65247251ac578eddc5752a7a96c7026fe4fdd514d11b3dae5af4e2d9f767d2d9e2e0b96f6930905913c8a6407ce231d521379016d75e84956ebe73c808b8c6f36c44a46dbc10e752ea6f8d84171452fe3d6f5840041bd4c2f5c172d40b65e7164c952d0b355179f64e7d8182239d300988f850643f44ec06cd3bf254d6409dd0ca7d4ae715b469d111293c3660cec68586ba5a0605845ee4a27662a23465acaa9677449da69c5490ea4120f9972310cf1cb221ef6a6de15a7a67fcfbe4a7df6489c1820054c7d1228d1fde21fe8251c9e9c0f331a704766f4570fc18d62932f524e59152416b318a57901792f4d7858309e5fbc2e4bd3b4c8ee114aab7bb00a2d429567c30d34bdfad6a3a1cf99d62e89f7415f6ad74f90d154cb2cac45d9e7d162ec5b299f2bc0b2e519053953f76c45f2ad0f58e499dbc8c9485a04eeff2fee9b72742aa3fe00e071294c2b65fb9e9cd66ae68e42b3a438ec37756dbe334e80c049bc35fdaca9c6097789c7fa1934c706eb2ff59eaa2b857fa5202dff6f16e2802cacc8de45d3f3913ed95041e5a3ace6865ca4cf62deb55cd586c3795305d7d9c1851b83d58811d3128cd013b5285ffff1c9ac703454e1284b5fd41a22bcb322c4510f7087319ae5703ff8e6c9d8b3e5077a044a4ed94afb623c47194f40e2d4e29640a6178b8ac91b31e0a90e78ea20740f24119268569cca679fbfa872f8c7d3d630d374a9c46107ed6ba195287bd6a6ece4621a44db20d80ae255e397b1a8b1e3efeff3d03404d59ca4d7fcb2dbf2584e0fb24d8c61570fd088ef9d07d4f60f5bcb55349a950b90a319060afaf42814a0d2280dbc4db4ffe8232d7ef1e4e09921a56221cbf51503ab54be635b7b97044291423eca931f466db2abfe3ee039fd4edd37002c9a92f84f99158d67659b600be5277293f951c0ae5f0c63df017a310b6766e3a12e129204d3e153dc2230bb4b18898d54c41c762e76cf8cf6bb3ed675216129c4424d28f23e1f476b7134a71566288add4b45066ae51b93bb2e8f40de24b2399068ac649e238bf31dd97995ec2225175e8aedfb8dc7d183ba3d617f4b4ced3667acee92970d61a36becc086ff1a14a7053ca461724cf30fbe8c9f8410675c5680eb798eaa83f7abacffacebc65572bfcefa38426c9d945fa37dcaaee5889176b4be37318d6ced2351762c6ae8c281bfb9935dbab59e7c2a16568ba5329548614198512a414ff42b7b515d3e94f3d48cef7f5d5c42151b8b1fa2c2151d61f7a93eac7555418dc848aec761759c8c5bdde0a954bfe36be3b31c7e5943d282e63ff8f4e40e3d6c3a01949252a469cff374a35e5ee33c748d7f76033667246f66fb1c5352501faa1ea5df6d1a9853f36e961ad7c56078093abee06e306f3c4e5998cda17f85cfcd5e9de5b9f1204b0c5c3c550d92f01c35dae55aba4ae695cdddb3d56123f4b20e360d3c25692ae459f3c7fe6f578ae5764ba7a890b27237efce83cb27d0b48ca71b148ec55f85a8d155f2baa4bc317c20e568c2605c804a40f346efd16812796844e4aa201654a524361b06da5b29d91d21333a77b9acec7f9f4dc6ae1a3a99a34abcb3039fba9aaecd34a3ee880330eb014dc59012ec37269a8d28e54ec48e3704518d9db9a9d316f9d91c1a56baeb46fda01b40d7321fb1b98b60160bb2432dd6c9fff6e633a222f6f389776006bd6baa710d67f2f3e19d066eb5f7ea0edaa6b1d8b49006f7b9a3d649316c32a30d00250a8e276aed1390eee6f9b7cfc6b4b9fc09ad69b0d97c1387b53404fd825545841ebb80841600e56b116d5ad2d5846352b7c55cdab69e5e9c32791e46c86094eda6f3168bcb286a79badab2aa2d14494a7314f1bfc109e49f05e2f66b42443b61aa6894f69677dfd9015bd728bb75bde742b209d8de3615e443b8fed8b31a8bb7e7ef71fcde0fb07d1529f6911e63731a3cb355f516db8f731379609a21127b865fd499c5247a5887faec9c72a07ef43d9758ed73bbb8aa0e19e1b19f73ae174028ba75e3fcfe1e917f421d25294b578164e26246b0d226d9a2dd088aa63c80f1bfe44e9466bf10dfef72d5addb54f0efdae2087adc6fb413a3ef2db27954a32205057133b18cea709a56980c506d64bef70ece351f4469cdc43dd553b9668811bd0f8950f473fbe283af5d1745bf1094964c65e3b6dd8c7c23da6deffe7e57ed750d0a97477fbcc7713cd856a7315c79d92f752bc27faa98e6e65a50600328b4e134c2406f2e7be43453341639efd2c436eec90eec987b82e56958167fba1ef34550cfdebe47231f49dfc5b611bc4a7567e26e9603e63d7d8f9dbb6f262c40d72ffefcc31ea7a77d38f06ed6c34da260c8634ce67d608d696582c6a64fb30b55021d2a1d1b32d42a72870e89f5f2d59c16b87c788d5693f3bd63abd3014dbfcbbc70538ef94ee82dbf5f5c0958eebdb75a20653ba7b6e91a781d5bdd20be4f8d3733b86edee2d014f8e69990f688525db0c4221abd9fdd9254f04b6a9e45ecb881ce663d0d5b063b089cea684e77555a4671ca49927bb1e916990deac3b5c76584f36b2db6423b037a53ad3dd943531c32bbea8b5dc3f802e8bee39ae0ec3056423c2875319a804aa168b3599468262fcd1748cd0e640a02edd817c013a6df27e9b03b66307e6ed020c0fbf8302786b3d1f6758bef9cd9c990919483452409c9e3a616cd62c537fbc27d43c36b4860e42ae4b648d45b20a9cc24e5c4ad5f81f65dbcc5235dfeb07dd6de1e705ffeb09f2b0cf32a1e105031c25fc97b7e9b870650a202441a7115d5e0f0c286ac26da23b122a418424bffaf32cb0ba10bd033f94f4e39834075d95de706a3a8ea9de773e53d46903d39af07ef456cd1abebae5de93e1b4ab81de6be6f89a88bdc168d09aee244a2701d0d9da9d8d5699af584550e3ae5317088ecd372508b18ca88ca3324195cc306201378f2d9137c56ec591c7a53e5fae25eddc1801457c1f1c1e5686416a17d3f69799f5e6561df680f7aceb04d3e63cc0941d27f9e7baa31732b7389b2d4fdfefedf9ab37fe3d1fc38cd9c3277b82df3d66fa4b8dff65fb41ae449724dc65efe0b7ac84524d0bc5cff56f6d7fcdc526aeca0657403fa9acb6449868d2e6a13b6c5eb9b0eb07c30fa5dd6b680b18dc71f9250936148e95ed391e9e722f4ff97db0cd514a03993ff824fa3010c9fa76b893abd86b72b7d6cf8e96fba4269456765c1e46c5e62534da5a18e17e1b8acccd930a52a9e22c347fc04c33f939abd5e88c5d36c24d777dd9851f9e001112a56e9ab3fd0aa12771e6a9a3fa631cde1e9159cfa7f76fb3fa4250fd44b2600aed5e29e6e3c1590ae41bb39d09d0c17750bada019060c8de090a93ff6cdf0d7f08a604ff74f6fbeaf9de58d3d07be13f1d768367815f9a29dd13781f7924af7e89480080c0c587002ca613eb9d6fa03b229b48faabd5a58576b312e2fd68bc95e172eb7aba410c6702c28465a0d48398d56975eb5c89a13957da4f51af6b9a68f60866fe4af18760d4932210b51d811a3b1f39967ed85d2e535de2239ab330a2ff7910bcfdd08035b6e9f1d4d556f564f7c82d6b32562c9e24265b1c0353d786778b6ef849b99ccaed50fd4f0819fc0d75568e3beae5979520c6abec201f22d9f42c51c252f798b1f91f5250de814196744950d61e39cb8eadd92d6c2f3af5d8a735e07ca0f4fdb25d1c77d4a032cd65554fbaf86e9cd4a0934081eebb3657e147977ca1805ec9099cfe37b71c7c71b30346e43d57fb52208d4261c37e9fb61d198e850f2f1acdba32c350b3572cc9175e05abe259b466db7b7256e3be33a6f80cf059723df8a3ff186b05f6d1c0673b5bd00f59871c7f4698d7233bacf851af65b88d0a8a86e4c49faa73a156f4f7377d87eb2508713242951b48890f950a84a6f5920c7142713e20bb2755489f848db94e8eead6eefef7d9a2891ed09d894e1d8724b39358c5d15232ad584cce6ef041f2297043a12edcccf2e7f7320df53d385c1b65f51945287b22814c4d92ec677398a086548be7da8472089a809e8401e3d2d1b13b115bb71a238cb8609d59ac9afa7437259e0f49640f2e0577f4997fdf661a067acc3316c9c0b6d6aef067d955788d412cc2526c3a2bf828a56bfce8dc42072c9ac623fd3e089913630c517c5bbc2e608fee12c6406e7fab8743aed1eb4b2e42885af6e285a8b8a77156250ddc7d24ce47586444ff8e45395e80c298f6993f6a5fa91a3ab0364c642d0d61121ab5426d8cebb2bb1424d6baed3d9a09791b421ae7b0042f034f78b985e3cdbe294f37c9de3725fd63b3f2e24004d147cd7302b175adfd714e08528c779b684e7d53a8d50a24f0e79cc3f086324fb761b5b61a149e5b611e32e2a28d5b2fc57d617336074bebed737dacf8c0bc899fb3f8e380c5168c7f9a356cc4535fbea872fa1a5de6618ce3dc0303af74e228a627923f32d8c29e92150878538cf073fd0902aa257bb740773500e56a4d897901d69c6ed8110899234dee6d98754758d2a07d1b9619fa0379956ee9890a24d9108f2398fe780ed3b1134aece223d688198d84c5739a7db39fd9af6faa6261c2f9fbc069cf8cc4577fac18619bb5da004400b6b3e100a1070ab7d2a2cca0a38fd4ac52035177c6195234ae1100bef2e02b5194fbba3b6e0e2f734e92f26c51275cf8b6a62daad36a45d35d30f12cb60ed5a7dbc9774b9455c3e2ffaa0f00277b79276e6a4efa28dd8392296330ccf59c4e426b0f9b9e7e41e3a6b5b56218b9beb8832b5276acfa6978e0e126397dde1cbc617348e8e888da68f955f542ac3dae9b6f051b649c535a9c88471ef3c24b3c0688483f109a1d0640107fadcd230d1ac55499578539a8dd54ed638bdbeee576cc4a45cb483b551cb257d9fef42ff0f9a1266fd3f9e5180aa92a4a02f853883d91f80fde20ad5957e7dde52deb508a6f3ac7a6a985ee2f169c71e56a8d8d4d6b930438747fff7acbda466550fea39c3de5d7873db13d6b0969847fc0fb557e2c9016e0d1af944d186e44f43e97b35f2a7e9456efa6fadf5be2965dc5d442c89afbff0246a6fb1d7f5a517a934112d39167e9488f9eaffa1674d73c0f427a9437238586f269c91a282fc9f36b10afe3a0bf253ff4e954ea0f72d6c71988c00c9a8440f1c40d6b64c7aa1861bad7abfbefee4a8a446227417fdb869b0c275f6c97347656ea5031320ada9b646541702b2dd5eae25bb68bb9f2456b5689fd87eead22c8ae9acf07493d1f1cd26fe042245a00da714694b5aca8a4e7aa6433c758c95f481a28e056e4d2e36e53d5eca2cb574bbee71e760e6fd84f8eec9db84a7bb996b9b773f8b56163a1736c7a18910b777566ed94749e112a31784a9046b45424cce0ef0902047322eb07f113f6ebb1648158be7fce8f9405e7f48e469a3e5e5e789534360c62e6132404eb82e93e9e809711cee98d0a686366a7bbae1dcb0fc9c2ff8a5d118f1725cee5242e520450548f529b900ef70b1487e5b87d3a621a0d161616c9a7aad5dffaa19734eef219e52512fee476c51d3f25054baf555741585ef397891b565bf78cbc5e45d5615cd49eeac87041b204a02cba711c762c3eefc889fc340c4fbcbd21ae87e852725513f616024f9e03dd327789f07cd9d0e40e058c5d1185f14c649820387d8d8c8533b7fb5b15bc668dd08d8442c824bfce7945993336e3dbd923805228ccac36b2a1675834ab1640debda66e122de038bc6b5aa9467fcce1fbad3db8070f06131dae59ba7797d880b51f48554b3889124a422af3a3134de664b4eea0ff5b395ec47bf5c988fd25c5ea96284cd1767e49e1b4c372e9f5734654c7a2c2aa07221f0a8233a7052b62959657df75f25c1d7a0e7b2a454e8383a4fe3e42d25be7961637254ced5873fec272f1a5cb4b2512bb0c984f4fcb90d6ecb7680b49c22ff9f038ce996aa0b6b970032e886d2223671adfdaf9d4ea9ba7ea97429d08eed14940d893885b35719aa064ce3b8feb4e997bfbc7c72ce5d79c8ef15dca12fc9c9112b7fcbc2454dec4500420a49a7b97fa0e718dcc5e8b50df22ed9ff1fd7585e0c756e6375be9eddbbf8cb69611c85cce06de285d5d8cb45e6e3d6ac5ccb9b4dc30df70d5e8a7a4cd91d059ffd81be168eb18430fa36b95f5d329fd80d1687a6595d7458d1cb349cd069f3046419c23c1a020774c6588f6b0b3ded80b7b79f49282a4c6a5ba341114c75132cae69bbfe1d02c4b6f2ed65b0706a6778ea8d24797043f2bc3776d42f8fe4b5ad07f0ce2cc127aa0a68f77bfeb4d7adf9cbc346bba86992c01024975744f6346a70b521faa09c44f98372570dbd7a48688e1e6a81dddc2b3fee35c7f00194e72e0497cd53bc6c3b9b78086732d5a592ca111c249e35cc58d3903f8122f61a88295dad555cdea152b69653a9ed7b78140ed4aed6ad9c6747b96bf0c58ff9fe4a8a9d0f21371360d63f44109b5a58e971851fa94d3164aca10adf52063f40072d0546bf65bc90ccdadbb049aa896d00cded6b293d4dc70515f8e9b2d3e4294b5d07c890a927cdd2b8dfde60a7f22022d2a0de40c6b28df8141f6d0090b586691d07a4ceaf2a6e36cc6d6716e435bcc949ad830e6d018d5fd66c31d260a1c93a1b8fdb5b5db7ff70df7c268f5de3981357f3257c5baf23026cffc19cad0619bd54ac565923efc124f39600893a4130dc74f0d96ee96b72f226b1da08b6ebadb56f2d17acb8db323b3cf4257081790d86f206643bc8b19b007c588c1650575fa4c0519974d53e2f91566bf434c6fd3fcfcf75e1493ebb658ddb40faef02b7212858f5082d4c42a3e7c270bde3fd3d5e67ba8918d9ee0790ad88d62b760c06788c59b51a923e7bfb6e2fea2f6e8d77edfd2d7eccb91c88e0bd128434fc3ce6db25bf667ff86d6f92d08b1c03c8526ebe707097778306b5ba6b4f602341cea558900392bb3df0391f665fce4062f27cd6d4c3810f4c9af3638613cb21394d528841f58477586eaccb2103b86db7493237145367cbeb3e4eef84983f589e9100d1ba458068c56ae2acdf666c16ceed1e91942f0ab3e57b8cfc18b9f64bdad02f7de7bf350b4f0465386caa44bcb009f6e6c4ce2c31d0adfc7f06688cc04f5d28baca37c4055d42f284e7bbbb79f190605fec8ac6372e2e711656bc2f594903d76875f55ef26e68681661645671056e3015c2bb50ba4bc4a3046f442fa62ef80faf9a7dc94edb25c5307282e22bd8984bcbad270166e273f71f46045d5fb1db80d5bc3a754aeab628849740bce7131f518633b05410dc25d2c9708f21c71f498241ea95b8a97aa1473a32b1caae46a2c10ed42f1429f2ba35d512b540476c69e7f283d7210114ce2ae62fefba60baf976bc53154c24b27a9712f16ea54e043d87f0148b523fb957632e0d210e422e57302919a5c0a009d1e76bc6aca79326bece918613240f2bf9222f5498e757803e3471e65d8e9166f0ef981218fbffb186acd299322a0da08299bf748c9e478abc7feeccd7ce213c84ee0ac9d361361b045e2d61cc5a396eba57446ff16f6c25ed0c9ef82a4b8efb0a6dc4ab7c602584177eb7b950aa21f0105c0522e858632a793025afb7df420e9b527bea5cc2101348a103d3f32ac1891e47775f86794cd4b185f573aba787a94e1b0cf38be220d5e3dc527dd04cd871e725645231f2d4a0af2755a2d724b3ec2b85d9aeea02302c87f71bbd3dc7fa848c58b61ba127662e60c336102ecad87802cc2b1c0e4f0b97c6b44fcdb7d6f05dfffdb15775b1ffce651e993991e8b01601a097c039cf41426beeecca296cc54254f1a5f355669a70a6bed12f52afaff951193ad2a441fa3a61cca1b7655e344a0782f62941046158fdfab75934dabe06b151b9a27fff3a2af36157de21cd7afb1662f713745eedd3ddb525ecb3194651f4093a39521439c5d153919390322974229ff786e5d5dbde2397d7cdd071993deac4ab73ec3c11a4980b727859393a6936a78320961c9eebceeb35a85d3b387deb1bf839f29e51111ee96c04cd57760feb3338a46259172d41fd596a8a74969d08794227bc8f5967e2429ba66699fec29bb5195ed69a1639a8fbd1fc6bbbfc5dfff06e1ca1bf9498f858f65878ea76008d2d4e621eba4b5b50c97e529bc401fbae97bf6bbd6b482c44b18feef83d8a498926bdd33c23c0b7b9d9ba556bd714ae83db236624cce433c8a867b6cb94e5c9db4cf3943c414c93f80390f636a8f5b7ee0b64fceab9f19fe65982b7e898c6bedce31a689ae113912e721c2b4f92cb3641753d6ef09522d6979ed830c5723fd77cdf1f218fdd6c698710427ccd8c0b2efabb4ff9802363806ca7537198295aa4c769545dc535cf65bf2e93dea759bba3b0813defd4aa969ae67c3d983fb407b15e1fdefa4104bfb0e847559096975602c7ccb1b6f6bf12c8dc195200fc232de53f313e57405f4a79a2dd549df7bbe54657167451646b339f045bfa7d2d5976d794df90aa18bc8b14c42966f8410b422e9836e9a1641035582f01e27f2a6eeb8ef3bb90ac5ee9be669f0005e717d23bf49766ca64735a7fdb593a30176a0eb72807f93dc0c86e6bdfceaeba8b985da35a82904c1cda8e6af378968ebb49b67651d61d4070639068c87efc25f6adb75b3faa801efd0233a8b75666f974fbe4669114543818f293b1469c78db0d0c5e5818786d319dd101924d463f481e62ff759a9174b1b2776f29eb7945456a9abace0e963a3a13ce56be3f5e2cf07527fa48f1ea4e153efce28785db1083c4a5553b2a7ceee1c0d3e99f34ee5bc504be</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">æœ¬ç¯‡æ­£åœ¨æ’°å†™ä¸­...</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">å››éä¸Šå²¸æ¢¦æ ¡BUAA</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>è®ºæ–‡ç¬”è®°|Video-LLaMAï¼šAn Instruction-tuned Audio-Visual Language Model for Video Understanding</title>
    <link href="https://www.cclmsy.cc/posts/2306.02858.html"/>
    <id>https://www.cclmsy.cc/posts/2306.02858.html</id>
    <published>2025-07-16T16:00:00.000Z</published>
    <updated>2025-07-18T11:17:56.833Z</updated>
    
    <content type="html"><![CDATA[<p>è®ºæ–‡ï¼š<a href="https://arxiv.org/abs/2306.02858">Video-LLaMA: An Instruction-tuned Audio-Visual Language Model for Video Understanding</a></p><p>é˜¿é‡Œè¾¾æ‘©é™¢çš„ä¸€ä¸ªå¤šæ¨¡æ€å¤§è¯­è¨€æ¨¡å‹äº§å“Video-LLaMAï¼Œå®ƒé’ˆå¯¹çš„ä»»åŠ¡æ˜¯å¤šæ¨¡æ€è§†é¢‘ç†è§£ã€‚</p><h1>Background</h1><p>è¦ä½¿LLMsç†è§£è§†é¢‘ï¼Œéœ€è¦å…¨é¢å¤„ç†åŒ…æ‹¬è§†è§‰è¾“å…¥ã€å¬è§‰è¾“å…¥å’Œæ–‡æœ¬è¾“å‡ºåœ¨å†…çš„ä¸åŒæ¨¡æ€ï¼Œè¿™æ¯”ä»…ç†è§£å›¾åƒæˆ–ä»…ç†è§£éŸ³é¢‘ä»»åŠ¡æ›´å…·æŒ‘æˆ˜æ€§</p><ul><li>Multi-modal Large Language Models (MLLMs)</li><li>ç°æœ‰æ–¹æ³•ï¼šåªæœ‰ä¸€ç§é¢å¤–æ¨¡æ€è¾“å…¥å’Œæ–‡æœ¬å¯¹é½</li><li>é’ˆå¯¹è§†é¢‘ç†è§£çš„workï¼šä¸ä½¿ç”¨éŸ³é¢‘éƒ¨åˆ†</li></ul><p>Video-LLaMAå¯ä»¥ç†è§£è§†é¢‘ä¸­è§†è§‰å’Œå¬è§‰å†…å®¹ã€‚</p><p>ä¸åŒäºé‡‡ç”¨å¤–éƒ¨æ„ŸçŸ¥å°†è§†å¬ä¿¡å·è½¬åŒ–ä¸ºæ–‡æœ¬ä¿¡å·ï¼Œä½œè€…æ„å»ºäº†ä¸€ä¸ªç«¯åˆ°ç«¯æ¨¡å‹ï¼Œå¯ä»¥åœ¨å•ä¸ªæ¡†æ¶å†…å¤„ç†æ¥è‡ªå¤šç§æ¨¡æ€çš„æ•°æ®</p><h1>Related Work</h1><ol><li>LLMs<ul><li>æœ¬æ–‡åŸºç¡€</li><li>Video-LLaMAèµ‹äºˆLLMè§†é¢‘ã€éŸ³é¢‘ç†è§£èƒ½åŠ›</li></ul></li><li>MLLMs<ol><li>å°†LLMä½œä¸ºæ§åˆ¶å™¨ï¼Œè¯†åˆ«ç”¨æˆ·æ„å›¾å¹¶å†³å®šè°ƒç”¨ç°æœ‰çš„å¤šæ¨¡æ€å·¥å…·ï¼Œæ•´åˆç»“æœå…¨é¢å“åº”</li><li>è®­ç»ƒåŸºç¡€å¤šæ¨¡æ€å¤§æ¨¡å‹ï¼Œæ ¸å¿ƒæ˜¯å°†å…¶ä»–æ¨¡æ€çš„é¢„è®­ç»ƒåŸºç¡€æ¨¡å‹ä¸æ–‡æœ¬å‹å¤§å‹è¯­è¨€æ¨¡å‹å¯¹é½</li></ol><ul><li>Video-LLaMAå±äºç¬¬äºŒç±»ï¼Œè®­ç»ƒæ¨¡å‹ä»¥æä¾›è§†è§‰ã€éŸ³é¢‘ç†è§£èƒ½åŠ›</li></ul></li></ol><h1>Architecture</h1><p>Video-LLaMAå°†è§†é¢‘å¸§å’ŒéŸ³é¢‘åˆ†åˆ«å¤„ç†ï¼Œæ•´ä¸ªæ¶æ„åˆ†æˆä¸¤ä¸ªåˆ†æ”¯ï¼šè§†è§‰è¯­è¨€åˆ†æ”¯å’ŒéŸ³é¢‘è¯­è¨€åˆ†æ”¯</p><p>åˆ†åˆ«å°†è§†é¢‘å¸§å’ŒéŸ³é¢‘ä¿¡å·è½¬æ¢ä¸ºä¸LLMæ–‡æœ¬è¾“å…¥å…¼å®¹çš„æŸ¥è¯¢è¡¨ç¤º</p><h2 id="Vision-Language-Branch">Vision-Language Branch</h2><h3 id="1-Frozen-pre-trained-image-encoder">1. Frozen pre-trained image encoder</h3><p>å†»ç»“çš„é¢„è®­ç»ƒå›¾åƒç¼–ç å™¨ï¼Œä»è§†é¢‘å¸§æå–å‡ºè§†è§‰ç‰¹å¾ã€‚</p><p>$$<br>V = [v_1, v_2, â€¦, v_N] , v_i \in \R^{K_f\times d_f}<br>$$</p><p>v_iè¡¨ç¤ºç¬¬iå¸§ç”¨K_fä¸ªpatchè¡¨ç¤ºçš„è§†è§‰ç‰¹å¾ï¼Œd_fæ˜¯æ¯ä¸ªpatchçš„ç»´åº¦ã€‚</p><h3 id="2-PE-layer">2. PE layer</h3><p>ä¸Šä¸€å±‚äº§å‡ºçš„presentationsæœªè€ƒè™‘æ—¶åºä¿¡æ¯ï¼ŒPEå±‚ä¸ºæ¯ä¸ªv_iæ·»åŠ ä½ç½®åµŒå…¥ï¼ˆæ—¶é—´ä¿¡æ¯ï¼‰</p><h3 id="3-Video-Q-Former">3. Video Q-Former</h3><p>Video Query-Transformerï¼ˆQ-Formerï¼‰ä½¿ç”¨å’ŒBLIP2çš„Q-Formerçš„åŒæ¬¾æ¶æ„ï¼Œå°†ä½ç½®ç¼–ç åçš„å¸§è¡¨å¾èšåˆä¸ºè§†é¢‘çº§åˆ«çš„åµŒå…¥è¡¨ç¤ºã€‚</p><p>$$<br>\hat V \in \R^{K_v \times d_v}<br>$$</p><h3 id="4-Linear">4. Linear</h3><p>ä½¿è§†é¢‘è¡¨å¾é€‚åº” LLM çš„è¾“å…¥ï¼Œå°†è§†é¢‘åµŒå…¥å‘é‡è½¬æ¢ä¸ºè§†é¢‘æŸ¥è¯¢å‘é‡ï¼Œä¸ LLM çš„æ–‡æœ¬åµŒå…¥å¯¹é½</p><p>ä¸€ä¸ªçº¿æ€§å±‚å°†è§†é¢‘åµŒå…¥è½¬æ¢ä¸ºè§†é¢‘æŸ¥è¯¢å‘é‡ï¼Œä¸æ–‡æœ¬åµŒå…¥çš„ç»´åº¦å¯¹é½ã€‚</p><h3 id="Implementation">Implementation</h3><p>å®ç°éƒ¨åˆ†ï¼Œå†»ç»“çš„é¢„è®­ç»ƒå›¾åƒç¼–ç å™¨ä½¿ç”¨Blip2çš„é¢„è®­ç»ƒè§†è§‰ç»„ä»¶ï¼ˆåŒ…å«æ¥è‡ª EVA-CLIP çš„ ViTG/14 å’Œä¸€ä¸ªé¢„è®­ç»ƒçš„ Q-formerï¼‰</p><p>å…¶ä½™ç»„ä»¶ï¼ŒåŒ…æ‹¬ä½ç½®åµŒå…¥å±‚ã€è§†é¢‘ Q-former å’Œçº¿æ€§å±‚ï¼Œå‡ç»è¿‡éšæœºåˆå§‹åŒ–å’Œä¼˜åŒ–ï¼Œä»¥ä¾¿å°†å†»ç»“è§†è§‰ç¼–ç å™¨çš„è¾“å‡ºä¸å†»ç»“çš„ LLM è‰¯å¥½åœ°è¿æ¥èµ·æ¥ã€‚</p><h2 id="Audio-Language-Branch">Audio-Language Branch</h2><p>æ•´ä½“ç»“æ„å’Œè§†è§‰è¯­è¨€åˆ†æ”¯åŸºæœ¬ç›¸åŒï¼Œå¤„ç†éŸ³é¢‘ä¿¡å·ã€‚</p><h3 id="1-Frozen-pre-trained-audio-encoder">1. Frozen pre-trained audio encoder</h3><p>å†»ç»“çš„é¢„è®­ç»ƒéŸ³é¢‘ç¼–ç å™¨ï¼Œè®¡ç®—çŸ­ç‰‡æ®µåŸå§‹éŸ³é¢‘çš„ç‰¹å¾ã€‚</p><p>$$<br>A = [a_1, a_2, â€¦, a_M]<br>$$</p><h3 id="2-PE-layer-2">2. PE layer</h3><p>å‘éŸ³é¢‘ç‰‡æ®µæ³¨å…¥æ—¶é—´ä¿¡æ¯</p><h3 id="3-Audio-Q-Former">3. Audio Q-Former</h3><p>Audio Q-Former ä¹Ÿä½¿ç”¨Q-Formerçš„åŒæ¬¾æ¶æ„</p><p>åˆ©ç”¨å¸¦æœ‰ä½ç½®ä¿¡æ¯çš„éŸ³é¢‘ç‰‡æ®µä¹‹é—´çš„äº¤äº’ï¼Œæ¥ç”Ÿæˆå›ºå®šé•¿åº¦çš„éŸ³é¢‘ç‰¹å¾ã€‚</p><p>$$<br>\hat A \in \R^{K_a \times d_a}<br>$$</p><h3 id="4-Linear-2">4. Linear</h3><p>å°†éŸ³é¢‘åµŒå…¥å‘é‡è½¬æ¢ä¸ºéŸ³é¢‘æŸ¥è¯¢å‘é‡ï¼Œä¸æ–‡æœ¬åµŒå…¥çš„ç»´åº¦å¯¹é½ã€‚</p><h3 id="Implementation-2">Implementation</h3><p>å®ç°éƒ¨åˆ†ï¼Œå†»ç»“çš„é¢„è®­ç»ƒéŸ³é¢‘ç¼–ç å™¨ä½¿ç”¨ Pre-trained ImageBind</p><p>çŸ­ç‰‡æ®µåŸå§‹éŸ³é¢‘ï¼šå‡åŒ€é‡‡æ ·Mä¸ª2ç§’çŸ­éŸ³é¢‘ç‰‡æ®µï¼Œä½¿ç”¨128ä¸ªmelé¢‘è°±å›¾åƒå°†æ¯ä¸ª2ç§’éŸ³é¢‘å‰ªè¾‘è½¬æ¢ä¸ºé¢‘è°±å›¾</p><p>å…¶ä»–éƒ¨åˆ†çš„å¤„ç†å’Œè§†è§‰è¯­è¨€åˆ†æ”¯ç›¸åŒã€‚</p><h1>Training</h1><h2 id="Video-Language">Video-Language</h2><p>é¢„è®­ç»ƒä½¿ç”¨çš„æ•°æ®é›†ï¼š</p><ul><li>Webvid-2Mï¼šå¤§è§„æ¨¡çŸ­è§†é¢‘æ•°æ®é›†ï¼ŒåŒ…å«æ¥è‡ªç´ æç½‘ç«™çš„æ–‡æœ¬æè¿°</li><li>CC595k: ç»è¿‡è¿‡æ»¤çš„å›¾åƒ-æ–‡æœ¬æ•°æ®é›†</li></ul><p>é—®é¢˜ï¼šç›¸å½“ä¸€éƒ¨åˆ†æ–‡æœ¬æè¿°ä¸è¶³ä»¥åæ˜ è§†é¢‘çš„å…¨éƒ¨å†…å®¹ï¼Œè§†é¢‘çš„è§†è§‰è¯­ä¹‰ä¸æè¿°çš„æ–‡æœ¬è¯­ä¹‰å¹¶éå®Œå…¨ä¸€è‡´ã€‚</p><p>é¢„è®­ç»ƒé˜¶æ®µçš„ç›®æ ‡æ˜¯åˆ©ç”¨æµ·é‡æ•°æ®ä½¿è§†é¢‘ç‰¹å¾å°½å¯èƒ½åœ°åŒ…å«è§†è§‰çŸ¥è¯†</p><p>å°†è§†è§‰æ–‡æœ¬å¯¹é½å’ŒæŒ‡ä»¤éµå¾ªèƒ½åŠ›ç•™å¾…ä¸‹ä¸€é˜¶æ®µå®Œæˆ</p><p>ä½¿ç”¨é«˜è´¨é‡çš„æŒ‡ç¤ºæ•°æ®å¯¹æ¨¡å‹è¿›è¡Œå¾®è°ƒï¼š</p><ul><li>å›¾åƒç»†èŠ‚æè¿° from MiniGPT-4</li><li>å›¾åƒæŒ‡ä»¤ from LLaVA</li><li>è§†é¢‘æŒ‡ä»¤ from Video-Chat</li></ul><p>ç»†èŠ‚æè¿°ï¼šè®­ç»ƒæ¨¡å‹èƒ½å¤Ÿå¯¹å›¾åƒæˆ–è§†é¢‘ç”Ÿæˆè¯¦å°½ã€å…¨é¢ã€äº‹å®æ€§çš„æ–‡æœ¬æè¿°ï¼Œå°½å¯èƒ½å¤šåœ°æ•æ‰å’Œæè¿°å›¾åƒ/è§†é¢‘ä¸­çš„æ‰€æœ‰å¯è§å…ƒç´ ã€å®ƒä»¬çš„å±æ€§ã€ç©ºé—´å…³ç³»ã€å‘ç”Ÿçš„åŠ¨ä½œä»¥åŠä¸Šä¸‹æ–‡</p><p>æŒ‡ä»¤ï¼šç†è§£å¹¶éµå¾ªç”¨æˆ·çš„ç‰¹å®šæŒ‡ä»¤æˆ–å›ç­”ç”¨æˆ·æå‡ºçš„å…·ä½“é—®é¢˜ï¼Œé’ˆå¯¹è¯¥æŒ‡ä»¤æˆ–é—®é¢˜çš„ç®€æ˜ã€å‡†ç¡®çš„å›ç­”æˆ–æ‰§è¡Œç»“æœ</p><h2 id="Audio-Language">Audio-Language</h2><p>éŸ³é¢‘-è¯­è¨€åˆ†æ”¯ä¸­å¯å­¦ä¹ å‚æ•°çš„ç›®æ ‡æ˜¯å°†å†»ç»“çš„éŸ³é¢‘ç¼–ç å™¨çš„è¾“å‡ºåµŒå…¥ä¸LLMçš„åµŒå…¥ç©ºé—´å¯¹é½ã€‚</p><p>ç›´æ¥ä½¿ç”¨éŸ³é¢‘-æ–‡æœ¬æ•°æ®è®­ç»ƒéŸ³é¢‘-è¯­è¨€åˆ†æ”¯éå¸¸å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œå› ä¸ºè¿™ç±»æ•°æ®éå¸¸ç¨€ç¼ºã€‚</p><p>å¤©æ‰çš„æƒ³æ³•ï¼šImageBindå…·å¤‡å°†ä¸åŒæ¨¡æ€çš„åµŒå…¥å¯¹é½åˆ°åŒä¸€å…±äº«ç©ºé—´çš„å“è¶Šèƒ½åŠ›</p><p>ç›´æ¥ç”¨è§†è§‰â€‘æ–‡æœ¬æ•°æ®æ¥è®­ç»ƒéŸ³é¢‘â€‘è¯­è¨€åˆ†æ”¯ï¼Œç”šè‡³å¤„ç†å’Œè®­ç»ƒæµç¨‹éƒ½ç›´æ¥ç…§æ¬//</p><p>è®­ç»ƒçš„ç»“æœï¼šè™½ç„¶è®­ç»ƒæ—¶æ²¡è§è¿‡éŸ³é¢‘æ•°æ®ï¼Œæ¨ç†è¿‡ç¨‹ä¸­å±•ç°å‡ºç†è§£éŸ³é¢‘çš„èƒ½åŠ›</p><h2 id="æ€è€ƒï¼šä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨è§†è§‰æ–‡æœ¬æ•°æ®è®­ç»ƒéŸ³é¢‘-è¯­è¨€åˆ†æ”¯ï¼Ÿ">æ€è€ƒï¼šä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨è§†è§‰æ–‡æœ¬æ•°æ®è®­ç»ƒéŸ³é¢‘-è¯­è¨€åˆ†æ”¯ï¼Ÿ</h2><ul><li>ä¸€åˆ‡çš„åŸºç¡€ï¼šImageBindçš„å¤šæ¨¡æ€å¯¹é½èƒ½åŠ›<ul><li>è¯»åˆ°æ¶æ„éƒ¨åˆ†çš„æ—¶å€™è¿˜å¥‡æ€ªä¸ºä»€ä¹ˆéŸ³é¢‘-è¯­è¨€åˆ†æ”¯è¦ç”¨ImageBindè¿™æ ·ä¸€ä¸ªåå­—é•¿å¾—åƒè§†è§‰è¯­è¨€å¤„ç†å™¨ä½œä¸ºç¼–ç å™¨ï¼Œä¸€åˆ‡éƒ½æœ‰è¿¹å¯å¾ª</li></ul></li><li>è§†é¢‘çš„ç”»é¢é€šå¸¸å’Œè¯­éŸ³åŒæ­¥å¯¹åº”ï¼Œå¯ä»¥è¿‘ä¼¼æ›¿ä»£éŸ³é¢‘æ•°æ®ï¼Œè®­ç»ƒæ•ˆæœåº”è¯¥ä¼šæ¯”è¾ƒç›¸è¿‘</li></ul><h1>LLM</h1><p>æœ€åï¼Œè§†é¢‘å’ŒéŸ³é¢‘ä¿¡æ¯ä¸æ–‡æœ¬åµŒå…¥è¿æ¥åœ¨ä¸€èµ·ï¼Œä½œä¸ºè§†é¢‘è½¯æç¤ºï¼Œå¼•å¯¼LLMsç”ŸæˆåŸºäºè§†é¢‘å†…å®¹çš„æ–‡æœ¬ã€‚</p><h1>Examples</h1><h2 id="1-è§†å¬æ•´åˆæ„ŸçŸ¥èƒ½åŠ›">1. è§†å¬æ•´åˆæ„ŸçŸ¥èƒ½åŠ›</h2><p>åœ¨åŒ…å«ä¸€ä¸ªè§†é¢‘çš„ä¸€ä¸ªå¯¹è¯ä¸­ï¼Œå„æå‡ºä¸€ä¸ªå…³äºéŸ³é¢‘å’Œè§†é¢‘çš„æŒ‡ä»¤ï¼ŒVideo-LLaMAéƒ½å¯ä»¥ç­”ä¸Šæ¥ï¼Œè¯´æ˜å…¶å…·å¤‡è‰¯å¥½çš„è§†å¬æ•´åˆæ„ŸçŸ¥èƒ½åŠ›ã€‚</p><h2 id="2-æ•æ‰è§†é¢‘å†…æ—¶é—´åŠ¨æ€çš„èƒ½åŠ›">2. æ•æ‰è§†é¢‘å†…æ—¶é—´åŠ¨æ€çš„èƒ½åŠ›</h2><p>Video-LLaMAå¯ä»¥æ•æ‰åˆ°èˆ¹å‘å³è¡Œè¿›ã€å¥³å­©å°†æ‰‹æŒ‡æ”¾åœ¨å˜´å”‡ä¸Šç­‰æ—¶é—´åŠ¨æ€ã€‚</p><h2 id="3-ç†è§£é™æ€å›¾ç‰‡çš„èƒ½åŠ›">3. ç†è§£é™æ€å›¾ç‰‡çš„èƒ½åŠ›</h2><p>èƒ½ç†è§£â€œç”·äººåœ¨è½¦é¡¶æ‹¿ç€ç†¨æ–—çƒ«è¡£æœâ€çš„éå¸¸è§„å†…å®¹ï¼›ç»†è‡´æå†™å°ç‹—åŠ¨ä½œï¼ŒåŒæ—¶å°†åŠ¨ä½œå’Œâ€œä¸äººç±»å‹å¥½äº’åŠ¨â€è”ç³»èµ·æ¥ã€‚</p><h2 id="4-å¸¸è¯†æ€§å†…å®¹">4. å¸¸è¯†æ€§å†…å®¹</h2><p>èƒ½å¤Ÿè®¤å‡ºåœ°æ ‡æ€§å»ºç­‘â€œç¾å›½å›½ä¼šå¤§å¦â€</p><p>ç”šè‡³è®¤å‡ºå½±è§†ã€ŠæƒåŠ›çš„æ¸¸æˆã€‹ä¸­ç”±åŸºç‰¹-å“ˆçµé¡¿æ‰®æ¼”çš„ç¼æ©-é›ªè¯ºå’Œç”±è‰¾ç±³è‰äºš-å…‹æ‹‰å…‹æ‰®æ¼”çš„ä¸¹å¦®è‰ä¸-å¦æ ¼åˆ©å®‰ï¼Œç”šè‡³æ¸…æ¥šåœ¨å‰§ä¸­ï¼Œä»–ä»¬æœ‰ç€æµªæ¼«çš„å…³ç³»ã€‚ä»–ä»¬ç¬¬ä¸€æ¬¡è§é¢æ˜¯åœ¨ç¬¬ä¸ƒå­£ï¼Œåœ¨ç¬¬å…«å­£ä¸­ï¼Œä»–ä»¬å¯¹å½¼æ­¤çš„å¸å¼•åŠ›ä¸æ—¥ä¿±å¢ã€‚</p><h1>Conclusion</h1><p>æå‡ºVideo-LLaMAï¼Œä¸€ä¸ªä½¿LLMèƒ½å¤ŸåŒæ—¶å¤„ç†ç»™å®šè§†é¢‘çš„è§†è§‰å’Œå¬è§‰å†…å®¹ï¼Œå¹¶ä¸äººç±»è¿›è¡Œå¯¹è¯çš„å¤šæ¨¡æ€æ¡†æ¶</p><h1>Limitations</h1><ol><li>æ„ŸçŸ¥èƒ½åŠ›æœ‰é™ï¼šå½“å‰è®­ç»ƒæ•°æ®é›†çš„è´¨é‡å’Œè§„æ¨¡é™åˆ¶äº†Videoâ€‘LLaMAçš„è¡¨ç°ã€‚æˆ‘ä»¬æ­£åœ¨ç§¯ææ„å»ºé«˜è´¨é‡çš„éŸ³è§†é¢‘æ–‡æœ¬å¯¹é½æ•°æ®é›†ä»¥æå‡æ¨¡å‹çš„æ„ŸçŸ¥èƒ½åŠ›ã€‚</li><li>å¤„ç†é•¿è§†é¢‘èƒ½åŠ›æœ‰é™ã€‚é•¿è§†é¢‘ï¼ˆå¦‚ç”µå½±ã€ç”µè§†å‰§ï¼‰åŒ…å«å¤§é‡ä¿¡æ¯ï¼Œå¯¹è®¡ç®—èµ„æºè¦æ±‚æ›´é«˜ã€‚è¿™ä¸€æŒ‘æˆ˜ä»æ˜¯ç ”ç©¶ç•Œç§¯ææ”»å…‹çš„å…³é”®é—®é¢˜ã€‚</li><li>å¹»è§‰é—®é¢˜ã€‚Videoâ€‘LLaMAç»§æ‰¿äº†å†»ç»“çš„å¤§è¯­è¨€æ¨¡å‹çš„å¹»è§‰é—®é¢˜ã€‚</li><li>æ•´ä¸ªworkå†…å®¹ç®€å•ï¼Œç¼ºä¹ç§‘å­¦çš„è¯„ä¼°å’Œä¸SOTA/baselineçš„å¯¹æ¯”</li><li>Webvid-2Mç´ ææ¥è‡ªç½‘ç»œã€çŸ­è§†é¢‘æ–‡æœ¬æè¿°æŠ½è±¡ä¸åˆ‡é¢˜ï¼Œæ•°æ®è´¨é‡ä½ï¼Œä¸”å¯èƒ½å«æœ‰æœ‰å®³å†…å®¹ã€‚<ul><li>å°½ç®¡æŒ‡ä»¤å¾®è°ƒä½¿ç”¨äº†â€œæ›´é«˜è´¨é‡â€çš„æ•°æ® ï¼Œä½†åˆå§‹é¢„è®­ç»ƒåœ¨ WebVid-2Mï¼ˆ200 ä¸‡è§†é¢‘ ï¼‰ä¸Šåºå¤§</li></ul></li><li>ä½¿ç”¨è§†è§‰-è¯­è¨€æ•°æ®è®­ç»ƒImageBindçš„éŸ³é¢‘-è¯­è¨€åˆ†æ”¯è¿™ç§åšæ³•è™½ç„¶åœ¨ç»“æœä¸Šçœ‹åˆ°æˆæ•ˆï¼Œä½†ä»ç„¶ç¼ºä¹å……åˆ†çš„ç†è®ºæ”¯æŒå’Œå®éªŒéªŒè¯ã€‚</li></ol>]]></content>
    
    
    <summary type="html">é˜…è¯»è®ºæ–‡ã€ŠVideo-LLaMAï¼šAn Instruction-tuned Audio-Visual Language Model for Video Understandingã€‹</summary>
    
    
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://www.cclmsy.cc/categories/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://www.cclmsy.cc/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    <category term="MLLLM" scheme="https://www.cclmsy.cc/tags/MLLLM/"/>
    
  </entry>
  
  <entry>
    <title>è®ºæ–‡ç¬”è®°|è§†å¹»è§‰è¯„ä¼°æ•°æ®é›†PhDï¼šA ChatGPT-Prompted Visual hallucination Evaluation Dataset</title>
    <link href="https://www.cclmsy.cc/posts/2403.11116.html"/>
    <id>https://www.cclmsy.cc/posts/2403.11116.html</id>
    <published>2025-06-24T16:00:00.000Z</published>
    <updated>2025-07-21T05:35:10.046Z</updated>
    
    <content type="html"><![CDATA[<p>è®ºæ–‡ï¼š<a href="https://arxiv.org/abs/2403.11116">PhD: A ChatGPT-Prompted Visual hallucination Evaluation Dataset</a></p><table><thead><tr><th style="text-align:center">ç¼©å†™</th><th style="text-align:center">å…¨ç§°</th><th style="text-align:center">ç›´è¯‘</th></tr></thead><tbody><tr><td style="text-align:center">VHE</td><td style="text-align:center">Visual Hallucination Evaluation</td><td style="text-align:center">è§†è§‰å¹»è§‰è¯„ä¼°</td></tr><tr><td style="text-align:center">hitem</td><td style="text-align:center">Hallucination item</td><td style="text-align:center">å¹»è§‰é¡¹</td></tr><tr><td style="text-align:center">CS</td><td style="text-align:center">Commen-sense</td><td style="text-align:center">åå¸¸è¯†</td></tr><tr><td style="text-align:center">CCS</td><td style="text-align:center">Counter-commen-sense</td><td style="text-align:center">åå¸¸è¯†</td></tr><tr><td style="text-align:center">VQA</td><td style="text-align:center">Visual Question Answering</td><td style="text-align:center">è§†è§‰é—®ç­”</td></tr><tr><td style="text-align:center">GT</td><td style="text-align:center">ground-truth</td><td style="text-align:center">æ­£ç¡®ç­”æ¡ˆ/çœŸå®ä¿¡æ¯</td></tr></tbody></table><h2 id="1-Introduction">1. Introduction</h2><p>MLLMä»¥LLMä¸ºå†…æ ¸ï¼Œç”±äºLLMå…·æœ‰å¹»è§‰é—®é¢˜ï¼ŒMLLMä¹Ÿä¼šå‡ºç°å¹»è§‰é—®é¢˜ã€‚</p><p>VHEä¸»è¦å‘MLLLMæå‡ºè§†è§‰é—®é¢˜ï¼Œä»¥ç‰¹å®šå•è¯æˆ–çŸ­è¯­è¯±å¯¼MLLMäº§ç”Ÿå’Œè§†è§‰å†…å®¹ä¸ä¸€è‡´çš„ååº”ã€‚</p><p>æœ¬æ–‡ä¸ºVHEå¼€å‘äº†ä¸€ä¸ªæ–°çš„æ•°æ®é›†ï¼Œç›®æ ‡ä¸ºä½çº§ï¼ˆå¯¹è±¡ã€å±æ€§ï¼‰åˆ°ä¸­çº§ï¼ˆæƒ…æ„Ÿã€ä½ç½®ã€è®¡æ•°ï¼‰çš„å®¢è§‚VHEè¯„ä¼°ã€‚</p><p>MLLMè§†è§‰å¹»è§‰ä¸»è¦åŸå› ï¼š</p><ol><li>Visual Ambiguity(è§†è§‰æ¨¡ç³Šæ€§)ï¼šMLLMä½¿ç”¨åŸºäºViTçš„ç¼–ç å™¨ï¼Œä»ç»™å®šå›¾åƒä¸­æå–<strong>é«˜å±‚æ¬¡ç‰¹å¾</strong>ï¼Œç¼ºä¹è¶³å¤Ÿçš„ç»†èŠ‚æ¥æ‰§è¡Œç²¾ç»†ä»»åŠ¡ï¼ˆç²¾ç¡®è®¡æ•°ï¼‰</li><li>Inconsistency in muti-modal input(å¤šæ¨¡æ€è¾“å…¥ä¸ä¸€è‡´)ï¼šLLMå†…æ ¸<strong>åå‘</strong>å¤šæ¨¡æ€è¾“å…¥ä¸­çš„<strong>æ–‡æœ¬éƒ¨åˆ†</strong>ï¼Œè§†è§‰ä¿¡æ¯æ›´å¯èƒ½è¢«å¿½ç•¥ã€‚</li><li>Counter-commen-sense(åå¸¸è¯†å†…å®¹)ï¼šLLMå†…æ ¸ä¸¥é‡ä¾èµ–å…¶å†…éƒ¨çš„â€œå¸¸è¯†â€</li></ol><p>æ–°æ•°æ®é›†PhDé€šè¿‡æ”¹ç¼–æ•°æ®é›†<a href="https://arxiv.org/abs/1703.09684">TDIUC</a>å’Œåˆ©ç”¨ChatGPTè¾…åŠ©åŠè‡ªåŠ¨åŒ–ç®¡é“æ„å»º</p><p>è´¡çŒ®ï¼š</p><ol><li>PhDæ•°æ®é›†ï¼šæ ¹æ®äº§ç”Ÿå¹»è§‰çš„3ä¸ªåŸå› ï¼Œåˆ›å»ºçš„åŒ…å«5ç§ä»»åŠ¡ã€4ç§è¯„ä¼°æ¨¡å¼çš„æ•°æ®é›†<ul><li>åŒ…å«14648æ—¥å¸¸å›¾åƒã€750CCSå›¾åƒå’Œ102564ä¸ªVQAä¸‰å…ƒç»„ï¼ŒåŒç±»æ•°æ®é›†è§„æ¨¡æœ€å¤§</li><li>æ¯ä¸ªæ ·æœ¬æä¾›äº†hitemçš„ä¿¡æ¯</li></ul></li><li>æä¾›äº†ç”±ChatGPTè¾…åŠ©ï¼Œæå°‘äººå·¥å¹²é¢„çš„åŠè‡ªåŠ¨åŒ–æ•°æ®é›†æ„å»ºç®¡é“</li><li>åœ¨15ç§å¼€æºMLLMã€3ç§ç§æœ‰MLLMã€2ç§å¹»è§‰ç¼“è§£æ–¹æ³•ä¸Šè¿›è¡Œè¯„ä¼°ï¼Œæ•´ä½“å±•ç¤ºPhDæ•°æ®é›†åœ¨VHEä¸Šçš„æœ‰æ•ˆæ€§</li></ol><h2 id="2-Related-work">2. Related work</h2><p>ç°æœ‰æ•°æ®é›†åˆ†ç±»ï¼š</p><ol><li>çº§åˆ«<ul><li>ä½çº§ï¼ˆå¯¹è±¡ã€å±æ€§ï¼‰~ä¸­çº§ï¼ˆæƒ…æ„Ÿã€ä½ç½®ã€è®¡æ•°ï¼‰ï¼šè¯„ä»·MLLMçš„åŸºæœ¬è§†è§‰åŠŸèƒ½</li><li>é«˜çº§ï¼šçŸ¥è¯†å¯†é›†åº¦é«˜ï¼ŒåŒ…æ‹¬æ•°å­¦è§£é¢˜ã€åœ°ç†ä¿¡æ¯ç†è§£ã€å¤‡å¿˜å½•è§£è¯»ã€å†å²æ°‘ä¿—ç­‰</li></ul></li><li>è¯„ä»·æ–¹å¼<ul><li>å®¢è§‚è¯„ä»·ï¼šå°†æ¨¡å‹è¾“å‡ºå’ŒåŸºæœ¬äº‹å®å¯¹æ¯”ï¼Œä»¥YES/NOå½¢å¼è¿›è¡Œ</li><li>ä¸»è§‚è¯„ä»·ï¼šéœ€è¦äººæˆ–LLMæ¥è¯„ä¼°æ¨¡å‹è¾“å‡º</li></ul></li></ol><p>PhDå±äºä½çº§åˆ°ä¸­çº§çš„å®¢è§‚è¯„ä»·æ•°æ®é›†ã€‚</p><p>è¯¥éƒ¨åˆ†ç°æœ‰æ•°æ®é›†çš„ä¸è¶³ï¼š</p><ol><li>POPEã€ROMEï¼šhitemé€‰æ‹©åŸºäºè®­ç»ƒæ•°æ®ä¸­çš„æ ‡ç­¾å…±ç°ç‡ï¼ˆè„±ç¦»å›¾åƒï¼‰</li><li>NOPEã€CIEMï¼šç¼ºä¹hitemé€‰æ‹©</li><li>AMBERï¼šäººå·¥æ ‡æ³¨</li></ol><h2 id="3-Method">3. Method</h2><p><img src="https://source.cclmsy.cc/posts/notes/papers/2403.11116/image-1.png" alt="alt text"></p><h3 id="3-1-Task-specific-Hitem-Selection-é’ˆå¯¹å…·ä½“ä»»åŠ¡çš„Hitemé€‰æ‹©">3.1 Task-specific Hitem Selection é’ˆå¯¹å…·ä½“ä»»åŠ¡çš„Hitemé€‰æ‹©</h3><p><img src="https://source.cclmsy.cc/posts/notes/papers/2403.11116/image.png" alt="alt text"></p><ol><li>Subject-Attribute Extractionï¼šä½¿ç”¨ChatGPTä»TDIUCé—®ç­”å¯¹ä¸­æå–ä¸»ä½“å’Œå±æ€§</li><li>Candidate Hitem Generationï¼šæ ¹æ®å±æ€§ç”Ÿæˆè¯æ±‡è¡¨ï¼Œæ’é™¤GT</li><li>Visual-based Hitem Rankingï¼šä½¿ç”¨CLIPæ¨¡å‹å¯¹å€™é€‰hitemè¿›è¡Œæ’åºï¼Œé€‰æ‹©ä¸å›¾åƒç›¸å…³æ€§æœ€é«˜çš„hitem<ul><li>æ–‡æœ¬è¾“å…¥ï¼šhitem+ä¸»ä½“</li><li>æœªæ¥å¯ä½¿ç”¨æ€§èƒ½æ›´å¥½çš„æ¨¡å‹</li></ul></li><li>Manual Inspectionï¼šåŸå§‹TDIUCé—®ç­”å¯¹å¯èƒ½æœ‰è¯¯ï¼Œæ­¤æ—¶ä¸¢å¼ƒVQA</li></ol><p>æˆæœï¼šå–å¾—1452ä¸ªæ›´å…·å¤šæ ·åŒ–å’ŒæŒ‘æˆ˜æ€§çš„hitems</p><h3 id="3-2-Hitem-embedded-Qestion-Generation-åµŒå…¥Hitemçš„é—®ç­”ç”Ÿæˆ">3.2 Hitem-embedded Qestion Generation åµŒå…¥Hitemçš„é—®ç­”ç”Ÿæˆ</h3><p>ç»™å®šä¸»ä½“å’Œä¸€ä¸ªé€‰å®šçš„hitemï¼ŒChatGPTç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼Œç­”æ¡ˆä¸ºâ€œNoâ€</p><p>ä½¿ç”¨GTç”Ÿæˆçš„é—®é¢˜ï¼Œç­”æ¡ˆåˆ™ä¸ºâ€œYesâ€</p><h3 id="3-3-Specious-Incorrect-Context-Generation-ä¼¼æ˜¯è€Œéï¼ˆæˆ–é”™è¯¯ï¼‰çš„å†…å®¹ç”Ÿæˆ">3.3 Specious(Incorrect) Context Generation ä¼¼æ˜¯è€Œéï¼ˆæˆ–é”™è¯¯ï¼‰çš„å†…å®¹ç”Ÿæˆ</h3><p>æè¿°å’Œå›¾ç‰‡ä¸çŸ›ç›¾æ—¶ï¼Œä¹Ÿå¯èƒ½ä¸å®Œå…¨ä¸€è‡´ï¼Œå¦‚æ‘©æ‰˜é™æ­¢ï¼ˆå›¾ä¸­ï¼‰å’Œç–¾é©°ï¼ˆæè¿°ï¼‰</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/2403.11116/image-2.png" alt="alt text"></p><ol><li>Specious Cont Generationï¼šä½¿ç”¨ChatGPTç”Ÿæˆä¸å›¾åƒå†…å®¹ä¸ä¸€è‡´çš„ä¸Šä¸‹æ–‡<ul><li>specious textï¼šä¼¼æ˜¯è€Œéï¼Œè½»å¾®ä¸ä¸€è‡´ï¼Œä½†ä¸ç›´æ¥çŸ›ç›¾</li><li>Promptï¼šâ€œè¯·ä¸ºç»™å®šé—®é¢˜ç”Ÿæˆ[specious text]ï¼Œä½¿å…¶èƒ½å›ç­”é—®é¢˜ï¼Œä½†å¯èƒ½æ— æ³•åæ˜ å½“å‰çš„å®é™…æƒ…å†µï¼Œä»è€Œspeciousâ€</li></ul></li><li>Text Compositionï¼šå°†ç”Ÿæˆçš„specious textä¸åŸå§‹captionè¡”æ¥ï¼Œæ–°çš„ä¸Šä¸‹æ–‡åªæœ‰å°éƒ¨åˆ†ä¸å›¾åƒè½»å¾®ä¸ä¸€è‡´</li><li>Manual Inspectionï¼šäººå·¥æŠ½æŸ¥ï¼Œå¦‚æœè´¨é‡ä¸é«˜åˆ™ä¸¢å¼ƒæ ·æœ¬</li></ol><h3 id="3-4-CCS-Image-Generation-åå¸¸è¯†å›¾åƒç”Ÿæˆ">3.4 CCS Image Generation åå¸¸è¯†å›¾åƒç”Ÿæˆ</h3><p><img src="https://source.cclmsy.cc/posts/notes/papers/2403.11116/image-3.png" alt="alt text"></p><ol><li>CCS Description Generationï¼šä½¿ç”¨ChatGPTç”ŸæˆCCSæè¿°ï¼ŒåŒæ—¶ç”ŸæˆCSæè¿°<ul><li>æ‰‹å†™ç‰¹å®šä»»åŠ¡æ ·ä¾‹ï¼Œä¸ºChatGPTç”Ÿæˆæä¾›å‚è€ƒ</li></ul></li><li>Text2Imageï¼šCCSæè¿°ç”Ÿæˆç›¸åº”å›¾åƒï¼Œäººå·¥è§£å†³æ•…éšœ</li><li>Question Generationï¼šä½¿ç”¨ChatGPTç”Ÿæˆï¼ŒCCSé—®é¢˜ç­”æ¡ˆä¸ºâ€œYesâ€ï¼ŒCSé—®é¢˜ç­”æ¡ˆä¸ºâ€œNoâ€</li></ol><h3 id="3-5-Dataset-Overview-PhD-Index-æ•°æ®é›†æ¦‚è§ˆä¸ç´¢å¼•">3.5 Dataset Overview &amp; PhD Index æ•°æ®é›†æ¦‚è§ˆä¸ç´¢å¼•</h3><p><img src="https://source.cclmsy.cc/posts/notes/papers/2403.11116/image-4.png" alt="alt text"></p><p>å››ç§è¯„ä¼°æ¨¡å¼ï¼š</p><ol><li>PhD-base: ä¸å«ä¸Šä¸‹æ–‡çš„æ—¥å¸¸å›¾åƒ</li><li>PhD-sec(specious): å«ä¼¼æ˜¯è€Œéä¸Šä¸‹æ–‡çš„æ—¥å¸¸å›¾åƒ</li><li>PhD-icc(incorrect): å«é”™è¯¯ä¸Šä¸‹æ–‡çš„æ—¥å¸¸å›¾åƒ</li><li>PhD-ccs: åå¸¸è¯†å›¾åƒé—®é¢˜</li></ol><p>4ç§è¯„ä¼°æ¨¡å¼Ã—5ç§ä»»åŠ¡=20ç§æ¨¡å¼-ä»»åŠ¡ç»„åˆ</p><p>PhDæŒ‡æ ‡ï¼šè°ƒå’Œå¹³å‡æ•°$\dfrac{2Recall_{yes}Recall_{no}}{Recall_{yes}+Recall_{no}}$</p><h2 id="4-Evaluating-MLLMs-on-PhD">4. Evaluating MLLMs on PhD</h2><h3 id="4-1-Setup">4.1 Setup</h3><p>æµ‹è¯•æ¨¡å‹ï¼š</p><ul><li>15ç§å¼€æºMLLMï¼ˆå…¨é‡ï¼‰</li><li>3ç§ç§æœ‰MLLMï¼ˆ2kéšæœºé‡‡æ ·ï¼‰</li><li>æ”¯æŒLLaVa-1.6-Lã€Qwen-VLçš„2ç§å¹»è§‰ç¼“è§£æ–¹æ³•VCDã€Woodpeckerï¼ˆ2kéšæœºé‡‡æ ·ï¼‰</li></ul><p>ä½¿ç”¨MLLMæŒ‡å®šæç¤ºè¯å½¢å¼ï¼›å¯¹äºsecã€iccï¼Œé™„åŠ æŒ‡ä»¤â€œå›¾æ–‡ä¸ä¸€è‡´ï¼Œä»¥å›¾ç‰‡ä¸ºå‡†â€</p><h3 id="4-2-æ€»ä½“PhDè¯„ä¼°">4.2 æ€»ä½“PhDè¯„ä¼°</h3><p>å…¨é¢äº†è§£å“ªç§MLLMäº§ç”Ÿçš„å¹»è§‰æœ€å°‘ã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/2403.11116/image-5.png" alt="alt text"></p><p>PhDè¾¨åˆ«èƒ½åŠ›å¼ºï¼Œä¾‹å¦‚å¯¹GPT-4oå’Œé¡¶çº§å¼€æºMLLMçš„æŒ‡æ ‡å·®è·æ¯”POPEå’ŒAMBERçš„è¯„ä¼°æ›´æ˜æ˜¾</p><p>PhDæ•°æ®é›†åœ¨ä»»åŠ¡å’Œè¯„ä¼°æ¨¡å¼æœ‰ç»†åˆ†ï¼Œæ”¯æŒé’ˆå¯¹æ€§åˆ†æ</p><h3 id="4-3-PhDé¢å‘æ¨¡å¼è¯„ä¼°">4.3 PhDé¢å‘æ¨¡å¼è¯„ä¼°</h3><p><img src="https://source.cclmsy.cc/posts/notes/papers/2403.11116/image-6.png" alt="alt text"></p><p>baseæ¨¡å¼ä¸‹ï¼Œå…·æœ‰æ›´å¼ºè§†è§‰è¾“å…¥çš„æ¨¡å‹è¡¨ç°æ›´å¥½ï¼Œå¯ä»¥é€šè¿‡2ç§æ–¹å¼å®ç°ï¼š</p><ol><li>æ›´å¼ºçš„è§†è§‰ç¼–ç å™¨</li><li>æ”¯æŒæ›´é«˜åˆ†è¾¨ç‡çš„è§†è§‰è¾“å…¥</li></ol><p>ä»…ä½¿ç”¨è¾ƒå¤§çš„LLMä¸ä¸€å®šèƒ½è·å¾—æ›´å¥½çš„MLLMï¼šè™½ç„¶å¤§å‹çš„LLMèƒ½æ›´å¥½åœ°ç†è§£ç”¨æˆ·æŒ‡ä»¤ï¼Œä½†åœ¨MLLMä¸­åº”ç”¨è¿˜éœ€è¦é’ˆå¯¹æ€§çš„VLå¯¹é½è®­ç»ƒã€‚</p><p>å¼€æºMLLMåœ¨PhD-iccå’ŒPhD-secä¸Šæ€§èƒ½æ™®éè¾ƒä½ï¼Œå› ä¸ºå¤šæ¨¡å¼è¾“å…¥ä¸‹ï¼ŒMLLMå†…æ ¸åå‘æ–‡æœ¬éƒ¨åˆ†ã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/2403.11116/image-7.png" alt="alt text"></p><p>ä½¿ç”¨æ›´å¤§çš„LLMå¯åœ¨PhD-iccå’ŒPhD-secä¸Šè·å¾—æ›´å¥½çš„ç»“æœï¼Œä½†æ›´ä¾èµ–å†…éƒ¨çŸ¥è¯†ï¼Œå¯¼è‡´åœ¨æ— ä¸Šä¸‹æ–‡çš„PhD-baseå’ŒPhD-ccsä¸Šæ€§èƒ½ä¸‹é™ã€‚</p><p>ï¼ˆWoodpeckerä½¿æ¨¡å‹è¡¨ç°æ›´å‡è¡¡ï¼‰</p><h3 id="4-4-PhDé¢å‘ä»»åŠ¡è¯„ä¼°">4.4 PhDé¢å‘ä»»åŠ¡è¯„ä¼°</h3><p><img src="https://source.cclmsy.cc/posts/notes/papers/2403.11116/image-8.png" alt="alt text"></p><p>MLLMå¹»è§‰ç¨‹åº¦å’Œä»»åŠ¡æ°´å¹³ç›¸å…³ï¼Œæ€»ä½“æŒ‡æ ‡ä»é«˜åˆ°ä½ï¼šæƒ…æ„Ÿ &gt; è®¡æ•° &gt; ä½ç½® &gt; å±æ€§ &gt; å¯¹è±¡</p><p>æƒ…æ„Ÿä»»åŠ¡å¤æ‚å¾®å¦™ã€è®¡æ•°ä»»åŠ¡è¦æ±‚ç²¾ç¡®ï¼Œéš¾åº¦è¾ƒé«˜ï¼›åœ¨æœ‰æ–‡æœ¬æˆ–CCSå¹²æ‰°æ—¶å°¤å…¶åƒåŠ›ã€‚</p><p>æ¨¡å‹åœ¨æ¯ç§æ¨¡å¼-ä»»åŠ¡ç»„åˆéƒ½æœ‰ä¸€ä¸ªå¾—åˆ†ï¼Œæœ‰åŠ©äºé’ˆå¯¹æ€§åˆ†æå®Œå–„ã€‚çƒ­åŠ›å›¾ï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/2403.11116/image-9.png" alt="alt text"></p><h3 id="4-5-MLLMç­”æ¡ˆå€¾å‘æ€§">4.5 MLLMç­”æ¡ˆå€¾å‘æ€§</h3><p>MLLMçš„PhDåˆ†æ•°å’ŒYESç‡çš„æ–¯çš®å°”æ›¼ç›¸å…³æ€§ï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/2403.11116/image-10.png" alt="alt text"></p><p>ç»“æœè¡¨ç¤ºï¼ŒMLLMè¡¨ç°å’ŒYESç‡å­˜åœ¨è¾ƒå¼ºè´Ÿç›¸å…³ï¼ŒYESç‡è¶Šé«˜ï¼ŒPhDåˆ†æ•°è¶Šä½ã€‚</p><p>è§£å†³VHé—®é¢˜éœ€è¦æ³¨é‡å¹³è¡¡è¾“å‡ºå€¾å‘ï¼Œå¢å¼ºæ¨¡å‹è¾“å‡ºNOçš„èƒ½åŠ›ã€‚</p><h2 id="5-ç¬”è®°">5. ç¬”è®°</h2><h3 id="5-1-PhDæ•°æ®é›†çš„ä¼˜ç‚¹">5.1 PhDæ•°æ®é›†çš„ä¼˜ç‚¹</h3><ol><li>åŒç±»æ•°æ®é›†è§„æ¨¡æœ€å¤§</li><li>æ¶µç›–5ç§ä»»åŠ¡ã€4ç§è¯„ä¼°æ¨¡å¼ï¼Œæ”¯æŒé’ˆå¯¹æ€§åˆ†æ</li><li>AIè¾…åŠ©åŠè‡ªåŠ¨åŒ–æ•°æ®é›†æ„å»ºç®¡é“ï¼Œæå¤§åœ°å‡å°‘äººå·¥å¹²é¢„<ul><li>äººå·¥å¹²é¢„ç¯èŠ‚ä¸»è¦é›†ä¸­åœ¨è´¨é‡å®¡æŸ¥</li></ul></li><li>é’ˆå¯¹ç—›ç‚¹ï¼Œç›´é¢MLLMçš„å¹»è§‰æˆå› ï¼Œè¯„ä¼°æœ‰æ•ˆæ€§é«˜<ul><li>è”ç³»åˆ°CLUEä¸­æåˆ°çš„MLLMå…·æœ‰æ¥è‡ªè¯­è¨€å…ˆéªŒå’Œéå›¾åƒä¸­å¿ƒåŒºåŸŸçš„åå·®é—®é¢˜ï¼›æ­¤å¤–ï¼Œè€ƒè™‘åˆ°äº†å›¾ç‰‡å¯èƒ½åŒ…å«CCSå†…å®¹</li></ul></li></ol><h3 id="5-2-ç–‘é—®">5.2 ç–‘é—®</h3><h4 id="åŸæ–‡-3-1">åŸæ–‡ 3.1</h4><p>Vocabulary Construction per taskï¼Œé¢œè‰²å±æ€§éœ€è¦äººå·¥æŒ‡å®šï¼ˆmanually specifyï¼‰ä¸€äº›ï¼Œç„¶åChatGPTè‡ªåŠ¨ç”Ÿæˆä¸€äº›æ—¥å¸¸è¯æ±‡ã€‚</p><p>ä¸åŒå¯¹è±¡ï¼ˆå®¶å…·ã€è½½å…·ï¼‰ã€å±æ€§ï¼ˆå¤§å°ã€é¢œè‰²ï¼‰ï¼Œæ¯ä¸€ä¸ªä»»åŠ¡çš„è¯æ±‡è¡¨ç”Ÿæˆéƒ½éœ€è¦äººå·¥æŒ‡å®šä¸€äº›å—ï¼Ÿ</p><p>å…³äºç¯èŠ‚é¡ºåºï¼Œä¸ªäººè®¤ä¸ºåº”è¯¥æ˜¯å…ˆè¿›è¡ŒSubject-Attribute Extractionï¼Œå†æ ¹æ®Subject/Attributeæ„å»ºè¯æ±‡è¡¨ï¼Ÿ</p>]]></content>
    
    
    <summary type="html">é˜…è¯»è®ºæ–‡ã€ŠPhDï¼šA ChatGPT-Prompted Visual hallucination Evaluation Datasetã€‹</summary>
    
    
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://www.cclmsy.cc/categories/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://www.cclmsy.cc/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    <category term="MLLLM" scheme="https://www.cclmsy.cc/tags/MLLLM/"/>
    
    <category term="æ•°æ®é›†" scheme="https://www.cclmsy.cc/tags/%E6%95%B0%E6%8D%AE%E9%9B%86/"/>
    
  </entry>
  
  <entry>
    <title>ã€Šæ“ä½œç³»ç»Ÿã€‹è¯¾ç¨‹ç¬”è®°</title>
    <link href="https://www.cclmsy.cc/posts/operating_system.html"/>
    <id>https://www.cclmsy.cc/posts/operating_system.html</id>
    <published>2025-06-16T16:00:00.000Z</published>
    <updated>2025-07-20T12:46:18.896Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€å¯¼è®º">ä¸€ã€å¯¼è®º</h2><h3 id="1-è®¡ç®—æœºç³»ç»Ÿçš„ç»„æˆéƒ¨åˆ†">1. è®¡ç®—æœºç³»ç»Ÿçš„ç»„æˆéƒ¨åˆ†</h3><p><img src="https://source.cclmsy.cc/posts/notes/course/operating_system/image.png" alt="alt text"></p><h3 id="2-æ“ä½œç³»ç»Ÿçš„æ¦‚å¿µ">2. æ“ä½œç³»ç»Ÿçš„æ¦‚å¿µ</h3><p>æ“ä½œç³»ç»Ÿ(OS)ä¹Ÿç§°å†…æ ¸(Kernel)ï¼Œæ˜¯ä¸€ç›´è¿è¡Œåœ¨è®¡ç®—æœºä¸Šçš„ç¨‹åºã€‚</p><p>å››å¤§ç‰¹å¾ï¼šå¹¶å‘ã€å…±äº«ã€è™šæ‹Ÿã€å¼‚æ­¥</p><p>ä½œç”¨(ç³»ç»Ÿè§†è§’)ï¼š</p><ul><li>èµ„æºåˆ†é…å™¨ï¼šä¸ºå„ç”¨æˆ·å’Œè¿›ç¨‹åˆ†é…èµ„æºï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡</li><li>æ§åˆ¶ç¨‹åºï¼šæ§åˆ¶å„ä¸ªè¿›ç¨‹çš„æ‰§è¡Œï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œ</li></ul><p>åŠŸèƒ½ï¼š</p><ol><li>è¿›ç¨‹ç®¡ç†ï¼šåˆ›å»ºã€åˆ é™¤ã€æŒ‚èµ·ã€é‡å¯è¿›ç¨‹ï¼›æä¾›è¿›ç¨‹åŒæ­¥æœºåˆ¶ã€è¿›ç¨‹é€šä¿¡æœºåˆ¶ã€æ­»é”å¤„ç†æœºåˆ¶</li><li>å†…å­˜ç®¡ç†ï¼šè®°å½•å†…å­˜åˆ†é…æƒ…å†µï¼›å†³å®šå“ªäº›è¿›ç¨‹å¯ä»¥è¿›å…¥å†…å­˜ï¼›æä¾›å†…å­˜åˆ†é…å’Œå›æ”¶æœºåˆ¶</li><li>å­˜å‚¨ç®¡ç†</li></ol><h3 id="3-å­˜å‚¨å±‚æ¬¡">3. å­˜å‚¨å±‚æ¬¡</h3><p>å¯„å­˜å™¨(Register)ã€<strong>é«˜é€Ÿç¼“å­˜(Cache)ã€å†…å­˜(Memory)</strong>ã€ç£ç›˜(Disk)ã€ç¡¬ç›˜ã€å…‰ç›˜ã€ç£å¸¦</p><ul><li>å†…å­˜ï¼šCPUå¯ç›´æ¥è®¿é—®çš„å”¯ä¸€å¤§å®¹é‡å­˜å‚¨åŒºåŸŸ</li><li>Cacheï¼šCPU-å†…å­˜å­˜å‚¨å±‚æ¬¡</li></ul><p>å±æ€§ï¼šå®¹é‡ã€é€Ÿåº¦ã€ä»·æ ¼ã€æ˜“å¤±æ€§</p><h3 id="4-å¤šé“ç¨‹åºè®¾è®¡">4. å¤šé“ç¨‹åºè®¾è®¡</h3><p>å¤šé“ç¨‹åºè®¾è®¡(Multiprogramming)æ˜¯æ“ä½œç³»ç»Ÿ<strong>æœ€é‡è¦çš„ç‰¹ç‚¹</strong>ï¼Œé€šè¿‡ç»„ç»‡ä½œä¸šä½¿CPUæ€»æœ‰ä¸€ä¸ªä½œä¸šå¯ä»¥æ‰§è¡Œã€‚</p><p>åœ¨å†…å­˜ä¸­åŒæ—¶å­˜æ”¾å¤šä¸ªç¨‹åºï¼Œä½¿å¾—CPUå¯ä»¥åœ¨ä¸€ä¸ªç¨‹åºç­‰å¾…I/Oæ“ä½œæ—¶ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªç¨‹åºæ‰§è¡Œï¼Œä»è€Œæé«˜CPUçš„åˆ©ç”¨ç‡ã€‚</p><h3 id="5-åŒé‡æ¨¡å¼å’Œç‰¹æƒæŒ‡ä»¤">5. åŒé‡æ¨¡å¼å’Œç‰¹æƒæŒ‡ä»¤</h3><p>åŒé‡æ¨¡å¼ï¼š</p><p>ä¸ºäº†åŒºåˆ†æ“ä½œç³»ç»Ÿä»£ç å’Œç”¨æˆ·ä»£ç æ‰§è¡Œï¼Œè‡³å°‘éœ€è¦ä¸¤ç§æ¨¡å¼ï¼š<strong>å†…æ ¸æ¨¡å¼</strong>ï¼ˆåˆç§°ç®¡ç†æ¨¡å¼ã€ç³»ç»Ÿæ¨¡å¼ã€ç‰¹æƒæ¨¡å¼ï¼‰å’Œ<strong>ç”¨æˆ·æ¨¡å¼</strong>ï¼Œé€šè¿‡æ¨¡å¼ä½ï¼ˆ0/1ï¼‰æ¥åŒºåˆ†ã€‚</p><p>å½“åº”ç”¨ç¨‹åºéœ€è¦æ“ä½œç³»ç»Ÿçš„æœåŠ¡æ—¶ï¼Œ<strong>å¿…é¡»</strong>ä»ç”¨æˆ·æ¨¡å¼åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼ã€‚</p><p>ç‰¹æƒæŒ‡ä»¤(Privileged Instructions)ï¼š</p><p>åªæœ‰åœ¨å†…æ ¸æ¨¡å¼ä¸‹æ‰èƒ½æ‰§è¡Œçš„æŒ‡ä»¤ã€‚</p><p>ç‰¹æƒæŒ‡ä»¤ï¼šåˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ã€I/Oæ§åˆ¶ç›¸å…³ã€è®¿é—®ç‰¹æ®Šå¯„å­˜å™¨çš„æŒ‡ä»¤ã€å®šæ—¶å™¨ç®¡ç†ã€ä¸­æ–­ç®¡ç†ã€å†…å­˜ç®¡ç†ï¼ˆå¦‚æ”¹å˜å†…å­˜åˆ†é…å›¾ï¼‰ã€è®¾ç½®æ—¶é’Ÿæ—¥æœŸç­‰</p><p>æ˜“æ··æ·†çš„éç‰¹æƒæŒ‡ä»¤ï¼š</p><ul><li>è®¿ç®¡æŒ‡ä»¤ï¼šç”±ç”¨æˆ·ç¨‹åºå‘èµ·çš„ä¸€ç§ç‰¹æ®ŠæŒ‡ä»¤ï¼Œç”¨äºè¯·æ±‚æ“ä½œç³»ç»Ÿæ‰§è¡ŒæŸäº›éœ€è¦ç‰¹æ®Šæƒé™æ‰èƒ½è®¿é—®çš„æ“ä½œï¼Œä¼šä»å†…æ ¸æ¨¡å¼åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼ï¼Œå°†æ§åˆ¶æƒäº¤ç»™æ“ä½œç³»ç»Ÿå†…æ ¸æ‰§è¡Œç›¸åº”æ“ä½œï¼Œç„¶åå†è¿”å›ç”¨æˆ·æ¨¡å¼</li><li>ä¸»æœºå’Œç£ç›˜é—´é€šè¿‡DMAä¼ é€æ•°æ®çš„æŒ‡ä»¤</li><li>æ”¹å˜ç£ç›˜ç©ºé—´åˆ†é…å›¾ï¼ˆåŒºåˆ«äºæ”¹å˜å†…å­˜åˆ†é…å›¾ï¼‰</li><li>å†™ç¨‹åºè®¡æ•°å™¨PCã€å¯„å­˜å™¨æ¸…0ã€å–æŒ‡ä»¤ã€å–æ“ä½œæ•°ã€å†™å†…å­˜</li></ul><h3 id="6-å®šæ—¶å™¨">6. å®šæ—¶å™¨</h3><p>å®šæ—¶å™¨(Timer)ç¡®ä¿æ“ä½œç³»ç»Ÿç»´æŒå¯¹CPUçš„æ§åˆ¶ï¼Œé˜²æ­¢ç”¨æˆ·ç¨‹åºï¼š</p><ol><li>é™·å…¥æ­»å¾ªç¯</li><li>ä¸è°ƒç”¨ç³»ç»ŸæœåŠ¡ï¼Œä½†ä¸å°†æ§åˆ¶è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿ</li></ol><p>æ“ä½œç³»ç»Ÿåœ¨å°†æ§åˆ¶æƒäº¤ç»™ç”¨æˆ·ä¹‹å‰ï¼Œåº”ç¡®ä¿è®¾ç½®å¥½å®šæ—¶å™¨ä»¥ä¾¿äº§ç”Ÿä¸­æ–­ã€‚</p><h2 id="äºŒã€æ“ä½œç³»ç»Ÿç»“æ„">äºŒã€æ“ä½œç³»ç»Ÿç»“æ„</h2><h3 id="1-æ“ä½œç³»ç»ŸæœåŠ¡">1. æ“ä½œç³»ç»ŸæœåŠ¡</h3><p>1~6æ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨ï¼›7~9æé«˜ç³»ç»Ÿæ•ˆç‡ã€‚</p><ol><li>ç”¨æˆ·ç•Œé¢(User Interface)ï¼šæä¾›ç”¨æˆ·ä¸æ“ä½œç³»ç»Ÿäº¤äº’çš„æ–¹å¼ã€‚</li><li>ç¨‹åºæ‰§è¡Œï¼šåŠ è½½ç¨‹åºåˆ°å†…å­˜å¹¶è¿è¡Œï¼Œèƒ½ç»“æŸæ‰§è¡Œï¼ˆä¸è®ºæ˜¯æ­£å¸¸è¿˜æ˜¯å¼‚å¸¸ï¼‰</li><li>I/Oæ“ä½œï¼šæä¾›å¯¹I/Oè®¾å¤‡çš„è®¿é—®å’Œæ§åˆ¶</li><li>æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼šåˆ›å»ºã€åˆ é™¤ã€è¯»å†™æ–‡ä»¶å’Œç›®å½•</li><li>é€šä¿¡ï¼šæä¾›è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œå¦‚ç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜ç­‰<ul><li>æ–¹å¼ï¼šå…±äº«å†…å­˜ã€æ¶ˆæ¯äº¤æ¢</li></ul></li><li>é”™è¯¯æ£€æµ‹ï¼šæ£€æµ‹å’Œå¤„ç†é”™è¯¯ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œ</li><li>èµ„æºåˆ†é…ï¼šä¸ºå„ä¸ªè¿›ç¨‹åˆ†é…CPUæ—¶é—´ã€å†…å­˜ç©ºé—´ã€I/Oè®¾å¤‡ç­‰èµ„æº</li><li>è®°è´¦ï¼šè®°å½•èµ„æºä½¿ç”¨ç±»å‹å’Œæ•°é‡</li><li>ä¿æŠ¤ä¸å®‰å…¨ï¼šç¡®ä¿ç³»ç»Ÿèµ„æºçš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®</li></ol><h3 id="2-å‘½ä»¤è§£é‡Šç¨‹åº">2. å‘½ä»¤è§£é‡Šç¨‹åº</h3><p>å‘½ä»¤è§£é‡Šç¨‹åº(Command Interpreter)ä¹Ÿè¢«ç§°ä¸ºå¤–å£³(Shell)ï¼Œç”¨äºè·å–å¹¶æ‰§è¡Œç”¨æˆ·çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ç¨‹åº/</p><ul><li>å‘½ä»¤è¡Œç•Œé¢(Command Line Interface, CLI)</li><li>å›¾å½¢ç”¨æˆ·ç•Œé¢(Graphical User Interface, GUI)</li><li>æ‰¹å¤„ç†(Batch)</li></ul><h3 id="3-ç³»ç»Ÿè°ƒç”¨ç±»å‹">3. ç³»ç»Ÿè°ƒç”¨ç±»å‹</h3><p>ç³»ç»Ÿè°ƒç”¨æ˜¯æ“ä½œç³»ç»Ÿæä¾›ç»™åº”ç”¨ç¨‹åºçš„å”¯ä¸€ç¨‹åºæ¥å£</p><p>ç±»å‹ï¼šè¿›ç¨‹æ§åˆ¶;æ–‡ä»¶ç®¡ç†;è®¾å¤‡ç®¡ç†;ä¿¡æ¯ç»´æŠ¤;é€šä¿¡ã€‚</p><h2 id="ä¸‰ã€è¿›ç¨‹-Process">ä¸‰ã€è¿›ç¨‹(Process)</h2><h3 id="1-è¿›ç¨‹">1. è¿›ç¨‹</h3><p>è¿›ç¨‹æ˜¯æ­£åœ¨æ‰§è¡Œçš„ç¨‹åºçš„å®ä¾‹ï¼ŒåŒ…æ‹¬ï¼šä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆæ®µã€å †ã€è¿›ç¨‹æ§åˆ¶å—(PCB)ã€‚</p><h4 id="è¿›ç¨‹æ§åˆ¶å—-PCB">è¿›ç¨‹æ§åˆ¶å—(PCB)</h4><p>è¿›ç¨‹å­˜åœ¨çš„å”¯ä¸€æ ‡è¯†ï¼ŒåŒ…å«ï¼š</p><ul><li>è¿›ç¨‹çŠ¶æ€(State)ï¼šæ–°çš„ã€è¿è¡Œã€ç­‰å¾…ã€å°±ç»ªã€ç»ˆæ­¢</li><li>ç¨‹åºè®¡æ•°å™¨(Program Counter, PC)ï¼šæŒ‡å‘ä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤</li><li>CPUå¯„å­˜å™¨(Registers)ï¼šä¿å­˜è¿›ç¨‹æ‰§è¡Œæ—¶çš„å¯„å­˜å™¨çŠ¶æ€</li><li>CPUè°ƒåº¦ä¿¡æ¯ï¼šè¿›ç¨‹ä¼˜å…ˆçº§ï¼Œè°ƒåº¦é˜Ÿåˆ—æŒ‡é’ˆç­‰</li><li>å†…å­˜ç®¡ç†ä¿¡æ¯ï¼šé¡µè¡¨ã€æ®µè¡¨ã€åŸºåœ°å€ç­‰</li><li>è®°è´¦ä¿¡æ¯ã€I/Oä¿¡æ¯</li></ul><h4 id="ä¸Šä¸‹æ–‡åˆ‡æ¢">ä¸Šä¸‹æ–‡åˆ‡æ¢</h4><p>ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šè¿›ç¨‹é—´åˆ‡æ¢çš„è¿‡ç¨‹ï¼Œä¿å­˜å½“å‰è¿›ç¨‹çš„çŠ¶æ€åˆ°PCB1ä¸­ï¼Œå¹¶ä»PCB2ä¸­æ¢å¤ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„çŠ¶æ€ã€‚</p><h3 id="2-è¿›ç¨‹çŠ¶æ€ä¸è½¬æ¢">2. è¿›ç¨‹çŠ¶æ€ä¸è½¬æ¢</h3><ul><li>æ–°çš„(new)ï¼šè¿›ç¨‹æ­£åœ¨åˆ›å»ºä¸­</li><li>è¿è¡Œ(running)ï¼šæŒ‡ä»¤æ­£åœ¨æ‰§è¡Œï¼ˆä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹å¯åœ¨ä¸€ä¸ªCPUä¸Šè¿è¡Œï¼‰</li><li>ç­‰å¾…(waiting)ï¼šè¿›ç¨‹æ­£åœ¨ç­‰å¾…æŸä¸ªäº‹ä»¶å‘ç”Ÿï¼ˆå¦‚I/Oæ“ä½œå®Œæˆã€æ”¶åˆ°ä¿¡å·ç­‰ï¼‰</li><li>å°±ç»ª(ready)ï¼šè¿›ç¨‹å·²å‡†å¤‡å¥½è¿è¡Œï¼Œç­‰å¾…åˆ†é…å¤„ç†å™¨</li><li>ç»ˆæ­¢(terminated)ï¼šè¿›ç¨‹å·²å®Œæˆæ‰§è¡Œ</li></ul><p><img src="https://source.cclmsy.cc/posts/notes/course/operating_system/image-1.png" alt="alt text"></p><ul><li>å› æ—¶é—´ç‰‡ç”¨å®Œæš‚åœï¼šè¿è¡Œ-&gt;å°±ç»ª</li><li>å› I/Oæ“ä½œæš‚åœï¼šè¿è¡Œ-&gt;ç­‰å¾…</li><li>è¿›ç¨‹æ‰“å°ç»“æŸï¼šç­‰å¾…-&gt;å°±ç»ª</li></ul><h3 id="3-è¿›ç¨‹è°ƒåº¦">3. è¿›ç¨‹è°ƒåº¦</h3><p>è°ƒåº¦é˜Ÿåˆ—ï¼š</p><ul><li>ä½œä¸šé˜Ÿåˆ—ï¼šç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹</li><li>å°±ç»ªé˜Ÿåˆ—ï¼šå¤„äºå°±ç»ªçŠ¶æ€ç­‰å¾…è¿è¡Œçš„è¿›ç¨‹</li><li>è®¾å¤‡é˜Ÿåˆ—ï¼šç­‰å¾…ç‰¹å®šI/Oè®¾å¤‡çš„è¿›ç¨‹</li></ul><p>è°ƒåº¦ç¨‹åºï¼š</p><ul><li>çŸ­æœŸè°ƒåº¦ï¼ˆCPUè°ƒåº¦ï¼‰ï¼šä»<strong>é˜Ÿåˆ—</strong>ä¸­é€‰æ‹©ä¸€ä¸ªè¿›ç¨‹å¹¶ä¸ºä¹‹åˆ†é…CPU<ul><li>å¿«é€Ÿæ‰§è¡Œï¼Œé¢‘ç¹å‘ç”Ÿï¼Œé€šå¸¸æ¯éš”å‡ æ¯«ç§’</li></ul></li><li>é•¿æœŸè°ƒåº¦ï¼ˆä½œä¸šè°ƒåº¦ï¼‰ï¼šä»<strong>ç£ç›˜ç¼“å†²æ± </strong>ä¸­é€‰æ‹©è¿›ç¨‹å¹¶å°†å…¶åŠ è½½åˆ°å†…å­˜ä»¥ä¾¿æ‰§è¡Œ<ul><li>æ§åˆ¶å¤šé“ç¨‹åºç¨‹åº¦ï¼ˆå†…å­˜ä¸­çš„è¿›ç¨‹æ•°ï¼‰</li><li>é€‰æ‹©è¿›ç¨‹ï¼šåˆç†æ­é…CPUå¯†é›†å‹å’ŒI/Oå¯†é›†å‹è¿›ç¨‹</li></ul></li><li>ä¸­æœŸè°ƒåº¦ï¼šå°†è¿›ç¨‹ä»<strong>å†…å­˜æˆ–CPUç«äº‰</strong>ä¸­ç§»å‡º<ul><li>é™ä½å¤šé“ç¨‹åºç¨‹åº¦</li></ul></li></ul><h3 id="4-è¿›ç¨‹åˆ›å»º-ç»ˆæ­¢">4. è¿›ç¨‹åˆ›å»º/ç»ˆæ­¢</h3><p>è¿›ç¨‹åˆ›å»ºï¼š<code>fork()</code>ã€<code>vfork()</code>ã€<code>clone()</code>ç­‰ç³»ç»Ÿè°ƒç”¨</p><ul><li>åˆ›å»ºæ–°è¿›ç¨‹æ—¶ï¼Œçˆ¶è¿›ç¨‹çš„æ‰€æœ‰èµ„æºï¼ˆä»£ç ã€æ•°æ®ã€å †æ ˆï¼‰éƒ½è¢«å¤åˆ¶åˆ°å­è¿›ç¨‹ä¸­</li><li>å­è¿›ç¨‹fork()è¿”å›å€¼ä¸º0ï¼Œçˆ¶è¿›ç¨‹è¿”å›å­è¿›ç¨‹çš„PID</li><li>å­è¿›ç¨‹æ‹¥æœ‰è‡ªå·±çš„PCBå’Œç‹¬ç«‹çš„åœ°å€ç©ºé—´</li></ul><p>è¿›ç¨‹ç»ˆæ­¢ï¼šæ­£å¸¸ç»“æŸ<code>exit()</code>ï¼›å¼‚å¸¸ç»“æŸ<code>abort()</code></p><p>çº§è”ç»ˆæ­¢ï¼šå½“çˆ¶è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œæ‰€æœ‰å­è¿›ç¨‹ä¹Ÿä¼šè¢«ç»ˆæ­¢</p><p>çˆ¶è¿›ç¨‹ç­‰å¾…ï¼š<code>wait()</code>ç³»ç»Ÿè°ƒç”¨</p><ul><li>æ³¨æ„ï¼šexec()ç³»åˆ—å‡½æ•°ä¼šç”¨æ–°ç¨‹åºæ›¿æ¢å½“å‰è¿›ç¨‹çš„ä»£ç æ®µã€æ•°æ®æ®µå’Œå †æ ˆæ®µï¼Œä½†ä¿ç•™PCBå’Œè¿›ç¨‹IDï¼Œä¸ä¼šåˆ›å»ºæ–°è¿›ç¨‹ã€‚</li></ul><h3 id="5-è¿›ç¨‹åä½œ-é€šä¿¡">5. è¿›ç¨‹åä½œ/é€šä¿¡</h3><p>å¦‚æœä¸€ä¸ªè¿›ç¨‹èƒ½å½±å“å…¶ä»–è¿›ç¨‹æˆ–è¢«å…¶ä»–è¿›ç¨‹å½±å“ï¼Œé‚£ä¹ˆè¯¥è¿›ç¨‹å°±æ˜¯<strong>åä½œ</strong>çš„ï¼Œå¦åˆ™å°±æ˜¯<strong>ç‹¬ç«‹</strong>çš„ã€‚</p><p>åä½œè¿›ç¨‹éœ€è¦ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼ˆInter-Process Communication, IPCï¼‰æ¥äº¤æ¢ä¿¡æ¯ï¼Œæœ‰2ç§åŸºæœ¬æ–¹å¼ï¼š</p><ul><li>å…±äº«å†…å­˜ï¼šå¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€å—å†…å­˜åŒºåŸŸ<ul><li>å¿«ï¼Œä»…åœ¨å»ºç«‹å…±äº«å†…å­˜æ—¶éœ€è¦ç³»ç»Ÿè°ƒç”¨</li></ul></li><li>æ¶ˆæ¯ä¼ é€’ï¼šé€šè¿‡å‘é€å’Œæ¥æ”¶æ¶ˆæ¯æ¥äº¤æ¢ä¿¡æ¯<ul><li>äº¤æ¢å°‘é‡æ•°æ®æ—¶æœ‰ç”¨ï¼Œæ— éœ€é¿å…å†²çª</li></ul></li></ul><p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”Ÿäº§è€…</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span>(((in+<span class="number">1</span>) % N) == out); <span class="comment">//ç­‰å¾…ç¼“å†²åŒºæœ‰ç©ºä½</span></span><br><span class="line">    buffer[in] = produce_item(); <span class="comment">//ç”Ÿäº§ä¸€ä¸ªé¡¹ç›®</span></span><br><span class="line">    in = (in + <span class="number">1</span>) % N; <span class="comment">//æ›´æ–°è¾“å…¥æŒ‡é’ˆ</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ¶ˆè´¹è€…</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (in == out); <span class="comment">//ç­‰å¾…ç¼“å†²åŒºæœ‰é¡¹ç›®</span></span><br><span class="line">    consume_item(buffer[out]); <span class="comment">//æ¶ˆè´¹ä¸€ä¸ªé¡¹ç›®</span></span><br><span class="line">    out = (out + <span class="number">1</span>) % N; <span class="comment">//æ›´æ–°è¾“å‡ºæŒ‡é’ˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å››ã€çº¿ç¨‹-Thread">å››ã€çº¿ç¨‹(Thread)</h2><h3 id="1-çº¿ç¨‹">1. çº¿ç¨‹</h3><p>çº¿ç¨‹æ˜¯CPUå¤„ç†çš„åŸºæœ¬å•ä½ï¼Œç”±ï¼šçº¿ç¨‹IDã€ç¨‹åºè®¡æ•°å™¨ã€å¯„å­˜å™¨é›†åˆå’Œæ ˆç»„æˆ</p><h3 id="2-çº¿ç¨‹ä¸è¿›ç¨‹">2. çº¿ç¨‹ä¸è¿›ç¨‹</h3><p>è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿåˆ†é…èµ„æºçš„åŸºæœ¬å•ä½ï¼Œè€Œçº¿ç¨‹æ˜¯CPUå¤„ç†çš„åŸºæœ¬å•ä½</p><p>åŒä¸€è¿›ç¨‹ çš„ ä¸åŒçº¿ç¨‹ ä¹‹é—´<strong>å…±äº«ä»£ç æ®µã€æ•°æ®æ®µã€æ–‡ä»¶</strong>ç­‰ï¼Œ<strong>ç§æœ‰å¯„å­˜å™¨å’Œæ ˆ</strong>ã€‚</p><h3 id="3-å¤šçº¿ç¨‹çš„ä¼˜ç‚¹">3. å¤šçº¿ç¨‹çš„ä¼˜ç‚¹</h3><ol><li>å“åº”åº¦é«˜ï¼šå³ä½¿éƒ¨åˆ†é˜»å¡æˆ–æ‰§è¡Œå†—é•¿æ“ä½œï¼Œä»ç„¶å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œå¢åŠ å¯¹ç”¨æˆ·çš„å“åº”ç¨‹åº¦</li><li>èµ„æºå…±äº«ï¼šè¿›ç¨‹åªèƒ½é€šè¿‡ï¼ˆå…±äº«å†…å­˜ã€æ¶ˆæ¯ä¼ é€’ï¼‰ç­‰æ–¹å¼å…±äº«èµ„æºï¼Œè€Œçº¿ç¨‹é»˜è®¤å…è®¸å…±äº«å†…å­˜å’Œèµ„æº</li><li>ç»æµï¼šè¿›ç¨‹åˆ›å»ºæ‰€éœ€çš„å†…å­˜å’Œèµ„æºåˆ†é…é«˜ï¼Œçº¿ç¨‹å…±äº«èµ„æºï¼Œåˆ›å»ºå’Œåˆ‡æ¢å¼€é”€å°</li><li>å¯ä¼¸ç¼©æ€§ï¼šå¤šçº¿ç¨‹ç¨‹åºå¯ä»¥æ›´å¥½åœ°åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„å¹¶è¡Œå¤„ç†èƒ½åŠ›</li></ol><h3 id="4-ç”¨æˆ·çº¿ç¨‹å’Œå†…æ ¸çº¿ç¨‹">4. ç”¨æˆ·çº¿ç¨‹å’Œå†…æ ¸çº¿ç¨‹</h3><p>ç”¨æˆ·çº¿ç¨‹åœ¨å†…æ ¸ä¹‹ä¸Šæ”¯æŒï¼Œå¹¶é€šè¿‡ç”¨æˆ·çº§çº¿ç¨‹åº“æ¥å®ç°ã€‚<br>çº¿ç¨‹åº“æä¾›å¯¹ç”¨æˆ·çº¿ç¨‹çš„åˆ›å»ºã€è°ƒåº¦å’Œç®¡ç†çš„æ”¯æŒï¼Œè€Œæ— éœ€å†…æ ¸æ”¯æŒã€‚</p><p>ä¸‰ç§åŸºæœ¬çš„ç”¨æˆ·çº§çº¿ç¨‹åº“ï¼šPOSIX Pthreadsã€Win32 Threadsã€Java Threadsã€‚</p><p>å†…æ ¸ç”±æ“ä½œç³»ç»Ÿç›´æ¥æ”¯æŒï¼Œå†…æ ¸åœ¨å…¶ç©ºé—´å†…æ‰§è¡Œå†…æ ¸çº¿ç¨‹çš„åˆ›å»ºã€è°ƒåº¦å’Œç®¡ç†ã€‚</p><p>å®ä¾‹ï¼šWindows XP/2000ã€Solarisã€Linuxç­‰æ“ä½œç³»ç»Ÿéƒ½æ”¯æŒå†…æ ¸çº¿ç¨‹ã€‚</p><p>å¤šçº¿ç¨‹æ¨¡å‹ï¼šç”¨æˆ·çº¿ç¨‹å’Œå†…æ ¸çº¿ç¨‹çš„æ˜ å°„å…³ç³»ï¼ˆ1:1ã€M:1ã€M:Nï¼‰</p><h2 id="äº”ã€è¿›ç¨‹è°ƒåº¦">äº”ã€è¿›ç¨‹è°ƒåº¦</h2><h3 id="1-åŸºæœ¬æ¦‚å¿µ">1. åŸºæœ¬æ¦‚å¿µ</h3><h4 id="1-1-CPU-I-Oæ‰§è¡Œå‘¨æœŸ">1.1 CPU-I/Oæ‰§è¡Œå‘¨æœŸ</h4><p>è¿›ç¨‹æ‰§è¡ŒåŒ…æ‹¬å‘¨æœŸåœ°äº¤æ›¿è¿›è¡Œï¼šCPUæ‰§è¡Œå’ŒI/Oç­‰å¾…</p><p>çŸ­CPUåŒºé—´å‡ºç°çš„é¢‘ç‡è¾ƒé«˜ï¼Œé•¿CPUåŒºé—´åˆ™å¾ˆå°‘ã€‚<br>I/Oä¸ºä¸»çš„ç¨‹åºé€šå¸¸çŸ­CPUåŒºé—´å¾ˆå¤šï¼Œè€ŒCPUä¸ºä¸»çš„ç¨‹åºå¯èƒ½æœ‰å°‘é‡çš„é•¿CPUåŒºé—´ã€‚</p><h4 id="1-2-CPUè°ƒåº¦ç¨‹åº">1.2 CPUè°ƒåº¦ç¨‹åº</h4><p>å½“CPUå˜ä¸ºç©ºé—²æ—¶ï¼Œæ“ä½œç³»ç»Ÿå°±å¿…é¡»ä»å°±ç»ªé˜Ÿåˆ—ä¸­é€‰æ‹©ä¸€ä¸ªè¿›ç¨‹æ¥æ‰§è¡Œã€‚<br>è¿›ç¨‹çš„é€‰æ‹©ç”±çŸ­æœŸè°ƒåº¦ç¨‹åºï¼ˆShort-term scheduler,æˆ–CPUè°ƒåº¦ç¨‹åºï¼‰æ‰§è¡Œã€‚</p><p>å½“å‡ºç°ä¸‹é¢ä»»ä½•æƒ…å½¢ä¹‹ä¸€æ—¶ï¼Œéœ€è¦CPUè°ƒåº¦ï¼š</p><ol><li>è¿›ç¨‹ä»è¿è¡ŒçŠ¶æ€è½¬å…¥ç­‰å¾…çŠ¶æ€ï¼ˆI/Oè¯·æ±‚ï¼‰</li><li>è¿›ç¨‹ä»è¿è¡ŒçŠ¶æ€è½¬å…¥å°±ç»ªçŠ¶æ€ï¼ˆå‡ºç°ä¸­æ–­ï¼‰</li><li>è¿›ç¨‹ä»ç­‰å¾…çŠ¶æ€è½¬å…¥å°±ç»ªçŠ¶æ€ï¼ˆI/Oå®Œæˆï¼‰</li><li>è¿›ç¨‹ç»ˆæ­¢</li></ol><p>å¦‚æœè°ƒåº¦åªå‘ç”Ÿåœ¨1,4æƒ…å½¢ï¼Œåˆ™ç§°ä¸ºéæŠ¢å å¼è°ƒåº¦ï¼›<br>å¦‚æœåœ¨2,3æƒ…å½¢å‘ç”Ÿè°ƒåº¦ï¼Œåˆ™ç§°ä¸ºæŠ¢å å¼è°ƒåº¦ã€‚</p><h4 id="1-3-è°ƒåº¦ç¨‹åº-åˆ†æ´¾ç¨‹åº">1.3 è°ƒåº¦ç¨‹åº/åˆ†æ´¾ç¨‹åº</h4><p>è°ƒåº¦ç¨‹åºï¼ˆDispatcherï¼Œåˆç§°åˆ†æ´¾ç¨‹åºï¼‰æ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œç”¨æ¥å°†CPUæ§åˆ¶æƒäº¤ç»™çŸ­æœŸè°ƒåº¦ç¨‹åºé€‰æ‹©çš„è¿›ç¨‹ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š</p><ol><li>åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼šä¿å­˜å½“å‰è¿›ç¨‹çš„çŠ¶æ€ï¼Œå¹¶åŠ è½½æ–°è¿›ç¨‹çš„çŠ¶æ€</li><li>åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼</li><li>è·³è½¬åˆ°ç”¨æˆ·ç¨‹åºçš„åˆé€‚ä½ç½®ï¼Œä»¥ä¾¿é‡æ–°å¯åŠ¨ç¨‹åº</li></ol><p>æ¯æ¬¡è¿›ç¨‹åˆ‡æ¢éƒ½éœ€è¦ä½¿ç”¨è°ƒåº¦ç¨‹åºï¼Œé€Ÿåº¦åº”å°½å¯èƒ½å¿«ã€‚</p><p>è°ƒåº¦å»¶è¿Ÿ/åˆ†æ´¾å»¶è¿Ÿï¼šåœæ­¢ä¸€ä¸ªè¿›ç¨‹è€Œå¯åŠ¨å¦ä¸€ä¸ªè¿›ç¨‹æ‰€éœ€çš„æ—¶é—´ã€‚</p><h3 id="2-è°ƒåº¦å‡†åˆ™">2. è°ƒåº¦å‡†åˆ™</h3><ul><li>æœ€å¤§åŒ–ï¼šCPUåˆ©ç”¨ç‡ã€ååé‡</li><li>æœ€å°åŒ–ï¼š<ul><li>å¹³å‡å‘¨è½¬æ—¶é—´ï¼šä»è¿›ç¨‹æäº¤åˆ°è¿›ç¨‹å®Œæˆçš„æ—¶é—´</li><li>å¹³å‡ç­‰å¾…æ—¶é—´ï¼šç¨‹åœ¨å°±ç»ªé˜Ÿåˆ—ä¸­ç­‰å¾…æ‰€èŠ±çš„æ—¶é—´ï¼Œå¹³å‡ç­‰å¾…æ—¶é—´=å¹³å‡å‘¨è½¬æ—¶é—´-å¹³å‡æ‰§è¡Œæ—¶é—´</li><li>å¹³å‡å“åº”æ—¶é—´ï¼šä»è¿›ç¨‹æäº¤åˆ°è¿›ç¨‹ç¬¬ä¸€æ¬¡å¼€å§‹æ‰§è¡Œçš„æ—¶é—´</li></ul></li></ul><h3 id="3-è°ƒåº¦ç®—æ³•">3. è°ƒåº¦ç®—æ³•</h3><ul><li>éæŠ¢å å¼ï¼šä¸€æ—¦è¿›ç¨‹å¼€å§‹æ‰§è¡Œï¼Œé™¤éå®ƒå®Œæˆï¼Œå¦åˆ™ä¸ä¼šè¢«æŠ¢å </li><li>æŠ¢å å¼ï¼šå¦‚æœä¸€ä¸ªæ–°åˆ°è¾¾çš„è¿›ç¨‹æ»¡è¶³æŠ¢å æ¡ä»¶ï¼Œåˆ™æŠ¢å å½“å‰è¿›ç¨‹</li></ul><h4 id="3-1-å…ˆåˆ°å…ˆæœåŠ¡ï¼ˆFCFSï¼‰">3.1 å…ˆåˆ°å…ˆæœåŠ¡ï¼ˆFCFSï¼‰</h4><p>å…ˆåˆ°å…ˆæœåŠ¡ï¼ˆFirst-Come, First-Served, FCFSï¼‰æ˜¯æœ€ç®€å•çš„è°ƒåº¦ç®—æ³•ã€‚</p><p>æŒ‰ç…§è¿›ç¨‹åˆ°è¾¾å°±ç»ªé˜Ÿåˆ—çš„é¡ºåºè¿›è¡Œè°ƒåº¦ã€‚</p><p>é—®é¢˜ï¼šæŠ¤èˆªæ•ˆåº”ï¼šé•¿è¿›ç¨‹å¯èƒ½ä¼šé˜»å¡çŸ­è¿›ç¨‹ï¼Œå¯¼è‡´å¹³å‡ç­‰å¾…æ—¶é—´å¢åŠ ã€‚</p><h4 id="3-2-æœ€çŸ­ä½œä¸šä¼˜å…ˆ">3.2 æœ€çŸ­ä½œä¸šä¼˜å…ˆ</h4><p>æœ€çŸ­ä½œä¸šä¼˜å…ˆï¼ˆShortest Job First, SJFï¼‰ï¼Œæ˜¯æœ€ä½³çš„è°ƒåº¦ç®—æ³•ä¹‹ä¸€ã€‚</p><p>åŸºäºè¿›ç¨‹æ‰§è¡Œæ—¶é—´çš„è°ƒåº¦ç®—æ³•ï¼Œé€‰æ‹©é¢„è®¡æ‰§è¡Œæ—¶é—´æœ€çŸ­çš„è¿›ç¨‹è¿›è¡Œè°ƒåº¦ã€‚</p><p>åˆ†ä¸ºéæŠ¢å å¼ï¼ˆæœ€çŸ­ä½œä¸šä¼˜å…ˆSJFï¼‰å’ŒæŠ¢å å¼ï¼ˆæœ€çŸ­å‰©ä½™æ—¶é—´è°ƒåº¦SRTFï¼‰</p><p>SJFç®—æ³•æ˜¯æœ€ä½³çš„ï¼Œä½†æ˜¯å®ƒä¸èƒ½åœ¨çŸ­æœŸCPUè°ƒåº¦çš„å±‚æ¬¡ä¸Šå®ç°ï¼Œå› ä¸ºæ²¡æœ‰åŠæ³•çŸ¥é“ä¸‹ä¸€ä¸ªCPUè¯·æ±‚çš„é•¿åº¦ã€‚</p><p>é—®é¢˜ï¼šé¥¥é¥¿ç°è±¡/æ— ç©·é˜»å¡ï¼šé•¿è¿›ç¨‹å¯èƒ½æ°¸è¿œå¾—ä¸åˆ°æ‰§è¡Œã€‚</p><h4 id="3-3-ä¼˜å…ˆçº§è°ƒåº¦">3.3 ä¼˜å…ˆçº§è°ƒåº¦</h4><p>ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆPriority Schedulingï¼‰ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œè°ƒåº¦æ—¶é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„è¿›ç¨‹ã€‚</p><p>åˆ†ä¸ºéæŠ¢å å¼å’ŒæŠ¢å å¼ã€‚</p><p>SJFç®—æ³•æ˜¯é€šç”¨ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œåªä¸è¿‡SJFç®—æ³•çš„ä¼˜å…ˆçº§æ˜¯é€šè¿‡é¢„æµ‹CPUåŒºé—´çš„é•¿çŸ­æ¥å®ç°çš„ã€‚</p><p>é—®é¢˜ï¼šé¥¥é¥¿ç°è±¡/æ— ç©·é˜»å¡</p><p>è§£å†³åŠæ³•ï¼šè€åŒ–ï¼šé€æ¸å¢å¤§åœ¨ç³»ç»Ÿä¸­ç­‰å¾…å¾ˆé•¿æ—¶é—´çš„è¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚</p><h4 id="3-4-è½®è½¬è°ƒåº¦ï¼ˆRRï¼‰">3.4 è½®è½¬è°ƒåº¦ï¼ˆRRï¼‰</h4><p>è½®è½¬è°ƒåº¦ï¼ˆRound Robin, RRï¼‰æ˜¯æœ€å¸¸ç”¨çš„æŠ¢å å¼è°ƒåº¦ç®—æ³•ã€‚</p><p>å°†ä¸€ä¸ªè¾ƒå°çš„æ—¶é—´å•å…ƒå®šä¹‰ä¸ºæ—¶é—´ç‰‡ï¼ˆTime Quantumï¼‰ï¼Œæ¯ä¸ªè¿›ç¨‹åœ¨æ—¶é—´ç‰‡å†…æ‰§è¡Œã€‚</p><p>å¦‚æœæ—¶é—´ç‰‡ç”¨å®Œï¼Œè¿›ç¨‹è¢«æŠ¢å å¹¶æ”¾å›å°±ç»ªé˜Ÿåˆ—çš„æœ«å°¾ã€‚</p><p>ä¼˜ç‚¹ï¼šå“åº”æ—¶é—´å°ã€ä¸ä¼šå‡ºç°æŠ¤èˆªæ•ˆåº”å’Œé¥¥é¥¿ç°è±¡ã€‚</p><p>RRä¾èµ–äºæ—¶é—´ç‰‡å¤§å°ï¼Œè¿‡å¤§åˆ™å’ŒFCFSç›¸åŒï¼Œè¿‡å°åˆ™ä¼šå¯¼è‡´é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢</p><p>æ³¨ï¼šè€ƒè¯•ä¸­æ—¶é—´ç‰‡é»˜è®¤ä¸º2s</p><h4 id="3-5-å¤šçº§é˜Ÿåˆ—è°ƒåº¦">3.5 å¤šçº§é˜Ÿåˆ—è°ƒåº¦</h4><p>å°†å°±ç»ªé˜Ÿåˆ—åˆ’åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹é˜Ÿåˆ—ï¼Œæ ¹æ®è¿›ç¨‹çš„æŸäº›å±æ€§åˆ†é…åˆ°ä¸åŒé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—æœ‰è‡ªå·±çš„è°ƒåº¦ç®—æ³•ã€‚</p><p>é˜Ÿåˆ—ä¹‹é—´ä¹Ÿéœ€è¦ä¼˜å…ˆçº§ï¼Œå¯ä»¥æ˜¯å›ºå®šä¼˜å…ˆçº§æˆ–åˆ’åˆ†æ—¶é—´ç‰‡</p><h4 id="3-6-å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦">3.6 å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦</h4><p>æ ¹æ®ä¸åŒCPUåŒºé—´ç‰¹ç‚¹ä»¥åŒºåˆ†è¿›ç¨‹ï¼Œå…è®¸è¿›ç¨‹åœ¨é˜Ÿåˆ—ä¹‹é—´ç§»åŠ¨ã€‚</p><p>å¦‚æœè¿›ç¨‹ä½¿ç”¨è¿‡å¤šçš„CPUæ—¶é—´ï¼Œé‚£ä¹ˆå®ƒä¼šè¢«ç§»åˆ°æ›´ä½ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œè¿™ä¸€æ–¹æ¡ˆä¼šå°†I/Oä¸ºä¸»å’Œäº¤äº’å¼è¿›ç¨‹ç•™åœ¨è¾ƒé«˜ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚</p><p>åœ¨è¾ƒä½ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­ç­‰å¾…è¿‡é•¿çš„è¿›ç¨‹ä¼šè¢«è½¬ç§»åˆ°è¾ƒé«˜ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œè¿™ç§å½¢å¼çš„è€åŒ–èƒ½å¤Ÿé˜»æ­¢é¥¥é¥¿çš„å‘ç”Ÿã€‚</p><h3 id="4-è°ƒåº¦ç®—æ³•è®¡ç®—é¢˜">4. è°ƒåº¦ç®—æ³•è®¡ç®—é¢˜</h3><table><thead><tr><th style="text-align:center">è¿›ç¨‹</th><th style="text-align:center">åˆ°è¾¾æ—¶é—´</th><th style="text-align:center">æ‰§è¡Œæ—¶é—´</th><th style="text-align:center">ä¼˜å…ˆçº§</th></tr></thead><tbody><tr><td style="text-align:center">P1</td><td style="text-align:center">0</td><td style="text-align:center">10</td><td style="text-align:center">2</td></tr><tr><td style="text-align:center">P2</td><td style="text-align:center">1</td><td style="text-align:center">4</td><td style="text-align:center">5</td></tr><tr><td style="text-align:center">P3</td><td style="text-align:center">2</td><td style="text-align:center">9</td><td style="text-align:center">3</td></tr><tr><td style="text-align:center">P4</td><td style="text-align:center">3</td><td style="text-align:center">5</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">P5</td><td style="text-align:center">4</td><td style="text-align:center">2</td><td style="text-align:center">4</td></tr></tbody></table><h4 id="4-1-FCFSè°ƒåº¦">4.1 FCFSè°ƒåº¦</h4><p>ç”˜ç‰¹å›¾ï¼š</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| <span class="type">P1</span> | <span class="type">P2</span> | <span class="type">P3</span> | <span class="type">P4</span> | <span class="type">P5</span> |</span><br><span class="line"><span class="type">0</span>    <span class="number">10</span>   <span class="number">14</span>   <span class="number">23</span>   <span class="number">28</span>   <span class="number">30</span> </span><br></pre></td></tr></table></figure><ul><li>å¹³å‡ç­‰å¾…æ—¶é—´ï¼š$(0+(10-1)+(14-2)+(23-3)+(28-4))\div 5 = 13$</li><li>å¹³å‡å‘¨è½¬æ—¶é—´ï¼š$(10+(14-1)+(23-2)+(28-3)+(30-4))\div 5 = 19$</li><li>å¹³å‡å“åº”æ—¶é—´=å¹³å‡ç­‰å¾…æ—¶é—´</li></ul><h4 id="4-2-SJFè°ƒåº¦">4.2 SJFè°ƒåº¦</h4><p>ç”±äºP1å…ˆåˆ°ï¼Œæ‰€ä»¥P1å…ˆæ‰§è¡Œï¼ŒéæŠ¢å å¼</p><p>ç”˜ç‰¹å›¾ï¼š</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| <span class="type">P1</span> | <span class="type">P5</span> | <span class="type">P2</span> | <span class="type">P4</span> | <span class="type">P3</span> |</span><br><span class="line"><span class="type">0</span>    <span class="number">10</span>   <span class="number">12</span>   <span class="number">16</span>   <span class="number">21</span>   <span class="number">30</span></span><br></pre></td></tr></table></figure><ul><li>å¹³å‡ç­‰å¾…æ—¶é—´ï¼š$(0+(12-1)+(21-2)+(16-3)+(10-4))\div 5 = 9.8$</li><li>å¹³å‡å‘¨è½¬æ—¶é—´ï¼š$(10+(16-1)+(30-2)+(21-3)+(12-4))\div 5 = 15.8$</li><li>å¹³å‡å“åº”æ—¶é—´=å¹³å‡ç­‰å¾…æ—¶é—´</li></ul><h4 id="4-3-SRTFè°ƒåº¦">4.3 SRTFè°ƒåº¦</h4><p>ç”˜ç‰¹å›¾ï¼š</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| <span class="type">P1</span> | <span class="type">P2</span> | <span class="type">P5</span> | <span class="type">P4</span> | <span class="type">P1</span> | <span class="type">P3</span> |</span><br><span class="line"><span class="type">0</span>    <span class="number">1</span>    <span class="number">5</span>    <span class="number">7</span>    <span class="number">12</span>   <span class="number">21</span>   <span class="number">30</span></span><br></pre></td></tr></table></figure><ul><li>å¹³å‡ç­‰å¾…æ—¶é—´ï¼š$((0+(12-1))+(1-1)+(21-2)+(7-3)+(5-4))\div 5 = 7$</li><li>å¹³å‡å‘¨è½¬æ—¶é—´ï¼š$(21+(5-1)+(30-2)+(12-3)+(7-4))\div 5 = 13$</li><li>å¹³å‡å“åº”æ—¶é—´ï¼š$(0+(1-1)+(21-2)+(7-3)+(5-4))\div 5 = 4.8$</li></ul><h4 id="4-4-ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆéæŠ¢å å¼ï¼‰">4.4 ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆéæŠ¢å å¼ï¼‰</h4><p>ç”±äºP1å…ˆåˆ°ï¼Œæ‰€ä»¥P1å…ˆæ‰§è¡Œï¼ŒéæŠ¢å å¼</p><p>ç”˜ç‰¹å›¾ï¼š</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| <span class="type">P1</span> | <span class="type">P4</span> | <span class="type">P3</span> | <span class="type">P5</span> | <span class="type">P2</span> |</span><br><span class="line"><span class="type">0</span>    <span class="number">10</span>   <span class="number">15</span>   <span class="number">24</span>   <span class="number">26</span>   <span class="number">30</span></span><br></pre></td></tr></table></figure><ul><li>å¹³å‡ç­‰å¾…æ—¶é—´ï¼š$(0+(24-1)+(15-2)+(10-3)+(26-4))\div 5 = 13$</li><li>å¹³å‡å‘¨è½¬æ—¶é—´ï¼š$(10+(30-1)+(26-2)+(15-3)+(24-4))\div 5 = 19$</li><li>å¹³å‡å“åº”æ—¶é—´=å¹³å‡ç­‰å¾…æ—¶é—´</li></ul><h4 id="4-5-ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆæŠ¢å å¼ï¼‰">4.5 ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆæŠ¢å å¼ï¼‰</h4><p>ç”˜ç‰¹å›¾ï¼š</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| <span class="type">P1</span> | <span class="type">P4</span> | <span class="type">P1</span> | <span class="type">P3</span> | <span class="type">P5</span> | <span class="type">P2</span> |</span><br><span class="line"><span class="type">0</span>    <span class="number">3</span>    <span class="number">8</span>    <span class="number">15</span>   <span class="number">24</span>   <span class="number">26</span>   <span class="number">30</span></span><br></pre></td></tr></table></figure><ul><li>å¹³å‡ç­‰å¾…æ—¶é—´ï¼š$((0+(8-3))+(26-1)+(15-2)+(4-3)+(24-4))\div 5 = 12.6$</li><li>å¹³å‡å‘¨è½¬æ—¶é—´ï¼š$(15+(30-1)+(24-2)+(8-3)+(26-4))\div 5 = 18.6$</li><li>å¹³å‡å“åº”æ—¶é—´ï¼š$(0+(26-1)+(15-2)+(4-3)+(24-4))\div 5 = 11.6$</li></ul><h4 id="4-6-è½®è½¬è°ƒåº¦ï¼ˆRRï¼‰">4.6 è½®è½¬è°ƒåº¦ï¼ˆRRï¼‰</h4><p>å‡è®¾æ—¶é—´ç‰‡ä¸º2sï¼Œè¿›ç¨‹åˆ°è¾¾å…¥é˜Ÿ ä¼˜å…ˆäº æ—¶é—´ç‰‡åˆ°å…¥é˜Ÿ</p><p>è¿è¡Œæµç¨‹</p><table><thead><tr><th style="text-align:center">æ—¶é—´</th><th style="text-align:center">CPUæ‰§è¡Œ</th><th style="text-align:center">å°±ç»ªé˜Ÿåˆ—</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center">0</td><td style="text-align:center">P1(0/10)</td><td style="text-align:center">[]</td><td style="text-align:center">P1åˆ°è¾¾ï¼ŒP1æ‰§è¡Œ</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">P1(1/10)</td><td style="text-align:center">[P2(0/4) ]</td><td style="text-align:center">P2åˆ°è¾¾ï¼ŒP1ç»§ç»­æ‰§è¡Œ</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">P2(0/4)</td><td style="text-align:center">[P3(0/9), P1(2/10)]</td><td style="text-align:center">P3åˆ°è¾¾ï¼ŒP1æ—¶é—´ç‰‡åˆ°ï¼ŒP2æ‰§è¡Œ</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">P2(1/4)</td><td style="text-align:center">[P3(0/9), P1(2/10), P4(0/5)]</td><td style="text-align:center">P4åˆ°è¾¾ï¼ŒP2ç»§ç»­æ‰§è¡Œ</td></tr><tr><td style="text-align:center">4</td><td style="text-align:center">P3(0/9)</td><td style="text-align:center">[P1(2/10), P4(0/5), P5(0/2), P2(2/4)]</td><td style="text-align:center">P5åˆ°è¾¾ï¼ŒP2æ—¶é—´ç‰‡åˆ°ï¼ŒP3æ‰§è¡Œ</td></tr><tr><td style="text-align:center">6</td><td style="text-align:center">P1(2/10)</td><td style="text-align:center">[P4(0/5), P5(0/2), P2(2/4), P3(2/9)]</td><td style="text-align:center">P3æ—¶é—´ç‰‡åˆ°ï¼ŒP1æ‰§è¡Œ</td></tr><tr><td style="text-align:center">8</td><td style="text-align:center">P4(0/5)</td><td style="text-align:center">[P5(0/2), P2(2/4), P3(2/9), P1(4/10)]</td><td style="text-align:center">P1æ—¶é—´ç‰‡åˆ°ï¼ŒP4æ‰§è¡Œ</td></tr><tr><td style="text-align:center">10</td><td style="text-align:center">P5(0/2)</td><td style="text-align:center">[P2(2/4), P3(2/9), P1(4/10), P4(2/5)]</td><td style="text-align:center">P4æ—¶é—´ç‰‡åˆ°ï¼ŒP5æ‰§è¡Œ</td></tr><tr><td style="text-align:center">12</td><td style="text-align:center">P2(2/4)</td><td style="text-align:center">[P3(2/9), P1(4/10), P4(2/5)]</td><td style="text-align:center">P5å®Œæˆï¼ŒP2æ‰§è¡Œ</td></tr><tr><td style="text-align:center">14</td><td style="text-align:center">P3(2/9)</td><td style="text-align:center">[P1(4/10), P4(2/5)]</td><td style="text-align:center">P2å®Œæˆï¼ŒP3æ‰§è¡Œ</td></tr><tr><td style="text-align:center">16</td><td style="text-align:center">P1(4/10)</td><td style="text-align:center">[P4(2/5), P3(4/9)]</td><td style="text-align:center">P3æ—¶é—´ç‰‡åˆ°ï¼ŒP1æ‰§è¡Œ</td></tr><tr><td style="text-align:center">18</td><td style="text-align:center">P4(2/5)</td><td style="text-align:center">[P3(4/9), P1(6/10)]</td><td style="text-align:center">P1æ—¶é—´ç‰‡åˆ°ï¼ŒP4æ‰§è¡Œ</td></tr><tr><td style="text-align:center">20</td><td style="text-align:center">P3(4/9)</td><td style="text-align:center">[P1(6/10), P4(4/5)]</td><td style="text-align:center">P4æ—¶é—´ç‰‡åˆ°ï¼ŒP3æ‰§è¡Œ</td></tr><tr><td style="text-align:center">22</td><td style="text-align:center">P1(6/10)</td><td style="text-align:center">[P4(4/5), P3(6/9)]</td><td style="text-align:center">P3æ—¶é—´ç‰‡åˆ°ï¼ŒP1æ‰§è¡Œ</td></tr><tr><td style="text-align:center">24</td><td style="text-align:center">P4(4/5)</td><td style="text-align:center">[P3(6/9), P1(8/10)]</td><td style="text-align:center">P1æ—¶é—´ç‰‡åˆ°ï¼ŒP4æ‰§è¡Œ</td></tr><tr><td style="text-align:center">25</td><td style="text-align:center">P3(6/9)</td><td style="text-align:center">[P1(8/10) ]</td><td style="text-align:center">P4å®Œæˆï¼ŒP3æ‰§è¡Œ</td></tr><tr><td style="text-align:center">27</td><td style="text-align:center">P1(8/10)</td><td style="text-align:center">[P3(8/9) ]</td><td style="text-align:center">P3æ—¶é—´ç‰‡åˆ°ï¼ŒP1æ‰§è¡Œ</td></tr><tr><td style="text-align:center">29</td><td style="text-align:center">P3(8/9)</td><td style="text-align:center">[]</td><td style="text-align:center">P1å®Œæˆï¼ŒP3æ‰§è¡Œ</td></tr><tr><td style="text-align:center">30</td><td style="text-align:center">P3(9/9)</td><td style="text-align:center">[]</td><td style="text-align:center">P3å®Œæˆï¼Œæ‰€æœ‰è¿›ç¨‹æ‰§è¡Œå®Œæ¯•</td></tr></tbody></table><p>ç”˜ç‰¹å›¾ï¼š</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| <span class="type">P1</span> | <span class="type">P2</span> | <span class="type">P3</span> | <span class="type">P1</span> | <span class="type">P4</span> | <span class="type">P5</span> | <span class="type">P2</span> | <span class="type">P3</span> | <span class="type">P1</span> | <span class="type">P4</span> | <span class="type">P3</span> | <span class="type">P1</span> | <span class="type">P4</span> | <span class="type">P3</span> | <span class="type">P1</span> | <span class="type">P3</span> |</span><br><span class="line"><span class="type">0</span>    <span class="number">2</span>    <span class="number">4</span>    <span class="number">6</span>    <span class="number">8</span>    <span class="number">10</span>   <span class="number">12</span>   <span class="number">14</span>   <span class="number">16</span>   <span class="number">18</span>   <span class="number">20</span>   <span class="number">22</span>   <span class="number">24</span>   <span class="number">25</span>   <span class="number">27</span>   <span class="number">29</span>   <span class="number">30</span></span><br></pre></td></tr></table></figure><ul><li>å¹³å‡ç­‰å¾…æ—¶é—´=å‘¨è½¬æ—¶é—´-æ‰§è¡Œæ—¶é—´=$((29-0-10)+(14-1-4)+(30-2-9)+(23-3-5)+(25-4-2))/5=14$</li><li>å¹³å‡å‘¨è½¬æ—¶é—´=$(29+(14-1)+(30-2)+(23-3)+(25-4))/5=20$</li><li>å¹³å‡å“åº”æ—¶é—´=$(0+(2-1)+(4-2)+(8-3)+(10-4))/5=2.8$</li></ul><h2 id="å…­ã€è¿›ç¨‹åŒæ­¥">å…­ã€è¿›ç¨‹åŒæ­¥</h2><h3 id="1-ç«äº‰æ¡ä»¶">1. ç«äº‰æ¡ä»¶</h3><p>å¤šä¸ªè¿›ç¨‹å¹¶å‘è®¿é—®å’Œæ“ä½œåŒä¸€æ•°æ®æ—¶ï¼Œæ‰§è¡Œç»“æœå’Œè®¿é—®å‘ç”Ÿçš„ç‰¹å®šé¡ºåºæœ‰å…³ï¼Œè¿™ç§æƒ…å†µç§°ä¸ºç«äº‰æ¡ä»¶ã€‚</p><p>ä¾‹å¦‚ï¼šèµ‹å€¼è¯­å¥å’Œè‡ªå¢è¯­å¥</p><h3 id="2-ä¸´ç•ŒåŒºé—®é¢˜">2. ä¸´ç•ŒåŒºé—®é¢˜</h3><p>ä¸´ç•ŒåŒº(Critical Section)ï¼šå¹¶å‘è¿‡ç¨‹ä¸­å¯èƒ½è®¿é—®/ä¿®æ”¹å…±äº«æ•°æ®çš„ä»£ç æ®µã€‚</p><p>ä¸´ç•ŒåŒºé—®é¢˜ï¼šç¡®ä¿åœ¨ä»»ä½•æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥è¿›å…¥ä¸´ç•ŒåŒºã€‚</p><p>è§£å†³ä¸´ç•ŒåŒºé—®é¢˜å¿…é¡»æ»¡è¶³çš„3ä¸ªæ¡ä»¶ï¼š</p><ol><li>äº’æ–¥ï¼šè¿›ç¨‹åœ¨ä¸´ç•ŒåŒºï¼Œå…¶ä»–è¿›ç¨‹ä¸èƒ½è¿›å…¥ä¸´ç•ŒåŒº</li><li>å‰è¿›ï¼šæ²¡æœ‰è¿›ç¨‹åœ¨ä¸´ç•ŒåŒºï¼Œå…è®¸å…¶ä»–è¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œä¸èƒ½æ— é™ç­‰å¾…</li><li>æœ‰é™ç­‰å¾…ï¼šä»ä¸€ä¸ªè¿›ç¨‹ä½œå‡ºè¿›å…¥ä¸´ç•ŒåŒºçš„è¯·æ±‚åˆ°è¯¥è¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒºä¹‹é—´ï¼Œå…¶ä»–è¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒºçš„è¯·æ±‚ä¸ªæ•°æœ‰é™</li></ol><p>å¿™åˆ™ç­‰å¾…ï¼›ç©ºåˆ™è®©è¿›ï¼›ç­‰åˆ™æœ‰é™ï¼›ç­‰åˆ™è®©æƒ</p><h3 id="3-Petersonç®—æ³•">3. Petersonç®—æ³•</h3><p>é€‚ç”¨äºä¸¤ä¸ªè¿›ç¨‹çš„ä¸´ç•ŒåŒºé—®é¢˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> flag[<span class="number">2</span>] = &#123;<span class="number">0</span>, <span class="number">0</span>&#125;; <span class="comment">// è¡¨ç¤ºå“ªä¸ªè¿›ç¨‹æƒ³è¦è¿›å…¥ä¸´ç•ŒåŒº,é»˜è®¤ä¸ºfalse</span></span><br><span class="line"><span class="type">int</span> turn; <span class="comment">// è¡¨ç¤ºå½“å‰è½®åˆ°å“ªä¸ªè¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒº</span></span><br><span class="line"><span class="comment">// P0</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    flag[<span class="number">0</span>] = <span class="number">1</span>; <span class="comment">// è¡¨ç¤ºè¿›ç¨‹0æƒ³è¿›å…¥ä¸´ç•ŒåŒº</span></span><br><span class="line">    turn = <span class="number">1</span>; <span class="comment">// è®©è¿›ç¨‹1å…ˆè¿›å…¥ä¸´ç•ŒåŒºï¼ˆç­‰åˆ™è®©æƒï¼‰</span></span><br><span class="line">    <span class="keyword">while</span>(flag[<span class="number">1</span>] &amp;&amp; turn == <span class="number">1</span>); <span class="comment">// ç­‰å¾…è¿›ç¨‹1é€€å‡ºä¸´ç•ŒåŒº</span></span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒºä»£ç </span></span><br><span class="line">    flag[<span class="number">0</span>] = <span class="number">0</span>; <span class="comment">// é€€å‡ºä¸´ç•ŒåŒº</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// P1</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    flag[<span class="number">1</span>] = <span class="number">1</span>; <span class="comment">// è¡¨ç¤ºè¿›ç¨‹1æƒ³è¿›å…¥ä¸´ç•ŒåŒº</span></span><br><span class="line">    turn = <span class="number">0</span>; <span class="comment">// è®©è¿›ç¨‹0å…ˆè¿›å…¥ä¸´ç•ŒåŒº</span></span><br><span class="line">    <span class="keyword">while</span>(flag[<span class="number">0</span>] &amp;&amp; turn == <span class="number">0</span>); <span class="comment">// ç­‰å¾…è¿›ç¨‹0é€€å‡ºä¸´ç•ŒåŒº</span></span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒºä»£ç </span></span><br><span class="line">    flag[<span class="number">1</span>] = <span class="number">0</span>; <span class="comment">// é€€å‡ºä¸´ç•ŒåŒº</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-ç¡¬ä»¶åŒæ­¥">4. ç¡¬ä»¶åŒæ­¥</h3><p>è®¸å¤šç³»ç»Ÿä¸ºè§£å†³ä¸´ç•ŒåŒºé—®é¢˜æä¾›äº†ç¡¬ä»¶æ”¯æŒ</p><ol><li>ä¿®æ”¹å…±äº«å˜é‡ç¦æ­¢ä¸­æ–­<ul><li>æ­£åœ¨è¿è¡Œçš„æŒ‡ä»¤ä¸è¢«å…¶ä»–æŒ‡ä»¤æŠ¢å CPU</li><li>é€‚ç”¨äºå•å¤„ç†å™¨ç¯å¢ƒï¼ŒéæŠ¢å å†…æ ¸ï¼ˆä¸å…è®¸å†…æ ¸æ¨¡å¼è¿›ç¨‹è¢«æŠ¢å ï¼ŒåŒæ—¶åˆ»åªæœ‰ä¸€ä¸ªå†…æ ¸æ¨¡å¼è¿›ç¨‹ï¼‰</li></ul></li><li>ä½¿ç”¨åŸå­æ“ä½œï¼šä¸èƒ½è¢«ä¸­æ–­çš„åŸå­æŒ‡ä»¤</li></ol><h3 id="5-ä¿¡å·é‡-Semaphore">5. ä¿¡å·é‡(Semaphore)</h3><p>ä¿¡å·é‡æ˜¯ä¸€ç§ä¸éœ€è¦å¿™ç­‰çš„è¿›ç¨‹åŒæ­¥æœºåˆ¶ï¼ˆç©ºåˆ™è®©è¿›ï¼‰ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªæ•´æ•°å˜é‡ã€‚</p><p>é™¤åˆå§‹åŒ–å¤–ï¼Œåªèƒ½é€šè¿‡ä¸¤ä¸ªåŸå­æ“ä½œæ¥ä¿®æ”¹ï¼šPï¼ˆwaitï¼‰å’ŒVï¼ˆsignalï¼‰ã€‚</p><ul><li>Pæ“ä½œï¼šå¦‚æœä¿¡å·é‡å€¼å¤§äº0ï¼Œåˆ™å°†å…¶å‡1å¹¶ç»§ç»­æ‰§è¡Œï¼›å¦‚æœä¿¡å·é‡å€¼ä¸º0ï¼Œåˆ™é˜»å¡è¿›ç¨‹ï¼Œç›´åˆ°ä¿¡å·é‡å€¼å¤§äº0ã€‚</li><li>Væ“ä½œï¼šå°†ä¿¡å·é‡å€¼åŠ 1ï¼Œå¦‚æœæœ‰è¿›ç¨‹åœ¨ç­‰å¾…ï¼Œåˆ™å”¤é†’ä¸€ä¸ªç­‰å¾…çš„è¿›ç¨‹ã€‚</li></ul><p>ä¿¡å·é‡åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š</p><ol><li>äºŒè¿›åˆ¶ä¿¡å·é‡ï¼ˆBinary Semaphoreï¼‰ï¼šå€¼åªèƒ½ä¸º0æˆ–1ï¼Œé€šå¸¸ç”¨äºäº’æ–¥è®¿é—®ä¸´ç•ŒåŒºï¼Œåˆè¢«ç§°ä¸ºäº’æ–¥é”ï¼ˆMutexï¼‰ã€‚</li><li>è®¡æ•°ä¿¡å·é‡ï¼ˆCounting Semaphoreï¼‰ï¼šå€¼å¯ä»¥ä¸ºä»»æ„éè´Ÿæ•´æ•°ï¼Œé€šå¸¸ç”¨äºæ§åˆ¶å¯¹æœ‰é™èµ„æºçš„è®¿é—®ã€‚</li></ol><p>å®ç°æ–¹æ¡ˆï¼šå¿™ç­‰å®ç°ï¼ˆS&gt;=0ï¼‰å’Œé˜»å¡å®ç°ï¼ˆSå¯ä»¥ä¸ºè´Ÿæ•°ï¼Œç»å¯¹å€¼è¡¨ç¤ºç­‰å¾…çš„è¿›ç¨‹æ•°ï¼‰ã€‚</p><p>å¿™ç­‰å®ç°-è‡ªæ—‹é”(Spinlock)ï¼š</p><ul><li>å½“ä¸€ä¸ªè¿›ç¨‹ä½äºå…¶ä¸´ç•ŒåŒºæ—¶ï¼Œå…¶å®ƒä»»ä½•è¯•å›¾è¿›å…¥ä¸´ç•ŒåŒºçš„è¿›ç¨‹éƒ½å¿…é¡»åœ¨å…¶è¿›å…¥åŒºçš„ä»£ç ä¸­è¿ç»­å¾ªç¯</li><li>ä¸ç”¨é˜»å¡è¿›ç¨‹ã€ä¸å¿…ä¸Šä¸‹æ–‡åˆ‡æ¢</li><li>ä¸´ç•ŒåŒºä»£ç çŸ­æ—¶æ•ˆç‡é«˜</li><li>é€‚åˆå¤šå¤„ç†å™¨ç¯å¢ƒï¼ˆå•å¤„ç†å™¨å¯ä»¥é€šè¿‡ç®€å•çš„ç¦æ­¢ä¸­æ–­å®ç°waitå’Œsignalçš„åŸå­æ‰§è¡Œï¼‰</li><li>å•å¤„ç†å™¨ç³»ç»Ÿå¿™ç­‰æ—¶ä¸ä¼šé‡Šæ”¾CPUï¼Œä¹Ÿæ²¡æœ‰å…¶ä»–è¿›ç¨‹èƒ½å¤Ÿè¿è¡Œä»¥è·å¾—CPUæ§åˆ¶æƒ</li></ul><h3 id="6-æ­»é”å’Œé¥¥é¥¿">6. æ­»é”å’Œé¥¥é¥¿</h3><p>æ­»é”ï¼ˆDeadlockï¼‰ï¼šä¸¤ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æºï¼Œå¯¼è‡´æ‰€æœ‰è¿›ç¨‹éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œã€‚</p><p>é¥¥é¥¿ï¼ˆStarvationï¼‰ï¼šè¿›ç¨‹æ— é™ç­‰å¾…ä¿¡å·é‡ã€‚å¯¹ä¿¡å·é‡æœ‰å…³çš„é“¾è¡¨LIFOé¡ºåºå¢åˆ è¿›ç¨‹å¯èƒ½å¯¼è‡´ã€‚</p><h3 id="7-ç»å…¸åŒæ­¥é—®é¢˜">7. ç»å…¸åŒæ­¥é—®é¢˜</h3><h4 id="7-1-å­˜åœ¨å…ˆåå…³ç³»çš„ç®€å•åŒæ­¥é—®é¢˜">7.1 å­˜åœ¨å…ˆåå…³ç³»çš„ç®€å•åŒæ­¥é—®é¢˜</h4><p>å°†ä¸åŒè¿›ç¨‹é—´çš„ä»£ç å—çš„æ‰§è¡Œé¡ºåºè§†ä¸ºDAGï¼Œè¿›è¡Œæ‹“æ‰‘æ’åºï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/course/operating_system/image-2.png" alt="alt text"></p><p>è®°ä¿¡å·é‡<code>Sij</code>è¡¨ç¤ºè¿›ç¨‹<code>j</code>ç­‰å¾…è¿›ç¨‹<code>i</code>çš„ä¿¡å·é‡ï¼ˆè¿›ç¨‹<code>i</code>æ‰§è¡Œå®Œåæ‰èƒ½æ‰§è¡Œè¿›ç¨‹<code>j</code>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// P1</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    wait(S21);</span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒº1ä»£ç </span></span><br><span class="line">    signal(S15);</span><br><span class="line"></span><br><span class="line">    wait(S54);</span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒº4ä»£ç </span></span><br><span class="line">    signal(S47);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// P2</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="comment">// ä»£ç å—2</span></span><br><span class="line">    signal(S21);</span><br><span class="line">    </span><br><span class="line">    wait(S15);</span><br><span class="line">    wait(S35);</span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒº5ä»£ç </span></span><br><span class="line">    signal(S54);</span><br><span class="line">    signal(S56);</span><br><span class="line"></span><br><span class="line">    wait(S47);</span><br><span class="line">    wait(S67);</span><br><span class="line">    <span class="comment">// ä»£ç å—7</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// P3ç•¥</span></span><br></pre></td></tr></table></figure><h4 id="7-2-ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜">7.2 ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜</h4><p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜æ˜¯ç»å…¸çš„è¿›ç¨‹åŒæ­¥é—®é¢˜ï¼Œæ¶‰åŠåˆ°ä¸¤ä¸ªè¿›ç¨‹ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚</p><p>ç”Ÿäº§è€…è¿›ç¨‹ç”Ÿæˆæ•°æ®å¹¶å°†å…¶æ”¾å…¥ç¼“å†²åŒºï¼Œæ¶ˆè´¹è€…è¿›ç¨‹ä»ç¼“å†²åŒºä¸­å–å‡ºæ•°æ®è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”Ÿäº§è€…</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    wait(empty); <span class="comment">// ç­‰å¾…ç¼“å†²åŒºæœ‰ç©ºä½</span></span><br><span class="line"></span><br><span class="line">    wait(mutex); <span class="comment">// è¿›å…¥ä¸´ç•ŒåŒº</span></span><br><span class="line">    buffer[in] = produce_item(); <span class="comment">// ç”Ÿäº§ä¸€ä¸ªé¡¹ç›®</span></span><br><span class="line">    in = (in + <span class="number">1</span>) % N; <span class="comment">// æ›´æ–°è¾“å…¥æŒ‡é’ˆ</span></span><br><span class="line">    signal(mutex); <span class="comment">// ç¦»å¼€ä¸´ç•ŒåŒº</span></span><br><span class="line"></span><br><span class="line">    signal(full); <span class="comment">// å¢åŠ ç¼“å†²åŒºæ»¡çš„è®¡æ•°</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ¶ˆè´¹è€…</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    wait(full); <span class="comment">// ç­‰å¾…ç¼“å†²åŒºæœ‰é¡¹ç›®</span></span><br><span class="line"></span><br><span class="line">    wait(mutex); <span class="comment">// è¿›å…¥ä¸´ç•ŒåŒº</span></span><br><span class="line">    consume_item(buffer[out]); <span class="comment">// æ¶ˆè´¹ä¸€ä¸ªé¡¹ç›®</span></span><br><span class="line">    out = (out + <span class="number">1</span>) % N; <span class="comment">// æ›´æ–°è¾“å‡ºæŒ‡é’ˆ</span></span><br><span class="line">    signal(mutex); <span class="comment">// ç¦»å¼€ä¸´ç•ŒåŒº</span></span><br><span class="line"></span><br><span class="line">    signal(empty); <span class="comment">// å¢åŠ ç¼“å†²åŒºç©ºçš„è®¡æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7-3-è¯»è€…-å†™è€…é—®é¢˜">7.3 è¯»è€…-å†™è€…é—®é¢˜</h4><p>è¯»è€…-å†™è€…é—®é¢˜æ˜¯ç»å…¸çš„è¿›ç¨‹åŒæ­¥é—®é¢˜ï¼Œæ¶‰åŠåˆ°å¤šä¸ªè¯»è€…å’Œä¸€ä¸ªå†™è€…ã€‚</p><ul><li>è¯»è€…ï¼šå¹¶å‘è¯»å–æ•°æ®ï¼Œä¸ä¿®æ”¹æ•°æ®</li><li>å†™è€…ï¼šç‹¬å è®¿é—®æ•°æ®ï¼Œä¿®æ”¹æ•°æ®</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»è€…</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    wait(read_mutex); <span class="comment">// è¿›å…¥è¯»è€…ä¸´ç•ŒåŒº</span></span><br><span class="line">    read_count++; <span class="comment">// å¢åŠ è¯»è€…è®¡æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (read_count == <span class="number">1</span>) wait(write_mutex); <span class="comment">// ç¬¬ä¸€ä¸ªè¯»è€…é˜»å¡å†™è€…</span></span><br><span class="line">    signal(read_mutex); <span class="comment">// ç¦»å¼€è¯»è€…ä¸´ç•ŒåŒº</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æ•°æ®</span></span><br><span class="line">    read_data();</span><br><span class="line"></span><br><span class="line">    wait(read_mutex); <span class="comment">// è¿›å…¥è¯»è€…ä¸´ç•ŒåŒº</span></span><br><span class="line">    read_count--; <span class="comment">// å‡å°‘è¯»è€…è®¡æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (read_count == <span class="number">0</span>) signal(write_mutex); <span class="comment">// æœ€åä¸€ä¸ªè¯»è€…é‡Šæ”¾å†™è€…</span></span><br><span class="line">    signal(read_mutex); <span class="comment">// ç¦»å¼€è¯»è€…ä¸´ç•ŒåŒº</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å†™è€…</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    wait(write_mutex); <span class="comment">// è¿›å…¥å†™è€…ä¸´ç•ŒåŒº</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥æ•°æ®</span></span><br><span class="line">    write_data();</span><br><span class="line"></span><br><span class="line">    signal(write_mutex); <span class="comment">// ç¦»å¼€å†™è€…ä¸´ç•ŒåŒº</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥çš„ï¼š</p><ul><li>è¯»è€…ä¼˜å…ˆï¼šç›´åˆ°æ— è¯»è€…ç­‰å¾…ï¼Œå†™è€…æ‰èƒ½è¿›å…¥ä¸´ç•ŒåŒº</li><li>å†™è€…ä¼˜å…ˆï¼šæœ‰å†™è€…ç­‰å¾…æ—¶ï¼Œè¯»è€…ä¸èƒ½è¿›å…¥ä¸´ç•ŒåŒº</li></ul><h4 id="7-4-å“²å­¦å®¶å°±é¤é—®é¢˜">7.4 å“²å­¦å®¶å°±é¤é—®é¢˜</h4><p>å“²å­¦å®¶å°±é¤é—®é¢˜æ˜¯ç»å…¸çš„è¿›ç¨‹åŒæ­¥é—®é¢˜ï¼Œæ¶‰åŠåˆ°5ä¸ªå“²å­¦å®¶å’Œ5ä¸ªå‰å­ã€‚</p><p>å¦‚æœæ‰€æœ‰å“²å­¦å®¶éƒ½æ‹¿èµ·å·¦è¾¹çš„å‰å­ï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿæ­»é”ã€‚</p><p>è§£å†³æ€è·¯ï¼š</p><ol><li>å½“4ä¸ªå‰å­è¢«æ‹¿èµ·æ—¶ï¼Œæ²¡æœ‰å‰å­çš„å“²å­¦å®¶ä¸èƒ½æ‹¿èµ·å‰å­</li><li>ä»»ä¸€å“²å­¦å®¶æ‹¿èµ·ä¸¤ä¸ªå‰å­å‰æ—¶ï¼Œå…¶ä»–å“²å­¦å®¶ä¸èƒ½æ‹¿èµ·å‰å­</li><li>â€¦</li></ol><h2 id="ä¸ƒã€æ­»é”-Deadlock">ä¸ƒã€æ­»é”(Deadlock)</h2><h3 id="1-æ­»é”çš„4ä¸ªå¿…è¦æ¡ä»¶">1. æ­»é”çš„4ä¸ªå¿…è¦æ¡ä»¶</h3><ol><li>äº’æ–¥ï¼šè‡³å°‘æœ‰ä¸€ä¸ªèµ„æºä¸èƒ½å…±äº«</li><li>å æœ‰å¹¶ç­‰å¾…ï¼šä¸€ä¸ªè¿›ç¨‹è‡³å°‘æŒæœ‰ä¸€ä¸ªèµ„æºï¼Œå¹¶ç­‰å¾…å…¶ä»–èµ„æºï¼ˆè¢«å…¶ä»–è¿›ç¨‹æŒæœ‰ï¼‰</li><li>éæŠ¢å ï¼šèµ„æºä¸èƒ½è¢«æŠ¢å ï¼Œåªèƒ½ç”±æŒæœ‰è¯¥èµ„æºçš„è¿›ç¨‹é‡Šæ”¾</li><li>å¾ªç¯ç­‰å¾…ï¼šå­˜åœ¨ä¸€ä¸ªè¿›ç¨‹ç­‰å¾…ç¯ï¼Œå…¶ä¸­æ¯ä¸ªè¿›ç¨‹éƒ½åœ¨ç­‰å¾…ä¸‹ä¸€ä¸ªè¿›ç¨‹æŒæœ‰çš„èµ„æº</li></ol><p>å¿…é¡»åŒæ—¶æ»¡è¶³è¿™å››ä¸ªæ¡ä»¶æ‰èƒ½å‘ç”Ÿæ­»é”ã€‚</p><h4 id="ä¾‹é¢˜">ä¾‹é¢˜</h4><p>å‡è®¾æœ‰4ä¸ªç›¸åŒç±»å‹çš„èµ„æºè¢«3ä¸ªè¿›ç¨‹å…±äº«ï¼Œæ¯ä¸ªè¿›ç¨‹æœ€å¤šéœ€è¦2ä¸ªèµ„æºï¼Œè¯•è¯æ˜è¿™ä¸ªç³»ç»Ÿä¸ä¼šæ­»é”ã€‚</p><p>åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œå³ä½¿æ‰€æœ‰è¿›ç¨‹éƒ½æŒæœ‰æœ€å¤§â€œä¸å®Œå…¨â€èµ„æºï¼ˆæ¯ä¸ªè¿›ç¨‹1ä¸ªèµ„æºï¼‰ï¼Œç³»ç»Ÿä¸­ä¹Ÿæ€»ä¼šå‰©ä¸‹è‡³å°‘1ä¸ªèµ„æºã€‚è¿™ä¸ªå‰©ä½™çš„èµ„æºè¶³ä»¥è®©å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹è·å¾—å¹¶å®Œæˆä»»åŠ¡ï¼Œç„¶åé‡Šæ”¾å…¶å æœ‰çš„èµ„æºã€‚</p><p>éšç€èµ„æºçš„é‡Šæ”¾ï¼Œå…¶ä»–è¢«é˜»å¡çš„è¿›ç¨‹ä¹Ÿèƒ½ä¾æ¬¡è·å¾—èµ„æºå¹¶å®Œæˆä»»åŠ¡ã€‚</p><p>å› æ­¤ï¼Œç³»ç»Ÿæ°¸è¿œä¸ä¼šè¿›å…¥æ‰€æœ‰è¿›ç¨‹éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œçš„æ­»é”çŠ¶æ€ã€‚</p><h3 id="2-èµ„æºåˆ†é…å›¾">2. èµ„æºåˆ†é…å›¾</h3><p>æ–¹å½¢Rè¡¨ç¤ºèµ„æºï¼Œå†…éƒ¨ç‚¹ä¸ªæ•°è¡¨ç¤ºèµ„æºæ•°é‡ï¼›åœ†å½¢Pè¡¨ç¤ºè¿›ç¨‹ã€‚</p><ul><li>P-&gt;Rï¼šè¡¨ç¤ºè¿›ç¨‹Pè¯·æ±‚èµ„æºR</li><li>R-&gt;Pï¼šè¡¨ç¤ºèµ„æºRè¢«è¿›ç¨‹På ç”¨</li></ul><p><img src="https://source.cclmsy.cc/posts/notes/course/operating_system/image-3.png" alt="alt text"></p><p>æ­»é”åˆ¤æ–­ï¼š</p><ol><li>æ ¹æ®èµ„æºRçš„å‡ºè¾¹ï¼Œåˆ’æ‰å·²è¢«åˆ†é…çš„èµ„æº</li><li>æ‰¾åˆ°ä¸€ä¸ªè¿›ç¨‹Pï¼Œå…¶æ‰€æœ‰è¯·æ±‚ï¼ˆå‡ºè¾¹ï¼‰éƒ½å¯è¢«æ»¡è¶³</li><li>é‡Šæ”¾è¿›ç¨‹På ç”¨çš„èµ„æºRï¼Œå¹¶å°†å…¶è¾¹ä»å›¾ä¸­åˆ é™¤</li><li>é‡å¤æ­¥éª¤2å’Œ3ï¼Œç›´åˆ°æ²¡æœ‰è¿›ç¨‹æ»¡è¶³æ¡ä»¶æˆ–æ‰€æœ‰è¿›ç¨‹éƒ½è¢«é‡Šæ”¾</li></ol><h3 id="3-æ­»é”çš„é¢„é˜²">3. æ­»é”çš„é¢„é˜²</h3><p>å¦å®šæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ä¹‹ä¸€ï¼š</p><ol><li>äº’æ–¥ï¼šéå…±äº«èµ„æºå¿…é¡»è¦æœ‰äº’æ–¥æ¡ä»¶ï¼Œä¸èƒ½å¦å®š</li><li>å æœ‰å¹¶ç­‰å¾…ï¼šé™ä½èµ„æºåˆ©ç”¨ç‡ï¼Œå¹¶ä¸”å¯èƒ½å¯¼è‡´é¥¥é¥¿<ol><li>æ‰§è¡Œå‰å¿…é¡»ç”³è¯·åˆ°æ‰€æœ‰èµ„æº</li><li>ç”³è¯·æ–°èµ„æºå‰å¿…é¡»é‡Šæ”¾æ‰€æœ‰å·²å æœ‰çš„èµ„æº</li></ol></li><li>éæŠ¢å ï¼šä½¿ç”¨èŒƒå›´æœ‰é™ï¼Œåªèƒ½ç”¨äºå¯ä¿å­˜å’Œæ¢å¤çš„èµ„æºï¼ˆå¯„å­˜å™¨ã€å†…å­˜ç­‰ï¼‰<ol><li>å¦‚æœä¸€ä¸ªè¿›ç¨‹ç”³è¯·çš„èµ„æºä¸èƒ½ç«‹åˆ»åˆ†é…ï¼Œå·²åˆ†é…èµ„æºå¯è¢«æŠ¢å </li></ol></li><li>å¾ªç¯ç­‰å¾…ï¼šå¯¹æ‰€æœ‰èµ„æºçš„ç±»å‹è¿›è¡Œå®Œå…¨æ’åºï¼Œè¦æ±‚æ¯ä¸ªè¿›ç¨‹æŒ‰é€’å¢é¡ºåºç”³è¯·èµ„æº</li></ol><h3 id="4-æ­»é”çš„é¿å…">4. æ­»é”çš„é¿å…</h3><p>å®‰å…¨çŠ¶æ€ï¼šå­˜åœ¨ä¸€ç§é¡ºåºä¸ºæ‰€æœ‰è¿›ç¨‹åˆ†é…èµ„æºï¼Œèƒ½å¤Ÿé¿å…æ­»é”</p><h4 id="4-1-èµ„æºåˆ†é…å›¾ç®—æ³•">4.1 èµ„æºåˆ†é…å›¾ç®—æ³•</h4><p>[èµ„æºåˆ†é…å›¾]ç®—æ³•(#2-èµ„æºåˆ†é…å›¾)é€‚ç”¨äºæ¯ç§èµ„æºç±»å‹åªæœ‰ä¸€ä¸ªå®ä¾‹çš„æƒ…å†µï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯æ£€æµ‹å›¾ä¸­æ˜¯å¦å­˜åœ¨ç¯è·¯ã€‚</p><p>ç®—æ³•æœºåˆ¶ï¼š</p><ol><li>é™¤ç”³è¯·è¾¹å’Œåˆ†é…è¾¹å¤–ï¼Œå¼•å…¥ä¸€ç§æ–°ç±»å‹çš„è¾¹ï¼Œç§°ä¸ºéœ€æ±‚è¾¹ã€‚<ul><li>éœ€æ±‚è¾¹Pi-&gt;Rj è¡¨ç¤ºè¿›ç¨‹Piå¯èƒ½åœ¨å°†æ¥æŸä¸ªæ—¶å€™ç”³è¯·èµ„æºRjã€‚</li><li>éœ€æ±‚è¾¹ç±»ä¼¼äºç”³è¯·è¾¹ï¼Œä½†ç”¨è™šçº¿è¡¨ç¤ºã€‚</li></ul></li><li>å½“è¿›ç¨‹ç”³è¯·èµ„æºæ—¶ï¼Œéœ€æ±‚è¾¹å˜æˆç”³è¯·è¾¹ã€‚</li><li>å½“èµ„æºåˆ†é…ç»™è¿›ç¨‹æ—¶ï¼Œç”³è¯·è¾¹å˜æˆåˆ†é…è¾¹ã€‚</li><li>å½“è¿›ç¨‹é‡Šæ”¾èµ„æºæ—¶ï¼Œåˆ†é…è¾¹å˜æˆéœ€æ±‚è¾¹ã€‚</li><li>ç³»ç»Ÿå¿…é¡»äº‹å…ˆè¦æ±‚èµ„æºï¼Œå³å½“è¿›ç¨‹Piå¼€å§‹æ‰§è¡Œæ—¶ï¼Œæ‰€æœ‰éœ€æ±‚è¾¹å¿…é¡»å¤„äºèµ„æºåˆ†é…å›¾ã€‚</li></ol><p>å‡è®¾è¿›ç¨‹Piç”³è¯·èµ„æºRjï¼Œåªæœ‰åœ¨å°†ç”³è¯·è¾¹Pi-&gt;Rjå˜æˆåˆ†é…è¾¹Rj-&gt;Piï¼Œä¸”ä¸ä¼šå¯¼è‡´èµ„æºåˆ†é…å›¾å½¢æˆç¯æ—¶æ‰å…è®¸ç”³è¯·ã€‚</p><h4 id="4-2-é“¶è¡Œå®¶ç®—æ³•">4.2 é“¶è¡Œå®¶ç®—æ³•</h4><p>é€‚ç”¨äºæ¯ç§èµ„æºç±»å‹æœ‰å¤šä¸ªå®ä¾‹çš„æƒ…å†µã€‚</p><p>å½“è¿›ç¨‹ç”³è¯·ä¸€ç»„èµ„æºæ—¶ï¼Œç³»ç»Ÿå¿…é¡»ç¡®å®šåˆ†é…è¿™äº›èµ„æºåç³»ç»Ÿæ˜¯å¦ä»å¤„äºå®‰å…¨çŠ¶æ€ã€‚<br>å¦‚æœæ˜¯ï¼Œå°±åˆ†é…èµ„æºï¼Œå¦åˆ™ï¼Œè¿›ç¨‹å¿…é¡»ç­‰å¾…ç›´åˆ°å…¶ä»–è¿›ç¨‹é‡Šæ”¾è¶³å¤Ÿçš„èµ„æºã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é“¶è¡Œå®¶ç®—æ³•</span></span><br><span class="line"><span class="type">int</span> n,m; <span class="comment">// nä¸ºè¿›ç¨‹æ•°ï¼Œmä¸ºèµ„æºç§ç±»æ•°</span></span><br><span class="line"><span class="type">int</span> available[m]; <span class="comment">// å¯ç”¨èµ„æºå‘é‡</span></span><br><span class="line"><span class="type">int</span> max[n][m]; <span class="comment">// æœ€å¤§éœ€æ±‚çŸ©é˜µ</span></span><br><span class="line"><span class="type">int</span> allocation[n][m]; <span class="comment">// å½“å‰åˆ†é…çŸ©é˜µ</span></span><br><span class="line"><span class="type">int</span> need[n][m]; <span class="comment">// éœ€æ±‚çŸ©é˜µï¼Œneed[i][j] = max[i][j] - allocation[i][j]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®‰å…¨æ€§æ£€æŸ¥ </span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">is_safe</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> work = available; <span class="comment">// å¯ç”¨èµ„æºå‘é‡</span></span><br><span class="line">    <span class="keyword">auto</span> finish = <span class="built_in">vector</span>&lt;<span class="type">bool</span>&gt;(n, <span class="literal">false</span>); <span class="comment">// è¿›ç¨‹å®Œæˆæ ‡å¿—</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">        <span class="comment">// è¿›ç¨‹iæœªå®Œæˆä¸”éœ€æ±‚å°äºç­‰äºå¯ç”¨èµ„æº</span></span><br><span class="line">        <span class="keyword">if</span>(finish[i]==<span class="literal">false</span> &amp;&amp; need[i] &lt;= work) &#123;</span><br><span class="line">            work += allocation[i]; <span class="comment">// å®Œæˆï¼Œé‡Šæ”¾èµ„æº</span></span><br><span class="line">            finish[i] = <span class="literal">true</span>; <span class="comment">// æ ‡è®°è¿›ç¨‹iå®Œæˆ</span></span><br><span class="line">            i = <span class="number">-1</span>; <span class="comment">// é‡ç½®iï¼Œé‡æ–°æ£€æŸ¥æ‰€æœ‰è¿›ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è¿›ç¨‹éƒ½å®Œæˆ</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span>(finish[i] == <span class="literal">false</span>) <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// å­˜åœ¨æœªå®Œæˆè¿›ç¨‹ï¼Œç³»ç»Ÿä¸å®‰å…¨</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// æ‰€æœ‰è¿›ç¨‹éƒ½å®Œæˆï¼Œç³»ç»Ÿå®‰å…¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// èµ„æºè¯·æ±‚ç®—æ³•</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">request_resources</span><span class="params">(<span class="type">int</span> i, vector&lt;<span class="type">int</span>&gt; request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(request&lt;= need[i])) <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// è¯·æ±‚è¶…è¿‡éœ€æ±‚</span></span><br><span class="line">    <span class="keyword">if</span> (!(request &lt;= available)) <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// è¯·æ±‚è¶…è¿‡å¯ç”¨èµ„æº</span></span><br><span class="line">    <span class="comment">// å‡è®¾åˆ†é…èµ„æº</span></span><br><span class="line">    available -= request; <span class="comment">// æ›´æ–°å¯ç”¨èµ„æº</span></span><br><span class="line">    allocation[i] += request; <span class="comment">// æ›´æ–°åˆ†é…çŸ©é˜µ</span></span><br><span class="line">    need[i] -= request; <span class="comment">// æ›´æ–°éœ€æ±‚çŸ©é˜µ</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">is_safe</span>()) &#123; <span class="comment">// æ£€æŸ¥æ˜¯å¦å®‰å…¨</span></span><br><span class="line">        <span class="comment">// å¦‚æœä¸å®‰å…¨ï¼Œå›æ»šåˆ†é…</span></span><br><span class="line">        available += request; <span class="comment">// æ¢å¤å¯ç”¨èµ„æº</span></span><br><span class="line">        allocation[i] -= request; <span class="comment">// æ¢å¤åˆ†é…çŸ©é˜µ</span></span><br><span class="line">        need[i] += request; <span class="comment">// æ¢å¤éœ€æ±‚çŸ©é˜µ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// è¯·æ±‚å¤±è´¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-æ­»é”çš„æ£€æµ‹å’Œæ¢å¤">5. æ­»é”çš„æ£€æµ‹å’Œæ¢å¤</h3><p>æ­»é”æ£€æµ‹ç®—æ³•ï¼šæ£€æµ‹ç³»ç»ŸçŠ¶æ€ï¼Œç¡®å®šç³»ç»Ÿæ˜¯å¦å‡ºç°äº†æ­»é”ã€‚ï¼ˆåŸç†ç±»ä¼¼äºæ­»é”é¿å…ï¼‰</p><p>æ¢å¤æœºåˆ¶ï¼šç»ˆæ­¢ï¼ˆä»£ä»·å¤§ï¼‰ã€èµ„æºæŠ¢å </p><h2 id="å…«ã€ä¸»å­˜ç®¡ç†">å…«ã€ä¸»å­˜ç®¡ç†</h2><h3 id="1-å†…å­˜ç®¡ç†å•å…ƒMMU">1. å†…å­˜ç®¡ç†å•å…ƒMMU</h3><p>åœ¨è¿è¡Œæ—¶å®Œæˆé€»è¾‘åœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢çš„ç¡¬ä»¶è¢«ç§°ä¸ºå†…å­˜ç®¡ç†å•å…ƒï¼ˆMemory Management Unit, MMUï¼‰ã€‚</p><p>ä¸‰ç§å®ç°æ–¹æ³•ï¼šè¿ç»­å†…å­˜åˆ†é…ã€åˆ†é¡µå’Œåˆ†æ®µ</p><h3 id="2-è¿ç»­å†…å­˜åˆ†é…">2. è¿ç»­å†…å­˜åˆ†é…</h3><p>å†…å­˜ä¿æŠ¤ï¼šé€šè¿‡åŸºå€å¯„å­˜å™¨å’Œç•Œé™å¯„å­˜å™¨æ¥å®ç°ã€‚</p><ul><li>åŸºå€å¯„å­˜å™¨ï¼šå­˜å‚¨é€»è¾‘åœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€</li><li>ç•Œé™å¯„å­˜å™¨ï¼šå­˜å‚¨é€»è¾‘åœ°å€ç©ºé—´çš„å¤§å°</li></ul><p>å¤šåˆ†åŒºæ–¹æ³•ï¼šå›ºå®šåˆ†åŒºã€<strong>å¯å˜åˆ†åŒº</strong></p><p>å­”ï¼šå¯ç”¨çš„å†…å­˜å—ã€‚<br>ä¸€å¼€å§‹æ•´ä¸ªå†…å­˜æ˜¯ä¸€ä¸ªå­”ï¼Œéšç€è¿›ç¨‹çš„è¿›å…¥å’Œä¸­æ­¢ï¼Œæ•´ä¸ªå†…å­˜å°†éå¸ƒç€è®¸å¤šå¤§å°ä¸åŒçš„å­”ã€‚</p><p>åŠ¨æ€å­˜å‚¨åˆ†é…é—®é¢˜ï¼šæ ¹æ®ä¸€ç»„ç©ºé—²çš„å­”å’Œä¸€ä¸ªè¯·æ±‚çš„å¤§å°ï¼Œé€‰æ‹©ä¸€ä¸ªå­”æ¥æ»¡è¶³è¯·æ±‚ã€‚</p><p>ä¸‰ç§åˆ†é…ç­–ç•¥ï¼š</p><ol><li>é¦–æ¬¡é€‚åº”ï¼ˆFirst Fitï¼‰ï¼šä»å¤´å¼€å§‹æœç´¢ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å­”åˆ†é…ç»™è¿›ç¨‹ã€‚</li><li>æœ€ä½³é€‚åº”ï¼ˆBest Fitï¼‰ï¼šæœç´¢æ‰€æœ‰å­”ï¼Œæ‰¾åˆ°æœ€å°çš„è¶³å¤Ÿå¤§çš„å­”åˆ†é…ç»™è¿›ç¨‹ã€‚</li><li>æœ€å·®é€‚åº”ï¼ˆWorst Fitï¼‰ï¼šæœç´¢æ‰€æœ‰å­”ï¼Œæ‰¾åˆ°æœ€å¤§çš„å­”åˆ†é…ç»™è¿›ç¨‹ã€‚</li></ol><ul><li>é¦–æ¬¡é€‚åº”å’Œæœ€ä½³é€‚åº”åœ¨æ‰§è¡Œæ—¶é—´å’Œåˆ©ç”¨ç©ºé—´æ–¹é¢éƒ½å¥½äºæœ€å·®é€‚åº”ã€‚</li><li>é¦–æ¬¡é€‚åº”æ¯”æœ€ä½³é€‚åº”è¦å¿«</li></ul><p>ç¢ç‰‡ï¼šå› å¤ªå°è€Œæ— æ³•åˆ†é…ç»™ä»»ä½•è¿›ç¨‹çš„å­”ã€‚</p><ul><li>å¤–éƒ¨ç¢ç‰‡ï¼šç”±äºåˆ†é…å’Œé‡Šæ”¾å†…å­˜å—åï¼Œå‰©ä½™çš„å†…å­˜å—å¤ªå°è€Œæ— æ³•æ»¡è¶³æ–°çš„è¯·æ±‚ï¼Œä¸‰ç§åˆ†é…ç­–ç•¥éƒ½å¯èƒ½å¯¼è‡´å¤–éƒ¨ç¢ç‰‡ã€‚</li><li>å†…éƒ¨ç¢ç‰‡ï¼šå›ºå®šåˆ†åŒºï¼ˆåˆ†é¡µï¼‰æ–¹æ³•çš„é—®é¢˜ï¼Œè¿›ç¨‹åˆ†é…åˆ°çš„å†…å­˜å—æ¯”å®é™…éœ€è¦çš„è¦å¤§ï¼Œå¯¼è‡´æœªä½¿ç”¨çš„å†…å­˜ç©ºé—´ã€‚</li></ul><p>è§£å†³å¤–éƒ¨ç¢ç‰‡çš„æ–¹æ³•ï¼š</p><ol><li>ç´§ç¼©ï¼šç§»åŠ¨å†…å­˜å†…å®¹ï¼Œå°†æ‰€æœ‰ç©ºé—²ç©ºé—´åˆå¹¶æˆä¸€æ•´å—<ul><li>ç¼ºç‚¹ï¼šæœ‰æ¡ä»¶é™åˆ¶ï¼ˆè¦æ±‚é‡å®šä½æ˜¯åŠ¨æ€çš„ï¼‰ã€å¼€é”€å¤§</li></ul></li><li>å…è®¸ç‰©ç†åœ°å€ç©ºé—´ä¸ºéè¿ç»­çš„ï¼ˆåˆ†é¡µå’Œåˆ†æ®µï¼‰</li></ol><h3 id="3-åˆ†é¡µï¼ˆPagingï¼‰">3. åˆ†é¡µï¼ˆPagingï¼‰</h3><h4 id="3-1-åŸºæœ¬æ–¹æ³•">3.1 åŸºæœ¬æ–¹æ³•</h4><p>ç‰©ç†åœ°å€åˆ†ä¸ºå›ºå®šå¤§å°çš„å—ï¼Œç§°ä¸º<strong>å¸§</strong>(Frame)ï¼Œé€»è¾‘åœ°å€åˆ†ä¸ºåŒæ ·å¤§å°çš„å—ï¼Œç§°ä¸º<strong>é¡µ</strong>(Page)ã€‚</p><p>å†…å­˜çš„åˆ†é…ä¿¡æ¯ä¿å­˜åœ¨ç§°ä¸º<strong>å¸§è¡¨</strong>(frame table)çš„æ•°æ®ç»“æ„ä¸­</p><p>å¦‚æœä¸€ä¸ªè¿›ç¨‹éœ€è¦xé¡µï¼Œåˆ™åœ¨å†…å­˜åœ¨å¯»æ‰¾xä¸ªç©ºé—²å¸§ï¼Œå¦‚æœæœ‰ï¼Œåˆ™åˆ†é…ã€‚</p><p>ä¸ºè¿›ç¨‹åˆ†é…å†…å­˜æ—¶å»ºç«‹ä¸€ä¸ª<strong>é¡µè¡¨</strong>ï¼Œç”¨äºå°†é€»è¾‘åœ°å€è½¬æ¢æˆç‰©ç†åœ°å€ï¼Œé¡µè¡¨çš„æŒ‡é’ˆä¸å…¶ä»–ä¿¡æ¯ä¸€èµ·å­˜å…¥è¿›ç¨‹æ§åˆ¶å—ã€‚</p><p>é¡µè¡¨åŸºå¯„å­˜å™¨(PTBR)æŒ‡å‘é¡µè¡¨ï¼Œåˆ‡æ¢é¡µè¡¨åªéœ€æ”¹å˜PTBRçš„å€¼å³å¯ã€‚</p><p>é¡µè¡¨é•¿åº¦å¯„å­˜å™¨(PTLB)è¡¨ç¤ºé¡µè¡¨çš„é•¿åº¦ã€‚</p><p>é‡‡ç”¨åˆ†é¡µæŠ€æœ¯ä¸ä¼šäº§ç”Ÿå¤–éƒ¨ç¢ç‰‡ï¼Œä½†æ˜¯ä¼šæœ‰<strong>å†…éƒ¨ç¢ç‰‡</strong>ã€‚</p><p>åˆ†é¡µçš„ä¼˜ç‚¹ä¹‹ä¸€æ˜¯å¯ä»¥å…±äº«å…±åŒä»£ç ï¼šå¤šä¸ªè¿›ç¨‹ä¹‹é—´å¯ä»¥å…±äº«åŒä¸€åªè¯»ä»£ç ï¼ˆé‡å…¥ä»£ç ï¼‰æ®µçš„æ‹·è´ï¼›ç§æœ‰ç‹¬å ä»£ç å’Œæ•°æ®</p><p>è®°å—å¤§å°$2^n$ï¼Œç‰©ç†å†…å­˜å¤§å°ä¸º$2^k$ï¼Œè¿›ç¨‹é€»è¾‘åœ°å€å¤§å°ä¸º$2^m$ã€‚</p><p>å¸§æ•°ï¼š$2^{k-n}$ï¼Œé¡µæ•°ï¼š$2^{m-n}$</p><p>é€»è¾‘åœ°å€é«˜m-nä½ä¸ºÂ§é¡µè¡¨ç´¢å¼•ï¼Œä½nä½(d)ä¸ºé¡µåç§»</p><p>å‡è®¾æ¯é¡µ4Bï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/course/operating_system/image-5.png" alt="alt text"></p><p><img src="https://source.cclmsy.cc/posts/notes/course/operating_system/image-4.png" alt="alt text"></p><h4 id="3-2-è½¬æ¢è¡¨ç¼“å†²TLB">3.2 è½¬æ¢è¡¨ç¼“å†²TLB</h4><p>é¡µè¡¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ¯è®¿é—®ä¸€ä¸ªå­—èŠ‚ï¼Œéœ€è¦ä¸¤æ¬¡è®¿é—®å†…å­˜ï¼ˆæŸ¥æ‰¾é¡µè¡¨ã€æ‰¾åˆ°éœ€è¦çš„ä¿¡æ¯ï¼‰ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜çš„æ ‡å‡†è§£å†³æ–¹æ¡ˆæ˜¯å…³è”å†…å­˜(TLB)ã€‚</p><p>å½“å…³è”å†…å­˜æ ¹æ®ç»™å®šå€¼ï¼ˆé¡µå·ï¼‰æŸ¥æ‰¾æ—¶ï¼Œå®ƒä¼šåŒæ—¶ä¸æ‰€æœ‰é”®è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ‰¾åˆ°æ¡ç›®ï¼Œå°±å¾—åˆ°ç›¸åº”çš„å€¼åŸŸï¼ˆå¸§å·ï¼‰</p><p>ç›¸å½“äºé¡µè¡¨çš„ä¸€ä¸ªç¼“å­˜ï¼ŒTLBçš„å¤§å°é€šå¸¸å¾ˆå°ï¼ˆå‡ åä¸ªæ¡ç›®ï¼‰ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨æ›¿æ¢ç®—æ³•</p><p>æœ‰æ•ˆå†…å­˜è®¿é—®æ—¶é—´(Effective Memory Access Time, EMAT)ï¼š</p><p>$$<br>EMAT = (T+\epsilon)\alpha + (2T+\epsilon)(1-\alpha)<br>$$</p><ul><li>Tï¼šè®¿é—®ä¸€æ¬¡å†…å­˜çš„æ—¶é—´</li><li>Îµï¼šè®¿é—®ä¸€æ¬¡TLBçš„æ—¶é—´</li><li>Î±ï¼šTLBå‘½ä¸­ç‡</li><li>ç¬¬ä¸€é¡¹ï¼šTLBå‘½ä¸­ï¼Œè®¿é—®ä¸€æ¬¡å†…å­˜</li><li>ç¬¬äºŒé¡¹ï¼šTLBæœªå‘½ä¸­ï¼Œè®¿é—®ä¸¤æ¬¡å†…å­˜</li></ul><h4 id="3-3-é¡µè¡¨çš„ç»“æ„">3.3 é¡µè¡¨çš„ç»“æ„</h4><ol><li>å±‚æ¬¡åŒ–é¡µè¡¨ï¼šå°†é¡µè¡¨åˆ†ä¸ºå¤šä¸ªå±‚æ¬¡ï¼Œæ¯ä¸ªå±‚æ¬¡çš„é¡µè¡¨åªåŒ…å«ä¸€éƒ¨åˆ†é¡µè¡¨é¡¹ï¼Œå‡å°‘å†…å­˜å ç”¨ã€‚</li><li>å“ˆå¸Œé¡µè¡¨ï¼šä½¿ç”¨å“ˆå¸Œå‡½æ•°å°†é¡µå·æ˜ å°„åˆ°é¡µè¡¨é¡¹ï¼Œå‡å°‘å†…å­˜å ç”¨</li><li>åå‘é¡µè¡¨ï¼šæ¯ä¸ªç‰©ç†å¸§å¯¹åº”ä¸€ä¸ªé¡µè¡¨é¡¹ï¼Œè®°å½•å“ªä¸ªè¿›ç¨‹çš„å“ªä¸ªé¡µæ˜ å°„åˆ°è¯¥å¸§</li></ol><p><img src="https://source.cclmsy.cc/posts/notes/course/operating_system/image-6.png" alt="alt text"></p><h4 id="3-4-ä¾‹é¢˜1">3.4 ä¾‹é¢˜1</h4><p>é¡µé¢å¤§å°ä¸º4KBï¼Œé€»è¾‘åœ°å€24KBï¼Œé¡µè¡¨çš„å†…å®¹ä¸ºï¼š[2,5,6,8,3,11]ã€‚<br>åˆ™é€»è¾‘åœ°å€12293è½¬æ¢æˆç‰©ç†åœ°å€ä¸ºå¤šå°‘ï¼Ÿç»™å‡ºè®¡ç®—è¿‡ç¨‹ã€‚</p><p>12293D=011|0000,0000,0101B</p><p>é¡µå·p=011=3 =&gt; å¸§å·8</p><p>é¡µå†…åç§»d=101=5</p><p>ç‰©ç†åœ°å€=å¸§å·<em>é¡µå¤§å°+é¡µå†…åç§»=8</em>4KB+5=32768+5=32773</p><h4 id="3-5-ä¾‹é¢˜2">3.5 ä¾‹é¢˜2</h4><p>å¦‚æœè®¿é—®ä¸€æ¬¡å†…å­˜è¦1.5nsï¼Œå¿«è¡¨çš„å‘½ä¸­ç‡ä¸º85%ï¼ŒæŸ¥æ‰¾å¿«è¡¨çš„æ—¶é—´ä¸º0.5nsã€‚è®¡ç®—è¯¥ç³»ç»Ÿçš„æœ‰æ•ˆè®¿é—®æ—¶é—´ã€‚</p><p>EMAT = (T + Îµ)Î± + (2T + Îµ)(1 - Î±) = (1.5 + 0.5) * 0.85 + (2 * 1.5 + 0.5) * (1 - 0.85)</p><h3 id="4-åˆ†æ®µï¼ˆSegmentationï¼‰">4. åˆ†æ®µï¼ˆSegmentationï¼‰</h3><p>åˆ†æ®µæ˜¯æŒ‡å°†é€»è¾‘åœ°å€ç©ºé—´åˆ’åˆ†æˆä¸€ç»„æ®µï¼Œæ¯ä¸ªæ®µéƒ½æœ‰åç§°å’Œé•¿åº¦ã€‚<br>åœ°å€æŒ‡å®šäº†æ®µåå’Œæ®µå†…åç§»ã€‚<br>å› æ­¤ç”¨æˆ·å¯é€šè¿‡ä¸¤ä¸ªé‡æ¥æŒ‡å®šåœ°å€æ®µåå’Œåç§»ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ ¹æ®ç”¨æˆ·ç¨‹åºæ„é€ æ®µã€‚</p><p>é€»è¾‘åœ°å€ç”±ä¸¤ä¸ªå…ƒç´ ç»„æˆï¼š&lt;æ®µå·sï¼Œæ®µå†…åç§»d&gt;</p><p>æ®µè¡¨ï¼šå°†äºŒç»´çš„ç”¨æˆ·å®šä¹‰åœ°å€æ˜ å°„ä¸ºä¸€ç»´ç‰©ç†åœ°å€ã€‚æ®µè¡¨çš„æ¯ä¸ªæ¡ç›®éƒ½åŒ…å«ï¼š</p><ul><li>åŸºåœ°å€ï¼šåŒ…å«æ®µçš„èµ·å§‹åœ°å€</li><li>ç•Œé™ï¼šæŒ‡å®šæ®µçš„é•¿åº¦</li></ul><p>æ®µè¡¨åŸºåœ°å€å¯„å­˜å™¨ï¼ˆSTBRï¼‰æŒ‡å‘å†…å­˜ä¸­çš„æ®µè¡¨æ‰€åœ¨çš„ç‰©ç†åœ°å€</p><p>æ®µè¡¨ç•Œé™å¯„å­˜å™¨ï¼ˆSTLRï¼‰æŒ‡ç¤ºç¨‹åºæ‰€ç”¨çš„æ®µçš„ä¸ªæ•°ï¼Œæ®µå·Så°äºSTLRçš„æ—¶å€™æ‰æ˜¯æœ‰æ•ˆçš„</p><h3 id="5-æ¯”è¾ƒ">5. æ¯”è¾ƒ</h3><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">è¿ç»­å†…å­˜åˆ†é…</th><th style="text-align:center">åˆ†é¡µ</th><th style="text-align:center">åˆ†æ®µ</th></tr></thead><tbody><tr><td style="text-align:center">å¤–éƒ¨ç¢ç‰‡</td><td style="text-align:center">æœ‰</td><td style="text-align:center">æ— </td><td style="text-align:center">æœ‰</td></tr><tr><td style="text-align:center">å†…éƒ¨ç¢ç‰‡</td><td style="text-align:center">æ— </td><td style="text-align:center">æœ‰</td><td style="text-align:center">æ— </td></tr><tr><td style="text-align:center">ä»£ç å…±äº«</td><td style="text-align:center">ä¸å¯ä»¥</td><td style="text-align:center">å¯ä»¥</td><td style="text-align:center">å¯ä»¥</td></tr></tbody></table><h3 id="6-å…¶ä»–">6. å…¶ä»–</h3><p>åœ°å€æ˜ å°„æ˜¯æŒ‡å°†ç¨‹åºä¸­çš„<strong>é€»è¾‘</strong>åœ°å€è½¬æ¢ä¸ºå†…å­˜ä¸­çš„<strong>ç‰©ç†</strong>åœ°å€ã€‚</p><p>åœ¨åˆ†é¡µç®¡ç†ç³»ç»Ÿä¸­ï¼Œä¸ºå®ç°åœ°å€è½¬æ¢è®¾ç½®äº†æ§åˆ¶å¯„å­˜å™¨ï¼Œå…¶ä¸­å­˜æ”¾çš„æ˜¯<strong>é¡µè¡¨</strong>åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€ã€‚</p><p>å­˜å‚¨ç®¡ç†åº”å…·æœ‰çš„åŠŸèƒ½åŒ…æ‹¬ï¼š<strong>å†…å­˜åˆ†é…ä¸å›æ”¶</strong>ï¼Œ<strong>åœ°å€æ˜ å°„</strong>ï¼Œ<strong>å†…å­˜ä¿æŠ¤</strong>å’Œ<strong>å†…å­˜æ‰©å……</strong>ã€‚</p><p>åœ¨åˆ†é¡µå¼è™šæ‹Ÿå†…å­˜ä¸­ï¼Œå½“å‘ç°æŸé¡µä¸åœ¨<strong>é¡µè¡¨</strong>ä¸­ï¼Œå°†äº§ç”Ÿç¼ºé¡µä¸­æ–­ã€‚è‹¥å†…å­˜æ²¡æœ‰ç©ºé—²å¸§ï¼Œåˆ™éœ€è¦è¿›è¡Œ<strong>é¡µé¢ç½®æ¢</strong>ã€‚å¦‚æœç®—æ³•é€‰æ‹©ä¸åˆç†ï¼Œå¯èƒ½ä¼šå‡ºç°é¢‘ç¹çš„é¡µé¢è°ƒåº¦ï¼Œç³»ç»Ÿäº§ç”Ÿ<strong>æŠ–åŠ¨</strong>ç°è±¡ã€‚</p><h2 id="ä¹ã€è™šæ‹Ÿå†…å­˜">ä¹ã€è™šæ‹Ÿå†…å­˜</h2><h3 id="1-æœ‰æ•ˆè®¿é—®æ—¶é—´">1. æœ‰æ•ˆè®¿é—®æ—¶é—´</h3><p>æœ‰æ•ˆè®¿é—®æ—¶é—´ï¼ˆEffective Access Time, EATï¼‰æ˜¯æŒ‡åœ¨è™šæ‹Ÿå†…å­˜ç³»ç»Ÿä¸­ï¼Œå¹³å‡æ¯æ¬¡è®¿é—®å†…å­˜æ‰€éœ€çš„æ—¶é—´ã€‚</p><p>EATçš„è®¡ç®—å…¬å¼ä¸ºï¼š<br>$$<br>EAT = (1 - p) \times T + p \times S<br>$$</p><ul><li>pï¼šç¼ºé¡µç‡ï¼ˆPage Fault Rateï¼‰ï¼Œè¡¨ç¤ºè®¿é—®å†…å­˜æ—¶å‘ç”Ÿç¼ºé¡µçš„æ¦‚ç‡</li><li>Tï¼šå¹³å‡å†…å­˜è®¿é—®æ—¶é—´</li><li>Sï¼šå¹³å‡é¡µé”™è¯¯å¤„ç†æ—¶é—´</li></ul><p>å®ç°æŒ‰éœ€é¡µé¢è°ƒåº¦è¦è§£å†³çš„ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li>å¸§åˆ†é…ï¼šå†…å­˜ä¸­å­˜åœ¨å¤šä¸ªè¿›ç¨‹ï¼Œéœ€è¦å†³å®šæ¯ä¸ªè¿›ç¨‹åˆ†é…å¤šå°‘å¸§</li><li>é¡µé¢ç½®æ¢ï¼šå½“å†…å­˜æ»¡æ—¶ï¼Œéœ€è¦å†³å®šå°†å“ªä¸ªé¡µé¢æ¢å‡ºï¼ŒåŸåˆ™ï¼šæœ€å°é¡µé”™è¯¯ç‡</li></ol><h3 id="2-é¡µé¢ç½®æ¢ç®—æ³•">2. é¡µé¢ç½®æ¢ç®—æ³•</h3><p>é¡µé¢ç½®æ¢çš„åŸºæœ¬æ–¹æ³•ï¼š</p><ol><li>æŸ¥æ‰¾æ‰€éœ€é¡µåœ¨ç£ç›˜ä¸Šçš„ä½ç½®ã€‚</li><li>æŸ¥æ‰¾ç©ºé—²å¸§<ul><li>å¦‚æœæœ‰ç©ºé—²å¸§ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨å®ƒï¼›</li><li>å¦‚æœæ²¡æœ‰ç©ºé—²å¸§ï¼Œå°±ä½¿ç”¨é¡µé¢ç½®æ¢ç®—æ³•é€‰æ‹©ä¸€ä¸ªâ€œç‰ºç‰²â€å¸§ã€‚</li><li>å°†â€œç‰ºç‰²â€å¸§çš„å†…å®¹å†™åˆ°ç£ç›˜ä¸Šï¼Œä¿®æ”¹é¡µè¡¨å’Œå¸§è¡¨ã€‚</li></ul></li><li>å°†æ‰€éœ€çš„é¡µè¯»å…¥ç©ºé—²å¸§ï¼Œä¿®æ”¹é¡µè¡¨å’Œå¸§è¡¨ã€‚</li><li>é‡å¯è¿›ç¨‹ã€‚</li></ol><h3 id="3-FIFOé¡µé¢ç½®æ¢ç®—æ³•">3. FIFOé¡µé¢ç½®æ¢ç®—æ³•</h3><p>FIFOï¼ˆFirst In First Outï¼‰é¡µé¢ç½®æ¢ç®—æ³•æ˜¯æœ€ç®€å•çš„é¡µé¢ç½®æ¢ç®—æ³•ã€‚</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  1 , 2 , 3 , 4 , 1 , 2 , 5 , 1 , 2 , 3 , 4 , 5</span><br><span class="line"></span><br><span class="line">|<span class="string"> 1*</span>|<span class="string"> 1 </span>|<span class="string"> 1 </span>|<span class="string"> 4*</span>|<span class="string"> 4 </span>|<span class="string"> 4 </span>|<span class="string"> 5*</span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string"> 5 </span>|<span class="string"> 5 </span>|<span class="string"> H </span>|</span><br><span class="line">|<span class="string">   </span>|<span class="string"> 2*</span>|<span class="string"> 2 </span>|<span class="string"> 2 </span>|<span class="string"> 1*</span>|<span class="string"> 1 </span>|<span class="string"> 1 </span>|<span class="string"> H </span>|<span class="string">   </span>|<span class="string"> 3*</span>|<span class="string"> 3 </span>|<span class="string">   </span>|</span><br><span class="line">|<span class="string">   </span>|<span class="string">   </span>|<span class="string"> 3*</span>|<span class="string"> 3 </span>|<span class="string"> 3 </span>|<span class="string"> 2*</span>|<span class="string"> 2 </span>|<span class="string">   </span>|<span class="string"> H </span>|<span class="string"> 2 </span>|<span class="string"> 4*</span>|<span class="string">   </span>|</span><br></pre></td></tr></table></figure><p>é¡µé”™è¯¯æ¬¡æ•°ï¼š9</p><p>è§„å¾‹ï¼šä¸è®¡å‘½ä¸­ï¼Œè‡ªæŸå¸§è¿›å…¥å†…å­˜å¼€å§‹ä¼šå‡ºç°næ¬¡ï¼Œnä¸ºå†…å­˜å¸§æ•°</p><p>Beladyå¼‚å¸¸ï¼šé¡µé”™è¯¯ç‡å¯èƒ½ä¼šéšç€æ‰€åˆ†é…çš„å¸§æ•°çš„å¢åŠ è€Œå¢åŠ ï¼Œå¦‚ä¸Šä¾‹å¢åŠ ä¸º4å¸§æ—¶ï¼š</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  1 , 2 , 3 , 4 , 1 , 2 , 5 , 1 , 2 , 3 , 4 , 5</span><br><span class="line"></span><br><span class="line">|<span class="string"> 1*</span>|<span class="string"> 1 </span>|<span class="string"> 1 </span>|<span class="string"> 1 </span>|<span class="string"> H </span>|<span class="string">   </span>|<span class="string"> 5*</span>|<span class="string"> 5 </span>|<span class="string"> 5 </span>|<span class="string"> 5 </span>|<span class="string"> 4*</span>|<span class="string"> 4 </span>|</span><br><span class="line">|<span class="string">   </span>|<span class="string"> 2*</span>|<span class="string"> 2 </span>|<span class="string"> 2 </span>|<span class="string">   </span>|<span class="string"> H </span>|<span class="string"> 2 </span>|<span class="string"> 1*</span>|<span class="string"> 1 </span>|<span class="string"> 1 </span>|<span class="string"> 1 </span>|<span class="string"> 5*</span>|</span><br><span class="line">|<span class="string">   </span>|<span class="string">   </span>|<span class="string"> 3*</span>|<span class="string"> 3 </span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string"> 3 </span>|<span class="string"> 3 </span>|<span class="string"> 2*</span>|<span class="string"> 2 </span>|<span class="string"> 2 </span>|<span class="string"> 2 </span>|</span><br><span class="line">|<span class="string">   </span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string"> 4*</span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string"> 4 </span>|<span class="string"> 4 </span>|<span class="string"> 4 </span>|<span class="string"> 3*</span>|<span class="string"> 3 </span>|<span class="string"> 3 </span>|</span><br></pre></td></tr></table></figure><h3 id="4-æœ€ä¼˜é¡µé¢ç½®æ¢OPT">4. æœ€ä¼˜é¡µé¢ç½®æ¢OPT</h3><p>æœ€ä¼˜é¡µé¢ç½®æ¢ç®—æ³•ï¼ˆOptimal Page Replacementï¼‰æ˜¯ç†è®ºä¸Šæœ€å¥½çš„é¡µé¢ç½®æ¢ç®—æ³•ã€‚</p><p>é€‰æ‹©å°†æ¥æœ€é•¿æ—¶é—´ä¸è¢«è®¿é—®çš„é¡µé¢è¿›è¡Œç½®æ¢ã€‚</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  1 , 2 , 3 , 4 , 1 , 2 , 5 , 1 , 2 , 3 , 4 , 5</span><br><span class="line"></span><br><span class="line">|<span class="string"> 1*</span>|<span class="string"> 1 </span>|<span class="string"> 1 </span>|<span class="string"> 1 </span>|<span class="string"> H </span>|<span class="string">   </span>|<span class="string"> 1 </span>|<span class="string"> H </span>|<span class="string">   </span>|<span class="string"> 3*</span>|<span class="string"> 3 </span>|<span class="string">   </span>|</span><br><span class="line">|<span class="string">   </span>|<span class="string"> 2*</span>|<span class="string"> 2 </span>|<span class="string"> 2 </span>|<span class="string">   </span>|<span class="string"> H </span>|<span class="string"> 2 </span>|<span class="string">   </span>|<span class="string"> H </span>|<span class="string"> 2 </span>|<span class="string"> 4*</span>|<span class="string">   </span>|</span><br><span class="line">|<span class="string">   </span>|<span class="string">   </span>|<span class="string"> 3*</span>|<span class="string"> 4*</span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string"> 5*</span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string"> 5 </span>|<span class="string"> 5 </span>|<span class="string"> H </span>|</span><br></pre></td></tr></table></figure><p>é¡µé”™è¯¯æ¬¡æ•°ï¼š7</p><h3 id="5-LRUé¡µé¢ç½®æ¢ç®—æ³•">5. LRUé¡µé¢ç½®æ¢ç®—æ³•</h3><p>LRUï¼ˆLeast Recently Usedï¼‰é¡µé¢ç½®æ¢ç®—æ³•æ˜¯åŸºäºæœ€è¿‘æœ€å°‘ä½¿ç”¨åŸåˆ™çš„é¡µé¢ç½®æ¢ç®—æ³•ã€‚</p><p>LRUç®—æ³•é€‰æ‹©æœ€ä¹…æœªè¢«è®¿é—®çš„é¡µé¢è¿›è¡Œç½®æ¢ã€‚</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  1 , 2 , 3 , 4 , 1 , 2 , 5 , 1 , 2 , 3 , 4 , 5</span><br><span class="line"></span><br><span class="line">|<span class="string"> 1*</span>|<span class="string"> 1 </span>|<span class="string"> 1 </span>|<span class="string"> 4*</span>|<span class="string"> 4 </span>|<span class="string"> 4 </span>|<span class="string"> 5*</span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string"> 3*</span>|<span class="string"> 5 </span>|<span class="string"> H </span>|</span><br><span class="line">|<span class="string">   </span>|<span class="string"> 2*</span>|<span class="string"> 2 </span>|<span class="string"> 2 </span>|<span class="string"> 1*</span>|<span class="string"> 1 </span>|<span class="string"> 1 </span>|<span class="string"> H </span>|<span class="string">   </span>|<span class="string"> 1 </span>|<span class="string"> 4*</span>|<span class="string">   </span>|</span><br><span class="line">|<span class="string">   </span>|<span class="string">   </span>|<span class="string"> 3*</span>|<span class="string"> 3 </span>|<span class="string"> 3 </span>|<span class="string"> 2*</span>|<span class="string"> 2 </span>|<span class="string">   </span>|<span class="string"> H </span>|<span class="string"> 2 </span>|<span class="string"> 2 </span>|<span class="string">   </span>|</span><br></pre></td></tr></table></figure><p>é¡µé”™è¯¯æ¬¡æ•°ï¼š9</p><p>OPTå’ŒLRUæ²¡æœ‰Beladyå¼‚å¸¸ã€‚</p><h2 id="åã€æ–‡ä»¶ç³»ç»Ÿ">åã€æ–‡ä»¶ç³»ç»Ÿ</h2><h3 id="1-æ¦‚å¿µ">1. æ¦‚å¿µ</h3><ul><li>æ–‡ä»¶å±æ€§ï¼šåç§°ã€ç±»å‹ã€ä½ç½®ã€å¤§å°ã€æ—¶é—´æˆ³ã€æƒé™ç­‰</li><li>æ–‡ä»¶æ“ä½œï¼šåˆ›å»ºã€åˆ é™¤ã€è¯»ã€å†™ã€é‡å®šä½ç­‰</li><li>æ–‡ä»¶ç±»å‹ï¼šæ‰©å±•å</li></ul><h3 id="2-è®¿é—®æ–¹æ³•">2. è®¿é—®æ–¹æ³•</h3><ol><li>é¡ºåºè®¿é—®ï¼šä»å¤´åˆ°å°¾ä¾æ¬¡è®¿é—®æ–‡ä»¶å†…å®¹<ul><li>read_next(), write_next(), reset()ç­‰</li></ul></li><li>ç›´æ¥è®¿é—®ï¼ˆéšæœºè®¿é—®ã€ç›¸å¯¹è®¿é—®ï¼‰ï¼šå¯ä»¥ç›´æ¥è·³è½¬åˆ°æ–‡ä»¶çš„ä»»æ„ä½ç½®è¿›è¡Œè¯»å†™æ“ä½œ<ul><li>read(n), write(n), position_to(n)ç­‰</li></ul></li><li>ç´¢å¼•è®¿é—®ï¼šä½¿ç”¨ç´¢å¼•è¡¨æ¥å¿«é€Ÿå®šä½æ–‡ä»¶ä¸­çš„æ•°æ®å—</li></ol><h3 id="3-æ–‡ä»¶çš„è·¯å¾„å">3. æ–‡ä»¶çš„è·¯å¾„å</h3><p><code>ç›˜ç¬¦:\ç›®å½•1\ç›®å½•2\...\æ–‡ä»¶å.æ‰©å±•å</code></p><p>ç›¸å¯¹è·¯å¾„ã€ç»å¯¹è·¯å¾„</p><h3 id="4-ç›®å½•ä¸ç£ç›˜ç»“æ„">4. ç›®å½•ä¸ç£ç›˜ç»“æ„</h3><ol><li>å•å±‚ç›®å½•ï¼šæ‰€æœ‰æ–‡ä»¶éƒ½åœ¨åŒä¸€ç›®å½•ä¸‹ï¼Œå‘½åå†²çªã€åˆ†ç»„é—®é¢˜</li><li>åŒå±‚ç›®å½•ï¼šæ¯ä¸ªç”¨æˆ·æœ‰è‡ªå·±çš„ç›®å½•ï¼Œç”¨æˆ·ç›®å½•ä¸‹æœ‰æ–‡ä»¶</li><li>æ ‘å½¢ç›®å½•ï¼šå…¸å‹ï¼Œç›¸å¯¹è·¯å¾„ã€ç»å¯¹è·¯å¾„éƒ½å”¯ä¸€</li><li>æ— ç¯å›¾ç›®å½•ï¼šæœ‰å¤šæ¡è·¯å¾„è®¿é—®åŒä¸€æ–‡ä»¶<ul><li>å‘½åï¼šä¸€ä¸ªæ–‡ä»¶å¯æœ‰å¤šä¸ªç»å¯¹è·¯å¾„åï¼Œä¸åŒæ–‡ä»¶åå¯èƒ½è¡¨ç¤ºåŒä¸€æ–‡ä»¶</li><li>åˆ é™¤ï¼šåˆ é™¤æ–‡ä»¶å¯¼è‡´æ‚¬æŒ‚æŒ‡é’ˆï¼ˆæŒ‡å‘ä¸å­˜åœ¨çš„æ–‡ä»¶æˆ–è€…æ‰§è¡Œäº†å…¶ä»–æ–‡ä»¶ï¼‰</li></ul></li><li>é€šç”¨å›¾ç›®å½•ï¼šæœ‰å¤šæ¡è·¯å¾„è®¿é—®åŒä¸€æ–‡ä»¶æˆ–ç›®å½•</li></ol><h2 id="åä¸€ã€æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼ˆç£ç›˜åˆ†é…æ–¹æ³•ï¼‰">åä¸€ã€æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼ˆç£ç›˜åˆ†é…æ–¹æ³•ï¼‰</h2><h3 id="1-è¿ç»­åˆ†é…">1. è¿ç»­åˆ†é…</h3><p>æ¯ä¸ªæ–‡ä»¶åœ¨ç£ç›˜ä¸Šå ç”¨ä¸€ç»„è¿ç»­çš„å—ã€‚</p><p>ä¼˜ç‚¹ï¼š</p><ol><li>ç®€å•ï¼šåªéœ€è¦å—èµ·å§‹åœ°å€å’Œå—é•¿åº¦ï¼ˆå ç”¨å‡ ä¸ªå—ï¼‰å°±èƒ½è®¿é—®æ–‡ä»¶</li><li>è®¿é—®è¿ç»­åˆ†é…çš„æ–‡ä»¶æ‰€éœ€çš„å¯»é“æ—¶é—´æœ€å°</li><li>æ”¯æŒéšæœºè®¿é—®</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>å¤–éƒ¨ç¢ç‰‡ï¼šéšç€æ–‡ä»¶çš„åˆ›å»ºå’Œåˆ é™¤ï¼Œç£ç›˜ä¸Šä¼šäº§ç”Ÿå¤–éƒ¨ç¢ç‰‡ï¼Œå¯¼è‡´æ— æ³•åˆ†é…è¿ç»­ç©ºé—´</li><li>æœ‰æ—¶åˆ›å»ºæ–‡ä»¶æ—¶ä¸èƒ½ç¡®å®šæ–‡ä»¶çš„å¤§å°</li><li>æ–‡ä»¶ä¸èƒ½åŠ¨æ€æ‰©å±•</li></ol><h3 id="2-é“¾æ¥åˆ†é…">2. é“¾æ¥åˆ†é…</h3><p>æ¯ä¸ªæ–‡ä»¶æ˜¯ç£ç›˜å—çš„é“¾è¡¨ï¼Œæ¯ä¸ªå—åŒ…å«ä¸‹ä¸€ä¸ªå—çš„åœ°å€ã€‚</p><p>ä¼˜ç‚¹ï¼š</p><ol><li>ç®€å•ï¼šåªéœ€è¦èµ·å§‹åœ°å€ï¼›</li><li>åˆ©ç”¨ç‡é«˜ï¼šæ²¡æœ‰å¤–éƒ¨ç¢ç‰‡ï¼Œåªè¦æœ‰ç©ºé—²å—ï¼Œæ–‡ä»¶å°±èƒ½å¢å¤§</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>åªèƒ½ç”¨äºæ–‡ä»¶çš„é¡ºåºè®¿é—®ï¼Œä¸æ”¯æŒæ–‡ä»¶çš„ç›´æ¥è®¿é—®ã€‚</li><li>æŒ‡é’ˆéœ€è¦ç©ºé—´ï¼Œç£ç›˜ç©ºé—´æœ‰ä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨æŒ‡é’ˆã€‚</li><li>å¯é æ€§ä½ï¼šå¦‚æœæŒ‡é’ˆä¸¢å¤±æˆ–æŸåå¯èƒ½ç‰µè¿åˆ°ç©ºé—²ç©ºé—´åˆ—è¡¨ã€‚</li></ol><h3 id="3-ç´¢å¼•åˆ†é…ï¼ˆæ•£åˆ—åˆ†é…ï¼‰">3. ç´¢å¼•åˆ†é…ï¼ˆæ•£åˆ—åˆ†é…ï¼‰</h3><p>å°†æ‰€æœ‰æŒ‡é’ˆæ”¾åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªç´¢å¼•å—ï¼Œç´¢å¼•å—åŒ…å«æ–‡ä»¶çš„æ‰€æœ‰å—çš„åœ°å€ã€‚</p><p>ç´¢å¼•å—æ–¹æ¡ˆï¼šé“¾æ¥ç´¢å¼•ã€å¤šçº§ç´¢å¼•ã€ç»„åˆæ–¹æ¡ˆ</p><h2 id="åäºŒã€å¤§å®¹é‡å­˜å‚¨ç»“æ„ï¼ˆç£ç›˜ï¼‰">åäºŒã€å¤§å®¹é‡å­˜å‚¨ç»“æ„ï¼ˆç£ç›˜ï¼‰</h2><h3 id="1-ç£ç›˜é€Ÿåº¦">1. ç£ç›˜é€Ÿåº¦</h3><p>ç£ç›˜çš„è®¿é—®æ—¶é—´ï¼š</p><ul><li>æ•°æ®ä¼ è¾“æ—¶é—´ï¼šé©±åŠ¨å™¨ä¸è®¡ç®—æœºä¹‹é—´çš„æ•°æ®ä¼ è¾“é€Ÿç‡</li><li>å®šä½æ—¶é—´/éšæœºè®¿é—®æ—¶é—´<ul><li>å¯»é“æ—¶é—´ï¼šç£å¤´ç§»åŠ¨åˆ°æŸ±é¢æ‰€éœ€çš„æ—¶é—´</li><li>æ—‹è½¬å»¶æ—¶ï¼šç­‰å¾…æ‰‡åŒºæ—‹è½¬åˆ°ç£å¤´ä¸‹æ‰€éœ€çš„æ—¶é—´</li></ul></li></ul><h3 id="2-ç£ç›˜è°ƒåº¦">2. ç£ç›˜è°ƒåº¦</h3><p>å‡è®¾æœ‰ä¸€ä¸ªç£ç›˜é˜Ÿåˆ—ï¼Œå…¶I/Oå¯¹å„ä¸ªæŸ±é¢ä¸Šå—çš„è¯·æ±‚é¡ºåºï¼š98, 183, 37, 122, 14, 124, 65, 67ï¼Œç£å¤´ä½äº53å·æŸ±é¢</p><p>å¯»é“è·ç¦»ï¼šå¯»é“é¡ºåºä¸‹ï¼Œç›¸é‚»é¡¹åºå·ä¹‹å·®çš„ç»å¯¹å€¼ä¹‹å’Œ</p><p>è°ƒåº¦æ—¶é—´=å¯»é“è·ç¦»Ã—å¹³å‡å¯»é“æ—¶é—´+æ—‹è½¬å»¶æ—¶Ã—æ—‹è½¬æ¬¡æ•°</p><h4 id="2-1-FCFS">2.1 FCFS</h4><p>å¯»é“é¡ºåºï¼š53-&gt;98-&gt;183-&gt;37-&gt;122-&gt;14-&gt;124-&gt;65-&gt;67</p><p>å¯»é“è·ç¦»ï¼š640</p><p><img src="https://source.cclmsy.cc/posts/notes/course/operating_system/image-7.png" alt="alt text"></p><h4 id="2-2-SSTF-æœ€çŸ­å¯»é“æ—¶é—´ä¼˜å…ˆ">2.2 SSTF æœ€çŸ­å¯»é“æ—¶é—´ä¼˜å…ˆ</h4><p>ä¼˜å…ˆå‰å¾€è·ç¦»å½“å‰ç£å¤´ä½ç½®æœ€è¿‘çš„è¯·æ±‚ã€‚</p><p>å¯»é“é¡ºåºï¼š53-&gt;65-&gt;67-&gt;37-&gt;14-&gt;98-&gt;122-&gt;124-&gt;183</p><p>å¯»é“è·ç¦»ï¼š236</p><p><img src="https://source.cclmsy.cc/posts/notes/course/operating_system/image-8.png" alt="alt text"></p><h4 id="2-3-SCAN-æ‰«æç®—æ³•">2.3 SCAN æ‰«æç®—æ³•</h4><p>ç£è‡‚ä¸›ç£ç›˜çš„ä¸€ç«¯ç§»åŠ¨åˆ°å¦ä¸€ç«¯ï¼Œå½“ç£å¤´ç§»è¿‡æ¯ä¸ªæŸ±é¢æ—¶ï¼Œå¤„ç†è¯¥æŸ±é¢ä¸Šçš„è¯·æ±‚ï¼›åˆ°è¾¾å¦ä¸€ç«¯æ—¶è¿”å›å¹¶ä¾æ¬¡å¤„ç†æŸ±é¢ä¸Šçš„è¯·æ±‚ã€‚</p><p>å¯»é“é¡ºåºï¼š53-&gt;37-&gt;14-&gt;(0)-&gt;65-&gt;67-&gt;98-&gt;122-&gt;124-&gt;183</p><p>å¯»é“è·ç¦»ï¼š208+28(åˆ°è¾¾0é€ æˆçš„å¤šä½™å¯»é“è·ç¦»)=236</p><p><img src="https://source.cclmsy.cc/posts/notes/course/operating_system/image-9.png" alt="alt text"></p><h4 id="2-4-C-SCAN-å¾ªç¯æ‰«æç®—æ³•">2.4 C-SCAN å¾ªç¯æ‰«æç®—æ³•</h4><p>æä¾›æ›´åŠ å‡åŒ€çš„ç­‰å¾…æ—¶é—´ï¼Œç£å¤´ç§»åŠ¨åˆ°å¦ä¸€ç«¯åç«‹å³è¿”å›ç£ç›˜å¼€å§‹ï¼Œè¿”å›æ—¶ä¸å¤„ç†è¯·æ±‚ã€‚</p><p>å¯»é“é¡ºåºï¼š53-&gt;65-&gt;67-&gt;98-&gt;122-&gt;124-&gt;183-&gt;(199)-&gt;(0)-&gt;14-&gt;37</p><p>å¯»é“è·ç¦»ï¼š382</p><p><img src="https://source.cclmsy.cc/posts/notes/course/operating_system/image-10.png" alt="alt text"></p><h4 id="2-5-LOOK-C-LOOK-è°ƒåº¦ç®—æ³•">2.5 LOOK/C-LOOK è°ƒåº¦ç®—æ³•</h4><p>å’ŒSCAN/C-SCANå¯¹åº”ï¼ŒLOOKè°ƒåº¦ç®—æ³•åªæ‰«æåˆ°æœ€åä¸€ä¸ªè¯·æ±‚çš„æŸ±é¢ï¼Œç„¶åè¿”å›ã€‚</p><p>C-LOOKå¯»é“é¡ºåºï¼š53-&gt;65-&gt;67-&gt;98-&gt;122-&gt;124-&gt;183-&gt;14-&gt;37</p><p>å¯»é“è·ç¦»ï¼š322</p><p><img src="https://source.cclmsy.cc/posts/notes/course/operating_system/image-11.png" alt="alt text"></p><h2 id="åä¸‰ã€I-Oç³»ç»Ÿ">åä¸‰ã€I/Oç³»ç»Ÿ</h2><h3 id="1-I-Oç¡¬ä»¶">1. I/Oç¡¬ä»¶</h3><ol><li>è½®è¯¢ï¼ˆPollingï¼‰ï¼šI/Oè®¾å¤‡ä¼ è¾“æ•°æ®æ—¶CPUå¤„äºå¿™ç­‰çŠ¶æ€ï¼ŒCPUä¸æ–­æ£€æŸ¥è®¾å¤‡çŠ¶æ€ï¼Œç›´åˆ°è®¾å¤‡å‡†å¤‡å¥½æ•°æ®ã€‚<ul><li>å¹¶å‘æ€§å·®ã€I/Oæ•ˆç‡ä½ã€‚</li></ul></li><li>ä¸­æ–­ï¼ˆInterruptï¼‰ï¼šI/Oè®¾å¤‡ä¼ è¾“æ•°æ®æ—¶ï¼ŒCPUå¯ä»¥ä¸ºå…¶å®ƒè¿›ç¨‹æœåŠ¡ï¼Œæ¯ä¼ è¾“å®Œä¸€ä¸ªå­—èŠ‚ï¼Œç”±I/Oè®¾å¤‡å‘CPUå‘é€ä¸­æ–­è¯·æ±‚ä¿¡å·ã€‚<ul><li>å¹¶å‘æ€§å¥½ï¼Œä¼ é€å¤§æ‰¹æ•°æ®æ—¶I/Oæ•ˆç‡ä½ã€‚</li><li>é€‚ç”¨äºä½é€Ÿå¤–è®¾ï¼Œå¦‚é”®ç›˜ã€é¼ æ ‡ç­‰</li></ul></li><li>å†…å­˜ç›´æ¥è®¿é—®(DMA)ï¼šCPUæä¾›æºåœ°å€ã€ç›®æ ‡åœ°å€ä»¥åŠå­—èŠ‚æ•°ï¼Œå®Œæˆæ•´å—æ•°æ®ä¼ è¾“åäº§ç”Ÿä¸€æ¬¡ä¸­æ–­<ul><li>å¹¶å‘æ€§å¥½ï¼Œå¯ä¸€æ¬¡æ€§ä¼ é€å¤§æ‰¹æ•°æ®ï¼Œæ•ˆç‡é«˜</li><li>é€‚ç”¨äºé«˜é€Ÿå¤–è®¾ï¼Œå¦‚ç£ç›˜ã€ç½‘ç»œç­‰</li></ul></li></ol><h3 id="2-ä¸­æ–­å’Œé™·é˜±">2. ä¸­æ–­å’Œé™·é˜±</h3><p>ä¸­æ–­ï¼šæ“ä½œç³»ç»Ÿä¸­å‘ç”ŸæŸä¸€äº‹ä»¶æ—¶ï¼Œç¡¬ä»¶å°†è§¦å‘ä¸€ä¸ªä¸­æ–­ï¼Œä¸­æ–­ä¿¡å·é€šè¿‡ä¸­æ–­å‘é‡å°†æ§åˆ¶ç¨‹åºè½¬ç§»åˆ°åˆé€‚çš„ç»ˆç«¯æœåŠ¡ç¨‹åºï¼Œä»¥æ”¹å˜CPUçš„æ‰§è¡Œè¿‡ç¨‹</p><p>é™·é˜±ï¼šé™·é˜±æ˜¯ç”±è½¯ä»¶äº§ç”Ÿçš„ï¼Œä¸€èˆ¬ç”±ç”¨æˆ·è¯·æ±‚æˆ–è€…é”™è¯¯å¼•èµ·ï¼Œä¸»è¦ç”¨äºè°ƒç”¨æ“ä½œç³»ç»ŸæœåŠ¡æˆ–è€…æ•æ‰ç®—æ³•é”™è¯¯ã€‚</p>]]></content>
    
    
    <summary type="html">æ“ä½œæ“ä½œç³»ç»Ÿæ“ä½œè®¡ç®—æœºå®Œæˆæ“ä½œï¼ˆä¹</summary>
    
    
    
    <category term="è¯¾ç¨‹ç¬”è®°" scheme="https://www.cclmsy.cc/categories/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="è¯¾ç¨‹ç¬”è®°" scheme="https://www.cclmsy.cc/tags/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>è®ºæ–‡ç¬”è®°|MLLM-as-a-Judge for Image Safety without Human Labeling</title>
    <link href="https://www.cclmsy.cc/posts/2501.00192.html"/>
    <id>https://www.cclmsy.cc/posts/2501.00192.html</id>
    <published>2025-06-13T16:00:00.000Z</published>
    <updated>2025-07-21T05:57:26.023Z</updated>
    
    <content type="html"><![CDATA[<p>è®ºæ–‡ï¼š<a href="https://arxiv.org/abs/2501.00192">MLLM-as-a-Judge for Image Safety without Human Labeling</a></p><h2 id="1-Introduction">1. Introduction</h2><p>æ–¹å‘ï¼šImage Safety Judgmentï¼ˆå›¾åƒå®‰å…¨æ€§åˆ¤æ–­ï¼‰</p><p>ç°æœ‰æ–¹æ¡ˆï¼ˆTraditional Classiferã€MLLMï¼‰æåº¦ä¾èµ–äººå·¥æ ‡æ³¨æ•°æ®ï¼Œæœ‰æ•ˆä½†è€—è´¹æ—¶é—´å’Œèµ„æº</p><p>ä¸€ç§â€œ<strong>åˆ©ç”¨é¢„è®­ç»ƒMLLMçš„èƒ½åŠ›ï¼Œæ ¹æ®ä¸€å¥—å®‰å…¨è§„åˆ™ï¼Œä»¥0-Shotæ–¹å¼åˆ¤æ–­å›¾åƒå®‰å…¨æ€§</strong>â€çš„æ–¹æ¡ˆå—åˆ°å…³æ³¨ã€‚</p><p>å¯¹MLLMè¿›è¡Œå®‰å…¨æ€§è§„åˆ™æŸ¥è¯¢ä¸è¶³ä»¥å®ç°å¯é çš„å®‰å…¨æ€§æ£€æµ‹ï¼ŒåŸå› æœ‰ä»¥ä¸‹ä¸‰ç‚¹ï¼š</p><ol><li><strong>å®‰å…¨æ€§è§„åˆ™æè¿°æ¨¡ç³Šæˆ–å…·æœ‰ä¸»è§‚æ€§</strong>ã€‚æ ·ä¾‹è¯¢é—®â€œä¸é€‚åˆå…¬ä¼—è§‚çœ‹çš„å†…å®¹â€æè¿°ç¬¼ç»Ÿï¼Œä¸åŒäººå¯¹â€œä¸é€‚åˆâ€çš„ç†è§£å¯èƒ½ä¸åŒ</li><li><strong>å½“å‰çš„MLLMéš¾ä»¥æ¨ç†å¤æ‚å†—é•¿çš„å®‰å…¨æ€§è§„åˆ™</strong>ã€‚æ ·ä¾‹è¯¢é—®åŒ…å«2ä¸ªåˆ†å¥25ä¸ªè‹±æ–‡å•è¯ï¼ŒMLLMå¯èƒ½æ— æ³•å®Œå…¨ç†è§£</li><li><strong>MLLMå­˜åœ¨å›ºæœ‰åå·®</strong>ã€‚æ ·ä¾‹è¯¢é—®â€œæ˜¯å¦æœ‰å–‰éƒ¨ä¼¤å£â€œï¼Œå³ä½¿å›¾ç‰‡ä¸­åªæœ‰åœ°é¢å’Œæ¯›å‘ä¸Šæœ‰è¡€è¿¹ï¼ŒMLLMä¹Ÿå¯èƒ½ä¼šé”™è¯¯åœ°è®¤ä¸ºæœ‰å–‰éƒ¨ä¼¤å£</li></ol><p><img src="https://source.cclmsy.cc/posts/notes/papers/2501.00192/image.png" alt="alt text"></p><p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæœ¬æ–‡æå‡ºäº†<strong>CLUE</strong>ï¼ˆ<strong>C</strong>ontrastive M<strong>L</strong>LM J<strong>u</strong>dg<strong>e</strong>ï¼‰ï¼Œæ˜¾è‘—æé«˜äº†MLLM 0-Shot Image Safety Judgeçš„æœ‰æ•ˆæ€§</p><ol><li>å°†å®‰å…¨æ€§è§„åˆ™<strong>å®¢è§‚åŒ–</strong>ï¼Œè½¬åŒ–ä¸ºMLLMå¯ä»¥æœ‰æ•ˆå¤„ç†çš„å®¢è§‚ã€å¯è¡Œçš„è§„åˆ™</li><li>ä¸€æ¬¡æ£€æŸ¥ä¸€ä¸ªè§„åˆ™<ul><li>ä¸ºäº†å¤„ç†å¤æ‚æˆ–å†—é•¿çš„è§„åˆ™ï¼Œæ¯æ¡è§„åˆ™è½¬åŒ–ä¸ºä¸€ç»„é€»è¾‘ä¸Šå®Œæ•´çš„<strong>å‰ææ¡ä»¶é“¾</strong></li><li>ä¸ºäº†åŠ å¿«æ‰€æœ‰è§„åˆ™çš„è¿­ä»£è¿‡ç¨‹ï¼Œé‡‡ç”¨<strong>å¤šæ¨¡æ€å¯¹æ¯”æ¨¡å‹</strong>ï¼ˆå¦‚CLIPï¼‰è¡¡é‡è§„åˆ™å’Œå›¾åƒçš„ç›¸å…³æ€§</li></ul></li><li>è¿›è¡Œ<strong>å»åæ ‡è®°æ¦‚ç‡åˆ†æï¼ˆdebiased token probability analysisï¼‰</strong>ï¼Œä½¿ç”¨å»åæ¦‚ç‡é¢„æµ‹ç»“æœ<ul><li>å‡å°‘ç”±è¯­è¨€å…ˆéªŒå’Œéå›¾åƒä¸­å¿ƒåŒºåŸŸé€ æˆçš„åå·®</li></ul></li></ol><p>å½“æ ‡è®°æ¦‚ç‡åˆ†æç½®ä¿¡åº¦ä½æ—¶ï¼ŒCLUEä¼šä½¿ç”¨æ€ç»´é“¾è¿›è¡Œæ·±å…¥æ¨ç†ã€‚</p><h2 id="2-BG">2. BG</h2><ol><li>Image Content Safety å›¾åƒå†…å®¹å®‰å…¨</li><li>Safety Judge Model å®‰å…¨æ€§åˆ¤æ–­æ¨¡å‹<ul><li>æœ€åˆçš„ä¼ ç»Ÿåˆ†ç±»å™¨ï¼ˆTraditional Classifierï¼‰ã€æœ€è¿‘çš„å¾®è°ƒLLM<ul><li>å±€é™ï¼šäººå·¥æ ‡æ³¨è€—æ—¶ä¸”æ˜‚è´µ</li></ul></li><li>è¿‘æœŸï¼š0-shot MLLMï¼ˆMultimodal Large Language Modelï¼‰<ul><li>æ€§èƒ½ä¸ä»¤äººæ»¡æ„</li></ul></li></ul></li></ol><h2 id="3-Method">3. Method</h2><h3 id="é—®é¢˜æ¨¡å‹">é—®é¢˜æ¨¡å‹</h3><p>ç»™å®šä¸€å¼ å›¾åƒ$x$å’Œä¸€ç»„å®‰å…¨æ€§è§„åˆ™$G$ï¼Œæœ‰ä»¥ä¸‹2ä¸ªç›®æ ‡ï¼š</p><ol><li>ç¡®å®šå›¾åƒ$x$æ˜¯å¦è¿åäº†$G$ä¸­çš„ä»»ä½•è§„åˆ™</li><li>æä¾›è¯†åˆ«å‡ºçš„è¿åè§„åˆ™çš„åˆ—è¡¨</li></ol><p>è¡¨ç¤ºä¸ºï¼š$A(x,G)\rightarrow(s,R)$</p><ul><li>$s$ï¼šè¯†åˆ«ç»“æœï¼ˆå®‰å…¨/ä¸å®‰å…¨ï¼‰</li><li>$R$ï¼šè¿åçš„å…·ä½“å®‰å…¨è§„åˆ™</li></ul><h3 id="3-1-Rules-Objectification-è§„åˆ™å®¢è§‚åŒ–">3.1 Rules Objectification è§„åˆ™å®¢è§‚åŒ–</h3><p>å°†LLMä½œä¸ºä¼˜åŒ–å™¨ï¼ˆLLM-as-an-Optimizerï¼‰å¯¹è§„åˆ™è¿›è¡Œå®¢è§‚åŒ–ã€‚</p><p>è®©LLMå¯¹æ¯æ¡è§„åˆ™è¿›è¡Œ1~10åˆ†çš„æ‰“åˆ†ï¼Œä¿®æ”¹åˆ†æ•°ä½äºé˜ˆå€¼ï¼ˆ9ï¼‰çš„è§„åˆ™ï¼Œç›´åˆ°è¾¾åˆ°9åˆ†ã€‚</p><p>LLMå®¢è§‚æ€§è¯„ä¼°Promptï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/2501.00192/image-1.png" alt="alt text"></p><p>åŸå§‹è§„åˆ™é›†ï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/2501.00192/image-2.png" alt="alt text"></p><p>å®¢è§‚åŒ–åçš„è§„åˆ™é›†ï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/2501.00192/image-3.png" alt="alt text"></p><p>ä»¥ç¬¬4æ¡ä¸ºä¾‹ï¼Œâ€œæŒ¨ç€å¦ä¸€ä¸ªäººèººåœ¨åºŠä¸Šçš„äººâ€çš„7åˆ†æè¿°ä¿®æ”¹ä¸ºâ€œä¸¤ä¸ªäº’ç›¸æ¥è§¦çš„äººèººåœ¨åºŠä¸Šâ€çš„9åˆ†æè¿°â€</p><h3 id="3-2-Relevance-Scanning-ç›¸å…³æ€§æ‰«æ">3.2 Relevance Scanning ç›¸å…³æ€§æ‰«æ</h3><p>MLLMå¤„ç†å¤æ‚ç»“æ„æ—¶æ¨ç†èƒ½åŠ›æœ‰é™ï¼Œä¸èƒ½æŠŠæ‰€æœ‰è§„åˆ™ä¸€æ¬¡æ€§è¾“å…¥ã€‚<br>å°è¯•æšä¸¾è§„åˆ™è¾“å…¥ï¼Œä½†æ˜¯æ•ˆç‡ä¸é«˜ï¼Œè€Œä¸”å¾ˆå¤šè§„åˆ™å¯èƒ½å’Œå›¾ç‰‡æ— å…³ã€‚<br>å› æ­¤ï¼Œéœ€è¦è¿‡æ»¤æ‰ä¸å›¾åƒæ— å…³çš„è§„åˆ™ï¼Œå‡å°‘MLLMçš„å·¥ä½œé‡ä»¥æé«˜æ•ˆç‡ã€‚</p><p>CLUEä½¿ç”¨äº†é¢„è®­ç»ƒçš„æ–‡æœ¬å›¾åƒç¼–ç å™¨CLIPï¼Œé€šè¿‡è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦æ¥è¡¡é‡è§„åˆ™å’Œå›¾åƒçš„ç›¸å…³æ€§ã€‚</p><p>æ»¡è¶³$$cos(I(x),TÂ®)&gt;t$$çš„è§„åˆ™$r$è¢«è®¤ä¸ºä¸å›¾åƒ$x$ç›¸å…³</p><ul><li>$I(x)$ï¼šå›¾åƒ$x$çš„CLIPç¼–ç </li><li>$TÂ®$ï¼šè§„åˆ™$r$çš„CLIPç¼–ç </li><li>$t$ï¼šé˜ˆå€¼</li></ul><p>ä½¿ç”¨ç¼–ç å™¨çš„å¥½å¤„ï¼šé€Ÿåº¦ï¼ˆæ¯”MLLMï¼‰æ˜æ˜¾å¿«ï¼Œå› ä¸ºå’ŒMLLMæ•°åäº¿çš„å‚æ•°æ•°é‡ç›¸æ¯”ï¼ŒEncoderçš„å¤§å°è¦å°å¾—å¤š</p><p>å®éªŒè¯æ˜ï¼Œtè®¾ç½®ä¸º0.22æ—¶ï¼Œèƒ½å¤Ÿè¿‡æ»¤æ‰67%çš„ä¸ç›¸å…³è§„åˆ™ï¼ŒåŒæ—¶ä¿ç•™96.6%çš„å®é™…è¿è§„è§„åˆ™</p><h3 id="3-3-Precondition-Extraction-å‰ææ¡ä»¶æå–">3.3 Precondition Extraction å‰ææ¡ä»¶æå–</h3><p>è‡ªåŠ¨å°†æ¯æ¡è§„åˆ™è½¬åŒ–ä¸ºä¸€ç»„é€»è¾‘ä¸Šå®Œæ•´çš„å‰ææ¡ä»¶é“¾ï¼Œä¾¿äºMLLMæ›´å¥½åœ°ç†è§£å¤„ç†ã€‚</p><p>ä¾‹å¦‚â€œä¸åº”æç»˜äººç‰©æˆ–åŠ¨ç‰©èº«ä½“ä¸Šå¸¦æœ‰æ¸…æ™°å¯è§ã€è¡€è…¥ä¸”å¯èƒ½ä¼šå¯¼è‡´å…¶ç«‹å³æ­»äº¡çš„ä¼¤å®³â€è¢«è½¬åŒ–ä¸ºï¼š</p><ol><li>å›¾ä¸­æœ‰å¯è§çš„äºº OR å›¾ä¸­æœ‰å¯è§çš„åŠ¨ç‰©</li><li>èº«ä½“å¸¦æœ‰æ¸…æ™°å¯è§çš„è¡€è…¥ä¼¤å®³</li><li>ä¼¤å®³å¯èƒ½ä¼šå¯¼è‡´å…¶ç«‹å³æ­»äº¡</li></ol><p><img src="https://source.cclmsy.cc/posts/notes/papers/2501.00192/image-4.png" alt="alt text"></p><p>LLMå‰ææ¡ä»¶æå–Promptï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/2501.00192/image-5.png" alt="alt text"></p><h3 id="3-4-Debiased-Token-Probability-Analysis-å»åæ ‡è®°æ¦‚ç‡åˆ†æ">3.4 Debiased Token Probability Analysis å»åæ ‡è®°æ¦‚ç‡åˆ†æ</h3><p>ç»™å®šMLLM $\mathcal{M}$ã€å›¾åƒ$x$å’Œå‰ææ¡ä»¶$c$ï¼Œæˆ‘ä»¬å°†å‰ææ¡ä»¶å¾—åˆ†è®°ä¸ºï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/2501.00192/image-6.png" alt="alt text"></p><p>ä¹Ÿå°±æ˜¯é¢å¯¹å›¾åƒ$x$ï¼ŒMLLMå¯¹å‰ææ¡ä»¶$c$æ ‡è®°ä¸ºâ€œYesâ€çš„æ¦‚ç‡ã€‚</p><p>å¦‚æœé«˜äºä¸€å®šå€¼ï¼Œåˆ™è®¤ä¸ºå›¾åƒ$x$æ»¡è¶³äº†å‰ææ¡ä»¶$c$ã€‚</p><p>ä¸€ä¸ªç›´è§‚çš„æƒ³æ³•æ˜¯æŠŠé˜ˆå€¼è®¾ä¸º0.5ï¼Œä½†è¿™ä¸ªæ–¹æ³•å­˜åœ¨é—®é¢˜ã€‚</p><p>MLLMå…·æœ‰token probability biasï¼ˆæ ‡è®°æ¦‚ç‡åå·®ï¼‰ï¼Œå³ææ–™æœ¬èº«çš„å«ä¹‰æˆ–å±æ€§ä¼šå¯¹æ¨¡å‹çš„è¾“å‡ºäº§ç”Ÿè¯¯å¯¼ã€‚</p><h4 id="3-4-1-Bias-from-Language-Prior-è¯­è¨€å…ˆéªŒåå·®">3.4.1 Bias from Language Prior è¯­è¨€å…ˆéªŒåå·®</h4><p>ç ”ç©¶è¡¨æ˜ï¼ŒMLLMçš„æ ‡è®°æ¦‚ç‡ä¼šå—åˆ°æ¨¡å‹è¯­è¨€å…ˆéªŒçš„å½±å“ã€‚</p><p>åœ¨InternVL2-76Bä¸Šï¼Œå¤§éƒ¨åˆ†å›¾åƒå¯¹äºâ€œè¡€è…¥ä¼¤å®³å¯èƒ½ä¼šå¯¼è‡´å…¶ç«‹å³æ­»äº¡â€çš„â€œYesâ€æ ‡è®°æ¦‚ç‡éƒ½å¾ˆä½ï¼Œå› ä¸ºæ ¹æ®è®­ç»ƒæ•°æ®ï¼Œè¿™ç§å†…å®¹é€šå¸¸ä¸ä¼šå‡ºç°åœ¨å›¾åƒä¸­ã€‚</p><p>è§£å†³ç­–ç•¥ï¼šè¡¡é‡æœ‰æ— å›¾åƒtokenæŸ¥è¯¢ä¹‹é—´çš„å¾—åˆ†å·®å¼‚ã€‚</p><p>$$<br>\mathcal{M}(x, c) - \mathcal{M}(None, c)<br>$$</p><ul><li>ä½äº0ï¼Œåˆ™å›¾åƒ$x$å¾ˆå¯èƒ½ä¸æ»¡è¶³å‰ææ¡ä»¶$c$ï¼›</li><li>æ˜æ˜¾é«˜äº0ï¼Œå›¾åƒ$x$ææœ‰å¯èƒ½æ»¡è¶³å‰ææ¡ä»¶$c$</li></ul><h4 id="3-4-2-Bias-from-Image-æ¥è‡ªå›¾åƒçš„åå·®">3.4.2 Bias from Image æ¥è‡ªå›¾åƒçš„åå·®</h4><p>å›¾åƒçš„éæ ¸å¿ƒéƒ¨åˆ†ä¹Ÿä¼šå¸¦æ¥å¼ºçƒˆçš„åå·®ã€‚</p><p>æ¯”å¦‚å›¾åƒä¸­çš„äººä¸ŠåŠèº«è£¸ä½“ï¼ŒMLLMå¯¹æé—®â€œè¿™ä¸ªäººè£¸éœ²è‡€éƒ¨â€çš„â€œYesâ€æ ‡è®°æ¦‚ç‡ä¼šå¾ˆé«˜ï¼Œå› ä¸ºæ ¹æ®è®­ç»ƒæ•°æ®ï¼Œä¸ŠåŠèº«è£¸éœ²å’Œè‡€éƒ¨è£¸éœ²å…·æœ‰è¾ƒå¼ºçš„ç›¸å…³æ€§ã€‚</p><p>è§£å†³ç­–ç•¥ï¼šè¡¡é‡æ•´å¹…å›¾åƒå’Œåˆ é™¤å›¾åƒæ ¸å¿ƒåŒºåŸŸ$i$åå›¾åƒä¹‹é—´çš„å¾—åˆ†å·®å¼‚</p><p>$$<br>\mathcal{M}(x, c) - \mathcal{M}(x \ominus i, c)<br>$$</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/2501.00192/image-7.png" alt="alt text"></p><ul><li>ä½¿ç”¨æœ€å…ˆè¿›çš„å¼€æ”¾è¯æ±‡å¯¹è±¡æ£€æµ‹å™¨OWLv2</li><li>æ˜æ˜¾é«˜äº0ï¼Œä¸”å¯¹è±¡æ£€æµ‹è¾¹ç•Œæ¡†ç½®ä¿¡åº¦è¾ƒé«˜ï¼ˆ0.05ï¼‰ï¼Œå›¾åƒ$x$ææœ‰å¯èƒ½æ»¡è¶³å‰ææ¡ä»¶$c$</li></ul><h3 id="3-5-Reasoning-based-Judgment">3.5 Reasoning-based Judgment</h3><p>å¦‚æœåŸºäºå»åæ ‡è®°æ¦‚ç‡åˆ†æçš„ç½®ä¿¡åº¦ä¸å¤Ÿï¼ŒCLUEä¼šé‡‡ç”¨åŸºäºæ¨ç†çš„åˆ¤æ–­ã€‚</p><p>åˆ†ä¸º2æ­¥ï¼š</p><ol><li><strong>æ€ç»´é“¾ç”Ÿæˆ</strong><ul><li>ä½¿ç”¨LLMç”Ÿæˆæ€ç»´é“¾ï¼Œæ¨ç†å›¾åƒæ˜¯å¦æ»¡è¶³å‰ææ¡ä»¶</li><li>å¯¹æ ¼å¼ä¸åšè¦æ±‚</li></ul></li><li><strong>æ ¼å¼åŒ–</strong>ï¼šä»¥Jsonæ ¼å¼è¾“å‡ºé¢„æµ‹ç»“æœå’Œç†ç”±</li></ol><p>å“åº”é€Ÿåº¦æ…¢ï¼Œä½†åœ¨ä¹‹å‰æ­¥éª¤ç½®ä¿¡åº¦ä¸è¶³çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æä¾›æ›´å¯é çš„ç»“æœã€‚</p><h3 id="3-6-Algorithm">3.6 Algorithm</h3><p><img src="https://source.cclmsy.cc/posts/notes/papers/2501.00192/image-8.png" alt="alt text"></p><h2 id="4-ä¸ªäººæ€è€ƒ">4. ä¸ªäººæ€è€ƒ</h2><h3 id="4-1-è®ºæ–‡äº®ç‚¹">4.1 è®ºæ–‡äº®ç‚¹</h3><h4 id="4-1-1-æ‘†è„±å¯¹äººå·¥æ ‡æ³¨çš„ä¾èµ–">4.1.1 æ‘†è„±å¯¹äººå·¥æ ‡æ³¨çš„ä¾èµ–</h4><ol><li>é‡‡ç”¨0-Shotæ–¹å¼ï¼Œä¸éœ€è¦äººå·¥æ ‡æ³¨æ•°æ®</li><li>æ‰©å±•æ€§ã€é€‚åº”æ€§å¼ºï¼Œå¦‚æœå®‰å…¨è§„åˆ™å‘ç”Ÿå˜åŒ–ï¼Œåªéœ€è¦æ›´æ–°è§„åˆ™é›†ï¼Œæ— éœ€é‡æ–°æ ‡æ³¨æ•°æ®ã€å¾®è°ƒæ¨¡å‹</li><li>è¡¨ç°ä¼˜å¼‚ï¼šç»“æœè¿œé«˜äºbaselineï¼ˆä¸è®ºæ˜¯0-Shotè¿˜æ˜¯åŸºäºfine-tuningçš„æ–¹æ³•ï¼‰</li></ol><h3 id="4-1-2-æ´å¯Ÿä¸è§£å†³MLLMçš„åå·®é—®é¢˜">4.1.2 æ´å¯Ÿä¸è§£å†³MLLMçš„åå·®é—®é¢˜</h3><ol><li>ä½œè€…æ´å¯Ÿåˆ°Pre-trained MLLMåœ¨å¤„ç†å›¾åƒå®‰å…¨æ€§åˆ¤æ–­æ—¶å­˜åœ¨åå·®é—®é¢˜</li><li>æå‡ºäº†å»åæ ‡è®°æ¦‚ç‡åˆ†æï¼ˆdebiased token probability analysisï¼‰çš„æ–¹æ³•ï¼Œé’ˆå¯¹è¯­è¨€å…ˆéªŒå’Œå›¾åƒéæ ¸å¿ƒåŒºåŸŸåˆ†åˆ«è¿›è¡Œå»åå¤„ç†</li></ol><h3 id="4-1-3-è§„åˆ™å®¢è§‚åŒ–ä¸å‰ææ¡ä»¶æå–">4.1.3 è§„åˆ™å®¢è§‚åŒ–ä¸å‰ææ¡ä»¶æå–</h3><ol><li>è€ƒè™‘äº†å®‰å…¨è§„åˆ™æè¿°å¯èƒ½å…·æœ‰æ¨¡ç³Šæ€§å’Œä¸»è§‚æ€§çš„é—®é¢˜</li><li>é€šè¿‡LLMå¯¹è§„åˆ™è¿›è¡Œå®¢è§‚åŒ–å¤„ç†ï¼Œç¡®ä¿è§„åˆ™æè¿°æ¸…æ™°ã€å¯æ“ä½œ</li><li>å¯¹è§„åˆ™è¿›è¡Œå‰ææ¡ä»¶æå–ï¼Œå°†å¤æ‚è§„åˆ™è½¬åŒ–ä¸ºé€»è¾‘ä¸Šå®Œæ•´çš„å‰ææ¡ä»¶é“¾ï¼Œä¾¿äºMLLMå¤„ç†</li></ol><h3 id="4-1-4-å¤šé˜¶æ®µæ¨ç†æµç¨‹">4.1.4 å¤šé˜¶æ®µæ¨ç†æµç¨‹</h3><ol><li>é€šè¿‡ç›¸å…³æ€§æ‰«æè¿‡æ»¤ä¸ç›¸å…³è§„åˆ™ï¼Œå‡å°‘MLLMçš„å·¥ä½œé‡</li><li>åœ¨å»åæ ‡è®°æ¦‚ç‡åˆ†æç½®ä¿¡åº¦ä¸è¶³æ—¶ï¼Œé‡‡ç”¨æ€ç»´é“¾è¿›è¡Œæ·±å…¥æ¨ç†ï¼Œç»“åˆäº†ä¸¤è€…çš„ä¼˜åŠ¿</li></ol><h2 id="4-2-è®ºæ–‡å­˜åœ¨çš„é—®é¢˜">4.2 è®ºæ–‡å­˜åœ¨çš„é—®é¢˜</h2><h3 id="4-2-1-è§„åˆ™å®¢è§‚åŒ–çš„å±€é™æ€§">4.2.1 è§„åˆ™å®¢è§‚åŒ–çš„å±€é™æ€§</h3><ol><li>ä»…ä½¿ç”¨ç®€çŸ­çš„Promptæç¤ºLLMè¿›è¡Œ1~10åˆ†çš„è¯„åˆ†ï¼Œä½†å¹¶æ²¡æœ‰å…·ä½“çš„è¯„åˆ†æ ‡å‡†æˆ–ç¤ºä¾‹ï¼Œå¯èƒ½å¯¼è‡´è¯„åˆ†ç»“æœä¸ä¸€è‡´</li><li>ä¸èƒ½ä¿è¯LLMçš„è¯„åˆ†å°±æ˜¯å®¢è§‚å‡†ç¡®çš„ã€‚<ul><li>LLMæœ¬èº«å°±å› è®­ç»ƒæ•°æ®ç­‰åŸå› å­˜åœ¨åå·®ï¼Œç”šè‡³å¯èƒ½äº§ç”Ÿå¹»è§‰</li><li>æ¯ä¸€æ¬¡è°ƒç”¨LLMçš„ç»“æœå¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œç¼ºä¹ä¸€è‡´æ€§</li></ul></li><li>LLMå¯èƒ½æ ¹æ®è‡ªå·±çš„ç†è§£å°†è§„åˆ™ä¿®æ”¹ä¸ºå­è§„åˆ™ï¼Œè€Œé—æ¼éƒ¨åˆ†æƒ…å†µï¼Œå½±å“åˆ¤æ–­ç»“æœ</li></ol><h3 id="4-2-2-æœªè€ƒè™‘MLLMå—å¯¹æŠ—æ”»å‡»çš„å½±å“">4.2.2 æœªè€ƒè™‘MLLMå—å¯¹æŠ—æ”»å‡»çš„å½±å“</h3><p>MLLMå·²è¢«è¯æ˜æ˜“å—å¯¹æŠ—æ€§æ”»å‡»ï¼šå°å¹…åº¦ä¿®æ”¹è¾“å…¥å›¾åƒï¼Œå¯¼è‡´æ¨¡å‹è¾“å‡ºé”™è¯¯çš„ç»“æœã€‚</p><p>ä¸€ç¯‡ç ”ç©¶<a href="https://arxiv.org/abs/2505.21494">ã€ŠAdversarial Attacks against Closed-Source MLLMs via Feature Optimal Alignmentã€‹</a>ç”šè‡³å¯ä»¥å¯¹é—­æºçš„MLLMè¿›è¡Œå¯¹æŠ—æ”»å‡»ã€‚</p><p>CLUEä¸­å°±å­˜åœ¨å¤šä¸ªå¯èƒ½è¢«å¯¹æŠ—æ”»å‡»çš„ç¯èŠ‚ï¼š</p><ol><li>CLIPç¼–ç å™¨çš„ç›¸å…³æ€§æ‰«æï¼šè®¾è®¡ä¸€ä¸ªä¸å®‰å…¨çš„å›¾åƒï¼Œå…¶å¯¹æŠ—æ€§æ‰°åŠ¨ä¸“é—¨é’ˆå¯¹CLIPæ¨¡å‹ ï¼Œä½¿å…¶å¯¹ç›¸å…³å®‰å…¨è§„åˆ™äº§ç”Ÿä½ç›¸å…³æ€§åˆ†æ•°ï¼Œä»è€Œå¯¼è‡´å¤§éƒ¨åˆ†ç›¸å…³è§„åˆ™è¢«è¿‡æ»¤æ‰ï¼Œè¿›è€Œå‡å°‘å›¾åƒè¢«åˆ¤æ–­ä¸ºä¸å®‰å…¨çš„å¯èƒ½æ€§</li><li>ç”±äºå‰ææ¡ä»¶æå–ï¼Œå¤æ‚è§„åˆ™è¢«åˆ†è§£ä¸ºå¤šä¸ªå‰ææ¡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥é’ˆå¯¹ä¸ªåˆ«æ¡ä»¶è¿›è¡Œå¯¹æŠ—æ€§æ‰°åŠ¨ï¼Œä½¿å¾—æŸäº›å‰ææ¡ä»¶çš„æ ‡è®°æ¦‚ç‡ä½äºé˜ˆå€¼</li></ol><h2 id="4-3-æ”¹è¿›æ€è·¯å’Œå»ºè®®">4.3 æ”¹è¿›æ€è·¯å’Œå»ºè®®</h2><h3 id="4-3-1-è§„åˆ™å®¢è§‚åŒ–çš„æ”¹è¿›">4.3.1 è§„åˆ™å®¢è§‚åŒ–çš„æ”¹è¿›</h3><ol><li>å¼•å…¥è¯„åˆ†æ ‡å‡†ï¼šä¸ºLLMè¯„åˆ†æä¾›æ˜ç¡®çš„æ ‡å‡†å’Œç¤ºä¾‹ï¼Œç¡®ä¿è¯„åˆ†çš„ä¸€è‡´æ€§å’Œå®¢è§‚æ€§</li><li>å¤šæ¨¡å‹å¹¶è¡Œå–å¹³å‡ï¼šæ ¹æ®åŒä¸€è§„åˆ™ï¼Œè°ƒç”¨å¤šä¸ªä¸åŒçš„LLMè¿›è¡Œè¯„åˆ†ï¼Œå–å¹³å‡å€¼ï¼Œå‡å°‘å•ä¸€æ¨¡å‹åå·®çš„å½±å“</li></ol><h3 id="4-3-2-å¢å¼ºå¯¹æŠ—æ”»å‡»çš„é˜²å¾¡">4.3.2 å¢å¼ºå¯¹æŠ—æ”»å‡»çš„é˜²å¾¡</h3><p>ä¸€ä¸ªå®ç”¨ã€å…è®­ç»ƒçš„æ–¹æ³•æ˜¯é‡‡ç”¨æ¨¡å‹é›†æˆã€‚<br>2020å¹´9æœˆçš„ä¸€ç¯‡è®ºæ–‡<a href="https://arxiv.org/abs/2009.09612">ã€ŠImproving Ensemble Robustness by Collaboratively Promoting and Demoting Adversarial Robustnessã€‹</a>æå‡ºåŸºäºé›†åˆçš„å¯¹æŠ—è®­ç»ƒæ˜¯å®ç°å¯¹æŠ—æ”»å‡»é²æ£’æ€§çš„ä¸€ç§æ–¹æ³•ã€‚</p><p>ä¾‹å¦‚ï¼Œè®©å¤šæ¬¾ä¸åŒçš„MLLMï¼ˆå¦‚InternVLã€LLaVAã€GPT-4Vï¼‰å¯¹åŒä¸€å¼ å›¾ç‰‡è¿›è¡Œåˆ¤æ–­ï¼Œå¹¶è¦æ±‚è¾¾æˆå…±è¯†ï¼Œè¿™å¯ä»¥æé«˜é²æ£’æ€§ï¼Œå› ä¸ºé’ˆå¯¹æŸä¸€æ¨¡å‹çš„æ”»å‡»å¯èƒ½æ— æ³•è¿ç§»åˆ°å…¶ä»–æ¨¡å‹ä¸Šã€‚</p>]]></content>
    
    
    <summary type="html">é˜…è¯»è®ºæ–‡ã€ŠMLLM-as-a-Judge for Image Safety without Human Labelingã€‹</summary>
    
    
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://www.cclmsy.cc/categories/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://www.cclmsy.cc/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    <category term="MLLLM" scheme="https://www.cclmsy.cc/tags/MLLLM/"/>
    
    <category term="CV" scheme="https://www.cclmsy.cc/tags/CV/"/>
    
  </entry>
  
  <entry>
    <title>è®ºæ–‡ç¬”è®°&amp;å®ç°|PlugIRï¼šåŸºäºå¯¹è¯çš„å›¾åƒæ£€ç´¢ç³»ç»Ÿ</title>
    <link href="https://www.cclmsy.cc/posts/2406.03411.html"/>
    <id>https://www.cclmsy.cc/posts/2406.03411.html</id>
    <published>2025-04-09T16:00:00.000Z</published>
    <updated>2025-07-21T05:38:29.270Z</updated>
    
    <content type="html"><![CDATA[<p>è®ºæ–‡ï¼š<a href="https://arxiv.org/abs/2406.03411">Interactive Text-to-ImageRetrieval with Large Language Models: A Plug-and-Play Approach</a></p><h2 id="1-Introduction">1. Introduction</h2><p>ChatIRæ˜¯ä¸€ç§åŸºäºèŠå¤©çš„æ–‡æœ¬åˆ°å›¾åƒçš„æ–¹æ³•ï¼Œæå‡ºäº†åˆ©ç”¨LLMè¿›è¡Œå¤šè½®å¯¹è¯ä»¥æé«˜æ£€ç´¢æ•ˆç‡ã€‚ï¼ˆæˆ‘çš„é˜…è¯»ç¬”è®°è§<a href="https://www.cclmsy.cc/posts/2305.20062.html">Link</a>ï¼‰</p><p>è¿™ä¸ªæ–¹æ³•å…·æœ‰ä»¥ä¸‹ä¸è¶³ï¼š</p><ol><li>éœ€è¦è¿›è¡Œå¾®è°ƒæ–‡æœ¬ç¼–ç å™¨ï¼Œæ¥é€‚åº”å¤šè½®å¯¹è¯æ•°æ®<ul><li>å¾®è°ƒè€—è´¹èµ„æºã€å¯æ‰©å±•æ€§å·®ã€‚</li><li>è§£å†³æ–¹æ³•ï¼šå°†å¯¹è¯é‡æ„ä¸ºå¯ä»¥ç›´æ¥è¾“å…¥åˆ°é¢„è®­ç»ƒçš„è§†è§‰è¯­è¨€æ¨¡å‹çš„æ ¼å¼ï¼Œä¸éœ€è¦å¯¹æ¨¡å‹è¿›è¡Œå¾®è°ƒ</li></ul></li><li>LLMæé—®è€…GåªçŸ¥é“å¯¹è¯å†å²ï¼Œæ— æ³•æŸ¥çœ‹å€™é€‰å›¾åƒ<ul><li>å¯èƒ½ç”Ÿæˆå›¾åƒä¸­ä¸å­˜åœ¨çš„å±æ€§çš„è¯¢é—®</li><li>LLMæé—®è€…åŸºäºå€™é€‰é›†æé—®ï¼Œç¡®ä¿é—®é¢˜ä¸å›¾åƒå±æ€§ç›¸å…³</li></ul></li></ol><p>æœ¬æ–‡æå‡ºçš„PlugIRç³»ç»ŸåŒ…å«2ä¸ªéƒ¨åˆ†ï¼šä¸Šä¸‹æ–‡é‡æ„ï¼ˆContext Reformulationï¼‰å’Œä¸Šä¸‹æ–‡æ„ŸçŸ¥å¯¹è¯ç”Ÿæˆï¼ˆContext-aware Dialogue Generationï¼‰</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/2406.03411/PlugIR.png" alt="PlugIR"></p><p>æœ¬æ–‡è´¡çŒ®ï¼š</p><ol><li>å®è¯0æ ·æœ¬æˆ–å¾®è°ƒçš„å¤§æ¨¡å‹éš¾ä»¥ç†è§£å¯¹è¯æ•°æ®</li><li>æå‡ºäº†ä¸€ç§LLMæé—®è€…ï¼Œè§£å†³äº†å› å†—ä½™é—®é¢˜å’Œå™ªå£°é—®é¢˜å¸¦æ¥çš„æ€§èƒ½ç“¶é¢ˆ</li><li>æå‡ºæ–°æŒ‡æ ‡BRIï¼ˆæœ€ä½³å¯¹æ•°æ’åç§¯åˆ†ï¼ŒBest log Rank Integralï¼‰<ul><li>æ¯”Recall@Kå’ŒHit@Kæ›´æ¥è¿‘äººçš„è¯„ä»·ï¼Œæ›´å…¨é¢åœ°è¯„ä¼°äº¤äº’å¼æ£€ç´¢ç³»ç»Ÿ</li></ul></li><li>PlugIRå…·æœ‰å³æ’å³ç”¨çš„ç‰¹æ€§ï¼Œä¸”å…·æœ‰å®ç”¨æ€§</li></ol><h2 id="2-Related-Work">2. Related Work</h2><ul><li>æ–‡æœ¬åˆ°å›¾åƒæ£€ç´¢</li><li>è§†è§‰è¯­è¨€æ¨¡å‹ï¼šBLIPã€CLIP</li><li>å¤§è¯­è¨€æ¨¡å‹LLM</li></ul><h2 id="3-Method">3. Method</h2><h3 id="3-1-Preliminaries-InteractiveText-to-Image-Retrieval-äº¤äº’å¼æ–‡æœ¬åˆ°å›¾åƒæ£€ç´¢">3.1 Preliminaries:InteractiveText-to-Image Retrieval äº¤äº’å¼æ–‡æœ¬åˆ°å›¾åƒæ£€ç´¢</h3><p>å¯¹è¯è®°å½•è¡¨ç¤ºï¼š$D_i = (C, Q_1, A_1, â€¦, Q_i)$</p><ul><li>$C$ï¼šç›®æ ‡å›¾åƒçš„åˆå§‹æ–‡æœ¬æè¿°ï¼ˆæ ‡é¢˜ï¼‰</li><li>$Q_i$ï¼šç¬¬iä¸ªé—®é¢˜</li><li>$A_i$ï¼šç¬¬iä¸ªå›ç­”</li></ul><p>æ£€ç´¢ç³»ç»Ÿå°†æ•°æ®åº“ä¸­çš„æ‰€æœ‰å›¾ç‰‡ä¸æ–‡æœ¬è¿›è¡ŒåŒ¹é…ï¼Œæ ¹æ®ç›¸ä¼¼åº¦è¿›è¡Œæ’åºï¼Œæ ¹æ®ç›®æ ‡æ’åè¯„ä¼°ç³»ç»Ÿæ€§èƒ½ã€‚</p><ul><li>Recall@Kï¼šæœ¬è½®äº¤äº’æ£€ç´¢åˆ°çš„å‰Kå¼ å›¾ç‰‡åŒ…å«ç›®æ ‡çš„æ¦‚ç‡</li><li>Hit@Kï¼šæœ¬è½®ä»¥åŠä»»æ„ä¸€è½®çš„äº¤äº’æ£€ç´¢åˆ°çš„å‰Kå¼ å›¾ç‰‡åŒ…å«ç›®æ ‡çš„æ¦‚ç‡</li></ul><h3 id="3-2-Context-Reformulation-ä¸Šä¸‹æ–‡é‡æ„">3.2 Context Reformulation ä¸Šä¸‹æ–‡é‡æ„</h3><p>ä½œè€…æµ‹è¯•äº†0æ ·æœ¬çš„CLIPã€BLIPã€BLIP-2å’Œä¸€ä¸ªé»‘ç®±æ¨¡å‹ATM</p><ul><li>Hit@Ké€æ­¥æå‡ï¼Œä½†è¿™æ˜¯ç”±å…¶å®šä¹‰å†³å®šçš„</li><li>Recall@Kåœ¨ä»…åŒ…å«æœ€åˆçš„æ–‡æœ¬æè¿°æ—¶æœ€é«˜ï¼Œéšç€å¯¹è¯è½®æ¬¡å¢åŠ è€Œä¸‹é™<ul><li>å¯¹è¯åœ¨0æ ·æœ¬æ¨¡å‹ä¸Šå¯èƒ½æ²¡æœ‰è´¡çŒ®ã€äº§ç”Ÿäº†å™ªå£°</li><li>0æ ·æœ¬æ¨¡å‹æ— æ³•ç†è§£å¯¹è¯æ•°æ®</li></ul></li></ul><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€ç§æ–¹æ³•æ˜¯åƒChatIRä¸€æ ·å¯¹æ¨¡å‹è¿›è¡Œå¾®è°ƒï¼Œä½†è¿™æ ·åšæœ‰ä»¥ä¸‹é™åˆ¶ï¼š</p><ol><li>ä¸èƒ½ä½¿ç”¨é»‘ç®±æ¨¡å‹ï¼Œæ¯”å¦‚ATM</li><li>éœ€è¦å¤§é‡çš„è®­ç»ƒæ•°æ®</li></ol><p>æœ¬æ–‡ä¸ç›´æ¥ä½¿ç”¨å¯¹è¯ä½œä¸ºè¾“å…¥è¿›è¡ŒæŸ¥è¯¢ï¼Œè€Œæ˜¯å°†å¯¹è¯é‡æ„ä¸ºå¯ä»¥ç›´æ¥è¾“å…¥åˆ°é¢„è®­ç»ƒçš„è§†è§‰è¯­è¨€æ¨¡å‹çš„æ ¼å¼ï¼Œä¸éœ€è¦å¯¹æ¨¡å‹è¿›è¡Œå¾®è°ƒï¼ˆå³æ‰€è°“çš„Plug-and-Playï¼‰ã€‚</p><h3 id="3-3-Context-aware-Dialogue-Generation-ä¸Šä¸‹æ–‡æ„ŸçŸ¥å¯¹è¯ç”Ÿæˆ">3.3 Context-aware Dialogue Generation ä¸Šä¸‹æ–‡æ„ŸçŸ¥å¯¹è¯ç”Ÿæˆ</h3><p>ä»…é å¯¹è¯å†å²ç”Ÿæˆé—®é¢˜å…·æœ‰ä»¥ä¸‹é—®é¢˜ï¼š</p><ol><li>ç”Ÿæˆçš„é—®é¢˜å¯èƒ½ä¸å›¾åƒå±æ€§æ— å…³</li><li>å¯èƒ½è¯¢é—®å†å²å¯¹è¯ä¸­å·²æœ‰ä¿¡æ¯</li></ol><p>æé—®è¿‡ç¨‹ï¼ˆç”¨äºè§£å†³é—®é¢˜1ï¼‰ï¼š</p><ol><li>ä½¿ç”¨é‡æ„åçš„æŸ¥è¯¢è¯­å¥è¿›è¡Œæ£€ç´¢ï¼Œæ‰¾å‡ºé«˜ç›¸ä¼¼åº¦çš„â€œæ£€ç´¢å€™é€‰â€å›¾åƒé›†</li><li>å¯¹å€™é€‰å›¾åƒEmbeddingsè¿›è¡ŒK-meansèšç±»ï¼Œå¾—åˆ°æ¯ä¸ªå€™é€‰å›¾åƒä¸å…¶ä»–å›¾åƒçš„ç›¸ä¼¼åº¦å¾—åˆ†åˆ†å¸ƒ</li><li>å¯¹äºæ¯ä¸ªèšç±»ï¼Œé€‰æ‹©<code>ç›¸ä¼¼åº¦åˆ†å¸ƒç†µ</code>æœ€å°çš„å›¾åƒä½œä¸ºä»£è¡¨<ul><li>ç†µè¶Šå°ï¼Œå±æ€§è¶ŠçœŸå®ã€è¶Šå®¹æ˜“åŒºåˆ†</li><li>ä¾‹å¦‚ï¼ŒåŒä¸€ç»„å›¾åƒå¯¹â€œä¸€å¼ é…æœ‰2å°ç”µè„‘æ˜¾ç¤ºå™¨å’Œä¸€å‰¯é”®ç›˜çš„æ¡Œå­â€çš„æè¿°ç†µæ›´ä½ï¼Œå¯¹â€œåŠå…¬å®¤â€çš„æè¿°ç†µæ›´é«˜</li></ul></li><li>å°†è¿™Kå‰¯å›¾åƒé€šè¿‡image2textæ¨¡å‹ç”Ÿæˆcaptionï¼Œä½œä¸ºé™„åŠ ä¿¡æ¯æä¾›ç»™LLMæé—®è€…</li></ol><p>æé—®ï¼ˆç®—æ³•1ï¼‰ä¼ªä»£ç ï¼š</p><ol><li>è¾“å…¥ï¼šå¯¹è¯ä¸Šä¸‹æ–‡$c$ã€å›¾åƒåº“$I$ã€â€œæ£€ç´¢å€™é€‰â€å›¾åƒæ•°$n$ã€èšç±»æ•°$m$ã€ç›¸ä¼¼åº¦å‡½æ•°$sim$ã€$KMeans$ã€i2tæ¨¡å‹$Captioning$</li><li>ä»$I$ä¸­é€‰å‡ºå‰$n$ä¸ªå’Œ$c$æœ€ç›¸ä¼¼çš„å›¾åƒï¼Œä½œä¸º$S_R$<ol><li>åˆå§‹åŒ–$S_R \leftarrow {}$</li><li>$while S_R.size() &lt; n do$<ol><li>å°†å’Œ$c$æœ€ç›¸ä¼¼çš„å›¾åƒ$x$åŠ å…¥$S_R$</li><li>å°†$x$ä»$I$ä¸­ç§»é™¤</li></ol></li></ol></li><li>å¯¹$S_R$è¿›è¡Œ$KMeans$èšç±»ï¼Œå¾—åˆ°$m$ä¸ªèšç±»$S_R^{(1)}, S_R^{(2)}, â€¦, S_R^{(m)}$</li><li>è®¡ç®—æ¯ä¸ªå›¾åƒç›¸å¯¹$S_R$çš„æ¦‚ç‡ï¼Œä½¿ç”¨Softmaxå¾—åˆ°$P_c(x)=\frac{exp(sim(c, x))}{\sum_{xâ€™ \in S_R} exp(sim(c, xâ€™))}$</li><li>ä»æ¯ä¸ªç°‡$S_R^{(i)}$ä¸­é€‰æ‹©æœ€ä¼˜çš„å›¾åƒï¼Œå¹¶å¯¹è¿™$m$ä¸ªå›¾åƒè¿›è¡Œ$Captioning$ï¼Œå¾—åˆ°$T$<ol><li>$for i in range(1,m+1) do$<ol><li>è®¡ç®—å½“å‰ç°‡$S_R^{(i)}$ä¸­æ‰€æœ‰å›¾åƒçš„ç†µï¼Œå¹¶æ‰¾å‡ºæœ€å°ç†µçš„å›¾åƒ$\hat x^{(i)}$</li><li>å¯¹$\hat x^{(i)}$è¿›è¡Œ$Captioning$ï¼Œå¹¶åŠ å…¥$T$</li></ol></li></ol></li><li>è¿”å›ï¼š$T$</li></ol><p>é‡‡ç”¨æ€ç»´é“¾ï¼ˆChain of Thoughtï¼‰çš„æ–¹æ³•ï¼Œæç¤ºè¯ä½äºåŸæ–‡18~19é¡µï¼Œè·å–ä¸å›¾åƒç›¸å…³çš„é—®é¢˜ã€‚<br>è¿™æ ·ç”Ÿæˆçš„é—®é¢˜ä»ç„¶å¯èƒ½å†—ä½™ï¼ˆå·²ç»çŸ¥é“ç­”æ¡ˆï¼‰ï¼Œè¿˜éœ€è¦ç»è¿‡è¿‡æ»¤ã€‚</p><p>è¿‡æ»¤è¿‡ç¨‹ï¼ˆç”¨äºè§£å†³é—®é¢˜2ï¼‰ï¼š</p><ol><li>é€šè¿‡ä¸Šä¸‹æ–‡å›ç­”å‡½æ•°ï¼Œåˆ¤æ–­é—®é¢˜æ˜¯å¦â€œç¡®å®šâ€ï¼Œé€‰å–â€œä¸ç¡®å®šâ€çš„é—®é¢˜</li><li>é€‰æ‹©â€œä¸ç¡®å®šâ€çš„é—®é¢˜ä¸­KLæ•£åº¦æœ€å°çš„é—®é¢˜<ol><li>KLæ•£åº¦ï¼š$KL(P_c||P_{c,q})=\sum_{x \in T} P_c(x)log\frac{P_c(x)}{P_{c,q}(x)}$</li><li>ç”¨äºé˜²æ­¢ä¸åˆé€‚çš„é—®é¢˜å¯¼è‡´ç›¸ä¼¼åº¦éª¤å˜</li></ol></li></ol><p>è¿‡æ»¤ï¼ˆç®—æ³•2ï¼‰ä¼ªä»£ç ï¼š</p><ol><li>è¾“å…¥ï¼šå¯¹è¯ä¸Šä¸‹æ–‡$c$ã€é—®é¢˜é›†åˆ$Q$ã€æ£€ç´¢å€™é€‰é›†$T$ã€ç›¸ä¼¼åº¦å‡½æ•°$sim$ã€ä¸Šä¸‹æ–‡å›ç­”å‡½æ•°$Answer$</li><li>å®šä¹‰è®¡ç®—ä¸Šä¸‹æ–‡æ¦‚ç‡åˆ†å¸ƒçš„å‡½æ•°<ol><li>å›¾åƒ$x$åœ¨ä¸Šä¸‹æ–‡$c$ä¸‹çš„åˆ†å¸ƒï¼š$P_c(x)=\frac{exp(sim(c, x))}{\sum_{xâ€™ \in T} exp(sim(c, xâ€™))}$</li><li>åŠ å…¥é—®é¢˜$q$åå›¾åƒ$x$åœ¨ä¸Šä¸‹æ–‡$c$ä¸‹çš„åˆ†å¸ƒï¼š$P_{c,q}(x)=\frac{exp(sim(concat(c, q), x))}{\sum_{xâ€™ \in T} exp(sim(concat(c, q), xâ€™))}$</li></ol></li><li>ç­›é€‰å‡ºç­”æ¡ˆâ€œä¸ç¡®å®šâ€çš„é—®é¢˜ï¼Œä½œä¸º $Qâ€™$<ol><li>åˆå§‹åŒ– $Qâ€™ \leftarrow {}$</li><li>$for q in Q do$<ol><li>å¦‚æœ $Answer(c, q)$ ä¸ºâ€œä¸ç¡®å®šâ€ï¼Œåˆ™åŠ å…¥ $Qâ€™$</li></ol></li></ol></li><li>é€‰æ‹©KLæ•£åº¦æœ€å°çš„é—®é¢˜ $\hat q$</li><li>è¿”å›ï¼š$\hat q$</li></ol><h3 id="3-4-The-Best-Log-Rank-Integral-BRI-Metric-æœ€ä½³å¯¹æ•°æ’åç§¯åˆ†">3.4 The Best Log Rank Integral (BRI) Metric æœ€ä½³å¯¹æ•°æ’åç§¯åˆ†</h3><p>ä½œè€…æŒ‡å‡ºï¼Œåœ¨è¯„ä¼°äº¤äº’å¼æ£€ç´¢ç³»ç»Ÿæ—¶ï¼Œæœ‰3ä¸ªå…³é”®ç‚¹ï¼š</p><ol><li>ç”¨æˆ·æ»¡æ„åº¦ï¼šåœ¨å¤šå°‘æ¬¡äº¤äº’ä¸­è‡³å°‘æ‰¾åˆ°äº†ä¸€æ¬¡ç›®æ ‡å›¾åƒç®—æ»¡æ„</li><li>æ•ˆç‡ï¼šæˆåŠŸæ£€ç´¢æ‰€éœ€è½®æ¬¡è¶Šå°‘è¶Šå¥½</li><li>æ’åæå‡æ„ä¹‰ï¼šæ’åé å‰æ—¶æå‡æ’åçš„æ„ä¹‰æ›´å¤§ï¼Œå¦‚ä»2åˆ°1æ¯”ä»100åˆ°99æ›´æœ‰æ„ä¹‰</li></ol><p>Recall@Kç”¨äºéäº¤äº’å¼æ£€ç´¢ï¼›Hit@Kåªè€ƒè™‘äº†ç”¨æˆ·æ»¡æ„åº¦</p><p>ä½œè€…æå‡ºäº†BRIæŒ‡æ ‡ï¼Œç»¼åˆäº†ç”¨æˆ·æ»¡æ„åº¦ã€æ•ˆç‡å’Œæ’åæå‡æ„ä¹‰</p><p>è®°ï¼š$Q$é—®é¢˜é›†åˆã€$T$æœ€å¤§è½®æ¬¡</p><p>$\pi(q_t)$ï¼šè¡¨ç¤ºå…·æœ‰$t$è½®å¯¹è¯çš„æŸ¥è¯¢$q_t$ï¼Œåœ¨è¿™$t$è½®æŸ¥è¯¢ä¸­ï¼Œç›®æ ‡å›¾åƒçš„å†å²æœ€ä½³æ’åï¼Œç”¨äºè¡¡é‡ç”¨æˆ·æ»¡æ„åº¦</p><p>BRIï¼š$\mathbb E_{q \in Q}\left[ \dfrac{1}{2T}\log\pi(q_0)\pi(q_T)+\dfrac{1}{T}\sum\limits_{t=1}^{T-1}\log\pi(q_t)\right]$</p><ul><li>è¾¹ç•Œé¡¹ï¼š$\dfrac{1}{2T}\log\pi(q_0)\pi(q_T)$<ul><li>æƒé‡è¾ƒå°ï¼Œåæ˜ åˆå§‹æŸ¥è¯¢$q_0$åˆ°æœ€ç»ˆæŸ¥è¯¢$q_T$çš„æ’åæ”¹å–„æƒ…å†µ</li></ul></li><li>å¹³å‡æŸ¥è¯¢æ’åé¡¹ï¼š$\dfrac{1}{T}\sum\limits_{t=1}^{T-1}\log\pi(q_t)$<ul><li>è®¡ç®—äº†æŸ¥è¯¢$q$çš„æ‰€æœ‰$t$è½®ä¸­ï¼Œç›®æ ‡çš„å†å²æœ€ä½³æ’åçš„å¯¹æ•°çš„å‡å€¼</li><li>å¯¹æ•°å‡½æ•°ä½¿å¾—ä½æ’åçš„è¿›ä¸€æ­¥é™ä½å¯¹BRIå˜åŒ–çš„å½±å“æ›´å¤§</li></ul></li><li>BRIè¶Šå°ï¼Œæ€§èƒ½è¶Šå¥½</li><li>BRIä¸ä¾èµ–äºå…·ä½“çš„Kå€¼ï¼Œæ›´å…¨é¢ã€ç»Ÿä¸€</li><li>å®éªŒè¡¨æ˜ï¼ŒBRIä¸äººç±»è¯„ä»·æ›´æ¥è¿‘</li></ul><h2 id="4-Experiments">4. Experiments</h2><ul><li>æ•°æ®é›†ï¼šVisdailã€COCOã€Flickr30k</li><li>æ–‡æœ¬åˆ°å›¾åƒæ£€ç´¢æ¨¡å‹ï¼šé»˜è®¤BLIPï¼Œä¹Ÿæœ‰BLIP-2ã€ATM</li><li>LLMæé—®è€…ï¼šChatGPT</li><li>æµ‹è¯•é›†å›ç­”è€…ï¼šBLIP-2</li><li>èšç±»æ•°mï¼š10</li></ul><p>Baselineï¼š0-shotã€ChatIR</p><p>åŒæ—¶è¿›è¡Œäº†Ablation Studyï¼Œæµ‹è¯•äº†ä¸åŒç»„ä»¶çš„åŠ å…¥å¯¹ç»“æœçš„å½±å“</p><h2 id="æ€»ç»“å’Œå®ç°">æ€»ç»“å’Œå®ç°</h2><ul><li>PlugIRç³»ç»Ÿä¹Ÿæ˜¯ä¸€ä¸ªåŸºäºå¯¹è¯çš„å›¾åƒæ£€ç´¢ç³»ç»Ÿï¼Œåœ¨ChatIRçš„åŸºç¡€ä¸Šè¿›è¡Œäº†æ”¹è¿›</li><li>ä¸»è¦ä¼˜åŒ–äº†æé—®è¿‡ç¨‹ï¼Œä½¿å¾—æé—®çš„æœ‰æ•ˆæ€§æå‡</li><li>ä½¿ç”¨äº†æ–°çš„è¯„ä¼°æŒ‡æ ‡BRIï¼Œèƒ½å¤Ÿæ›´å…¨é¢åœ°è¯„ä¼°äº¤äº’å¼æ£€ç´¢ç³»ç»Ÿ</li></ul><p>ç”±äºç³»ç»Ÿä»£ç é‡è¾ƒå¤§ï¼Œåœ¨å®ç°æ—¶åˆ’åˆ†åˆ°å¤šä¸ªæ–‡ä»¶</p><h3 id="config-py"><a href="http://config.py">config.py</a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line">config = &#123;</span><br><span class="line">    <span class="string">&quot;hitk&quot;</span> : <span class="number">10</span>, <span class="comment"># hit@k</span></span><br><span class="line">    <span class="string">&quot;q_num&quot;</span> : <span class="number">5</span>, <span class="comment"># å¾…selectçš„é—®é¢˜æ•°é‡</span></span><br><span class="line">    <span class="string">&quot;threshold_low&quot;</span> : <span class="number">500</span>, <span class="comment"># ä½é˜ˆå€¼ï¼Œç”¨äºè®¡ç®—Kmeansèšç±»æ—¶çš„æ ·æœ¬æ•°</span></span><br><span class="line">    <span class="string">&quot;gpt_model&quot;</span> : <span class="string">&#x27;gpt-4o-mini&#x27;</span>, <span class="comment"># OpenAIæ¨¡å‹åç§°</span></span><br><span class="line">    <span class="string">&quot;api_key&quot;</span> : <span class="string">&quot;&quot;</span>, <span class="comment"># OpenAI APIå¯†é’¥</span></span><br><span class="line">    <span class="string">&quot;vqa_model&quot;</span> : <span class="string">&#x27;Salesforce/blip2-flan-t5-xl&#x27;</span>, <span class="comment"># VQAæ¨¡å‹åç§°</span></span><br><span class="line">    <span class="string">&quot;retriever&quot;</span> : <span class="string">&quot;blip&quot;</span>, <span class="comment"># æ£€ç´¢å™¨åç§°ï¼Œblipæˆ–clip</span></span><br><span class="line">    <span class="string">&quot;device&quot;</span> : torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>),</span><br><span class="line">    <span class="string">&quot;sep_token&quot;</span> : <span class="string">&quot;, &quot;</span>, <span class="comment"># ChatIRåˆ†éš”ç¬¦</span></span><br><span class="line">    <span class="string">&quot;eval_caption&quot;</span> : <span class="literal">True</span>, <span class="comment"># evalæ—¶æ˜¯å¦ä¸ºPlugIRæ€»ç»“çš„Captionï¼ŒTrueï¼šPlugIRï¼ŒFalseï¼šChatIR</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç®—æ³•é…ç½®</span></span><br><span class="line">    <span class="string">&quot;referring&quot;</span> : <span class="literal">True</span>, <span class="comment"># æ˜¯å¦å‚è€ƒå€™é€‰é›†Captionæé—®ï¼ˆç®—æ³•1ï¼‰</span></span><br><span class="line">    <span class="string">&quot;filtering&quot;</span> : <span class="literal">True</span>, <span class="comment"># æ˜¯å¦AIè¿‡æ»¤é—®é¢˜ï¼ˆç®—æ³•2ï¼‰</span></span><br><span class="line">    <span class="string">&quot;select&quot;</span> : <span class="literal">True</span>, <span class="comment"># æ˜¯å¦ä½¿ç”¨KLæ•£åº¦é€‰æ‹©é—®é¢˜ï¼ˆç®—æ³•2ï¼‰</span></span><br><span class="line">    <span class="string">&quot;reconstruct&quot;</span> : <span class="literal">True</span>, <span class="comment"># æ˜¯å¦é‡æ„å¯¹è¯</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·¯å¾„é…ç½®</span></span><br><span class="line">    <span class="comment"># å›¾ç‰‡è·¯å¾„å‰ç¼€ï¼Œè·¯å¾„=dir_prefix+&lt;img_path&gt;(&quot;unlabeled2017/xxx.jpg&quot;)</span></span><br><span class="line">    <span class="string">&quot;dir_prefix&quot;</span> : <span class="string">&quot;./&quot;</span>, </span><br><span class="line">    <span class="comment"># Visdialæ•°æ®ï¼Œ[&#123;&quot;img&quot;:&quot;&lt;img_path&gt;&quot;, &quot;dialog&quot;:[&quot;&lt;caption&gt;&quot;, &quot;Q? A&quot;, &quot;Q? A&quot;, ...]&#125;, ...]ï¼Œ2064</span></span><br><span class="line">    <span class="string">&quot;visdial_path&quot;</span> : <span class="string">&quot;./dialogues/VisDial_v1.0_queries_val.json&quot;</span>, </span><br><span class="line">    <span class="comment"># æœç´¢ç©ºé—´ï¼Œ[&quot;&lt;img_path&gt;&quot;, &quot;&lt;img_path&gt;&quot;, ...]ï¼Œ50000</span></span><br><span class="line">    <span class="string">&quot;search_space&quot;</span> : <span class="string">&quot;./Protocol/Search_Space_val_50k.json&quot;</span>, </span><br><span class="line"><span class="comment"># Visdialæ•°æ®ï¼Œä»…ä¿ç•™captionï¼Œ[&#123;&quot;id&quot;: &quot;&lt;img_path&gt;&quot;, &quot;caption&quot;: [&quot;&lt;caption&gt;&quot;]&#125;,...]ï¼Œ50000</span></span><br><span class="line">    <span class="string">&quot;captions_path&quot;</span> : <span class="string">&quot;./ChatIR/ChatIR_Protocol/visdial_captions.json&quot;</span>,</span><br><span class="line">    <span class="comment"># blipé¢„å¤„ç†çš„embeddings</span></span><br><span class="line">    <span class="string">&quot;img_emb_path&quot;</span> : <span class="string">&quot;./ChatIR/temp/corpus_finetuned_blip.pth&quot;</span>, </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="OpenAI-py"><a href="http://OpenAI.py">OpenAI.py</a></h3><p>æ‰€æœ‰å‡½æ•°ç»Ÿä¸€è¿”å›responseå¯¹è±¡ï¼ŒåŒ…å«äº†æ‰€æœ‰ä¿¡æ¯ã€‚</p><p>messages.pyä¸­å®šä¹‰äº†æ¶ˆæ¯æ ¼å¼ï¼ŒåŒ…å«promptä¿¡æ¯ï¼Œå…·ä½“æ–‡æœ¬è§è®ºæ–‡é™„å½•ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> openai</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> API.messages <span class="keyword">as</span> messages</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line">client = openai.OpenAI(api_key=config[<span class="string">&quot;api_key&quot;</span>])</span><br><span class="line"></span><br><span class="line">SEED = <span class="number">1021</span> <span class="comment"># éšæœºç§å­ <span class="doctag">TODO:</span>ä¸è®¾ç½®çš„æ•ˆæœ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reconstruct_dialog</span>(<span class="params">dialog:<span class="built_in">list</span>[<span class="built_in">str</span>], temperature:<span class="built_in">float</span>=<span class="number">.0</span>, model:<span class="built_in">str</span>=<span class="string">&#x27;gpt-4o-mini&#x27;</span></span>)-&gt;<span class="built_in">str</span>:</span><br><span class="line"><span class="string">&quot;&quot;&quot;é‡æ„å¯¹è¯æ¡†</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å°†å¯¹è¯ä¸­çš„æœ‰æ•ˆä¿¡æ¯æ€»ç»“ä¸ºä¸€æ®µæè¿°ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">dialog : å¯¹è¯åˆ—è¡¨</span></span><br><span class="line"><span class="string">temperature : é‡‡æ ·æ¸©åº¦ï¼Œè¶Šå°è¶Šä¿å®ˆ [0.0,2.0]</span></span><br><span class="line"><span class="string">model : æ¨¡å‹åç§°</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">retry_count = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">response = client.chat.completions.create(</span><br><span class="line">model=model,</span><br><span class="line">messages=messages.reconstruct_dialog_message(dialog),</span><br><span class="line">n=<span class="number">1</span>,</span><br><span class="line">temperature=temperature,</span><br><span class="line">seed=SEED,</span><br><span class="line">max_tokens=<span class="number">512</span>)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">retry_count += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">if</span> retry_count &gt; <span class="number">5</span>:</span><br><span class="line"><span class="keyword">raise</span> Exception(<span class="string">&quot;Retry limit exceeded!&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Retry <span class="subst">&#123;retry_count&#125;</span> times...&quot;</span>)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_questions</span>(<span class="params">dialog:<span class="built_in">list</span>[<span class="built_in">str</span>], n:<span class="built_in">int</span>=<span class="number">1</span>, model:<span class="built_in">str</span>=<span class="string">&#x27;gpt-4o-mini&#x27;</span></span>)-&gt;<span class="built_in">list</span>[<span class="built_in">str</span>]:</span><br><span class="line"><span class="string">&quot;&quot;&quot;Baseline: 1-shotç”Ÿæˆé—®é¢˜ ChatIR</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ä»…å‚è€ƒå†å²å¯¹è¯ç”Ÿæˆæ–°çš„é—®é¢˜ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">dialog : å¯¹è¯åˆ—è¡¨</span></span><br><span class="line"><span class="string">n : ç”Ÿæˆé—®é¢˜æ•°é‡</span></span><br><span class="line"><span class="string">model : æ¨¡å‹åç§°</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Returns:</span></span><br><span class="line"><span class="string">response :</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">retry_count = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">response = client.chat.completions.create(</span><br><span class="line">model=model,</span><br><span class="line">messages=messages.generate_questions_message(dialog),</span><br><span class="line">n=n,</span><br><span class="line">temperature=<span class="number">0.5</span>,</span><br><span class="line">max_tokens=<span class="number">32</span>)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">retry_count += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">if</span> retry_count &gt; <span class="number">5</span>:</span><br><span class="line"><span class="keyword">raise</span> Exception(<span class="string">&quot;Retry limit exceeded!&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Retry <span class="subst">&#123;retry_count&#125;</span> times...&quot;</span>)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_questions_referring</span>(<span class="params">dialog:<span class="built_in">list</span>[<span class="built_in">str</span>], prompt_related_captions:<span class="built_in">str</span>=<span class="string">&quot;&quot;</span>, questions:<span class="built_in">list</span>=[], n:<span class="built_in">int</span>=<span class="number">1</span>, model=<span class="string">&#x27;gpt-4o-mini&#x27;</span></span>):</span><br><span class="line"><span class="string">&quot;&quot;&quot;åˆ©ç”¨æ€ç»´é“¾CoTå’Œå€™é€‰é›†Captionsç”Ÿæˆæ–°é—®é¢˜</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">dailog : å¯¹è¯åˆ—è¡¨</span></span><br><span class="line"><span class="string">prompt_related_captions : é¢„å¤„ç†çš„å€™é€‰é›†Caption</span></span><br><span class="line"><span class="string">questions : å†å²é—®ç­”å¯¹</span></span><br><span class="line"><span class="string">n : ç”Ÿæˆé—®é¢˜æ•°é‡</span></span><br><span class="line"><span class="string">model : æ¨¡å‹åç§°</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">retry_count = <span class="number">0</span></span><br><span class="line">message = messages.generate_questions_referring_message(dialog, prompt_related_captions, questions)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">response = client.chat.completions.create(</span><br><span class="line">model=model,</span><br><span class="line">messages=message,</span><br><span class="line">n=<span class="number">1</span>,</span><br><span class="line">temperature=<span class="number">0.5</span>,</span><br><span class="line">max_tokens=<span class="number">32</span>)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">retry_count += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">if</span> retry_count &gt; <span class="number">5</span>:</span><br><span class="line"><span class="keyword">raise</span> Exception(<span class="string">&quot;Retry limit exceeded!&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Retry <span class="subst">&#123;retry_count&#125;</span> times...&quot;</span>)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter_questions</span>(<span class="params">context:<span class="built_in">str</span>, question:<span class="built_in">str</span>, model=<span class="string">&#x27;gpt-4o-mini&#x27;</span></span>):</span><br><span class="line"><span class="string">&quot;&quot;&quot;è¿‡æ»¤é—®é¢˜</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">åˆ¤æ–­é—®é¢˜æ˜¯å¦â€œUncertainâ€</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">context : ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="string">question : é—®é¢˜</span></span><br><span class="line"><span class="string">model : æ¨¡å‹åç§°</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">retry_count = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">response = client.chat.completions.create(</span><br><span class="line">model=model,</span><br><span class="line">messages=messages.filter_questions_message(context, question),</span><br><span class="line">n=<span class="number">1</span>,</span><br><span class="line">temperature=<span class="number">.0</span>,</span><br><span class="line">max_tokens=<span class="number">32</span>)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">retry_count += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">if</span> retry_count &gt; <span class="number">5</span>:</span><br><span class="line"><span class="keyword">raise</span> Exception(<span class="string">&quot;Retry limit exceeded!&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Retry <span class="subst">&#123;retry_count&#125;</span> times...&quot;</span>)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">paraphrase</span>(<span class="params">text:<span class="built_in">str</span>=<span class="string">&quot;&quot;</span>, model=<span class="string">&#x27;gpt-4o-mini&#x27;</span></span>):</span><br><span class="line"><span class="string">&quot;&quot;&quot;é‡è¿°</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">é‡è¿°ç»™å®šçš„æ–‡æœ¬ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">text : å¾…é‡è¿°æ–‡æœ¬</span></span><br><span class="line"><span class="string">model : æ¨¡å‹åç§°</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">retry_count = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">response = client.chat.completions.create(</span><br><span class="line">model=model,</span><br><span class="line">messages=messages.paraphrase(text),</span><br><span class="line">n=<span class="number">1</span>,</span><br><span class="line">temperature=<span class="number">0.7</span>,</span><br><span class="line">top_p=<span class="number">0.8</span>,</span><br><span class="line">max_tokens=<span class="number">512</span>)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">retry_count += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">if</span> retry_count &gt; <span class="number">5</span>:</span><br><span class="line"><span class="keyword">raise</span> Exception(<span class="string">&quot;Retry limit exceeded!&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Retry <span class="subst">&#123;retry_count&#125;</span> times...&quot;</span>)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> response</span><br></pre></td></tr></table></figure><h3 id="utils-py"><a href="http://utils.py">utils.py</a></h3><p>å®ç°äº†ç‰¹å¾æå–ã€K-meansèšç±»ã€KLæ•£åº¦è®¡ç®—ã€è·å–ç°‡ä¸­å¿ƒcaptionã€ç†µè®¡ç®—ç­‰å‡½æ•°åŠŸèƒ½ï¼Œä½¿ä¸»ç¨‹åºä»£ç ç®€æ´æ˜“è¯»ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.nn.functional <span class="keyword">import</span> normalize</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> BlipForImageTextRetrieval,AutoProcessor</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset, DataLoader</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms</span><br><span class="line"><span class="keyword">from</span> torchvision.transforms <span class="keyword">import</span> InterpolationMode</span><br><span class="line"><span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./Protocol/visdial_captions.json&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> ss_cap_json:</span><br><span class="line">captions = json.load(ss_cap_json) <span class="comment"># length:50000</span></span><br><span class="line"><span class="comment"># &#123;&quot;id&quot;: &quot;&lt;img_path&gt;&quot;, &quot;caption&quot;: [&quot;&lt;caption&gt;&quot;]&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BlipForRetrieval</span>(<span class="title class_ inherited__">BlipForImageTextRetrieval</span>):</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_text_features</span>(<span class="params"></span></span><br><span class="line"><span class="params">self,</span></span><br><span class="line"><span class="params">input_ids: torch.LongTensor, <span class="comment"># Tokenized input IDs</span></span></span><br><span class="line"><span class="params">attention_mask: torch.LongTensor | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">return_dict: <span class="built_in">bool</span>|<span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; torch.FloatTensor:</span><br><span class="line"><span class="string">&quot;&quot;&quot;è·å–æ–‡æœ¬ç‰¹å¾</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">input_ids : æ–‡æœ¬çš„token IDï¼ˆå³ç»è¿‡åˆ†è¯åçš„è¾“å…¥ï¼‰</span></span><br><span class="line"><span class="string">attention_mask : æ³¨æ„åŠ›æ©ç </span></span><br><span class="line"><span class="string">return_dict : æ˜¯å¦è¿”å›å­—å…¸</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">return_dict=return_dict <span class="keyword">if</span> return_dict <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> self.config.use_return_dict</span><br><span class="line"></span><br><span class="line">text_embeddings = self.text_encoder(</span><br><span class="line">input_ids=input_ids,</span><br><span class="line">attention_mask=attention_mask,</span><br><span class="line">return_dict=return_dict,</span><br><span class="line">)</span><br><span class="line">text_embeddings = text_embeddings[<span class="number">0</span>] <span class="keyword">if</span> <span class="keyword">not</span> return_dict <span class="keyword">else</span> text_embeddings.last_hidden_state</span><br><span class="line"><span class="keyword">return</span> normalize(self.text_proj(text_embeddings[:, <span class="number">0</span>, :]), dim=-<span class="number">1</span>) <span class="comment"># [:,0,:]å–çš„æ˜¯[CLS]æ ‡è®°çš„éšè—çŠ¶æ€ï¼Œå®ƒé€šå¸¸è¢«ç”¨ä½œæ•´ä¸ªå¥å­çš„ç‰¹å¾è¡¨ç¤º</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_image_features</span>(<span class="params"></span></span><br><span class="line"><span class="params">self,</span></span><br><span class="line"><span class="params">pixel_values: torch.FloatTensor,</span></span><br><span class="line"><span class="params">output_attentions: <span class="built_in">bool</span> | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">output_hidden_states: <span class="built_in">bool</span> | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">return_dict: <span class="built_in">bool</span> | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; torch.FloatTensor:</span><br><span class="line"><span class="string">&quot;&quot;&quot;è·å–å›¾ç‰‡ç‰¹å¾</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">pixel_values : å›¾ç‰‡åƒç´ å€¼</span></span><br><span class="line"><span class="string">output_attentions : æ˜¯å¦è¾“å‡ºæ³¨æ„åŠ›</span></span><br><span class="line"><span class="string">output_hidden_states : æ˜¯å¦è¾“å‡ºéšè—çŠ¶æ€</span></span><br><span class="line"><span class="string">return_dict : æ˜¯å¦è¿”å›å­—å…¸</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">return_dict = return_dict <span class="keyword">if</span> return_dict <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> self.config.use_return_dict</span><br><span class="line"></span><br><span class="line">output_attentions = output_attentions <span class="keyword">if</span> output_attentions <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> self.config.output_attentions</span><br><span class="line">output_hidden_states = output_hidden_states <span class="keyword">if</span> output_hidden_states <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> self.config.output_hidden_states</span><br><span class="line"></span><br><span class="line">vision_outputs = self.vision_encoder(</span><br><span class="line">pixel_values=pixel_values,</span><br><span class="line">output_attentions=output_attentions,</span><br><span class="line">output_hidden_states=output_hidden_states,</span><br><span class="line">return_dict=return_dict,</span><br><span class="line">)</span><br><span class="line">image_embeddings = vision_outputs[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">return</span> normalize(self.vision_proj(image_embeddings[:, <span class="number">0</span>, :]), dim=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">processor = AutoProcessor.from_pretrained(<span class="string">&quot;Salesforce/blip-itm-large-coco&quot;</span>)</span><br><span class="line">model = BlipForRetrieval.from_pretrained(<span class="string">&quot;Salesforce/blip-itm-large-coco&quot;</span>).to(config[<span class="string">&quot;device&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_text_features</span>(<span class="params">text: <span class="built_in">str</span>, model=model, processor=processor</span>) -&gt; torch.FloatTensor:</span><br><span class="line"><span class="string">&quot;&quot;&quot;è·å–æ–‡æœ¬ç‰¹å¾</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">text : æ–‡æœ¬</span></span><br><span class="line"><span class="string">model : Pretrained Modelï¼Œç”¨äºè·å–æ–‡æœ¬ç‰¹å¾</span></span><br><span class="line"><span class="string">processor : æ–‡æœ¬å¤„ç†å™¨ï¼Œç”¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºæ¨¡å‹è¾“å…¥</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">text_encodings = processor(text=text, padding=<span class="literal">True</span>, return_tensors=<span class="string">&quot;pt&quot;</span>).to(config[<span class="string">&quot;device&quot;</span>])</span><br><span class="line"><span class="keyword">return</span> model.get_text_features(**text_encodings)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_imgs</span>(<span class="params">query=<span class="string">&quot;&quot;</span>, img_embs=<span class="literal">None</span>, search_space=<span class="literal">None</span>, k=<span class="number">10</span></span>):</span><br><span class="line"><span class="string">&quot;&quot;&quot;æœç´¢å‰kä¸ªç›¸å…³å›¾ç‰‡</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">query : æŸ¥è¯¢æ–‡æœ¬</span></span><br><span class="line"><span class="string">img_embs : å›¾ç‰‡ç‰¹å¾</span></span><br><span class="line"><span class="string">search_space : æœç´¢ç©ºé—´ï¼Œå›¾ç‰‡è·¯å¾„åˆ—è¡¨</span></span><br><span class="line"><span class="string">k : è¿”å›çš„å›¾ç‰‡æ•°é‡</span></span><br><span class="line"><span class="string">Returns:</span></span><br><span class="line"><span class="string">related_imgs : å‰kä¸ªç›¸å…³å›¾ç‰‡</span></span><br><span class="line"><span class="string">related_indices : å‰kä¸ªç›¸å…³å›¾ç‰‡çš„ç´¢å¼•</span></span><br><span class="line"><span class="string">cos_sim : ä½™å¼¦ç›¸ä¼¼åº¦</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">query_emb = get_text_features(query)</span><br><span class="line">query_emb_norm = normalize(query_emb, dim=-<span class="number">1</span>) <span class="comment"># å½’ä¸€åŒ–æŸ¥è¯¢ç‰¹å¾</span></span><br><span class="line">cos_sim = torch.matmul(query_emb_norm, img_embs.T).squeeze() <span class="comment"># è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦</span></span><br><span class="line">related_indices = cos_sim.sort()[<span class="number">1</span>][-k:]</span><br><span class="line"><span class="comment"># related_indices = cos_sim.topk(k).indices</span></span><br><span class="line">related_imgs = []</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(k):</span><br><span class="line">related_imgs.append(search_space[related_indices[idx].item()])</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> related_imgs, related_indices, cos_sim</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fast_pytorch_kmeans <span class="keyword">import</span> KMeans</span><br><span class="line">kmeans = KMeans(n_clusters=<span class="number">10</span>, mode=<span class="string">&#x27;cosine&#x27;</span>, verbose=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_related_captions</span>(<span class="params">caption_recon, <span class="built_in">round</span>=<span class="number">1</span>, threshold_low=<span class="number">500</span>, img_embs=<span class="literal">None</span>, captions=<span class="literal">None</span></span>):</span><br><span class="line"><span class="string">&quot;&quot;&quot;è·å–ç°‡ä¸­å¿ƒçš„ç›¸å…³å›¾ç‰‡æè¿°</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å°†low-(round-1)*(low/10.0)ä¸ªæœ€ç›¸å…³çš„å›¾ç‰‡ä½œä¸ºå€™é€‰é›†S_Rï¼Œè¿›è¡Œk-meansèšç±»ï¼Œ</span></span><br><span class="line"><span class="string">å¾—åˆ°10ä¸ªç°‡ä¸­ï¼Œä¿¡æ¯ç†µæœ€å°çš„å›¾ç‰‡æè¿°ä½œä¸ºå½“å‰è½®æ¬¡çš„ç›¸å…³å›¾ç‰‡æè¿°ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">caption_recon : å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆé‡æ„çš„ï¼‰</span></span><br><span class="line"><span class="string">round : å½“å‰è½®æ¬¡</span></span><br><span class="line"><span class="string">threshold_low : æ ¹æ®è½®æ¬¡è®¡ç®—ç›¸å…³å›¾ç‰‡çš„æ•°é‡ low-(round-1)*(low/10.0)</span></span><br><span class="line"><span class="string">img_embs : å›¾ç‰‡ç‰¹å¾</span></span><br><span class="line"><span class="string">captions : å›¾ç‰‡æè¿°</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">caps = []</span><br><span class="line"><span class="comment"># related_size = 100 - (round-1)*10</span></span><br><span class="line">related_size = <span class="built_in">int</span>(threshold_low - (<span class="built_in">round</span>-<span class="number">1</span>) * (threshold_low / <span class="number">10.0</span>)) <span class="comment"># å€™é€‰é›†å¤§å° 500-(round-1)*50</span></span><br><span class="line">emb = normalize(get_text_features(caption_recon), dim=-<span class="number">1</span>) </span><br><span class="line">sim = torch.matmul(emb, img_embs.T).squeeze() <span class="comment"># è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦</span></span><br><span class="line">topk = sim.argsort()[-related_size:] <span class="comment"># è·å–å‰related_sizeä¸ªç›¸å…³å›¾ç‰‡çš„ç´¢å¼•</span></span><br><span class="line">img_embs_topk = img_embs[topk] <span class="comment"># è·å–å‰related_sizeä¸ªç›¸å…³å›¾ç‰‡çš„ç‰¹å¾</span></span><br><span class="line"></span><br><span class="line">entropies = torch.zeros([related_size]) </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(related_size):</span><br><span class="line">cap = captions[topk[i].item()][<span class="string">&#x27;caption&#x27;</span>]</span><br><span class="line">emb = normalize(get_text_features(cap), dim=-<span class="number">1</span>)</span><br><span class="line">sim = torch.matmul(emb, img_embs_topk.T).squeeze()</span><br><span class="line">p = torch.nn.functional.softmax(sim, dim=<span class="number">0</span>)</span><br><span class="line">entropy = (-p * p.log()).<span class="built_in">sum</span>().detach().cpu() <span class="comment"># ä¿¡æ¯ç†µ</span></span><br><span class="line">entropies[i] += entropy</span><br><span class="line">idx_entropies_sorted = entropies.argsort()</span><br><span class="line"></span><br><span class="line">cluster_label = kmeans.fit_predict(img_embs_topk)</span><br><span class="line">cluster_label_sorted = cluster_label[idx_entropies_sorted]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line"><span class="keyword">if</span> (cluster_label_sorted == i).<span class="built_in">any</span>():</span><br><span class="line">idx_c = (cluster_label_sorted == i).nonzero().squeeze().<span class="built_in">min</span>() </span><br><span class="line">caps.append(captions[topk[idx_entropies_sorted[idx_c]].item()][<span class="string">&#x27;caption&#x27;</span>][<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in range(10):</span></span><br><span class="line"><span class="comment">#     caps.append(captions[topk[entropies.argsort()[i]].item()][&#x27;caption&#x27;][0])</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> caps</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_referring_prompt</span>(<span class="params">caption=<span class="string">&quot;&quot;</span>, img_embs=<span class="literal">None</span>, k=<span class="number">10</span>, <span class="built_in">round</span>=<span class="number">1</span>, search_space=<span class="literal">None</span></span>):</span><br><span class="line"><span class="string">&quot;&quot;&quot; è¿›è¡Œk-meansèšç±»ï¼Œè·å–ç›¸å…³å›¾ç‰‡æè¿°ï¼›è·å–å‰kä¸ªç›¸å…³å›¾ç‰‡çš„ç´¢å¼•å’Œä½™å¼¦ç›¸ä¼¼åº¦ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">caption : å›¾ç‰‡æè¿°</span></span><br><span class="line"><span class="string">img_embs : å›¾ç‰‡ç‰¹å¾</span></span><br><span class="line"><span class="string">k : è¿”å›çš„å›¾ç‰‡æ•°é‡</span></span><br><span class="line"><span class="string">round : å½“å‰è½®æ¬¡</span></span><br><span class="line"><span class="string">search_space : æœç´¢ç©ºé—´ï¼Œå›¾ç‰‡è·¯å¾„åˆ—è¡¨</span></span><br><span class="line"><span class="string">Returns:</span></span><br><span class="line"><span class="string">prompt_sys : ç³»ç»Ÿprompt</span></span><br><span class="line"><span class="string">prompt_related_captions : ç›¸å…³å›¾ç‰‡æè¿°</span></span><br><span class="line"><span class="string">top_k : å‰kä¸ªç›¸å…³å›¾ç‰‡çš„ç´¢å¼•</span></span><br><span class="line"><span class="string">cos_sims : ä½™å¼¦ç›¸ä¼¼åº¦</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">img_paths, top_k, cos_sims = search_imgs(caption, img_embs, search_space, k=k)</span><br><span class="line">related_captions = get_related_captions(caption, <span class="built_in">round</span>, img_embs=img_embs, captions=captions)</span><br><span class="line"></span><br><span class="line">prompt_sys = <span class="string">&quot;&quot;</span></span><br><span class="line">prompt_sys += <span class="string">&quot;You should leverage the &#x27;related_captions Information&#x27; that is related to the target image &quot;</span></span><br><span class="line">prompt_sys += <span class="string">&quot;corresponding to the caption but does not match the target image.&quot;</span></span><br><span class="line"><span class="comment"># ä½ éœ€è¦åˆ©ç”¨ä¸ç›®æ ‡å›¾åƒç›¸å…³çš„â€œè™šå‡ä¿¡æ¯â€ï¼Œè¯¥ä¿¡æ¯ä¸ç›®æ ‡å›¾åƒæ ‡é¢˜ç›¸å…³ï¼Œä½†ä¸ç›®æ ‡å›¾åƒä¸åŒ¹é…ã€‚</span></span><br><span class="line"></span><br><span class="line">prompt_related_captions = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(related_captions)):</span><br><span class="line">prompt_related_captions += <span class="built_in">str</span>(i) + <span class="string">&#x27;. &#x27;</span> + related_captions[i] + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line"><span class="comment"># 1. caption1</span></span><br><span class="line"><span class="comment"># 2. caption2</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> prompt_sys, prompt_related_captions, top_k, cos_sims</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_question</span>(<span class="params">caption_recon=<span class="string">&quot;&quot;</span>, questions=[], cossim_prev=<span class="literal">None</span>, k=<span class="number">10</span>, img_embs=<span class="literal">None</span>, threshold=<span class="number">500</span>, <span class="built_in">round</span>=<span class="number">1</span></span>):</span><br><span class="line"><span class="string">&quot;&quot;&quot;é€‰æ‹©KLæ•£åº¦æœ€å°çš„é—®é¢˜</span></span><br><span class="line"><span class="string">æ ¹æ®ä¸Šä¸€æ¬¡çš„ç›¸ä¼¼åº¦ï¼Œé€‰æ‹©KLæ•£åº¦æœ€å°çš„é—®é¢˜ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">caption_recon : å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆé‡æ„çš„ï¼‰</span></span><br><span class="line"><span class="string">questions : é—®é¢˜åˆ—è¡¨</span></span><br><span class="line"><span class="string">cossim_prev : ä¸Šä¸€è½®çš„ç›¸ä¼¼åº¦</span></span><br><span class="line"><span class="string">k : è¿”å›çš„å›¾ç‰‡æ•°é‡</span></span><br><span class="line"><span class="string">img_embs : å›¾ç‰‡ç‰¹å¾</span></span><br><span class="line"><span class="string">threshold : ç›¸å…³å›¾ç‰‡çš„æ•°é‡ low-(round-1)*(low/10.0)</span></span><br><span class="line"><span class="string">round : å½“å‰è½®æ¬¡</span></span><br><span class="line"><span class="string">Returns:</span></span><br><span class="line"><span class="string">str : é€‰æ‹©çš„é—®é¢˜</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">threshold = <span class="built_in">int</span>(threshold - (<span class="built_in">round</span>-<span class="number">1</span>) * (threshold / <span class="number">10.0</span>))</span><br><span class="line">idx_related = cossim_prev.argsort()[-threshold:-k]</span><br><span class="line">p_prev = torch.nn.functional.softmax(cossim_prev[idx_related], dim=<span class="number">0</span>)</span><br><span class="line">kl_divs = torch.zeros([<span class="built_in">len</span>(questions)])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, ques <span class="keyword">in</span> <span class="built_in">enumerate</span>(questions):</span><br><span class="line">caption_tmp = caption_recon + <span class="string">&quot;, &quot;</span> + ques</span><br><span class="line"></span><br><span class="line">query_emb_tmp = normalize(get_text_features(caption_tmp), dim=-<span class="number">1</span>)</span><br><span class="line">cossim_tmp = torch.matmul(query_emb_tmp, img_embs.T).squeeze()</span><br><span class="line">p_tmp = torch.nn.functional.softmax(cossim_tmp[idx_related], dim=<span class="number">0</span>)</span><br><span class="line">kl_div = (p_prev*(p_prev.log() - p_tmp.log())).<span class="built_in">sum</span>().detach().cpu()</span><br><span class="line">kl_divs[i] += kl_div</span><br><span class="line"></span><br><span class="line">idx_final = kl_divs.argsort()[<span class="number">0</span>].item()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> questions[idx_final]</span><br></pre></td></tr></table></figure><h3 id="ç³»ç»Ÿå®ç°ï¼šPlugIR-exec-py">ç³»ç»Ÿå®ç°ï¼šPlugIR_exec.py</h3><p>PlugIRçš„è¿è¡Œç‰ˆï¼Œå®ç°åˆ©ç”¨å¤šè½®å¯¹è¯è¿›è¡Œå›¾åƒæ£€ç´¢çš„åŠŸèƒ½ï¼Œæè¿°ä»¥åŠæ¯æ¬¡é—®ç­”åæ˜¾ç¤ºå½“å‰æœ€ç›¸å…³çš„å›¾ç‰‡ã€‚</p><p>æ”¹å†™ä¸º<code>PlugIR_func.py</code>ï¼Œå®ç°äº†å‡½æ•°åŒ–ï¼Œä¾¿äºåç»­æ‰¹é‡ç”Ÿæˆå¯¹è¯æ•°æ®ç”¨äºevaluationã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> API <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> utils</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line">img_embs = torch.load(config[<span class="string">&quot;img_emb_path&quot;</span>], map_location=config[<span class="string">&quot;device&quot;</span>])[<span class="number">1</span>] <span class="comment"># blipé¢„å¤„ç†çš„embeddings</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> config[<span class="string">&quot;filtering&quot;</span>]:</span><br><span class="line">    config[<span class="string">&quot;q_num&quot;</span>] = <span class="number">1</span> <span class="comment"># ä¸è¿‡æ»¤é—®é¢˜ï¼Œç”Ÿæˆ1ä¸ªé—®é¢˜</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(config[<span class="string">&quot;search_space&quot;</span>], <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> ss_json:</span><br><span class="line">    search_space = json.load(ss_json) <span class="comment"># length:50000</span></span><br><span class="line">    search_space = [config[<span class="string">&quot;dir_prefix&quot;</span>] + path <span class="keyword">for</span> path <span class="keyword">in</span> search_space]</span><br><span class="line">    <span class="comment"># [&quot;&lt;img_path&gt;&quot;, &quot;&lt;img_path&gt;&quot;, ...]</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(config[<span class="string">&quot;visdial_path&quot;</span>], <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> diag_json:</span><br><span class="line">visdial = json.load(diag_json) <span class="comment"># length:2064</span></span><br><span class="line"><span class="comment"># [&#123;&quot;img&quot;:&quot;&lt;img_path&gt;&quot;, &quot;dialog&quot;:[&quot;&lt;caption&gt;&quot;, &quot;Q? A&quot;, &quot;Q? A&quot;, ...]&#125;, ...]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(config[<span class="string">&quot;captions_path&quot;</span>], <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> ss_cap_json:</span><br><span class="line">captions = json.load(ss_cap_json) <span class="comment"># length:50000</span></span><br><span class="line">    <span class="comment"># [&#123;&quot;id&quot;: &quot;&lt;img_path&gt;&quot;, &quot;caption&quot;: [&quot;&lt;caption&gt;&quot;]&#125;,...]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ask_for_caption</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¯¢é—®ç”¨æˆ·æè¿°&quot;&quot;&quot;</span></span><br><span class="line">    caption = <span class="built_in">input</span>(<span class="string">&quot;Caption: &quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> caption.strip()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ask_question</span>(<span class="params">question</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¯¢é—®ç”¨æˆ·é—®é¢˜&quot;&quot;&quot;</span></span><br><span class="line">    ans = <span class="built_in">input</span>(<span class="string">f&quot;<span class="subst">&#123;question&#125;</span> &quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> ans.strip()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">display_image</span>(<span class="params">img_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ˜¾ç¤ºå›¾ç‰‡&quot;&quot;&quot;</span></span><br><span class="line">    img = Image.<span class="built_in">open</span>(img_path)</span><br><span class="line">    img.show()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    caption = ask_for_caption() <span class="comment"># è¯¢é—®ç”¨æˆ·æè¿°</span></span><br><span class="line">    dialogue = [caption] <span class="comment"># å¯¹è¯æ¡†</span></span><br><span class="line">    caption_recon = caption <span class="comment"># é‡æ„åçš„æè¿°ï¼Œç”¨äºåŒ¹é…å›¾ç‰‡</span></span><br><span class="line">    caption_recons = [caption] <span class="comment"># é‡æ„æè¿°åˆ—è¡¨</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">round</span> <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>): <span class="comment"># 10è½®å¯¹è¯</span></span><br><span class="line">        questions = [] <span class="comment"># åˆæ³•é—®é¢˜åˆ—è¡¨</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> config[<span class="string">&quot;referring&quot;</span>]: <span class="comment"># å‚è€ƒå€™é€‰é›†çš„Captionæé—®</span></span><br><span class="line">            ques_prior = [] <span class="comment"># éæ³•é—®é¢˜åˆ—è¡¨</span></span><br><span class="line">            _, prompt_related_captions, top_k, cos_sims = utils.get_referring_prompt(</span><br><span class="line">                caption_recon,</span><br><span class="line">                img_embs=img_embs,</span><br><span class="line">                k=config[<span class="string">&quot;hitk&quot;</span>],</span><br><span class="line">                <span class="built_in">round</span>=<span class="built_in">round</span>+<span class="number">1</span>,</span><br><span class="line">                search_space=search_space)</span><br><span class="line">            display_image(search_space[top_k[-<span class="number">1</span>]]) <span class="comment"># æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(config[<span class="string">&quot;q_num&quot;</span>]): <span class="comment"># ç”Ÿæˆconfig[&quot;q_num&quot;]ä¸ªé—®é¢˜</span></span><br><span class="line">                <span class="keyword">if</span> config[<span class="string">&quot;filtering&quot;</span>]: <span class="comment"># AIè¿‡æ»¤é—®é¢˜</span></span><br><span class="line">                    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>): <span class="comment"># å°è¯•3æ¬¡æ ¹æ®å€™é€‰é›†Captionç”Ÿæˆé—®é¢˜</span></span><br><span class="line">                        resp = OpenAI.generate_questions_referring(</span><br><span class="line">                            dialog=dialogue,</span><br><span class="line">                            prompt_related_captions=prompt_related_captions,</span><br><span class="line">                            questions=ques_prior,</span><br><span class="line">                            model=config[<span class="string">&quot;gpt_model&quot;</span>]</span><br><span class="line">                        ).choices[<span class="number">0</span>].message.content</span><br><span class="line">                        question = resp.split(<span class="string">&#x27;?&#x27;</span>)[<span class="number">0</span>]+<span class="string">&#x27;?&#x27;</span></span><br><span class="line">                        fq = OpenAI.filter_questions(caption_recon, question).choices[<span class="number">0</span>].message.content</span><br><span class="line">                        <span class="keyword">if</span> <span class="string">&quot;uncertain&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> fq.lower(): <span class="comment"># å¦‚æœä¸uncertainï¼Œé—®é¢˜éæ³•</span></span><br><span class="line">                            ques_prior.append(question)</span><br><span class="line">                        <span class="keyword">else</span> : <span class="comment"># å¦‚æœuncertainï¼Œé—®é¢˜åˆæ³•</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(ques_prior) == <span class="number">3</span>: <span class="comment"># ä¸‰æ¬¡éæ³•é—®é¢˜ï¼Œå°è¯•ç›´æ¥è¯¢é—®ä¸€æ¬¡ï¼Œå†ä¸è¡Œï¼Œå°±å›ºå®šè¯¢é—®å…¶ä»–å¯¹è±¡</span></span><br><span class="line">                        response = OpenAI.generate_questions(dialog=dialogue, n=<span class="number">1</span>).choices[<span class="number">0</span>].message.content</span><br><span class="line">                        question = response.split(<span class="string">&#x27;?&#x27;</span>)[<span class="number">0</span>]+<span class="string">&#x27;?&#x27;</span></span><br><span class="line">                        fq = OpenAI.filter_questions(caption_recon, question).choices[<span class="number">0</span>].message.content</span><br><span class="line">                        <span class="keyword">if</span> <span class="string">&quot;uncertain&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> fq.lower():</span><br><span class="line">                            question = <span class="string">&quot;what is the other object in the image?&quot;</span></span><br><span class="line">                <span class="keyword">else</span>: <span class="comment"># ä¸è¿‡æ»¤é—®é¢˜</span></span><br><span class="line">                    response = OpenAI.generate_questions_referring(</span><br><span class="line">                        dialog=dialogue, prompt_related_captions=prompt_related_captions, questions=ques_prior, n=<span class="number">1</span>, model=config[<span class="string">&quot;gpt_model&quot;</span>]</span><br><span class="line">                    ).choices[<span class="number">0</span>].message.content</span><br><span class="line">                    question = response.split(<span class="string">&#x27;?&#x27;</span>)[<span class="number">0</span>]+<span class="string">&#x27;?&#x27;</span></span><br><span class="line">            questions.append(question)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># ChatIRï¼šç›´æ¥æé—®</span></span><br><span class="line">            _, top_k, cos_sims = utils.search_imgs(</span><br><span class="line">                query=caption_recon,</span><br><span class="line">                img_embs=img_embs, </span><br><span class="line">                search_space=search_space,</span><br><span class="line">                k=config[<span class="string">&quot;hitk&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">            display_image(search_space[top_k[-<span class="number">1</span>]]) <span class="comment"># æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡</span></span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(config[<span class="string">&quot;q_num&quot;</span>]): <span class="comment"># ç”Ÿæˆconfig[&quot;q_num&quot;]ä¸ªé—®é¢˜</span></span><br><span class="line">                question = OpenAI.generate_questions(</span><br><span class="line">                    dialog=dialogue, n=<span class="number">1</span>, model=config[<span class="string">&quot;gpt_model&quot;</span>]</span><br><span class="line">                ).choices[<span class="number">0</span>].message.content</span><br><span class="line">                questions.append(question)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> config[<span class="string">&quot;select&quot;</span>]: <span class="comment"># é€‰æ‹©KLæ•£åº¦æœ€å°çš„é—®é¢˜</span></span><br><span class="line">            question_final = utils.select_question( </span><br><span class="line">                caption_recon=caption_recon,</span><br><span class="line">                questions=questions,</span><br><span class="line">                cossim_prev=cos_sims,</span><br><span class="line">                k=config[<span class="string">&quot;hitk&quot;</span>],</span><br><span class="line">                img_embs=img_embs,</span><br><span class="line">                threshold=config[<span class="string">&quot;threshold_low&quot;</span>],</span><br><span class="line">                <span class="built_in">round</span>=<span class="built_in">round</span>+<span class="number">1</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            question_final = questions[<span class="number">0</span>] </span><br><span class="line"></span><br><span class="line">        answer = ask_question(question_final)</span><br><span class="line">        qa = question_final + <span class="string">&#x27; &#x27;</span> + answer</span><br><span class="line">        dialogue.append(qa)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> config[<span class="string">&quot;reconstruct&quot;</span>]: <span class="comment"># é‡æ„å¯¹è¯ä¸Šä¸‹æ–‡</span></span><br><span class="line">            caption_recon = OpenAI.reconstruct_dialog(</span><br><span class="line">                dialog=dialogue,</span><br><span class="line">                model=config[<span class="string">&quot;gpt_model&quot;</span>]</span><br><span class="line">            ).choices[<span class="number">0</span>].message.content</span><br><span class="line">            <span class="keyword">if</span> caption_recon == caption_recons[-<span class="number">1</span>]:</span><br><span class="line">                caption_recon = OpenAI.paraphrase(caption_recon, model=config[<span class="string">&quot;gpt_model&quot;</span>]).choices[<span class="number">0</span>].message.content</span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># ChatIRï¼š&quot;, &quot;è¿æ¥&quot;</span></span><br><span class="line">            caption_recon = <span class="string">&#x27;, &#x27;</span>.join(dialogue)</span><br><span class="line">        caption_recons.append(caption_recon)</span><br></pre></td></tr></table></figure><p>è¿è¡Œæ•ˆæœï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/2406.03411/PlugIR_exec.png" alt="PlugIR_exec"></p><h3 id="å¯¹è¯æ•°æ®ç”Ÿæˆï¼štest-gen-py">å¯¹è¯æ•°æ®ç”Ÿæˆï¼štest_gen.py</h3><p>ä¸ºäº†è‡ªåŠ¨è·å–æµ‹è¯•æ•°æ®ï¼Œå…é™¤äººå·¥å›ç­”ï¼Œä½¿ç”¨äº†BLIP2æ¨¡å‹å›ç­”é—®é¢˜ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> lavis.models <span class="keyword">import</span> load_model_and_preprocess</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> config</span><br><span class="line"><span class="keyword">from</span> PlugIR_func <span class="keyword">import</span> generate_question</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> API <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(config[<span class="string">&quot;visdial_path&quot;</span>], <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> diag_json:</span><br><span class="line">visdial = json.load(diag_json) <span class="comment"># length:2064</span></span><br><span class="line"><span class="comment"># [&#123;&quot;img&quot;:&quot;&lt;img_path&gt;&quot;, &quot;dialog&quot;:[&quot;&lt;caption&gt;&quot;, &quot;Q? A&quot;, &quot;Q? A&quot;, ...]&#125;, ...]</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># st,ed = 5,100 # ç›®æ ‡èŒƒå›´[0,2064]</span></span><br><span class="line">st,ed = <span class="built_in">int</span>(sys.argv[<span class="number">1</span>]), <span class="built_in">int</span>(sys.argv[<span class="number">2</span>]) <span class="comment"># ç›®æ ‡èŒƒå›´[0,2064]</span></span><br><span class="line">images = [visdial[i][<span class="string">&quot;img&quot;</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(st,ed)] <span class="comment"># ç›®æ ‡å›¾ç‰‡åˆ—è¡¨</span></span><br><span class="line">target_captions = [visdial[i][<span class="string">&quot;dialog&quot;</span>][<span class="number">0</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(st,ed)] <span class="comment"># ç›®æ ‡å›¾ç‰‡å¯¹åº”çš„captionä½œä¸ºç”¨æˆ·æè¿°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> Blip2Processor, Blip2ForConditionalGeneration</span><br><span class="line">processor2 = Blip2Processor.from_pretrained(config[<span class="string">&quot;vqa_model&quot;</span>])</span><br><span class="line">blip2 = Blip2ForConditionalGeneration.from_pretrained(config[<span class="string">&quot;vqa_model&quot;</span>], device_map=&#123;<span class="string">&quot;&quot;</span>: <span class="number">0</span>&#125;, torch_dtype=torch.float16)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reconstruct_caption</span>(<span class="params">dialogue, caption_recons</span>):</span><br><span class="line">caption_recon=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> config[<span class="string">&quot;reconstruct&quot;</span>]: <span class="comment"># é‡æ„å¯¹è¯ä¸Šä¸‹æ–‡</span></span><br><span class="line">caption_recon = OpenAI.reconstruct_dialog(</span><br><span class="line">dialog=dialogue,</span><br><span class="line">model=config[<span class="string">&quot;gpt_model&quot;</span>]</span><br><span class="line">).choices[<span class="number">0</span>].message.content</span><br><span class="line"><span class="keyword">if</span> caption_recon == caption_recons[-<span class="number">1</span>]:</span><br><span class="line">caption_recon = OpenAI.paraphrase(caption_recon, model=config[<span class="string">&quot;gpt_model&quot;</span>]).choices[<span class="number">0</span>].message.content</span><br><span class="line"><span class="keyword">else</span>: <span class="comment"># ChatIRï¼š&quot;, &quot;è¿æ¥</span></span><br><span class="line">caption_recon = config[<span class="string">&quot;sep_token&quot;</span>].join(dialogue)</span><br><span class="line"><span class="keyword">return</span> caption_recon</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_dialog</span>(<span class="params">idx</span>):</span><br><span class="line"><span class="string">&quot;&quot;&quot;ç”Ÿæˆå¯¹è¯æ•°æ®</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">idx : å›¾ç‰‡ç´¢å¼•(st-&gt;0)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">image = Image.<span class="built_in">open</span>(images[idx])</span><br><span class="line">caption = target_captions[idx] <span class="comment"># ç›®æ ‡å›¾ç‰‡å¯¹åº”çš„captionä½œä¸ºç”¨æˆ·æè¿°</span></span><br><span class="line">tqdm.write(<span class="string">f&quot;\nCaption <span class="subst">&#123;idx&#125;</span>: <span class="subst">&#123;caption&#125;</span>&quot;</span>)</span><br><span class="line">dialogue = [caption] <span class="comment"># å¯¹è¯æ¡†</span></span><br><span class="line">caption_recon = caption <span class="comment"># é‡æ„åçš„æè¿°ï¼Œç”¨äºåŒ¹é…å›¾ç‰‡</span></span><br><span class="line">caption_recons = [caption] <span class="comment"># é‡æ„æè¿°åˆ—è¡¨</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>): <span class="comment"># 10è½®å¯¹è¯</span></span><br><span class="line">question = generate_question(dialogue, caption_recon)</span><br><span class="line">prompt = <span class="string">f&quot;Question: <span class="subst">&#123;question&#125;</span> Answer: &quot;</span></span><br><span class="line">_inputs = processor2(images=image, text=prompt, return_tensors=<span class="string">&#x27;pt&#x27;</span>).to(config[<span class="string">&quot;device&quot;</span>])</span><br><span class="line">_outputs = blip2.generate(**_inputs, do_sample=<span class="literal">False</span>)</span><br><span class="line">answer = processor2.decode(_outputs[<span class="number">0</span>], skip_special_tokens=<span class="literal">True</span>).strip()</span><br><span class="line">qa = question.strip()+ <span class="string">&#x27; &#x27;</span> + answer</span><br><span class="line">dialogue.append(qa)</span><br><span class="line">caption_recon = reconstruct_caption(dialogue, caption_recons)</span><br><span class="line">caption_recons.append(caption_recon)</span><br><span class="line">tqdm.write(<span class="string">f&quot;Round <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>: <span class="subst">&#123;caption_recon&#125;</span>&quot;</span>)</span><br><span class="line">ret = &#123;</span><br><span class="line"><span class="string">&quot;img&quot;</span>: images[idx],</span><br><span class="line"><span class="string">&quot;dialog&quot;</span>: caption_recons</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">filename = <span class="string">&quot;dialogues/&quot;</span>+<span class="string">&quot;mine_&quot;</span> + config[<span class="string">&quot;gpt_model&quot;</span>]+<span class="string">&quot;_&quot;</span>+<span class="string">&quot;BLIP2&quot;</span>+<span class="string">&quot;.txt&quot;</span></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="built_in">len</span>(images)), desc=<span class="string">&quot;å¯¹è¯ç”Ÿæˆè¿›åº¦&quot;</span>, position=<span class="number">0</span>):</span><br><span class="line">dialog = generate_dialog(idx)</span><br><span class="line">f.write(json.dumps(dialog, ensure_ascii=<span class="literal">False</span>)+<span class="string">&quot;\n&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="Debugæ—¥å¿—">Debugæ—¥å¿—</h3><p>æµ‹è¯•ä½¿ç”¨äº†é¡¹ç›®ä»“åº“çš„<code>eval.py</code>æºä»£ç ã€‚</p><p>å¯èƒ½æ˜¯æˆ‘ä½¿ç”¨Windowsç³»ç»Ÿçš„ç¼˜æ•…ï¼Œ<code>eval.py</code>ä»£ç ä¸­æœ‰ä¸€äº›æŠ¥é”™ï¼Œå…·ä½“é—®é¢˜å’Œè°ƒæ•´å¦‚ä¸‹ï¼š</p><ol><li><code>AttributeError: Can't pickle local object 'BLIP_ZERO_SHOT_BASELINE.&lt;locals&gt;.&lt;lambda&gt;'</code><ul><li>åŸå› ï¼šåœ¨Windowsä¸Šä½¿ç”¨å¤šè¿›ç¨‹ï¼ˆ<code>num_workers&gt;0</code>ï¼‰æ—¶ï¼Œéœ€è¦pickleå¯¹è±¡ï¼Œä½†æ˜¯å…¶ä¸­çš„lambdaå‡½æ•°æˆ–å±€éƒ¨å‡½æ•°ä¸èƒ½è¢«pickle</li><li>è§£å†³ï¼šå°†lambdaå‡½æ•°æ”¹ä¸ºå…¨å±€å‡½æ•°ï¼Œå†ä½¿ç”¨<code>functools.partial</code>è¿›è¡Œå‚æ•°ç»‘å®š</li></ul></li><li><code>RuntimeError: Expected all tensors to be on the same device, but found at least two devices, cuda:0 and cpu!</code><ul><li>åŸå› ï¼šå‡½æ•°<code>text_encode_fn</code>ä¸­çš„<code>processor</code>æ²¡æœ‰<code>to(device)</code></li><li>è§£å†³ï¼šå¤šåšä¸€æ­¥ï¼Œå°†<code>processor</code>çš„è¾“å‡º``to(device)`</li></ul></li></ol><p>å°è¯•è·‘é€š<code>generate_dialog.py</code>çš„è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº†ä¸Šè¿°é—®é¢˜ï¼Œè§£å†³æ–¹æ³•åŒã€‚</p><h3 id="æµ‹è¯•ç»“æœ">æµ‹è¯•ç»“æœ</h3><p>æ­£å¸¸æƒ…å†µä¸‹3~5åˆ†é’Ÿå¯ä»¥ç”Ÿæˆ1æ¡æ•°æ®ï¼ˆå¤§çº¦80æ¬¡è¯·æ±‚ï¼‰ã€‚<br>ä½†ç”±äºæˆ‘ç”Ÿæˆæ•°æ®çŸ­æ—¶é—´å†…å¤§é‡è°ƒç”¨OpenAI APIï¼Œå¯¼è‡´è¢«é™æµï¼Œ20~30åˆ†é’Ÿæ‰èƒ½äº§ç”Ÿ1æ¡æ•°æ®ï¼Œæ•…æœ¬æ¬¡å®ç°åœ¨evalé˜¶æ®µä»…æœ‰253æ¡æ•°æ®ã€‚</p><p>åœ¨ä½¿ç”¨ChatGPT-4o-miniä½œä¸ºæé—®æ¨¡å‹Gï¼ŒBLIP2ä½œä¸ºå›ç­”æ¨¡å‹Aï¼Œä½¿ç”¨åŒä¸€æµ‹è¯•ä»£ç çš„æƒ…å†µä¸‹ï¼Œæµ‹è¯•ç»“æœå’Œä»“åº“çš„å¯¹è¯æ•°æ®Hit@Kå¯¹æ¯”å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">length</th><th style="text-align:center">ä»“åº“æ•°æ®Hit@10(2064 testcases)</th><th style="text-align:center">å®ç°æ•°æ®Hit@10ï¼ˆ253 testcasesï¼‰</th></tr></thead><tbody><tr><td style="text-align:center">0</td><td style="text-align:center">71.12%</td><td style="text-align:center">72.33%</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">79.02%</td><td style="text-align:center">81.42%</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">83.09%</td><td style="text-align:center">83.40%</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">85.85%</td><td style="text-align:center">85.38%</td></tr><tr><td style="text-align:center">4</td><td style="text-align:center">87.55%</td><td style="text-align:center">86.56%</td></tr><tr><td style="text-align:center">5</td><td style="text-align:center">88.71%</td><td style="text-align:center">87.75%</td></tr><tr><td style="text-align:center">6</td><td style="text-align:center">89.39%</td><td style="text-align:center">88.14%</td></tr><tr><td style="text-align:center">7</td><td style="text-align:center">90.12%</td><td style="text-align:center">88.54%</td></tr><tr><td style="text-align:center">8</td><td style="text-align:center">90.70%</td><td style="text-align:center">88.93%</td></tr><tr><td style="text-align:center">9</td><td style="text-align:center">91.09%</td><td style="text-align:center">89.33%</td></tr><tr><td style="text-align:center">10</td><td style="text-align:center">91.47%</td><td style="text-align:center">90.12%</td></tr></tbody></table><p>BRIå¯¹æ¯”ï¼ˆè¶Šä½è¶Šå¥½ï¼‰ï¼š</p><ul><li>ä»“åº“å¯¹è¯çš„BRIï¼š10.195615768432617</li><li>å®ç°å¯¹è¯çš„BRIï¼š10.252569198608398</li></ul>]]></content>
    
    
    <summary type="html">å®ç°è®ºæ–‡ã€ŠInteractive Text-to-ImageRetrieval with Large Language Modelsï¼šA Plug-and-Play Approachã€‹</summary>
    
    
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://www.cclmsy.cc/categories/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="è®ºæ–‡å®ç°" scheme="https://www.cclmsy.cc/tags/%E8%AE%BA%E6%96%87%E5%AE%9E%E7%8E%B0/"/>
    
    <category term="å›¾åƒæ£€ç´¢" scheme="https://www.cclmsy.cc/tags/%E5%9B%BE%E5%83%8F%E6%A3%80%E7%B4%A2/"/>
    
    <category term="MLLM" scheme="https://www.cclmsy.cc/tags/MLLM/"/>
    
  </entry>
  
  <entry>
    <title>Bag of Features å›¾åƒæ£€ç´¢ç®—æ³•</title>
    <link href="https://www.cclmsy.cc/posts/bag_of_features.html"/>
    <id>https://www.cclmsy.cc/posts/bag_of_features.html</id>
    <published>2025-03-15T16:00:00.000Z</published>
    <updated>2025-07-18T12:42:11.031Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®—æ³•åŸç†">ç®—æ³•åŸç†</h2><h3 id="å¼•å…¥ï¼šè¯è¢‹æ¨¡å‹ï¼ˆBag-of-Wordsï¼‰">å¼•å…¥ï¼šè¯è¢‹æ¨¡å‹ï¼ˆBag of Wordsï¼‰</h3><p>Bag of Wordsæ˜¯æ–‡æœ¬åˆ†ç±»ä¸­ä¸€ç§é€šä¿—æ˜“æ‡‚çš„ç­–ç•¥ã€‚<br>ä¸€èˆ¬æ¥è®²ï¼Œå¦‚æœæˆ‘ä»¬è¦äº†è§£ä¸€æ®µæ–‡æœ¬çš„ä¸»è¦å†…å®¹ï¼Œæœ€è¡Œä¹‹æœ‰æ•ˆçš„ç­–ç•¥æ˜¯æŠ“å–æ–‡æœ¬ä¸­çš„å…³é”®è¯ï¼Œæ ¹æ®å…³é”®è¯å‡ºç°çš„é¢‘ç‡ç¡®å®šè¿™æ®µæ–‡æœ¬çš„ä¸­å¿ƒæ€æƒ³ã€‚</p><p>Bag of Wordsä¸­çš„Wordsæ˜¯åŒºåˆ†åº¦è¾ƒé«˜çš„å•è¯ã€‚<br>æ ¹æ®è¿™äº›Words ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¿«é€Ÿè¯†åˆ«å‡ºæ–‡ç« å†…å®¹ï¼Œå¹¶å¯¹æ–‡ç« è¿›è¡Œåˆ†ç±»ã€‚</p><p>Bag of Featuresæ˜¯å¯¹å›¾åƒçš„ä¸€ç§ç±»ä¼¼çš„å¤„ç†æ–¹æ³•ï¼ŒæŠ½å‡ºå›¾åƒä¸­çš„å…³é”®ç‰¹å¾ï¼Œæ ¹æ®è¿™äº›ç‰¹å¾æ¥è¯†åˆ«å›¾åƒã€‚</p><h3 id="Bag-of-Features-ç®—æ³•æµç¨‹">Bag of Features ç®—æ³•æµç¨‹</h3><ol><li>æå–å‡ºå…³é”®ç‰¹å¾ï¼Œé€šå¸¸ä¼šä½¿ç”¨SIFTç‰¹å¾ã€‚</li><li>å°†è¿™äº›ç‰¹å¾è¿›è¡ŒK-Meansèšç±»ï¼Œå¾—åˆ°åŒ…å«Kä¸ªè§†è§‰è¯æ±‡çš„è¯å…¸ã€‚</li><li>å¯¹å›¾åƒä¸­çš„ç‰¹å¾ç‚¹è¿›è¡Œé‡åŒ–ï¼Œå°†ç‰¹å¾ç‚¹æ˜ å°„åˆ°è§†è§‰è¯æ±‡ä¸Šã€‚</li><li>ç»Ÿè®¡æ¯ä¸ªè§†è§‰è¯æ±‡çš„å‡ºç°é¢‘ç‡ï¼Œå¾—åˆ°é¢‘ç‡ç›´æ–¹å›¾ã€‚</li><li>æ„é€ ç‰¹å¾åˆ°å›¾åƒçš„å€’æ’è¡¨ï¼Œç”¨äºå›¾åƒæ£€ç´¢ã€‚</li><li>æ ¹æ®ç´¢å¼•ç»“æœï¼Œè¿›è¡Œç›´æ–¹å›¾åŒ¹é…</li></ol><h3 id="ä»£ç å®ç°">ä»£ç å®ç°</h3><p><code>image</code>æ–‡ä»¶å¤¹ä¸‹å­˜æ”¾å›¾åƒï¼Œ<code>query</code>æ–‡ä»¶å¤¹ä¸‹å­˜æ”¾æŸ¥è¯¢å›¾åƒã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn.cluster <span class="keyword">import</span> KMeans</span><br><span class="line"><span class="keyword">from</span> scipy.spatial <span class="keyword">import</span> distance</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;LOKY_MAX_CPU_COUNT&quot;</span>] = <span class="string">&quot;4&quot;</span> <span class="comment"># KMenas å¤šçº¿ç¨‹è®¾ç½®</span></span><br><span class="line"></span><br><span class="line">image_paths = [] <span class="comment"># å›¾ç‰‡è·¯å¾„åˆ—è¡¨</span></span><br><span class="line">sift_res = &#123;&#125; <span class="comment"># sift_res[img_path] = (keypoints, descriptors) # SIFTç‰¹å¾å­—å…¸</span></span><br><span class="line">k_means = <span class="literal">None</span> <span class="comment"># K-Meansæ¨¡å‹</span></span><br><span class="line">k = <span class="number">50</span> <span class="comment"># è§†è§‰è¯å…¸å¤§å°</span></span><br><span class="line">histograms = &#123;&#125; <span class="comment"># ç›´æ–¹å›¾å­—å…¸</span></span><br><span class="line">sift = cv2.SIFT_create() <span class="comment"># åˆ›å»ºSIFTå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰å›¾ç‰‡è·¯å¾„</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_images</span>(<span class="params">image_folder</span>):</span><br><span class="line">    <span class="keyword">global</span> image_paths</span><br><span class="line">    <span class="keyword">for</span> root, _, files <span class="keyword">in</span> os.walk(image_folder): </span><br><span class="line">        <span class="keyword">for</span> filename <span class="keyword">in</span> files:</span><br><span class="line">            <span class="keyword">if</span> filename.lower().endswith(<span class="string">&quot;.jpg&quot;</span>):</span><br><span class="line">                image_paths.append(os.path.join(root, filename))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. æå–SIFTç‰¹å¾</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_sift_features</span>(<span class="params">cache=<span class="string">&quot;cache/BOF_SIFT_desc.pkl&quot;</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;1.æå–SIFTç‰¹å¾&quot;</span>)</span><br><span class="line">    <span class="keyword">global</span> sift_res, image_paths</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(cache):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(cache, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;ä»ç¼“å­˜ä¸­åŠ è½½SIFTç‰¹å¾: <span class="subst">&#123;cache&#125;</span>&quot;</span>)</span><br><span class="line">            sift_res = pickle.load(f)</span><br><span class="line">            <span class="keyword">return</span> </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">for</span> img_path <span class="keyword">in</span> tqdm(image_paths):</span><br><span class="line">        img = cv2.imread(img_path, cv2.IMREAD_GRAYSCALE) </span><br><span class="line">        _, desc = sift.detectAndCompute(img, <span class="literal">None</span>) <span class="comment"># æå–ç‰¹å¾ç‚¹å’Œæè¿°ç¬¦</span></span><br><span class="line">        sift_res[img_path] = desc</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(cache, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ä¿å­˜SIFTç‰¹å¾åˆ°ç¼“å­˜: <span class="subst">&#123;cache&#125;</span>&quot;</span>)</span><br><span class="line">        pickle.dump(sift_res, f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. K-Meansèšç±»ï¼Œåˆ›å»ºè§†è§‰è¯å…¸</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_vocabulary</span>(<span class="params">cache=<span class="string">&quot;cache/BOF_kmeans.pkl&quot;</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;2.åˆ›å»ºè§†è§‰è¯å…¸&quot;</span>)</span><br><span class="line">    <span class="keyword">global</span> k_means, k</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(cache):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(cache, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;ä»ç¼“å­˜ä¸­åŠ è½½K-Meansæ¨¡å‹: <span class="subst">&#123;cache&#125;</span>&quot;</span>)</span><br><span class="line">            k_means=pickle.load(f)</span><br><span class="line">            <span class="keyword">return</span> </span><br><span class="line"></span><br><span class="line">    st = time()</span><br><span class="line">    descriptors_list = <span class="built_in">list</span>(sift_res.values())</span><br><span class="line">    all_descriptors = np.vstack(descriptors_list)  <span class="comment"># æ±‡æ€»æ‰€æœ‰ç‰¹å¾ç‚¹</span></span><br><span class="line">    k_means = KMeans(n_clusters=k, random_state=<span class="number">0</span>, n_init=<span class="number">10</span>)</span><br><span class="line">    k_means.fit(all_descriptors)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;K-Meansèšç±»è€—æ—¶: <span class="subst">&#123;time()-st:<span class="number">.2</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(cache, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ä¿å­˜K-Meansæ¨¡å‹åˆ°ç¼“å­˜: <span class="subst">&#123;cache&#125;</span>&quot;</span>)</span><br><span class="line">        pickle.dump(k_means, f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. è®¡ç®—BoFç›´æ–¹å›¾</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_histogram</span>(<span class="params">img_path</span>):</span><br><span class="line">    <span class="keyword">if</span> img_path <span class="keyword">in</span> sift_res:</span><br><span class="line">        descriptors = sift_res[img_path] <span class="comment"># è·å–æè¿°ç¬¦</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        img = cv2.imread(img_path, cv2.IMREAD_GRAYSCALE) </span><br><span class="line">        _, descriptors = sift.detectAndCompute(img, <span class="literal">None</span>)</span><br><span class="line">    words = k_means.predict(descriptors) <span class="comment"># é¢„æµ‹æ¯ä¸ªæè¿°ç¬¦çš„è¯æ±‡ç´¢å¼•</span></span><br><span class="line">    hist, _ = np.histogram(words, bins=np.arange(k+<span class="number">1</span>)) <span class="comment"># è®¡ç®—ç›´æ–¹å›¾</span></span><br><span class="line">    hist = hist / np.linalg.norm(hist)  <span class="comment"># å½’ä¸€åŒ–</span></span><br><span class="line">    <span class="keyword">return</span> hist</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_histograms</span>(<span class="params">cache=<span class="string">&quot;cache/BOF_histogram.pkl&quot;</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;3.è®¡ç®—æ•°æ®åº“çš„BoFç›´æ–¹å›¾&quot;</span>)</span><br><span class="line">    <span class="keyword">global</span> image_paths, histograms, k_means</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(cache):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(cache, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;ä»ç¼“å­˜ä¸­åŠ è½½æ•°æ®åº“ç›´æ–¹å›¾: <span class="subst">&#123;cache&#125;</span>&quot;</span>)</span><br><span class="line">            histograms=pickle.load(f)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> img_path <span class="keyword">in</span> tqdm(image_paths):</span><br><span class="line">        histograms[img_path] = compute_histogram(img_path)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(cache, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ä¿å­˜æ•°æ®åº“ç›´æ–¹å›¾åˆ°ç¼“å­˜: <span class="subst">&#123;cache&#125;</span>&quot;</span>)</span><br><span class="line">        pickle.dump(histograms, f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. ç›´æ–¹å›¾åŒ¹é…</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cos_sim</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> np.dot(a, b) / (np.linalg.norm(a) * np.linalg.norm(b))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_topk</span>(<span class="params">query_hist, topk=<span class="number">10</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;4.ç›´æ–¹å›¾åŒ¹é…&quot;</span>)</span><br><span class="line">    <span class="keyword">global</span> histograms</span><br><span class="line">    similarities = []</span><br><span class="line">    <span class="keyword">for</span> img_path, hist <span class="keyword">in</span> tqdm(histograms.items()):</span><br><span class="line">        <span class="comment"># dist = distance.euclidean(query_hist, hist)</span></span><br><span class="line">        dist = cos_sim(query_hist, hist)</span><br><span class="line">        similarities.append((img_path, dist))</span><br><span class="line">    similarities.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>) <span class="comment"># é™åºæ’åº</span></span><br><span class="line">    <span class="keyword">return</span> similarities[:topk]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡ŒBoFæµç¨‹</span></span><br><span class="line">image_folder = <span class="string">&quot;image&quot;</span></span><br><span class="line">get_images(image_folder)</span><br><span class="line">extract_sift_features()</span><br><span class="line">create_vocabulary()</span><br><span class="line">compute_histograms()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒ¹é…å›¾åƒ</span></span><br><span class="line">test_img = <span class="string">&quot;query/A0C573_20151103073308_3029240562.jpg&quot;</span></span><br><span class="line">test_hist = compute_histogram(test_img)</span><br><span class="line">topk=get_topk(test_hist, topk=<span class="number">10</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Top 10 ç›¸ä¼¼å›¾ç‰‡:&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i, (filepath, sim) <span class="keyword">in</span> <span class="built_in">enumerate</span>(topk):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>. <span class="subst">&#123;filepath&#125;</span> - ç›¸ä¼¼åº¦: <span class="subst">&#123;sim:<span class="number">.4</span>f&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœï¼š</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(DL) PS <span class="attr">D:</span>\Repos\Course\CVLab&gt; &amp; <span class="attr">C:</span><span class="regexp">/Users/</span>CCLMSY<span class="regexp">/.conda/</span>envs<span class="regexp">/DL/</span>python.exe <span class="attr">d:</span><span class="regexp">/Repos/</span>Course<span class="regexp">/CVLab/</span>BOF.py</span><br><span class="line"><span class="number">1.</span>æå–SIFTç‰¹å¾</span><br><span class="line">ä»ç¼“å­˜ä¸­åŠ è½½SIFTç‰¹å¾: cache/BOF_SIFT_desc.pkl</span><br><span class="line"><span class="number">2.</span>åˆ›å»ºè§†è§‰è¯å…¸</span><br><span class="line">ä»ç¼“å­˜ä¸­åŠ è½½K-Meansæ¨¡å‹: cache/BOF_kmeans.pkl</span><br><span class="line"><span class="number">3.</span>è®¡ç®—æ•°æ®åº“çš„BoFç›´æ–¹å›¾</span><br><span class="line">ä»ç¼“å­˜ä¸­åŠ è½½æ•°æ®åº“ç›´æ–¹å›¾: cache/BOF_histogram.pkl</span><br><span class="line"><span class="number">4.</span>æ„é€ å€’æ’ç´¢å¼•</span><br><span class="line"><span class="number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="number">945</span><span class="regexp">/945 [00:00&lt;00:00, 23779.80it/</span>s] </span><br><span class="line"><span class="number">5.</span>ç›´æ–¹å›¾åŒ¹é…</span><br><span class="line"><span class="number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="number">946</span><span class="regexp">/946 [00:00&lt;00:00, 157646.77it/</span>s] </span><br><span class="line">query/A0C573_20151029074136_6562078379.jpg åŒ¹é…åˆ°çš„æœ€ç›¸ä¼¼å›¾ç‰‡æ˜¯ image\A0C573\A0C573_20151029074136_6562078379.jpg</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ä¸€ç§æ˜¯ç”¨äºå›¾åƒå’Œè§†é¢‘æ£€ç´¢çš„ç®—æ³•</summary>
    
    
    
    <category term="DLç¬”è®°" scheme="https://www.cclmsy.cc/categories/DL%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="å›¾åƒæ£€ç´¢" scheme="https://www.cclmsy.cc/tags/%E5%9B%BE%E5%83%8F%E6%A3%80%E7%B4%A2/"/>
    
    <category term="CV" scheme="https://www.cclmsy.cc/tags/CV/"/>
    
  </entry>
  
  <entry>
    <title>SIFT å›¾åƒç‰¹å¾åŒ¹é…ç®—æ³•</title>
    <link href="https://www.cclmsy.cc/posts/sift.html"/>
    <id>https://www.cclmsy.cc/posts/sift.html</id>
    <published>2025-03-15T16:00:00.000Z</published>
    <updated>2025-07-21T05:29:25.279Z</updated>
    
    <content type="html"><![CDATA[<h2 id="SIFTç®€ä»‹">SIFTç®€ä»‹</h2><p>SIFTï¼ˆScale-Invariant Feature Transformï¼Œå°ºåº¦ä¸å˜ç‰¹å¾å˜æ¢åŒ¹é…ç®—æ³•ï¼‰æ˜¯ä¸€ç§é«˜æ•ˆåŒºåŸŸæ£€æµ‹ç®—æ³•ã€‚</p><p>SIFTç®—æ³•å¯ä»¥è§£å†³çš„é—®é¢˜ï¼š</p><ol><li>RSTï¼ˆRotation Scale Translationï¼‰ï¼šå›¾åƒçš„æ—‹è½¬ã€ç¼©æ”¾ã€å¹³ç§»ç­‰å˜æ¢</li><li>å›¾åƒçš„ä»¿å°„å˜æ¢ï¼ˆAffine Transformationï¼‰ï¼šå›¾åƒçš„æ‹‰ä¼¸ã€å‹ç¼©ã€æ‰­æ›²ç­‰å˜æ¢</li><li>å›¾åƒçš„å…‰ç…§å˜åŒ–</li><li>ç›®æ ‡éƒ¨åˆ†é®æŒ¡</li><li>æ‚ç‰©å’Œå™ªå£°å¹²æ‰°</li></ol><h2 id="SIFTç®—æ³•åŸç†">SIFTç®—æ³•åŸç†</h2><h3 id="1-é«˜æ–¯æ»¤æ³¢">1. é«˜æ–¯æ»¤æ³¢</h3><p>ä¸€ä¸ªå›¾åƒçš„å°ºåº¦ç©ºé—´$L$æ˜¯é«˜æ–¯å‡½æ•°$G(x,y,\sigma)$ä¸å›¾åƒ$I(x,y)$çš„å·ç§¯ï¼š</p><p>$$<br>\begin{aligned}<br>L(x,y,\sigma) &amp;= G(x,y,\sigma) * I(x,y) \\<br>G(x,y,\sigma) &amp;= \dfrac{1}{2\pi\sigma^2}e^{-\frac{(x-x_0)^2+(y-y_0)^2}{2\sigma^2}}<br>\end{aligned}<br>$$</p><p>å…¶ä¸­ï¼Œ$G(x,y,\sigma)$æ˜¯é«˜æ–¯å‡½æ•°ï¼Œ$\sigma$æ˜¯å°ºåº¦å› å­ï¼Œ$*$æ˜¯å·ç§¯è¿ç®—ï¼Œ$x_0,y_0$æ˜¯é«˜æ–¯å‡½æ•°çš„ä¸­å¿ƒï¼ˆå·ç§¯æ ¸çš„ä¸­å¿ƒï¼‰ã€‚</p><p>$\sigma$è¶Šå°ï¼Œå›¾åƒè¢«å¹³æ»‘çš„è¶Šå°‘ï¼Œå›¾åƒçš„ç»†èŠ‚è¶Šå¤šã€‚<br>å°å°ºåº¦å¯¹åº”äºå›¾åƒçš„ç»†èŠ‚ï¼Œå¤§å°ºåº¦å¯¹åº”äºå›¾åƒçš„æ•´ä½“ç‰¹å¾ã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/others/Gaussian_Blur.png" alt="Gaussian Blur"></p><h3 id="2-é«˜æ–¯é‡‘å­—å¡”">2. é«˜æ–¯é‡‘å­—å¡”</h3><p><img src="https://source.cclmsy.cc/posts/notes/others/%E9%AB%98%E6%96%AF%E9%87%91%E5%AD%97%E5%A1%94.png" alt="é«˜æ–¯é‡‘å­—å¡”"></p><p>é«˜æ–¯é‡‘å­—å¡”åŒ…å«å¤šç»„ï¼ˆOctaveï¼‰å›¾åƒï¼Œæ¯ç»„å›¾åƒç”±å¤šå±‚ï¼ˆIntervalï¼‰ä¸åŒå°ºåº¦çš„é«˜æ–¯æ¨¡ç³Šå›¾åƒç»„æˆã€‚</p><p>æ„å»ºè¿‡ç¨‹ï¼š</p><ol><li>å°†åŸå›¾åƒæ‰©å¤§åˆ°ä¸¤å€ï¼Œä½œä¸ºç¬¬0ç»„çš„ç¬¬0å±‚</li><li>å¯¹ç¬¬0ç»„çš„ç¬¬0å±‚è¿›è¡Œ$\sigma_0$çš„é«˜æ–¯æ¨¡ç³Šï¼Œå¾—åˆ°ç¬¬0ç»„çš„ç¬¬1å±‚</li><li>é€‰å®šä¸€ä¸ªæ¯”ä¾‹ç³»æ•°$k$ï¼Œå¯¹ç¬¬0ç»„çš„ç¬¬1å±‚è¿›è¡Œ$k\sigma_0$çš„é«˜æ–¯æ¨¡ç³Šï¼Œå¾—åˆ°ç¬¬0ç»„çš„ç¬¬2å±‚</li><li>å¯¹ç¬¬0ç»„çš„ç¬¬2å±‚è¿›è¡Œ$k^2\sigma_0$çš„é«˜æ–¯æ¨¡ç³Šï¼Œå¾—åˆ°ç¬¬0ç»„çš„ç¬¬3å±‚ï¼Œä»¥æ­¤ç±»æ¨â€¦</li><li>å°†<strong>ä¸Šä¸€ç»„å€’æ•°ç¬¬3å±‚å›¾åƒ</strong>åšæ¯”ä¾‹å› å­ä¸º2çš„é™é‡‡æ ·ï¼Œå¾—åˆ°ä¸‹ä¸€ç»„çš„ç¬¬0å±‚ï¼Œé‡å¤æ­¥éª¤2-4</li></ol><p>ç»„æ•°è®¡ç®—å…¬å¼ï¼š$O=\lfloor\log_2(\min(M,N))\rfloor-3$</p><ul><li>$M,N$ï¼šåŸå›¾åƒçš„é•¿å®½</li></ul><p>å±‚æ•°å…¬å¼ï¼š$S=n+3$</p><ul><li>$S$æ˜¯æ¯ç»„çš„å±‚æ•°ï¼ˆè‡ªè®¾ï¼‰</li><li>$n$æ˜¯æœ€ç»ˆæƒ³åœ¨å·®åˆ†é‡‘å­—å¡”ä¸­æå–æå€¼ç‚¹çš„å±‚æ•°ï¼ˆè§å·®åˆ†é‡‘å­—å¡”ï¼‰</li></ul><p>å¹³æ»‘å› å­å…¬å¼ï¼š$\sigma(o,r)=\sigma_0 2^{o+\frac{r}{n}}$ï¼Œå…¶ä¸­$o$æ˜¯ç»„æ•°ï¼Œ$r$æ˜¯å±‚æ•°</p><ul><li>SIFTç®—æ³•ä¸­ï¼Œ$\sigma_0=1.6$ã€‚ä½†ç”±äºç›¸æœºå…·æœ‰åˆå§‹æ¨¡ç³Š$\sigma_0=0.5$ï¼Œå®é™…$\sigma_0=\sqrt{1.6^2-0.5^2}=1.52$</li><li>ç¬¬oå±‚çš„åˆå§‹å¹³æ»‘å› å­$\sigma(o,0)=2^o\sigma_0$</li><li>$k=2^{1/n}$</li></ul><p><img src="https://source.cclmsy.cc/posts/notes/others/%E9%AB%98%E6%96%AF%E9%87%91%E5%AD%97%E5%A1%942.png" alt="é«˜æ–¯é‡‘å­—å¡”2"></p><p>é‡‘å­—å¡”å†…å„å›¾ç‰‡çš„å…³ç³»ï¼š</p><ul><li>åœ¨åŒä¸€ç»„å†…ï¼Œä¸åŒå±‚å›¾åƒçš„å°ºå¯¸æ˜¯ä¸€æ ·çš„ï¼Œåä¸€å±‚å›¾åƒçš„é«˜æ–¯å¹³æ»‘å› å­Ïƒæ˜¯å‰ä¸€å±‚å›¾åƒå¹³æ»‘å› å­çš„kå€</li><li>åœ¨ä¸åŒç»„å†…ï¼Œåä¸€ç»„ç¬¬ä¸€ä¸ªå›¾åƒæ˜¯å‰ä¸€ç»„å€’æ•°ç¬¬ä¸‰ä¸ªå›¾åƒçš„äºŒåˆ†ä¹‹ä¸€é‡‡æ ·ï¼Œå›¾åƒå¤§å°æ˜¯å‰ä¸€ç»„çš„ä¸€åŠ</li></ul><h3 id="3-é«˜æ–¯å·®åˆ†é‡‘å­—å¡”ä¸æå€¼ç‚¹æ£€æµ‹">3. é«˜æ–¯å·®åˆ†é‡‘å­—å¡”ä¸æå€¼ç‚¹æ£€æµ‹</h3><h4 id="3-1-é«˜æ–¯å·®åˆ†é‡‘å­—å¡”">3.1 é«˜æ–¯å·®åˆ†é‡‘å­—å¡”</h4><p>å¯¹é«˜æ–¯é‡‘å­—å¡”çš„æ¯ä¸€ç»„å›¾åƒï¼Œè®¡ç®—ç›¸é‚»ä¸¤å±‚å›¾åƒçš„å·®åˆ†ï¼Œå¾—åˆ°é«˜æ–¯å·®åˆ†é‡‘å­—å¡”(DoG, Difference of Gaussian)ã€‚</p><p>$$D(x,y,\sigma) = (G(x,y,k\sigma)-G(x,y,\sigma)) * I(x,y)$$</p><h4 id="3-2-ä¼°è®¡æå€¼ç‚¹">3.2 ä¼°è®¡æå€¼ç‚¹</h4><p>å°†æ¯ä¸ªåƒç´ ç‚¹å’Œå®ƒåœ¨3Ã—3Ã—3çš„é‚»åŸŸå†…çš„26ä¸ªåƒç´ ç‚¹è¿›è¡Œæ¯”è¾ƒã€‚<br>å¦‚æœè¿™ä¸ªç‚¹æ˜¯è¿™27ä¸ªç‚¹ä¸­çš„æœ€å¤§å€¼æˆ–æœ€å°å€¼ï¼Œåˆ™è®¤ä¸ºè¿™ä¸ªç‚¹æ˜¯ä¸€ä¸ªæå€¼ç‚¹ã€‚</p><p>DoGé‡‘å­—å¡”æ˜¯ç¦»æ•£çš„(å› ä¸ºå°ºåº¦ç©ºé—´å’Œåƒç´ ç‚¹éƒ½æ˜¯ç¦»æ•£çš„)ï¼Œæ‰€ä»¥æ‰¾åˆ°çš„æå€¼ç‚¹ä¸å¤ªå‡†ç¡®çš„ï¼Œå¾ˆå¤§å¯èƒ½åœ¨çœŸæ­£æå€¼ç‚¹é™„è¿‘ï¼Œå› æ­¤éœ€è¦å¯¹æ¯ä¸ªæå€¼ç‚¹è¿›è¡Œæ’å€¼ã€‚</p><h4 id="3-3-æ³°å‹’å±•å¼€æ±‚ç²¾ç¡®æå€¼ç‚¹">3.3 æ³°å‹’å±•å¼€æ±‚ç²¾ç¡®æå€¼ç‚¹</h4><p>å¯¹æ¯ä¸ªæå€¼ç‚¹$X_0(x_0,y_0,\sigma_0)^T$ï¼Œè¿›è¡Œä¸‰å…ƒäºŒæ¬¡æ³°å‹’å±•å¼€ï¼š</p><p>$$<br>\begin{aligned}<br>f(X) &amp;= f(x_0)+\dfrac{\partial f}{\partial X}^T\hat{X}+\dfrac{1}{2}\hat{X}^T\dfrac{\partial^2 f}{\partial X^2}\hat{X} \\<br>\hat{X} &amp;= X-X_0 \\<br>X &amp;= (x,y,\sigma)^T<br>\end{aligned}<br>$$</p><p>å°†$f(X)$å¯¹$X$æ±‚å¯¼ï¼š</p><p>$$<br>\dfrac{\partial f(X)}{\partial X} = \dfrac{\partial f}{\partial X}^T+\dfrac{1}{2}\left( \dfrac{\partial^2 f}{\partial X^2} + \dfrac{\partial^2 f}{\partial X^2}^T \right)\hat{X} = \dfrac{\partial f}{\partial X}^T+\dfrac{\partial^2 f}{\partial X^2}\hat{X}<br>$$</p><p>å¯¼æ•°ä¸º0æ—¶ï¼Œè§£å¾—æå€¼ç‚¹ï¼š</p><p>$$<br>\hat{X} = -\dfrac{\partial^2 f}{\partial X^2}^{-1}\dfrac{\partial f}{\partial X}<br>$$</p><p>ä»£å…¥$f(X)$å¾—åˆ°æå€¼ï¼š</p><p>$$<br>f(X) = f(x_0)+\dfrac{1}{2}\dfrac{\partial f}{\partial X}^T\hat{X}<br>$$</p><h4 id="3-4-å»é™¤ä½å¯¹æ¯”åº¦ç‚¹">3.4 å»é™¤ä½å¯¹æ¯”åº¦ç‚¹</h4><p>èˆå»$|f(X_0)|&lt;\dfrac{T}{n}, T=0.04$çš„æå€¼ç‚¹ï¼Œå› ä¸ºè¿™äº›ç‚¹å¯¹åº”çš„å·®åˆ†å€¼å¤ªå°ï¼Œå¯¹æ¯”åº¦ä½ï¼Œä¸å…·æœ‰ä»£è¡¨æ€§ã€‚</p><h4 id="3-5-å»é™¤è¾¹ç¼˜å“åº”">3.5 å»é™¤è¾¹ç¼˜å“åº”</h4><p>DoGåœ¨è¾¹ç¼˜ä¼šæœ‰æ¯”è¾ƒå¤§çš„å€¼ï¼ˆè¾¹ç¼˜å“åº”å¼ºï¼‰ï¼Œä½†è¾¹ç¼˜ä¸ä¸€å®šèƒ½å¤Ÿæä¾›ç¨³å®šçš„ç‰¹å¾ï¼Œå› æ­¤éœ€è¦å»é™¤è¾¹ç¼˜å“åº”å¼ºçš„ç‚¹ã€‚</p><p>å¯¹äºæ¯ä¸ªæå€¼ç‚¹ï¼Œè®¡ç®—HessiançŸ©é˜µçš„è¿¹å’Œè¡Œåˆ—å¼ï¼š</p><p>$$<br>\begin{aligned}<br>H &amp;= \begin{bmatrix} D_{xx} &amp; D_{xy} \ D_{xy} &amp; D_{yy} \end{bmatrix} \\<br>Tr(H) &amp;= D_{xx} + D_{yy} = \alpha + \beta \\<br>Det(H) &amp;= D_{xx} D_{yy} - (D_{xy})^2 = \alpha \beta<br>\end{aligned}<br>$$</p><p>å…¶ä¸­ï¼š</p><ul><li>$\alpha$ä¸ºè¾ƒå¤§çš„ç‰¹å¾å€¼ï¼Œ$\beta$ä¸ºè¾ƒå°çš„ç‰¹å¾å€¼</li><li>$\alpha = r \beta$ï¼Œ$r$æ˜¯ä¸€ä¸ªå¤§äº1çš„å®æ•°</li></ul><p>è¿‡æ»¤ï¼š</p><ol><li>$Det(H)&lt;0$</li><li>$\dfrac{(Tr(H))^2}{Det(H)}\ge (r+1)^2/r$ï¼Œè®ºæ–‡æ¨èå€¼$r=10$</li></ol><h3 id="4-å…³é”®ç‚¹æ–¹å‘åˆ†é…">4. å…³é”®ç‚¹æ–¹å‘åˆ†é…</h3><ol><li>0~360åº¦åˆ’åˆ†ä¸º36 binsï¼Œæ¯ä¸ªbinä¸º10åº¦</li><li>åœ¨<strong>é«˜æ–¯é‡‘å­—å¡”</strong>æ‰¾åˆ°å…³é”®ç‚¹å¯¹åº”ä½ç½®ï¼Œä»¥å®ƒä¸ºåœ†å¿ƒï¼ŒåŠå¾„ä¸º$1.5\sigma$ç”»åœ†</li><li>ç»Ÿè®¡åœ†ä¸­æ‰€æœ‰åƒç´ çš„æ¢¯åº¦æ–¹å‘ã€æ¢¯åº¦å¹…å€¼ï¼ˆæ¨¡ï¼‰ï¼Œç›´æ–¹å›¾å¹³æ»‘å¤„ç†ï¼Œç”¨$1.5\sigma$è¿›è¡Œé«˜æ–¯åŠ æƒ<ul><li>å¹³æ»‘å¤„ç†ï¼šé˜²æ­¢æŸä¸ªæ¢¯åº¦æ–¹å‘è§’åº¦å—å™ªå£°å¹²æ‰°ç­‰å› ç´ çªå˜</li><li>é«˜æ–¯åŠ æƒï¼šä½¿ç‰¹å¾ç‚¹é™„ä»¶çš„æ¢¯åº¦å¹…å€¼å…·æœ‰æ›´å¤§çš„æƒé‡ï¼Œå¼¥è¡¥å› æ²¡æœ‰ä»¿å°„ä¸å˜æ€§è€Œå¯¼è‡´çš„ç‰¹å¾ä¸ç¨³å®š</li></ul></li><li>ç»Ÿè®¡å‡ºæ•°å€¼æœ€é«˜çš„æ¢¯åº¦æ–¹å‘ï¼Œä½œä¸ºä¸»æ–¹å‘ï¼›ä¿ç•™å¤§äºä¸»æ–¹å‘80%çš„æ–¹å‘ä½œä¸ºè¾…æ–¹å‘</li></ol><p>æ¢¯åº¦æ–¹å‘å’Œæ¢¯åº¦å¹…å€¼çš„è®¡ç®—ï¼š</p><p>$$<br>m(x,y) = \sqrt{(L(x+1,y)-L(x-1,y))^2+(L(x,y+1)-L(x,y-1))^2}<br>$$</p><p>$$<br>\theta(x,y) = \arctan\left(\dfrac{L(x,y+1)-L(x,y-1)}{L(x+1,y)-L(x-1,y)}\right)<br>$$</p><p>é«˜æ–¯åŠ æƒå…¬å¼ï¼š</p><p>$$<br>W_{i,j} = e^{\dfrac{-(i^2+j^2)}{2\times(1.5\sigma)^2}}<br>$$</p><ul><li>$i,j$æ˜¯åƒç´ ç‚¹åˆ°å…³é”®ç‚¹çš„è·ç¦»</li></ul><h3 id="5-å…³é”®ç‚¹æè¿°">5. å…³é”®ç‚¹æè¿°</h3><p>æè¿°ç¬¦æ˜¯ä¸€ç»„å‘é‡ï¼Œç”¨äºæè¿°ç‰¹å¾ç‚¹åŠå…¶é¢†åŸŸç‚¹çš„ç‰¹å¾ï¼Œä»¥ä¾¿æ›´å¥½åœ°ä¸å…¶ä»–å›¾ç‰‡åŒ¹é…</p><ol><li>å°†åè½´æ ‡ç§»åˆ°å…³é”®ç‚¹æ–¹å‘</li><li>å°†ç‰¹å¾ç‚¹çš„é¢†åŸŸåˆ’åˆ†ä¸º$d\times d$ä¸ªå­åŒºåŸŸï¼Œæ¯ä¸ªå­åŒºåŸŸå¤§å°ä¸º$m\sigma\times m\sigma$ï¼Œå¹¶åˆ’åˆ†ä¸º8ä¸ªæ–¹å‘ã€‚è®ºæ–‡æ¨èå€¼ï¼š$m=3$ï¼Œ$d=4$</li><li>æ¯ä¸€ä¸ªå­å—è¿›è¡Œ8ä¸ªæ–¹å‘çš„ç›´æ–¹å›¾ç»Ÿè®¡æ“ä½œï¼Œå…±$d\times d\times 8=128$ä¸ªbinï¼Œå¾—åˆ°ä¸€ä¸ª128ç»´çš„ç‰¹å¾å‘é‡ï¼ˆæè¿°ç¬¦ï¼‰</li></ol><h3 id="6-ç‰¹å¾ç‚¹åŒ¹é…">6. ç‰¹å¾ç‚¹åŒ¹é…</h3><p>åˆ†åˆ«å¯¹æ¨¡æ¿å›¾ï¼ˆå‚è€ƒå›¾ï¼Œreference imageï¼‰å’Œå®æ—¶å›¾ï¼ˆè§‚æµ‹å›¾ï¼Œobservation imageï¼‰å»ºç«‹å…³é”®ç‚¹æè¿°å­é›†åˆã€‚</p><p>ç›®æ ‡çš„è¯†åˆ«æ˜¯é€šè¿‡ä¸¤ç‚¹é›†å†…å…³é”®ç‚¹æè¿°å­çš„æ¯”å¯¹æ¥å®Œæˆï¼Œä¸€èˆ¬é‡‡ç”¨æ¬§æ°è·ç¦»æ¥è¡¡é‡ä¸¤ä¸ªæè¿°å­ä¹‹é—´çš„ç›¸ä¼¼åº¦ã€‚</p><p>å¯ä»¥ä½¿ç”¨<a href="https://oi-wiki.org/ds/kdt/">KDæ ‘</a>ä¼˜åŒ–æœç´¢è¿‡ç¨‹ã€‚</p><h2 id="SIFTå®ç°">SIFTå®ç°</h2><p>cv2ä¸­å·²ç»ç»™å‡ºäº†SIFTç®—æ³•çš„å®ç°ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–å›¾åƒ</span></span><br><span class="line">img=cv2.imread(<span class="string">&#x27;nz.jpg&#x27;</span>)</span><br><span class="line">cat=cv2.cvtColor(img,cv2.COLOR_BGR2GRAY)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºSIFTå¯¹è±¡</span></span><br><span class="line">sift=cv2.SIFT_create()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é”®ç‚¹æ£€æµ‹ï¼škpå…³é”®ç‚¹ä¿¡æ¯åŒ…æ‹¬æ–¹å‘ï¼Œå°ºåº¦ï¼Œä½ç½®ä¿¡æ¯ï¼Œdesæ˜¯å…³é”®ç‚¹çš„æè¿°ç¬¦</span></span><br><span class="line">kp,des=sift.detectAndCompute(cat,<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å›¾åƒä¸Šç»˜åˆ¶å…³é”®ç‚¹çš„æ£€æµ‹ç»“æœ</span></span><br><span class="line">cv2.drawKeypoints(img,kp,img,flags=cv2.DRAW_MATCHES_FLAGS_DRAW_RICH_KEYPOINTS)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å›¾åƒæ˜¾ç¤º</span></span><br><span class="line">plt.imshow(cv2.cvtColor(img, cv2.COLOR_BGR2RGB))</span><br><span class="line">plt.title(<span class="string">&#x27;SIFT Result&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="https://source.cclmsy.cc/posts/notes/others/SIFT_Result.png" alt="SIFT Result"></p>]]></content>
    
    
    <summary type="html">å°ºåº¦ä¸å˜ç‰¹å¾å˜æ¢åŒ¹é…ç®—æ³• Scale-Invariant Feature Transform</summary>
    
    
    
    <category term="DLç¬”è®°" scheme="https://www.cclmsy.cc/categories/DL%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="å›¾åƒæ£€ç´¢" scheme="https://www.cclmsy.cc/tags/%E5%9B%BE%E5%83%8F%E6%A3%80%E7%B4%A2/"/>
    
    <category term="è®¡ç®—æœºè§†è§‰" scheme="https://www.cclmsy.cc/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/"/>
    
  </entry>
  
  <entry>
    <title>K-means/K-means++</title>
    <link href="https://www.cclmsy.cc/posts/k_means.html"/>
    <id>https://www.cclmsy.cc/posts/k_means.html</id>
    <published>2025-03-14T16:00:00.000Z</published>
    <updated>2025-07-21T05:30:01.676Z</updated>
    
    <content type="html"><![CDATA[<h2 id="K-Meansèšç±»ç®—æ³•">K-Meansèšç±»ç®—æ³•</h2><h3 id="ç®—æ³•æ€æƒ³">ç®—æ³•æ€æƒ³</h3><p>K-meansç®—æ³•æ˜¯ä¸€ç§è¿­ä»£æ±‚è§£çš„èšç±»ç®—æ³•ï¼Œå°†æ•°æ®é›†ä¸­çš„nä¸ªæ ·æœ¬åˆ’åˆ†ä¸ºKä¸ªç°‡ï¼ˆèšç±»ï¼‰ã€‚<br>æ¯ä¸ªå¯¹è±¡åˆ°ç°‡ä¸­å¿ƒçš„è·ç¦»ä¹‹å’Œæœ€å°ã€‚<br>ç°‡å†…çš„å¯¹è±¡ç›¸ä¼¼åº¦è¾ƒé«˜ï¼Œç°‡é—´çš„å¯¹è±¡ç›¸ä¼¼åº¦è¾ƒä½ã€‚</p><h3 id="ç®—æ³•æ­¥éª¤">ç®—æ³•æ­¥éª¤</h3><h4 id="1-é€‰æ‹©Kä¸ªåˆå§‹èšç±»ä¸­å¿ƒ">1. é€‰æ‹©Kä¸ªåˆå§‹èšç±»ä¸­å¿ƒ</h4><p>éšæœºé€‰æ‹©Kä¸ªæ ·æœ¬ä½œä¸ºåˆå§‹èšç±»ä¸­å¿ƒã€‚</p><p>é€‰æ‹©å¯¹æœ€ç»ˆçš„èšç±»ç»“æœæœ‰ä¸€å®šå½±å“ï¼Œå› æ­¤åœ¨å®é™…åº”ç”¨ä¸­ï¼Œé€šå¸¸ä¼šé‡‡ç”¨ä¸€äº›å¯å‘å¼çš„æ–¹æ³•æ¥é€‰æ‹©è¾ƒå¥½çš„åˆå§‹èšç±»ä¸­å¿ƒï¼Œå¦‚K-means++ç®—æ³•</p><h4 id="2-è®¡ç®—æ¯ä¸ªæ ·æœ¬åˆ°èšç±»ä¸­å¿ƒçš„è·ç¦»">2. è®¡ç®—æ¯ä¸ªæ ·æœ¬åˆ°èšç±»ä¸­å¿ƒçš„è·ç¦»</h4><p>å¯¹äºæ¯ä¸ªæ ·æœ¬ï¼Œè®¡ç®—å…¶åˆ°Kä¸ªèšç±»ä¸­å¿ƒçš„è·ç¦»ï¼Œå°†å…¶åˆ’åˆ†åˆ°è·ç¦»æœ€è¿‘çš„èšç±»ä¸­å¿ƒæ‰€åœ¨çš„ç°‡ä¸­ã€‚</p><p>é€šå¸¸ä½¿ç”¨æ¬§å¼è·ç¦»ï¼š$d(x_i, c_j) = \sqrt{\sum_{k=1}^{n}(x_{ik}-c_{jk})^2}$</p><h4 id="3-æ›´æ–°èšç±»ä¸­å¿ƒ">3. æ›´æ–°èšç±»ä¸­å¿ƒ</h4><p>å¯¹äºæ¯ä¸ªèšç±»ï¼Œé‡æ–°è®¡ç®—å…¶èšç±»ä¸­å¿ƒï¼Œæ–°çš„èšç±»ä¸­å¿ƒæ˜¯è¯¥èšç±»å†…æ‰€æœ‰æ•°æ®ç‚¹çš„å‡å€¼ï¼š$c_j = \dfrac{1}{|S_j|}\sum_{x_i\in S_j}x_i$</p><h4 id="4-è¿­ä»£">4. è¿­ä»£</h4><p>é‡å¤æ­¥éª¤2å’Œ3ï¼Œç›´åˆ°èšç±»ä¸­å¿ƒä¸å†å‘ç”Ÿæ˜¾è‘—å˜åŒ–æˆ–è€…è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ã€‚</p><h3 id="ç®—æ³•ä¼˜ç¼ºç‚¹">ç®—æ³•ä¼˜ç¼ºç‚¹</h3><p>ä¼˜ç‚¹ï¼šé€»è¾‘ç®€å•ã€æ˜“äºå®ç°ã€æ”¶æ•›é€Ÿåº¦å¿«</p><p>ç¼ºç‚¹ï¼šéœ€è¦äº‹å…ˆç¡®å®šèšç±»æ•°ç›®Kï¼Œå¯¹åˆå§‹èšç±»ä¸­å¿ƒæ•æ„Ÿï¼Œå¯èƒ½æ”¶æ•›åˆ°å±€éƒ¨æœ€ä¼˜è§£</p><h3 id="K-Means-å®ç°">K-Means å®ç°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">k_means</span>(<span class="params">data, k=<span class="number">3</span>, max_iter=<span class="number">100</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;K-means èšç±»ç®—æ³•</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        data: æ•°æ®é›†ï¼Œlist[element]ï¼Œelementæ˜¯ä¸€ä¸ªlist[float]</span></span><br><span class="line"><span class="string">        k: èšç±»æ•°</span></span><br><span class="line"><span class="string">        max_iter: æœ€å¤§è¿­ä»£æ¬¡æ•°</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–èšç±»ä¸­å¿ƒ</span></span><br><span class="line">    centers = random.sample(data, k)</span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–èšç±»ç»“æœ</span></span><br><span class="line">    clusters = [[] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(k)]</span><br><span class="line">    <span class="comment"># è¿­ä»£èšç±»</span></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">iter</span> <span class="keyword">in</span> <span class="built_in">range</span>(max_iter):</span><br><span class="line">        <span class="comment"># åˆ†é…æ•°æ®åˆ°æœ€è¿‘çš„èšç±»ä¸­å¿ƒ</span></span><br><span class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> data: <span class="comment"># å¯¹äºæ¯ä¸ªæ•°æ®</span></span><br><span class="line">            min_dist = <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>) <span class="comment"># æœ€å°è·ç¦»</span></span><br><span class="line">            min_idx = -<span class="number">1</span> <span class="comment"># æœ€è¿‘èšç±»</span></span><br><span class="line">            <span class="keyword">for</span> i, center <span class="keyword">in</span> <span class="built_in">enumerate</span>(centers):</span><br><span class="line">                dist = <span class="built_in">sum</span>((x-y)**<span class="number">2</span> <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(element, center)) <span class="comment"># è®¡ç®—è·ç¦»</span></span><br><span class="line">                <span class="keyword">if</span> dist &lt; min_dist:</span><br><span class="line">                    min_dist = dist</span><br><span class="line">                    min_idx = i</span><br><span class="line">            clusters[min_idx].append(element)</span><br><span class="line">        <span class="comment"># æ›´æ–°èšç±»ä¸­å¿ƒ</span></span><br><span class="line">        new_centers = [<span class="literal">None</span>] * k</span><br><span class="line">        <span class="keyword">for</span> i, cluster <span class="keyword">in</span> <span class="built_in">enumerate</span>(clusters):</span><br><span class="line">            new_centers[i] = [<span class="built_in">sum</span>(x)/<span class="built_in">len</span>(cluster) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">zip</span>(*cluster)]</span><br><span class="line">        <span class="comment"># åˆ¤æ–­æ˜¯å¦æ”¶æ•›ï¼šä¸­å¿ƒç‚¹æ˜¯å¦å˜åŒ–å°äºeps</span></span><br><span class="line">        eps = <span class="number">1e-6</span></span><br><span class="line">        fl = <span class="built_in">all</span>((<span class="built_in">sum</span>((x-y)**<span class="number">2</span> <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(a, b)) &lt; eps) <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(centers, new_centers))</span><br><span class="line">        <span class="keyword">if</span> fl <span class="keyword">or</span> <span class="built_in">iter</span> == max_iter-<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        centers = new_centers</span><br><span class="line">        clusters = [[] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(k)]</span><br><span class="line">    <span class="keyword">return</span> clusters</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•</span></span><br><span class="line">data = [[random.random() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>)] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>)]</span><br><span class="line">clusters = k_means(data, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»“æœå¯è§†åŒ–</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">colors = [<span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;m&#x27;</span>]</span><br><span class="line"><span class="keyword">for</span> i, cluster <span class="keyword">in</span> <span class="built_in">enumerate</span>(clusters):</span><br><span class="line">    <span class="keyword">for</span> element <span class="keyword">in</span> cluster:</span><br><span class="line">        plt.scatter(element[<span class="number">0</span>], element[<span class="number">1</span>], c=colors[i])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="https://source.cclmsy.cc/posts/notes/others/k_means.png" alt="k_means"></p><h2 id="K-Means-ç®—æ³•">K-Means++ç®—æ³•</h2><p>K-Means++ç®—æ³•æ˜¯K-meansç®—æ³•çš„æ”¹è¿›ï¼Œä¼˜åŒ–äº†åˆå§‹èšç±»ä¸­å¿ƒçš„é€‰æ‹©ï¼Œä½¿å¾—åˆå§‹èšç±»ä¸­å¿ƒæ›´æœ‰ä»£è¡¨æ€§ï¼Œæ”¶æ•›é€Ÿåº¦æ›´å¿«ã€‚</p><p>é€ä¸ªé€‰å–kä¸ªç°‡ä¸­å¿ƒï¼Œä¸”ç¦»å…¶å®ƒç°‡ä¸­å¿ƒè¶Šè¿œçš„æ ·æœ¬ç‚¹è¶Šæœ‰å¯èƒ½è¢«é€‰ä¸ºä¸‹ä¸€ä¸ªç°‡ä¸­å¿ƒ</p><h3 id="ç®—æ³•æ­¥éª¤ï¼ˆé€‰æ‹©Kä¸ªåˆå§‹èšç±»ä¸­å¿ƒçš„è¿‡ç¨‹ï¼‰">ç®—æ³•æ­¥éª¤ï¼ˆé€‰æ‹©Kä¸ªåˆå§‹èšç±»ä¸­å¿ƒçš„è¿‡ç¨‹ï¼‰</h3><h4 id="1-é€‰æ‹©ç¬¬ä¸€ä¸ªç°‡ä¸­å¿ƒ">1. é€‰æ‹©ç¬¬ä¸€ä¸ªç°‡ä¸­å¿ƒ</h4><p>éšæœºé€‰æ‹©ä¸€ä¸ªæ ·æœ¬ä½œä¸ºç¬¬ä¸€ä¸ªç°‡ä¸­å¿ƒ</p><h4 id="2-é€‰æ‹©ä¸‹ä¸€ä¸ªç°‡ä¸­å¿ƒ">2. é€‰æ‹©ä¸‹ä¸€ä¸ªç°‡ä¸­å¿ƒ</h4><p>å¯¹äºæ ·æœ¬xï¼Œè®¡ç®—å…¶åˆ°å·²æœ‰ç°‡ä¸­å¿ƒçš„æœ€çŸ­è·ç¦»ï¼Œè®°ä¸º$D(x)$ï¼Œé€‰å–xä½œä¸ºä¸‹ä¸€ä¸ªç°‡ä¸­å¿ƒçš„æ¦‚ç‡ä¸º$\dfrac{D(x)^2}{\sum_{x\in X}D(x)^2}$</p><h4 id="3-è¿­ä»£">3. è¿­ä»£</h4><p>é‡å¤æ­¥éª¤2ï¼Œç›´åˆ°é€‰å–kä¸ªç°‡ä¸­å¿ƒ</p><h3 id="å®ç°">å®ç°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€‰æ‹©ç¬¬ä¸€ä¸ªèšç±»ä¸­å¿ƒ</span></span><br><span class="line">centers = [random.choice(data)]</span><br><span class="line"><span class="comment"># é€‰æ‹©å…¶ä»–èšç±»ä¸­å¿ƒ</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(k-<span class="number">1</span>):</span><br><span class="line">    dists = [<span class="built_in">min</span>(<span class="built_in">sum</span>((x-y)**<span class="number">2</span> <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(element, center)) <span class="keyword">for</span> center <span class="keyword">in</span> centers) <span class="keyword">for</span> element <span class="keyword">in</span> data]</span><br><span class="line">    probs = [dist**<span class="number">2</span>/<span class="built_in">sum</span>(dists) <span class="keyword">for</span> dist <span class="keyword">in</span> dists]</span><br><span class="line">    centers.append(random.choices(data, probs)[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æœ€å¸¸ç”¨çš„èšç±»ç®—æ³•</summary>
    
    
    
    <category term="DLç¬”è®°" scheme="https://www.cclmsy.cc/categories/DL%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="èšç±»ç®—æ³•" scheme="https://www.cclmsy.cc/tags/%E8%81%9A%E7%B1%BB%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>è®ºæ–‡ç¬”è®°&amp;å®ç°|ChatIRï¼šåŸºäºå¯¹è¯çš„å›¾åƒæ£€ç´¢ç³»ç»Ÿ</title>
    <link href="https://www.cclmsy.cc/posts/2305.20062.html"/>
    <id>https://www.cclmsy.cc/posts/2305.20062.html</id>
    <published>2025-03-06T16:00:00.000Z</published>
    <updated>2025-07-21T05:33:51.333Z</updated>
    
    <content type="html"><![CDATA[<p>è®ºæ–‡ï¼š<a href="https://arxiv.org/abs/2305.20062">Chatting Makes Perfect: Chat-based Image Retrival</a></p><h2 id="1-Introduction">1. Introduction</h2><p>ä¼ ç»Ÿçš„æ–‡æœ¬åˆ°å›¾åƒæ£€ç´¢æ–¹æ³•ï¼Œç”¨æˆ·éœ€è¦ä¸€æ¬¡æ€§æä¾›å…¨é¢è¯¦ç»†çš„æè¿°ï¼Œæ¥æœç´¢ç›®æ ‡å›¾åƒã€‚</p><p>æœ¬æ–‡æå‡ºäº†ä¸€ä¸ªåŸºäºå¯¹è¯çš„å›¾åƒæ£€ç´¢ç³»ç»ŸChatIRï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å¤šè½®å¯¹è¯é€æ­¥ç»†åŒ–æœç´¢ç›®æ ‡ã€‚</p><p>ChatIRç³»ç»ŸåŒ…å«2ä¸ªéƒ¨åˆ†ï¼šå¯¹è¯æ„å»ºï¼ˆDialog Buildingï¼‰å’Œå›¾åƒæœç´¢ï¼ˆImage Searchï¼‰</p><ul><li>å¯¹è¯æ„å»ºï¼šä½¿ç”¨é—®é¢˜ç”Ÿæˆå™¨Gï¼Œè€ƒè™‘å½“å‰å¯¹è¯å†å²ï¼Œç”Ÿæˆä¸‹ä¸€ä¸ªé—®é¢˜</li><li>å›¾åƒæœç´¢ï¼šä½¿ç”¨æ¨¡å‹Fï¼Œå°†ä¸åŒé•¿åº¦çš„å¯¹è¯åºåˆ—æ˜ å°„åˆ°è§†è§‰åµŒå…¥ç©ºé—´</li><li>ä¸¤ä¸ªç»„æˆéƒ¨åˆ†å»ºç«‹åœ¨Instructional LLMså’Œfundation Vision and Language Modelsä¸Š</li></ul><p><img src="https://source.cclmsy.cc/posts/notes/papers/2305.20062.png" alt="ChatIR"></p><p>è€ƒè™‘ä¸‰ä¸ªé—®é¢˜ï¼š</p><ol><li>ä½¿ç”¨ä»€ä¹ˆæ•°æ®é›†è®­ç»ƒï¼Ÿæ˜¯å¦éœ€è¦æ–°åˆ›å»ºå’Œæ ‡æ³¨æ•°æ®é›†ï¼Ÿ<ul><li>ä½¿ç”¨VisDialæ•°æ®é›†</li><li>é—®é¢˜ï¼šVisDialæ˜¯ä¸€ä¸ªç”¨äºâ€œåˆ›å»ºå…³äºå›¾åƒçš„èŠå¤©â€çš„æ•°æ®é›†ï¼Œæ²¡æœ‰æ£€ç´¢ç›®æ ‡</li><li>è§£å†³ï¼šè¾“å…¥è¾“å‡ºåç½®ï¼Œå¯¹è¯ä½œä¸ºè¾“å…¥ã€å›¾åƒä½œä¸ºè¾“å‡º</li></ul></li><li>å¦‚ä½•ç‹¬ç«‹è¯„ä¼°ChatIRç³»ç»Ÿçš„ä¸åŒç»„ä»¶ï¼Ÿ<ul><li>æµ‹è¯•ä½¿ç”¨ä¸åŒçš„<code>Fè®­ç»ƒç­–ç•¥</code>å’Œ<code>æé—®æ¨¡å‹G</code>å¯¹æ£€ç´¢æ€§èƒ½çš„å½±å“</li><li>ä½¿ç”¨äº†BLIPæ›¿ä»£ç”¨æˆ·å›ç­”é—®é¢˜</li></ul></li><li>å¦‚ä½•å®šä¹‰è¯„ä¼°æŒ‡æ ‡ï¼Ÿ<ul><li>æ¯ä¸€è½®å¯¹è¯çš„æˆåŠŸæ£€ç´¢æ¦‚ç‡Hit@10</li></ul></li></ol><h2 id="2-Related-Work">2. Related Work</h2><ol><li>è§†è§‰å¯¹è¯ï¼ˆVisual Conversationï¼‰é¢†åŸŸ<ul><li>å½“å‰è§†è§‰é¢†åŸŸå·¥ä½œçš„é‡ç‚¹åœ¨äºå›¾åƒç†è§£å’Œç”Ÿæˆæ¨¡å‹ï¼Œè€Œä¸æ˜¯æ£€ç´¢</li><li>ç”Ÿæˆå¼è§†è§‰å¯¹è¯ä¸­ï¼Œè¿‘æœŸçš„åŸºç¡€æ¨¡å‹V&amp;Læ€§èƒ½ä¼˜è¶Šï¼Œå› æ­¤ChatIRç³»ç»Ÿåœ¨æ­¤åŸºç¡€ä¸Šæ„å»º</li></ul></li><li>è§†è§‰æœç´¢ï¼ˆVisual Searchï¼‰é¢†åŸŸ<ul><li>CoIRï¼šä½¿ç”¨å¤šæ¨¡æ€è¯¢é—®æŸ¥æ‰¾ç›®æ ‡å›¾åƒ</li><li>ä¸€äº›ç ”ç©¶åŸºäºCoIRï¼Œåˆ©ç”¨ç”¨æˆ·åé¦ˆç»†åŒ–æŸ¥è¯¢ç»“æœ</li><li>ä½†æ˜¯ï¼Œæ²¡æœ‰è€ƒè™‘ç”¨æˆ·äº¤äº’ï¼ˆåªæœ‰ç”¨æˆ·åé¦ˆï¼Œæ²¡æœ‰æœºå™¨æé—®ï¼‰ã€æ²¡æœ‰æ˜ç¡®åˆ©ç”¨å¯¹è¯å†å²</li></ul></li></ol><h2 id="3-Method">3. Method</h2><h3 id="3-1-Dialog-Builder-Model-å¯¹è¯ç”Ÿæˆæ¨¡å‹">3.1 Dialog Builder Model å¯¹è¯ç”Ÿæˆæ¨¡å‹</h3><p>å¯¹è¯è®°å½•è¡¨ç¤ºï¼š$D_i = (C, Q_1, A_1, â€¦, Q_i)$</p><ul><li>$C$ï¼šç›®æ ‡å›¾åƒçš„åˆå§‹æ–‡æœ¬æè¿°ï¼ˆæ ‡é¢˜ï¼‰</li><li>$Q_i$ï¼šç¬¬iä¸ªé—®é¢˜</li><li>$A_i$ï¼šç¬¬iä¸ªå›ç­”</li></ul><p>å¯¹è¯ç”Ÿæˆæ¨¡å‹åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>é—®é¢˜ç”Ÿæˆå™¨Gï¼šä¸€ä¸ªLLMï¼Œæ ¹æ®å¯¹è¯è®°å½•ç”Ÿæˆä¸‹ä¸€ä¸ªé—®é¢˜<ul><li>$G: D_i \rightarrow Q_{i+1}$</li><li>Gä¸çŸ¥é“ç›®æ ‡å›¾åƒTæ˜¯ä»€ä¹ˆï¼ŒåªçŸ¥é“å¯¹è¯å†å²</li></ul></li><li>ç­”æ¡ˆæä¾›è€…Aï¼šåœ¨å®è·µä¸­ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè„‘æµ·ä¸­æœ‰å¤§è‡´ç›®æ ‡å›¾åƒçš„äººç±»<ul><li>ç”±äºéœ€è¦å¤§è§„æ¨¡å®éªŒï¼Œä¸èƒ½ä¾èµ–ç”¨æˆ·æä¾›ç­”æ¡ˆ</li><li>å› æ­¤ï¼Œä½¿ç”¨äº†ä¸€ä¸ªç°æˆçš„æ¨¡å‹BLIP2æ¥å›ç­”</li></ul></li></ul><h3 id="3-2-Image-Retrieval-Model-å›¾åƒæ£€ç´¢æ¨¡å‹">3.2 Image Retrieval Model å›¾åƒæ£€ç´¢æ¨¡å‹</h3><p>å›¾åƒæœç´¢è¿‡ç¨‹ï¼šåœ¨<code>æŸ¥è¯¢</code>å’Œ<code>ç›®æ ‡å›¾åƒ</code>å…±äº«çš„è§†è§‰åµŒå…¥ç©ºé—´ä¸­ï¼Œæœç´¢åŒ¹é…é¡¹ã€‚</p><ul><li>æ‰€æœ‰çš„ç›®æ ‡å›¾åƒå…ˆç»è¿‡å›¾åƒåµŒå…¥æ¨¡å—è¿›è¡Œç¼–ç ï¼Œç”±ä¸€ä¸ª$d$ç»´çš„ç‰¹å¾å‘é‡$f\in \mathbb R^d$è¡¨ç¤ºã€‚</li><li>å›¾åƒæ£€ç´¢æ¨¡å—Få°†å¯¹è¯å†å²$D_i$æ˜ å°„åˆ°è§†è§‰åµŒå…¥ç©ºé—´ï¼Œ$F: D_i \rightarrow \mathbb R^d$ï¼Œ</li><li>å€™é€‰å¯¹è±¡æ ¹æ®ç›¸ä¼¼åº¦è¿›è¡Œæ’åºã€‚</li></ul><p>å¼•å…¥åˆ†éš”ç¬¦[SEP]å’Œæ·»åŠ ç¬¦[CLS]ï¼Œè¡¨ç¤ºæ•´ä¸ªå¯¹è¯åºåˆ—ï¼ŒæŠ•å°„åˆ°è§†è§‰åµŒå…¥ç©ºé—´ã€‚</p><p>Fé‡‡ç”¨ï¼ˆä½¿ç”¨BLIPï¼‰é¢„è®­ç»ƒçš„å›¾åƒ/æ–‡æœ¬ç¼–ç å™¨ï¼Œå¹¶é€šè¿‡å¯¹æ¯”å­¦ä¹ ï¼Œå¯¹åŸºäºå¯¹è¯çš„æ£€ç´¢è¿›è¡Œå¾®è°ƒã€‚</p><p>é€šè¿‡æå–VisDialæ•°æ®é›†ä¸­çš„å›¾åƒå’Œç›¸åº”å¯¹è¯ï¼Œæ‰‹åŠ¨æ ‡æ³¨ï¼Œè®­ç»ƒFã€‚</p><h2 id="4-Evaluation">4. Evaluation</h2><p>åœ¨è¯„ä¼°ç¯èŠ‚ï¼ŒåŸæ–‡ä½¿ç”¨äº†Hit@10æŒ‡æ ‡ï¼Œå³ç›®æ ‡å›¾åƒåœ¨å‰10ä¸ªæ£€ç´¢ç»“æœä¸­çš„è¯•éªŒå æ¯”ã€‚</p><p>åŸæ–‡ä»ä¸‰ä¸ªæ–¹é¢è¿›è¡Œäº†å¯¹æ¯”ï¼š</p><ol><li>ä¸ç°æœ‰æ–‡æœ¬åˆ°å›¾åƒï¼ˆText to Image,TTIï¼‰æ£€ç´¢æ–¹æ³•çš„æ¯”è¾ƒ<ol><li>ChatIRä½¿ç”¨ChatGPTä½œä¸ºæé—®è€…Gï¼ŒBLIP2ä½œä¸ºå›ç­”è€…A</li><li>ä¸Zero-shotçš„BLIPã€CLIPä»¥åŠfine-tuned SoTA TTI BLIPè¿›è¡Œæ¯”è¾ƒ</li><li>ç»“è®ºï¼šChatIRåœ¨å¤šè½®å¯¹è¯ç¯å¢ƒä¸­ï¼Œç›¸æ¯”ä¼ ç»Ÿå•è·³ TTI æ–¹æ³•è¡¨ç°æ›´ä¼˜</li></ol></li><li>ä¸åŒæé—®è€…Gçš„æ¯”è¾ƒ<ol><li>ä½¿ç”¨ChatGPTã€FLAN-ALPACA-XXLã€äººç±»ç­‰8ä¸­ä¸åŒæé—®è€…</li><li>ChatGPTè¡¨ç°æœ€å¥½</li></ol></li><li>äººç±»å‚ä¸å¯¹è¯çš„å½±å“<ol><li>ChatGPTæé—®ï¼Œäººç±»å›ç­”ï¼›ChatGPTæé—®ï¼ŒBLIP2å›ç­”ï¼›äººç±»æé—®ï¼Œäººç±»å›ç­”</li><li>ç”±äºäººç±»ç”Ÿæˆçš„ç­”æ¡ˆè´¨é‡æ˜æ˜¾ä¼˜äºBLIP2ï¼Œå› æ­¤äººç±»å‚ä¸å¯¹è¯æ—¶ï¼Œæ£€ç´¢æ€§èƒ½ä¼šæ¯”æµ‹è¯•çš„æ•°æ®æ›´å¥½</li></ol></li></ol><h2 id="æ€»ç»“å’Œå®ç°">æ€»ç»“å’Œå®ç°</h2><ul><li>ChatIRç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäºå¯¹è¯çš„å›¾åƒæ£€ç´¢ç³»ç»Ÿï¼ŒåŒ…å«å¯¹è¯æ„å»ºå’Œå›¾åƒæœç´¢ä¸¤ä¸ªéƒ¨åˆ†</li><li>å¯¹è¯æ„å»ºï¼šä½¿ç”¨é—®é¢˜ç”Ÿæˆå™¨Gï¼Œè€ƒè™‘å½“å‰å¯¹è¯å†å²ï¼Œç”Ÿæˆä¸‹ä¸€ä¸ªé—®é¢˜<ul><li>åŸæ–‡æµ‹è¯•äº†ä¸åŒçš„é—®é¢˜ç”Ÿæˆå™¨ï¼Œå…¶ä¸­ChatGPTè¡¨ç°æœ€å¥½</li></ul></li><li>å›¾åƒæœç´¢ï¼šä½¿ç”¨æ¨¡å‹Fï¼Œå°†ä¸åŒé•¿åº¦çš„å¯¹è¯åºåˆ—æ˜ å°„åˆ°è§†è§‰åµŒå…¥ç©ºé—´<ul><li>æˆ‘ä½¿ç”¨äº†è®ºæ–‡ä»“åº“æä¾›çš„é¢„è®­ç»ƒBLIP_ITMæ¨¡å‹</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset, DataLoader</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms</span><br><span class="line"><span class="keyword">from</span> torchvision.transforms.functional <span class="keyword">import</span> InterpolationMode</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os.path</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> multiprocessing <span class="comment"># å¤šè¿›ç¨‹å¤„ç†</span></span><br><span class="line">multiprocessing.set_start_method(<span class="string">&#x27;spawn&#x27;</span>, force=<span class="literal">True</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> OpenAI <span class="keyword">import</span> request_chat <span class="comment"># è‡ªå·±å®ç°çš„è°ƒç”¨APIå‡½æ•° request_chat(dialog:list) -&gt; new_question:str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys <span class="comment"># æ·»åŠ importè·¯å¾„</span></span><br><span class="line">sys.path.insert(<span class="number">0</span>, <span class="string">&#x27;./BLIP&#x27;</span>)</span><br><span class="line"><span class="keyword">from</span> BLIP.models.blip_itm <span class="keyword">import</span> blip_itm <span class="comment"># BLIPç”¨äºå›¾åƒæ–‡æœ¬åŒ¹é…çš„é¢„è®­ç»ƒæ¨¡å‹</span></span><br><span class="line"></span><br><span class="line">config = &#123;</span><br><span class="line">    <span class="string">&quot;corpus_path&quot;</span>: <span class="string">&quot;VisualDial/search_space.json&quot;</span>, <span class="comment"># å›¾åƒåº“è·¯å¾„</span></span><br><span class="line">    <span class="string">&quot;queries_path&quot;</span>: <span class="string">&quot;dialogues/ChatGPT4oMini_BLIP2.json&quot;</span>, <span class="comment"># æµ‹è¯•å¯¹è¯æ•°æ®è·¯å¾„</span></span><br><span class="line">    <span class="string">&quot;corpus_cache&quot;</span>: <span class="string">&quot;VisualDial/corpus_cache.pth&quot;</span>, <span class="comment"># å¤„ç†å¥½çš„å›¾åƒåº“ç¼“å­˜çš„è·¯å¾„</span></span><br><span class="line">    <span class="string">&quot;device&quot;</span>: <span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sep&quot;</span>: <span class="string">&quot;, &quot;</span>, <span class="comment"># å¯¹è¯åˆ†éš”ç¬¦</span></span><br><span class="line">    <span class="string">&quot;batch_size&quot;</span>: <span class="number">100</span>, <span class="comment"># æ‰¹å¤„ç†å¤§å°</span></span><br><span class="line">    <span class="string">&quot;num_workers&quot;</span>: <span class="number">8</span>, <span class="comment"># å¤šè¿›ç¨‹å¤„ç†æ•°</span></span><br><span class="line">    <span class="string">&quot;image_size&quot;</span> : <span class="number">224</span> <span class="comment"># å›¾åƒå¤§å°</span></span><br><span class="line">&#125;</span><br><span class="line">corpus = <span class="literal">None</span> <span class="comment"># å¤„ç†å¥½çš„å›¾åƒåº“ </span></span><br><span class="line">dialog = [] <span class="comment"># å¯¹è¯</span></span><br><span class="line">images = [] <span class="comment"># å›¾åƒåº“è·¯å¾„ list[å›¾åƒè·¯å¾„]</span></span><br></pre></td></tr></table></figure><h3 id="å›¾åƒæ•°æ®é›†ç±»">å›¾åƒæ•°æ®é›†ç±»</h3><p>ç»§æ‰¿è‡ªDatasetï¼Œç”¨äºåŠ è½½å›¾åƒæ•°æ®é›†</p><p>corpus_pathï¼šå›¾åƒæ•°æ®é›†.jsonï¼ŒåŒ…å«ä¸€ä¸ªlist[str]ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå›¾åƒçš„è·¯å¾„</p><p>å»ºç«‹è·¯å¾„å­—ç¬¦ä¸²åˆ°ç´¢å¼•çš„æ˜ å°„ï¼Œä¾¿äºèµ‹å€¼ä¼ é€’å’ŒæŸ¥è¯¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Corpus</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å›¾åƒæ•°æ®é›†&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, corpus_path, preprocessor</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŠ è½½å›¾åƒæ•°æ®é›†</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            corpus_path: å›¾ç‰‡è·¯å¾„åˆ—è¡¨</span></span><br><span class="line"><span class="string">            preprocessor: å›¾åƒé¢„å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(corpus_path, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            self.corpus = json.load(f)</span><br><span class="line">            f.close()</span><br><span class="line">        self.preprocessor = preprocessor</span><br><span class="line">        <span class="comment"># å›¾ç‰‡è·¯å¾„åˆ°ç´¢å¼•çš„æ˜ å°„ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾</span></span><br><span class="line">        self.path2idx = &#123;self.corpus[i]:i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.corpus))&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.corpus)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, idx</span>):</span><br><span class="line">        image = self.preprocessor(self.corpus[idx])</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;idx&quot;</span>: idx, <span class="string">&quot;image&quot;</span>: image&#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">path_to_index</span>(<span class="params">self, path</span>):</span><br><span class="line">        <span class="keyword">return</span> self.path2idx[path]</span><br></pre></td></tr></table></figure><h3 id="å›¾åƒé¢„å¤„ç†å‡½æ•°">å›¾åƒé¢„å¤„ç†å‡½æ•°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">image_preprocessor</span>(<span class="params">image_path</span>):</span><br><span class="line">    transform_prep = transforms.Compose([ </span><br><span class="line">        transforms.Resize((config[<span class="string">&quot;image_size&quot;</span>], config[<span class="string">&quot;image_size&quot;</span>]), </span><br><span class="line">                          interpolation=InterpolationMode.BICUBIC),</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize((<span class="number">0.48145466</span>, <span class="number">0.4578275</span>, <span class="number">0.40821073</span>), </span><br><span class="line">                             (<span class="number">0.26862954</span>, <span class="number">0.26130258</span>, <span class="number">0.27577711</span>)) <span class="comment"># å‚æ•°å‚è€ƒBLIPçš„demo</span></span><br><span class="line">    ])</span><br><span class="line">    raw = Image.<span class="built_in">open</span>(image_path).convert(<span class="string">&quot;RGB&quot;</span>)</span><br><span class="line">    img = transform_prep(raw)</span><br><span class="line">    <span class="keyword">return</span> img</span><br></pre></td></tr></table></figure><h3 id="BLIP-ITMæ¨¡å‹çš„å›¾åƒç¼–ç å™¨å’Œå¯¹è¯ç¼–ç å™¨">BLIP_ITMæ¨¡å‹çš„å›¾åƒç¼–ç å™¨å’Œå¯¹è¯ç¼–ç å™¨</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_funcs</span>():</span><br><span class="line">    <span class="comment"># model_url = &#x27;https://storage.googleapis.com/sfr-vision-language-research/BLIP/models/model_base_retrieval_coco.pth&#x27;</span></span><br><span class="line">    model = blip_itm(pretrained=<span class="string">&#x27;chatir_weights.ckpt&#x27;</span>, <span class="comment"># è®ºæ–‡ä»“åº“ä¸­çš„é¢„è®­ç»ƒæ¨¡å‹</span></span><br><span class="line">                    med_config=<span class="string">&quot;BLIP/configs/med_config.json&quot;</span>, </span><br><span class="line">                    image_size=config[<span class="string">&quot;image_size&quot;</span>],</span><br><span class="line">                    vit=<span class="string">&quot;base&quot;</span>)</span><br><span class="line">    device = config[<span class="string">&quot;device&quot;</span>]</span><br><span class="line">    model = model.to(device).<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">image_encoder</span>(<span class="params">img</span>):</span><br><span class="line">        embeddings = model.visual_encoder(img) <span class="comment"># embedding</span></span><br><span class="line">        <span class="comment"># print(embeddings.shape) # (æ‰¹æ¬¡å¤§å°, patchä¸ªæ•°+1, éšå±‚ç»´åº¦)</span></span><br><span class="line">        vision_proj = model.vision_proj(embeddings[:, <span class="number">0</span>, :]) <span class="comment"># å–[CLS] tokenï¼Œæå–å…¨å±€ç‰¹å¾</span></span><br><span class="line">        <span class="keyword">return</span> F.normalize(vision_proj, dim=-<span class="number">1</span>) <span class="comment"># æ­£åˆ™åŒ–</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dialog_encoder</span>(<span class="params">dialog</span>):</span><br><span class="line">        text = model.tokenizer(dialog, padding=<span class="string">&#x27;longest&#x27;</span>, truncation=<span class="literal">True</span>, max_length=<span class="number">200</span>, <span class="comment"># å¡«å……åˆ°æœ€é•¿ï¼Œæˆªæ–­åˆ°200</span></span><br><span class="line">                            return_tensors=<span class="string">&quot;pt&quot;</span>).to(device)  <span class="comment"># è¿”å›PyTorchå¼ é‡</span></span><br><span class="line">        text_out = model.text_encoder(text.input_ids, attention_mask=text.attention_mask, </span><br><span class="line">                                    return_dict=<span class="literal">True</span>, mode=<span class="string">&#x27;text&#x27;</span>) <span class="comment"># embedding</span></span><br><span class="line">        shift = model.text_proj(text_out.last_hidden_state[:, <span class="number">0</span>, :]) <span class="comment"># åŒ</span></span><br><span class="line">        <span class="keyword">return</span> F.normalize(shift, dim=-<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> image_encoder, dialog_encoder</span><br></pre></td></tr></table></figure><h3 id="å¤„ç†å›¾åƒåº“">å¤„ç†å›¾åƒåº“</h3><p>ç”±äºåŠ è½½æ—¶é—´é•¿ï¼Œä¸€æ¬¡åŠ è½½åå°†æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¾¿äºäºŒæ¬¡è°ƒç”¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">corpus_dataset = Corpus(config[<span class="string">&quot;corpus_path&quot;</span>], image_preprocessor)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_corpus</span>(<span class="params">image_encoder</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¤„ç†å›¾åƒåº“</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        corpus: tuple[torch.Tensor, torch.Tensor] å›¾åƒåº“ç´¢å¼•å’Œå¯¹åº”çš„å›¾åƒç‰¹å¾å‘é‡</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">global</span> corpus</span><br><span class="line">    corpus_cache = config[<span class="string">&quot;corpus_cache&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> corpus_cache <span class="keyword">and</span> os.path.exists(corpus_cache): <span class="comment"># è¯»å–ç¼“å­˜</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;-----Loading corpus from <span class="subst">&#123;corpus_cache&#125;</span>-----&quot;</span>)</span><br><span class="line">        corpus = torch.load(corpus_cache)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-----Preparing corpus-----&quot;</span>)</span><br><span class="line">    corpus_dataloader = DataLoader( <span class="comment"># å›¾åƒåº“çš„DataLoader</span></span><br><span class="line">        corpus_dataset,</span><br><span class="line">        batch_size=config[<span class="string">&quot;batch_size&quot;</span>],</span><br><span class="line">        shuffle=<span class="literal">False</span>,</span><br><span class="line">        num_workers=config[<span class="string">&quot;num_workers&quot;</span>],</span><br><span class="line">        pin_memory=<span class="literal">True</span>,</span><br><span class="line">        drop_last=<span class="literal">False</span></span><br><span class="line">    )</span><br><span class="line">    corpus_vectors = []</span><br><span class="line">    corpus_ids = []</span><br><span class="line">    <span class="keyword">for</span> batch <span class="keyword">in</span> tqdm(corpus_dataloader): <span class="comment"># é¢„å¤„ç†å›¾åƒåº“</span></span><br><span class="line">        batch_vectors = F.normalize(image_encoder(batch[<span class="string">&quot;image&quot;</span>].to(config[<span class="string">&quot;device&quot;</span>])), dim=-<span class="number">1</span>) <span class="comment"># æ­£åˆ™åŒ–</span></span><br><span class="line">        corpus_vectors.append(batch_vectors)</span><br><span class="line">        corpus_ids.append(batch[<span class="string">&quot;idx&quot;</span>].to(config[<span class="string">&quot;device&quot;</span>]))</span><br><span class="line"></span><br><span class="line">    corpus_vectors = torch.cat(corpus_vectors)</span><br><span class="line">    corpus_ids = torch.cat(corpus_ids)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æŒ‰ç…§ç´¢å¼•æ’åº</span></span><br><span class="line">    arg_ids = torch.argsort(corpus_ids)</span><br><span class="line">    corpus_vectors = corpus_vectors[arg_ids]</span><br><span class="line">    corpus_ids = corpus_ids[arg_ids]</span><br><span class="line"></span><br><span class="line">    corpus = corpus_ids, corpus_vectors</span><br><span class="line">    <span class="keyword">if</span> config[<span class="string">&quot;corpus_cache&quot;</span>]:</span><br><span class="line">        torch.save(corpus, config[<span class="string">&quot;corpus_cache&quot;</span>]) </span><br></pre></td></tr></table></figure><h3 id="æé—®ä¸åŒ¹é…å‡½æ•°">æé—®ä¸åŒ¹é…å‡½æ•°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ask_for_caption</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¯¢é—®ç”¨æˆ·æè¿°&quot;&quot;&quot;</span></span><br><span class="line">    caption = <span class="built_in">input</span>(<span class="string">&quot;Describe the image: &quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> caption</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ask_question</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¯¢é—®ç”¨æˆ·é—®é¢˜ï¼Œè·å–å›ç­”&quot;&quot;&quot;</span></span><br><span class="line">    question = request_chat(dialog)</span><br><span class="line">    answer = <span class="built_in">input</span>(<span class="string">f&quot;Q: <span class="subst">&#123;question&#125;</span>\nA: &quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> question+<span class="string">&#x27; &#x27;</span>+answer</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_top_results</span>(<span class="params">dialog, dialog_encoder, n=<span class="number">1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è·å–å‰næœ€ä½³åŒ¹é…ç»“æœ</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        dialog: str å¯¹è¯</span></span><br><span class="line"><span class="string">        dialog_encoder: å¯¹è¯ç¼–ç å™¨</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        tops: list[int] å‰nä¸ªåŒ¹é…ç»“æœçš„ç´¢å¼•</span></span><br><span class="line"><span class="string">        topscores: list[float] å‰nä¸ªåŒ¹é…ç»“æœçš„å¾—åˆ†</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    dialog = config[<span class="string">&quot;sep&quot;</span>].join(dialog)</span><br><span class="line">    dialog_vector = dialog_encoder(dialog) <span class="comment"># æå–ç‰¹å¾&amp;æ­£åˆ™åŒ–</span></span><br><span class="line">    scores = dialog_vector @ corpus[<span class="number">1</span>].T <span class="comment"># è®¡ç®—ç‚¹ç§¯ç›¸ä¼¼åº¦</span></span><br><span class="line">    top_id = torch.argsort(scores, descending=<span class="literal">True</span>) <span class="comment"># æ’åº</span></span><br><span class="line">    tops = top_id.tolist()[<span class="number">0</span>][:n]</span><br><span class="line">    topscores = scores[<span class="number">0</span>][tops].tolist()</span><br><span class="line">    <span class="keyword">return</span> tops, topscores</span><br></pre></td></tr></table></figure><h3 id="ä¸»å‡½æ•°">ä¸»å‡½æ•°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    image_encoder, dialog_encoder = get_funcs()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(config[<span class="string">&quot;corpus_path&quot;</span>], <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        images = json.load(f)</span><br><span class="line">        f.close()</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        prepare_corpus(image_encoder)</span><br><span class="line">    </span><br><span class="line">        dialog.append(ask_for_caption())</span><br><span class="line">        tops,topscores = get_top_results(dialog, dialog_encoder)</span><br><span class="line">        best_image = images[tops[<span class="number">0</span>]]</span><br><span class="line">        best_score = topscores[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Best image: <span class="subst">&#123;best_image&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Best score: <span class="subst">&#123;best_score&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># display(Image.open(best_image))</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">            dialog.append(ask_question())</span><br><span class="line">            tops,topscores = get_top_results(dialog, dialog_encoder)</span><br><span class="line">            best_image = images[tops[<span class="number">0</span>]]</span><br><span class="line">            best_score = topscores[<span class="number">0</span>]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Best image: <span class="subst">&#123;best_image&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Best score: <span class="subst">&#123;best_score&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> i==<span class="number">1</span>:</span><br><span class="line">                display(Image.<span class="built_in">open</span>(best_image))</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•å’Œè¯„ä¼°">æµ‹è¯•å’Œè¯„ä¼°</h2><p>åŸæ–‡è¯„ä¼°ChatIRæ€§èƒ½çš„æŒ‡æ ‡æ˜¯Hit@10ï¼Œå³ç›®æ ‡å›¾åƒå‡ºç°åœ¨æœ€åŒ¹é…çš„10ä¸ªå€™é€‰å›¾åƒä¸­çš„æ¦‚ç‡ï¼Œæˆ‘é‡‡ç”¨ç›¸åŒçš„è¯„ä¼°æ–¹å¼</p><h3 id="å¯¹è¯æ•°æ®é›†ç±»">å¯¹è¯æ•°æ®é›†ç±»</h3><p>å•ä¸ªæµ‹è¯•å¯¹è¯æ•°æ®ç»“æ„ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;image_path&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dialog&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;caption&quot;</span><span class="punctuation">,</span> <span class="string">&quot;question1? answer1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;question2? answer2&quot;</span><span class="punctuation">,</span> ...<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Queries</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¯¹è¯-å›¾åƒæ•°æ®é›†&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, queries_path, sep</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŠ è½½å¯¹è¯-å›¾åƒæ•°æ®é›†</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            queries_path: str æŸ¥è¯¢æ•°æ®é›†è·¯å¾„</span></span><br><span class="line"><span class="string">            sep: str åˆ†éš”ç¬¦</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(queries_path, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            self.queries = json.load(f)</span><br><span class="line">            f.close()</span><br><span class="line">        self.dialog_length = <span class="literal">None</span></span><br><span class="line">        self.sep = sep</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.queries)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, idx</span>):</span><br><span class="line">        <span class="keyword">assert</span> self.dialog_length <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        target_path = self.queries[idx][<span class="string">&quot;img&quot;</span>]</span><br><span class="line">        <span class="comment"># ä¿ç•™å¯¹è¯çš„å‰dialog_lengthè½®</span></span><br><span class="line">        text = self.sep.join(self.queries[idx][<span class="string">&quot;dialog&quot;</span>][:self.dialog_length + <span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;text&quot;</span>: text, <span class="string">&quot;target_path&quot;</span>: target_path&#125;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ä»£ç ">æµ‹è¯•ä»£ç </h3><p>ä½¿ç”¨äº†è®ºæ–‡ä»“åº“æä¾›çš„æµ‹è¯•ä»£ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">corpus_dataset = Corpus(config[<span class="string">&quot;corpus_path&quot;</span>], image_preprocessor)</span><br><span class="line">query_dataset = Queries(config[<span class="string">&quot;queries_path&quot;</span>], config[<span class="string">&quot;sep&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_recalls</span>(<span class="params">dataloader, dialog_length, dialog_encoder</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; è®¡ç®—dataloaderä¸­é•¿åº¦ä¸ºdialog_lengthçš„å¯¹è¯çš„å¬å›ç»“æœ</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        dataloader: æ•°æ®åŠ è½½å™¨</span></span><br><span class="line"><span class="string">        dialog_length: å¯¹è¯é•¿åº¦</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    dataloader.dataset.dialog_length = dialog_length  <span class="comment"># è®¾ç½®å¯¹è¯é•¿åº¦</span></span><br><span class="line">    recalls = []  <span class="comment"># æ¯ä¸ªå¯¹è¯çš„å¬å›ç»“æœ</span></span><br><span class="line">    <span class="keyword">for</span> batch <span class="keyword">in</span> tqdm(dataloader):</span><br><span class="line">        target_ids = torch.tensor(</span><br><span class="line">            [corpus_dataset.path_to_index(p) <span class="keyword">for</span> p <span class="keyword">in</span> batch[<span class="string">&#x27;target_path&#x27;</span>]]</span><br><span class="line">            ).unsqueeze(<span class="number">1</span>).to(config[<span class="string">&#x27;device&#x27;</span>]) <span class="comment"># å›¾ç‰‡è·¯å¾„è½¬æ¢ä¸ºç´¢å¼•</span></span><br><span class="line">        pred_vec = F.normalize(dialog_encoder(batch[<span class="string">&#x27;text&#x27;</span>]), dim=-<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        scores = pred_vec @ corpus[<span class="number">1</span>].T <span class="comment"># è®¡ç®—ç‚¹ç§¯ï¼Œå¾—åˆ°ç›¸ä¼¼åº¦åˆ†æ•°</span></span><br><span class="line">        arg_ranks = torch.argsort(scores, descending=<span class="literal">True</span>, dim=<span class="number">1</span>).long() <span class="comment"># å¯¹åˆ†æ•°è¿›è¡Œæ’åº</span></span><br><span class="line">        </span><br><span class="line">        target_recall = ((arg_ranks - target_ids) == <span class="number">0</span>).nonzero()[:, <span class="number">1</span>] <span class="comment"># ç›®æ ‡å›¾åƒåœ¨æ£€ç´¢æ’åä¸­å‡ºç°çš„ä½ç½®</span></span><br><span class="line">        recalls.append(target_recall)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> torch.cat(recalls)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_first_hitting_time</span>(<span class="params">target_recall, hitting_recall=<span class="number">10</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; è¿”å›(11, n)å¼ é‡ï¼Œå…¶ä¸­åŒ…å«æ¯è½®ï¼ˆ0, 11ï¼‰çš„å‘½ä¸­æ—¶é—´ã€‚infè¡¨ç¤ºæœªå‘½ä¸­ï¼ˆ10è½®åæ²¡æœ‰å‘½ä¸­ï¼‰ &quot;&quot;&quot;</span></span><br><span class="line">    target_recalls = target_recall.view(<span class="number">11</span>, -<span class="number">1</span>).T <span class="comment"># è½¬ç½®</span></span><br><span class="line">    hits = (target_recalls &lt; hitting_recall) <span class="comment"># ç›®æ ‡å›¾åƒæ˜¯å¦åœ¨å‰ hitting_recall è½®å†…å‡ºç°</span></span><br><span class="line"></span><br><span class="line">    final_hits = torch.inf * torch.ones(target_recalls.shape[<span class="number">0</span>]) <span class="comment"># åˆå§‹åŒ–ä¸ºinf</span></span><br><span class="line"></span><br><span class="line">    hitting_times = [] <span class="comment"># æ¯è½®çš„å‘½ä¸­æ—¶é—´</span></span><br><span class="line">    <span class="keyword">for</span> ro_i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">        rh = hits[:, ro_i]</span><br><span class="line">        final_hits[rh] = torch.<span class="built_in">min</span>(final_hits[rh], torch.ones(final_hits[rh].shape) * ro_i)</span><br><span class="line">        hitting_times.append(final_hits.clone())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> torch.stack(hitting_times)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cumulative_hits_per_round</span>(<span class="params">target_recall, hitting_recall=<span class="number">10</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; è¿”å›ç›´åˆ°ç¬¬xè½®çš„å¹³å‡å‘½ä¸­æ¬¡æ•° &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(hitting_recall) <span class="keyword">is</span> <span class="built_in">tuple</span>:</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(hitting_recall) == <span class="number">1</span></span><br><span class="line">        hitting_recall = hitting_recall[<span class="number">0</span>]</span><br><span class="line">    ht_times = get_first_hitting_time(target_recall, hitting_recall)</span><br><span class="line">    <span class="keyword">return</span> ((ht_times &lt; torch.inf).<span class="built_in">sum</span>(dim=-<span class="number">1</span>) * <span class="number">100</span> / ht_times[<span class="number">0</span>].shape[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">eval</span>(<span class="params">image_encoder, dialog_encoder, hits_at=<span class="number">10</span></span>):</span><br><span class="line">    prepare_corpus(image_encoder)</span><br><span class="line">    query_dataloader = torch.utils.data.DataLoader(query_dataset, <span class="comment"># è¯¢é—®æ•°æ®é›†</span></span><br><span class="line">                                             batch_size=config[<span class="string">&#x27;batch_size&#x27;</span>], <span class="comment"># æ‰¹å¤§å°</span></span><br><span class="line">                                             shuffle=<span class="literal">False</span>, <span class="comment"># ä¸æ‰“ä¹±</span></span><br><span class="line">                                             num_workers=config[<span class="string">&#x27;num_workers&#x27;</span>], <span class="comment"># å¤šçº¿ç¨‹</span></span><br><span class="line">                                             pin_memory=<span class="literal">True</span>, <span class="comment"># é”é¡µå†…å­˜</span></span><br><span class="line">                                             drop_last=<span class="literal">False</span></span><br><span class="line">                                             )</span><br><span class="line">    hits_results = []</span><br><span class="line">    <span class="keyword">for</span> dl <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>): <span class="comment"># å¯¹è¯é•¿åº¦ä»0åˆ°10</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Calculate recalls for each dialogues of length <span class="subst">&#123;dl&#125;</span>...&quot;</span>)</span><br><span class="line">        dialog_recalls = _get_recalls(query_dataloader, dialog_length=dl, dialog_encoder=dialog_encoder)</span><br><span class="line">        hits_results.append(dialog_recalls)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä½¿ç”¨cumulative_hits_per_roundè®¡ç®—æœ€ç»ˆçš„Hits@10ç»“æœ</span></span><br><span class="line">    <span class="comment"># Hits@10ï¼š`åœ¨é¢„æµ‹çš„å‰ 10 ä¸ªå€™é€‰é¡¹ä¸­ï¼ŒåŒ…å«äº†æ­£ç¡®ç­”æ¡ˆ`çš„æ¯”ä¾‹</span></span><br><span class="line">    hits_results = cumulative_hits_per_round(torch.cat(hits_results).cpu(), hitting_recall=<span class="number">10</span>).tolist()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;====== Results for Hits@10 ====== &quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> dl <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\t Dialog Length: <span class="subst">&#123;dl&#125;</span>: <span class="subst">&#123;<span class="built_in">round</span>(hits_results[dl], <span class="number">2</span>)&#125;</span>%&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    image_encoder, dialog_encoder = get_funcs()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(config[<span class="string">&quot;corpus_path&quot;</span>], <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        images = json.load(f)</span><br><span class="line">        f.close()</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="built_in">eval</span>(image_encoder, dialog_encoder)</span><br></pre></td></tr></table></figure><h3 id="å¯¹è¯æ•°æ®ç”Ÿæˆ">å¯¹è¯æ•°æ®ç”Ÿæˆ</h3><p>åŸæ–‡ä¸­ï¼Œä¸ºäº†è‡ªåŠ¨è·å–æµ‹è¯•æ•°æ®ï¼Œå…é™¤äººå·¥å›ç­”ï¼Œä½¿ç”¨äº†BLIP2æ¨¡å‹å›ç­”é—®é¢˜</p><p>æˆ‘å‚è€ƒåŸæ–‡çš„æ–¹æ³•ï¼Œä½¿ç”¨BLIP2ç”Ÿæˆå¯¹è¯æ•°æ®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lavis.models <span class="keyword">import</span> load_model_and_preprocess <span class="comment"># BLIP2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> OpenAI <span class="keyword">import</span> request_chat</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">st,ed = <span class="built_in">int</span>(sys.argv[<span class="number">1</span>]), <span class="built_in">int</span>(sys.argv[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;../dialogues/ChatGPT_BLIP2.json&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = json.load(f)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line">images = [d[<span class="string">&quot;img&quot;</span>] <span class="keyword">for</span> d <span class="keyword">in</span> data][st:ed]</span><br><span class="line">captions = [d[<span class="string">&quot;dialog&quot;</span>][<span class="number">0</span>] <span class="keyword">for</span> d <span class="keyword">in</span> data][st:ed]</span><br><span class="line"></span><br><span class="line">config = &#123;</span><br><span class="line">    <span class="string">&quot;device&quot;</span>: <span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>,</span><br><span class="line">    <span class="string">&quot;image_size&quot;</span> : <span class="number">224</span>,</span><br><span class="line">    <span class="string">&quot;sep&quot;</span>: <span class="string">&quot;, &quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> config[<span class="string">&quot;device&quot;</span>] == <span class="string">&quot;cuda&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Using GPU&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_image</span>(<span class="params">image_path</span>):</span><br><span class="line">    raw_image = Image.<span class="built_in">open</span>(image_path).convert(<span class="string">&#x27;RGB&#x27;</span>)</span><br><span class="line">    image = vis_processors[<span class="string">&quot;eval&quot;</span>](raw_image).unsqueeze(<span class="number">0</span>).to(config[<span class="string">&quot;device&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visual_qa</span>(<span class="params">image, question, model</span>):</span><br><span class="line">    answer = model.generate(&#123;<span class="string">&quot;image&quot;</span>: image, <span class="string">&quot;prompt&quot;</span>: <span class="string">f&quot;Question: <span class="subst">&#123;question&#125;</span> Answer:&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> answer[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ask_question</span>(<span class="params">dialog</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¯¢é—®ç”¨æˆ·é—®é¢˜&quot;&quot;&quot;</span></span><br><span class="line">    question = request_chat(dialog)</span><br><span class="line">    <span class="keyword">return</span> question</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_dialog</span>(<span class="params">idx, model</span>):</span><br><span class="line">    image = load_image(images[idx])</span><br><span class="line">    caption = captions[idx]</span><br><span class="line">    dialog = [caption]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        question = ask_question(dialog)</span><br><span class="line">        answer = visual_qa(image, question, model)</span><br><span class="line">        dialog.append(question+answer)</span><br><span class="line">    ret = &#123;</span><br><span class="line">        <span class="string">&quot;img&quot;</span>: images[idx],</span><br><span class="line">        <span class="string">&quot;dialog&quot;</span>: dialog</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    model, vis_processors, _ = load_model_and_preprocess(</span><br><span class="line">        name=<span class="string">&quot;blip2_opt&quot;</span>, model_type=<span class="string">&quot;caption_coco_opt6.7b&quot;</span>, is_eval=<span class="literal">True</span>, device=config[<span class="string">&quot;device&quot;</span>]</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;ChatGPT4oMini_BLIP2.txt&quot;</span>, <span class="string">&quot;a&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> idx <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="built_in">len</span>(images))):</span><br><span class="line">                dialog = generate_dialog(idx, model)</span><br><span class="line">                json.dump(dialog, f)</span><br><span class="line">                f.write(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            f.close()</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•æ—¥å¿—">æµ‹è¯•æ—¥å¿—</h3><ol><li>ç”±äºOpenAIçš„tokené™åˆ¶ï¼Œæˆ‘ä½¿ç”¨äº†è®¯é£æ˜Ÿç«APIä½œä¸ºæé—®æ¨¡å‹G</li><li>è®ºæ–‡æ²¡è¯»ä»”ç»†ï¼Œä¸€å¼€å§‹ä»¥ä¸ºç”Ÿæˆå¯¹è¯æ•°æ®æ—¶ï¼Œä»£æ›¿äººç±»å›ç­”çš„æ¨¡å‹å’Œç¼–ç ç”¨çš„æ¨¡å‹ä¸€æ ·ï¼Œæ˜¯BLIP</li><li>åœ¨ä»¥ä¸ŠåŸºç¡€ä¸Šï¼Œæµ‹è¯•çš„Hit@10ç»“æœï¼ˆ40%~60%ï¼‰ä¸åŸæ–‡ï¼ˆ63%~80%ï¼‰æœ‰è¾ƒå¤§å·®è·</li><li>åŸæœ¬è®¤ä¸ºæ˜¯æé—®æ¨¡å‹Gæ²¡æœ‰ç”¨ChatGPTçš„åŸå› ï¼Œå¾®æ°ªtokenï¼Œè°ƒæ•´ä¸ºChatGPT4o-miniï¼Œä½†ç»“æœä¾ç„¶ä¸ç†æƒ³ï¼ˆ40%~67%ï¼‰</li><li>æ³¨æ„åˆ°ï¼Œ40%æ˜¯$D_0$ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ç”¨BLIPç”Ÿæˆçš„ç¬¬ä¸€å¥æè¿°æ—¶çš„å‡†ç¡®ç‡ï¼Œå’Œæé—®æ¨¡å‹Gæ— å…³</li><li>å¯¹æ¯”åŸæ–‡ï¼Œå‘ç°å›ç­”æ¨¡å‹åº”è¯¥æ˜¯å¦ä¸€ç¯‡paperä¸­çš„BLIP2ï¼Œè€Œä¸æ˜¯BLIP</li><li>ä¿®æ”¹æ•°æ®ç”Ÿæˆä»£ç ï¼Œä½¿ç”¨BLIP2ç”Ÿæˆå¯¹è¯æ•°æ®ï¼Œæµ‹è¯•ç»“æœä¸åŸæ–‡æ¥è¿‘ï¼ˆ60%~80%ï¼‰</li></ol><p>å®¢è§‚é—®é¢˜ï¼šç”±äºç¡¬ä»¶æ¡ä»¶æœ‰é™ï¼Œè·‘å‡ºä¸€æ¡æ•°æ®éœ€è¦3~5åˆ†é’Ÿï¼Œå› æ­¤åªæµ‹è¯•äº†1021æ¡æ•°æ®ï¼Œå¯¹äºæ•´ä½“æ€§èƒ½è¯„ä¼°å¯èƒ½ä¸å¤Ÿå‡†ç¡®</p><h3 id="æµ‹è¯•ç»“æœ">æµ‹è¯•ç»“æœ</h3><p>åœ¨ä½¿ç”¨ChatGPTä½œä¸ºæé—®æ¨¡å‹Gï¼ŒBLIP2ä½œä¸ºå›ç­”æ¨¡å‹Aï¼Œä½¿ç”¨åŒä¸€æµ‹è¯•ä»£ç çš„æƒ…å†µä¸‹ï¼Œæµ‹è¯•ç»“æœå’ŒåŸæ–‡å¯¹æ¯”å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">length</th><th style="text-align:center">åŸæ–‡(2064 testcases)</th><th style="text-align:center">å®ç°ï¼ˆ1021 testcasesï¼‰</th></tr></thead><tbody><tr><td style="text-align:center">0</td><td style="text-align:center">63.42%</td><td style="text-align:center">62.98%</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">69.43%</td><td style="text-align:center">70.62%</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">72.38%</td><td style="text-align:center">72.67%</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">74.47%</td><td style="text-align:center">74.53%</td></tr><tr><td style="text-align:center">4</td><td style="text-align:center">76.02%</td><td style="text-align:center">75.32%</td></tr><tr><td style="text-align:center">5</td><td style="text-align:center">77.47%</td><td style="text-align:center">75.42%</td></tr><tr><td style="text-align:center">6</td><td style="text-align:center">78.49%</td><td style="text-align:center">76.00%</td></tr><tr><td style="text-align:center">7</td><td style="text-align:center">79.65%</td><td style="text-align:center">76.20%</td></tr><tr><td style="text-align:center">8</td><td style="text-align:center">80.09%</td><td style="text-align:center">76.69%</td></tr><tr><td style="text-align:center">9</td><td style="text-align:center">80.43%</td><td style="text-align:center">76.98%</td></tr><tr><td style="text-align:center">10</td><td style="text-align:center">80.77%</td><td style="text-align:center">77.18%</td></tr></tbody></table><p>åœ¨ç¬¬äº”è½®å¯¹è¯åï¼Œå¯¹è¯é•¿åº¦å¢åŠ å¯¹æ£€ç´¢æ€§èƒ½çš„æå‡ä¸å†æ˜æ˜¾</p>]]></content>
    
    
    <summary type="html">å®ç°è®ºæ–‡ã€ŠChatting Makes Perfectï¼šChat-based Image Retrivalã€‹</summary>
    
    
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://www.cclmsy.cc/categories/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="è®ºæ–‡å®ç°" scheme="https://www.cclmsy.cc/tags/%E8%AE%BA%E6%96%87%E5%AE%9E%E7%8E%B0/"/>
    
    <category term="å›¾åƒæ£€ç´¢" scheme="https://www.cclmsy.cc/tags/%E5%9B%BE%E5%83%8F%E6%A3%80%E7%B4%A2/"/>
    
    <category term="MLLM" scheme="https://www.cclmsy.cc/tags/MLLM/"/>
    
  </entry>
  
  <entry>
    <title>Pretrained BLIP æ¨¡å‹è°ƒç”¨</title>
    <link href="https://www.cclmsy.cc/posts/pretrained_blip.html"/>
    <id>https://www.cclmsy.cc/posts/pretrained_blip.html</id>
    <published>2025-03-02T16:00:00.000Z</published>
    <updated>2025-07-20T12:14:16.220Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/salesforce/BLIP">Github Repo</a></p><p>BLIPå…¨ç§°Bootstrapping Language-Image Pre-trainingï¼Œæ˜¯ä¸€ä¸ªå…¨æ–°çš„ ç»Ÿä¸€è§†è§‰è¯­è¨€ç†è§£ä¸ç”Ÿæˆçš„é¢„è®­ç»ƒæ¨¡å‹</p><p>å®ƒç»Ÿä¸€äº†è§†è§‰è¯­è¨€ä»»åŠ¡çš„ç†è§£ä¸ç”ŸæˆåŠŸèƒ½ï¼Œå¹¶ä¸”é€šè¿‡åµŒå…¥ Captioner å’Œ Filter å»é™¤ç½‘ç»œèµ„æºä¸­çš„æ–‡æœ¬å™ªå£°ï¼Œæé«˜äº†æ¨¡å‹åœ¨ä¸‹æ¸¸è§†è§‰è¯­è¨€ä»»åŠ¡ä¸Šçš„æ€§èƒ½</p><h2 id="Colab-Notebook-è¿è¡Œ">Colab Notebook è¿è¡Œ</h2><p>Salesforceåœ¨Colab NoteBookä¸­æä¾›äº†Demoï¼Œå¯ä»¥åœ¨äº‘ç«¯ç›´æ¥è¿è¡Œï¼š<a href="https://colab.research.google.com/github/salesforce/BLIP/blob/main/demo.ipynb">Colab notebook</a></p><p>ç¬¬ä¸€æ­¥é…ç½®ç¯å¢ƒæ—¶å‡ºç°<code>ERROR: Failed building wheel for tokenizers</code>é—®é¢˜ï¼Œåœ¨<a href="https://github.com/salesforce/BLIP/issues/151#issuecomment-1537125671">Issue#151çš„è¯„è®º</a>ä¸­æä¾›äº†è§£å†³æ–¹æ¡ˆï¼šä¿®æ”¹transformersç‰ˆæœ¬<code>4.25.1</code></p><h2 id="æœ¬åœ°è°ƒç”¨">æœ¬åœ°è°ƒç”¨</h2><p>å­¦ä¹ åœ¨æœ¬åœ°ä½¿ç”¨Pretrained BLIPæ¨¡å‹ï¼Œæµ‹è¯•ä»£ç ç½®äºBLIPç›®å½•ä¸‹</p><p>å®éªŒç¯å¢ƒï¼š</p><ul><li>Python 3.11.11 on conda</li><li>transformers 4.25.1</li><li>timm 0.4.12</li><li>fairscale 0.4.4</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms</span><br><span class="line"><span class="keyword">from</span> torchvision.transforms.functional <span class="keyword">import</span> InterpolationMode</span><br><span class="line"></span><br><span class="line">device = torch.device(<span class="string">&#x27;cuda&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_demo_image</span>(<span class="params">image_size,device</span>):</span><br><span class="line">    img_url = <span class="string">&#x27;https://storage.googleapis.com/sfr-vision-language-research/BLIP/demo.jpg&#x27;</span> </span><br><span class="line">    raw_image = Image.<span class="built_in">open</span>(requests.get(img_url, stream=<span class="literal">True</span>).raw).convert(<span class="string">&#x27;RGB&#x27;</span>)   </span><br><span class="line"></span><br><span class="line">    w,h = raw_image.size</span><br><span class="line">    <span class="built_in">print</span>(raw_image.resize((w//<span class="number">5</span>,h//<span class="number">5</span>)))</span><br><span class="line">    </span><br><span class="line">    transform = transforms.Compose([</span><br><span class="line">        transforms.Resize((image_size,image_size),interpolation=InterpolationMode.BICUBIC),</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize((<span class="number">0.48145466</span>, <span class="number">0.4578275</span>, <span class="number">0.40821073</span>), (<span class="number">0.26862954</span>, <span class="number">0.26130258</span>, <span class="number">0.27577711</span>))</span><br><span class="line">        ]) </span><br><span class="line">    image = transform(raw_image).unsqueeze(<span class="number">0</span>).to(device)   </span><br><span class="line">    <span class="keyword">return</span> image</span><br></pre></td></tr></table></figure><h3 id="Image-Captioning-å›¾åƒæè¿°">Image Captioning å›¾åƒæè¿°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> models.blip <span class="keyword">import</span> blip_decoder</span><br><span class="line"></span><br><span class="line">image_size = <span class="number">384</span></span><br><span class="line">image = load_demo_image(image_size=image_size, device=device)</span><br><span class="line"></span><br><span class="line">model_url = <span class="string">&#x27;https://storage.googleapis.com/sfr-vision-language-research/BLIP/models/model_base_capfilt_large.pth&#x27;</span></span><br><span class="line">    </span><br><span class="line">model = blip_decoder(pretrained=model_url, image_size=image_size, vit=<span class="string">&#x27;base&#x27;</span>)</span><br><span class="line">model.<span class="built_in">eval</span>()</span><br><span class="line">model = model.to(device)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    <span class="comment"># beam search </span></span><br><span class="line">    caption = model.generate(image, sample=<span class="literal">False</span>, num_beams=<span class="number">3</span>, max_length=<span class="number">20</span>, min_length=<span class="number">5</span>)</span><br><span class="line">    <span class="comment"># nucleus sampling</span></span><br><span class="line">    <span class="comment"># caption = model.generate(image, sample=True, top_p=0.9, max_length=20, min_length=5)  </span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;caption: &#x27;</span>+caption[<span class="number">0</span>])</span><br></pre></td></tr></table></figure><pre><code>The cache for model files in Transformers v4.22.0 has been updated. Migrating your old cache. This is a one-time only operation. You can interrupt this and resume the migration later on by calling `transformers.utils.move_cache()`.Moving 0 files to the new cache system0it [00:00, ?it/s]&lt;PIL.Image.Image image mode=RGB size=409x273 at 0x11139327650&gt;reshape position embedding from 196 to 576load checkpoint from https://storage.googleapis.com/sfr-vision-language-research/BLIP/models/model_base_capfilt_large.pthcaption: a woman and her dog on the beach</code></pre><h3 id="Visual-Question-Answering-è§†è§‰é—®ç­”">Visual Question Answering è§†è§‰é—®ç­”</h3><p>ç”±äºå­˜åœ¨å’ŒImageCaptioningä¸­çš„beam_searchç›¸åŒçš„ç‰ˆæœ¬é—®é¢˜ï¼Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> models.blip_vqa <span class="keyword">import</span> blip_vqa</span><br><span class="line"></span><br><span class="line">image_size = <span class="number">480</span></span><br><span class="line">image = load_demo_image(image_size=image_size, device=device)     </span><br><span class="line"></span><br><span class="line">model_url = <span class="string">&#x27;https://storage.googleapis.com/sfr-vision-language-research/BLIP/models/model_base_vqa_capfilt_large.pth&#x27;</span></span><br><span class="line">    </span><br><span class="line">model = blip_vqa(pretrained=model_url, image_size=image_size, vit=<span class="string">&#x27;base&#x27;</span>)</span><br><span class="line">model.<span class="built_in">eval</span>()</span><br><span class="line">model = model.to(device)</span><br><span class="line"></span><br><span class="line">question = <span class="string">&#x27;where is the woman sitting?&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    answer = model(image, question, train=<span class="literal">False</span>, inference=<span class="string">&#x27;generate&#x27;</span>) </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;answer: &#x27;</span>+answer[<span class="number">0</span>])</span><br></pre></td></tr></table></figure><pre><code>&lt;PIL.Image.Image image mode=RGB size=409x273 at 0x11139109090&gt;load checkpoint from https://storage.googleapis.com/sfr-vision-language-research/BLIP/models/model_base_vqa_capfilt_large.pthanswer: on beach</code></pre><h3 id="Image-Text-Matching-å›¾æ–‡åŒ¹é…">Image-Text Matching å›¾æ–‡åŒ¹é…</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> models.blip_itm <span class="keyword">import</span> blip_itm</span><br><span class="line"></span><br><span class="line">image_size = <span class="number">384</span></span><br><span class="line">image = load_demo_image(image_size=image_size,device=device)</span><br><span class="line"></span><br><span class="line">model_url = <span class="string">&#x27;https://storage.googleapis.com/sfr-vision-language-research/BLIP/models/model_base_retrieval_coco.pth&#x27;</span></span><br><span class="line">    </span><br><span class="line">model = blip_itm(pretrained=model_url, image_size=image_size, vit=<span class="string">&#x27;base&#x27;</span>)</span><br><span class="line">model.<span class="built_in">eval</span>()</span><br><span class="line">model = model.to(device=device)</span><br><span class="line"></span><br><span class="line">caption = <span class="string">&#x27;a woman sitting on the beach with a dog&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;text: %s&#x27;</span> %caption)</span><br><span class="line"></span><br><span class="line">itm_output = model(image,caption,match_head=<span class="string">&#x27;itm&#x27;</span>)</span><br><span class="line">itm_score = torch.nn.functional.softmax(itm_output,dim=<span class="number">1</span>)[:,<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;The image and text is matched with a probability of %.4f&#x27;</span>%itm_score)</span><br><span class="line"></span><br><span class="line">itc_score = model(image,caption,match_head=<span class="string">&#x27;itc&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;The image feature and text feature has a cosine similarity of %.4f&#x27;</span>%itc_score)</span><br></pre></td></tr></table></figure><pre><code>&lt;PIL.Image.Image image mode=RGB size=409x273 at 0x11130227FD0&gt;load checkpoint from https://storage.googleapis.com/sfr-vision-language-research/BLIP/models/model_base_retrieval_coco.pthtext: a woman sitting on the beach with a dogThe image and text is matched with a probability of 0.9960The image feature and text feature has a cosine similarity of 0.5262</code></pre>]]></content>
    
    
    <summary type="html">Salesforceæä¾›çš„ç»Ÿä¸€è§†è§‰è¯­è¨€ç†è§£ä¸ç”Ÿæˆçš„é¢„è®­ç»ƒæ¨¡å‹</summary>
    
    
    
    <category term="DLç¬”è®°" scheme="https://www.cclmsy.cc/categories/DL%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="æ¨¡å‹è°ƒç”¨" scheme="https://www.cclmsy.cc/tags/%E6%A8%A1%E5%9E%8B%E8%B0%83%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>å¤ç°|æ‰‹æ“Transformeræ¨¡å‹</title>
    <link href="https://www.cclmsy.cc/posts/transformer.html"/>
    <id>https://www.cclmsy.cc/posts/transformer.html</id>
    <published>2025-02-27T16:00:00.000Z</published>
    <updated>2025-07-21T05:32:34.685Z</updated>
    
    <content type="html"><![CDATA[<p>è®ºæ–‡ï¼š<a href="https://arxiv.org/abs/1706.03762">Attention is All You Need</a></p><blockquote><p>2017å¹´Googleåœ¨è®ºæ–‡ã€ŠAttention is All You Needã€‹ä¸­æå‡ºäº†Transformeræ¨¡å‹ï¼Œå¹¶æˆåŠŸåº”ç”¨åˆ°NLPé¢†åŸŸã€‚<br>è¯¥æ¨¡å‹å®Œå…¨åŸºäºè‡ªæ³¨æ„åŠ›æœºåˆ¶Attention mechanismå®ç°ï¼Œå¼¥è¡¥äº†ä¼ ç»Ÿçš„RNNæ¨¡å‹çš„ä¸è¶³ã€‚</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¨å±€å˜é‡</span></span><br><span class="line">d_model = <span class="number">512</span> <span class="comment"># è¯å‘é‡ç»´åº¦</span></span><br><span class="line">d_ff = <span class="number">2048</span> <span class="comment"># å‰é¦ˆç¥ç»ç½‘ç»œéšå±‚ç»´åº¦</span></span><br><span class="line">src_vocab_size = <span class="number">10</span> <span class="comment"># æºè¯­è¨€è¯è¡¨å¤§å°</span></span><br><span class="line">tgt_vocab_size = <span class="number">10</span> <span class="comment"># ç›®æ ‡è¯­è¨€è¯è¡¨å¤§å°</span></span><br><span class="line">n_layers = <span class="number">6</span> <span class="comment"># ç¼–ç å™¨å’Œè§£ç å™¨å †å åŸºç¡€å—çš„æ•°é‡</span></span><br></pre></td></tr></table></figure><h2 id="0-TransformeråŸç†">0.TransformeråŸç†</h2><p>å®è§‚ä¸Šï¼ŒTransformerå¯ä»¥çœ‹ä½œä¸€ä¸ªé»‘ç®±æ“ä½œçš„Seq2Seqæ¨¡å‹ã€‚<br>æ‹†å¼€é»‘ç®±ï¼Œå¯ä»¥çœ‹åˆ°æ¨¡å‹çš„æœ¬è´¨æ˜¯ä¸€ä¸ªEncoder-Decoderç»“æ„ã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/transformer/Transformer%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84.webp" alt="Transformeræ•´ä½“æ¶æ„"></p><ul><li>Embeddingï¼šè¯åµŒå…¥å±‚ï¼Œå°†è¾“å…¥çš„è¯è½¬æ¢ä¸ºè¯å‘é‡</li><li>Positional Encodingï¼šä½ç½®ç¼–ç ï¼Œä¸ºäº†è®©æ¨¡å‹å­¦ä¹ åˆ°åºåˆ—çš„ä½ç½®ä¿¡æ¯</li><li>Multi-Head Attentionï¼šå¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼Œç”¨äºæ•æ‰è¾“å…¥åºåˆ—çš„å…¨å±€ä¾èµ–å…³ç³»</li><li>Add &amp; Normï¼šæ®‹å·®è¿æ¥å’Œå±‚å½’ä¸€åŒ–ï¼Œç”¨äºåŠ é€Ÿè®­ç»ƒã€ç¼“è§£æ¢¯åº¦æ¶ˆå¤±é—®é¢˜<ul><li>Addæ®‹å·®è¿æ¥ï¼šæŠŠç½‘ç»œçš„è¾“å…¥å’Œè¾“å‡ºç›¸åŠ ï¼Œæœ‰æ•ˆè§£å†³æ¢¯åº¦æ¶ˆå¤±é—®é¢˜</li><li>Normå±‚å½’ä¸€åŒ–ï¼šå¯¹ç½‘ç»œçš„è¾“å‡ºè¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼ŒåŠ é€Ÿè®­ç»ƒ</li></ul></li><li>Feed Forwardï¼šå‰é¦ˆç¥ç»ç½‘ç»œï¼Œç”¨äºå¯¹ç‰¹å¾è¿›è¡Œéçº¿æ€§å˜æ¢</li><li>Linearï¼šçº¿æ€§å˜æ¢å±‚ï¼Œç”¨äºå°†ç‰¹å¾æ˜ å°„åˆ°è¾“å‡ºç©ºé—´</li><li>Softmaxï¼šSoftmaxå±‚ï¼Œç”¨äºè¾“å‡ºæ¦‚ç‡åˆ†å¸ƒ</li></ul><h2 id="1-Encoder">1.Encoder</h2><p><img src="https://source.cclmsy.cc/posts/notes/papers/transformer/Transformer_Encoder.webp" alt="Transformer_Encoder"></p><h3 id="1-1-Embedding-è¯åµŒå…¥">1.1 Embedding è¯åµŒå…¥</h3><p>æ¨¡å‹æ— æ³•ç›´æ¥å¤„ç†æ–‡æœ¬æ•°æ®ï¼Œéœ€è¦æŠŠæ–‡æœ¬æ•°æ®è½¬æ¢æˆè®¡ç®—æœºèƒ½å¤Ÿè¯†åˆ«çš„å‘é‡å½¢å¼ã€‚<br>å°†æ–‡æœ¬è½¬åŒ–ä¸ºå‘é‡é€šå¸¸æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>One-hotç¼–ç ï¼šè¯å…¸å¤§å°ä¸ºNï¼Œæ¯ä¸ªè¯ç”¨ä¸€ä¸ªNç»´å‘é‡è¡¨ç¤ºï¼Œå½“å‰è¯å¯¹åº”çš„ç»´åº¦ä¸º1ï¼Œå…¶ä½™ç»´åº¦ä¸º0<ul><li>ä¼˜ç‚¹ï¼šç®€å•ç›´è§‚</li><li>ç¼ºç‚¹ï¼šå‘é‡ç»´åº¦é«˜ã€ç¨€ç–ã€ç¼ºä¹è¯­ä¹‰ä¹‹é—´çš„è”ç³»</li></ul></li><li>Embeddingè¯åµŒå…¥ï¼šé€šè¿‡è®­ç»ƒå­¦ä¹ åˆ°çš„è¯å‘é‡ï¼Œå°†è¯æ˜ å°„åˆ°ä¸€ä¸ªä½ç»´ç©ºé—´<ul><li>ä¼˜ç‚¹ï¼šä½ç»´ã€ç¨ å¯†ã€èƒ½å¤Ÿè¡¨è¾¾è¯ä¹‹é—´çš„å…³ç³»</li></ul></li></ul><p>è¾“å…¥Imputçš„ç»´åº¦æ˜¯[batch_size, seq_len]ï¼ŒEmbeddingå±‚çš„è¾“å‡ºç»´åº¦æ˜¯[batch_size, seq_len, d_model]ã€‚</p><ul><li>batch_sizeï¼šæ‰¹æ¬¡å¤§å°ï¼ˆå¥å­ä¸ªæ•°ï¼‰</li><li>seq_lenï¼šæœ€é•¿å¥å­é•¿åº¦</li><li>d_modelï¼šè¯å‘é‡ç»´åº¦</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Embeddings</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, vocab_size, d_model</span>):</span><br><span class="line">        <span class="built_in">super</span>(Embeddings, self).__init__()</span><br><span class="line">        <span class="comment"># è°ƒç”¨nn.Embeddingï¼Œè·å¾—å®ä¾‹åŒ–çš„è¯åµŒå…¥å¯¹è±¡lut(look up table)</span></span><br><span class="line">        self.lut = nn.Embedding(vocab_size, d_model)</span><br><span class="line">        self.d_model = d_model <span class="comment"># è¯åµŒå…¥ç»´åº¦</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Embeddingå±‚çš„å‰å‘ä¼ æ’­</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: è¾“å…¥çš„è¯ç´¢å¼•å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, seq_len)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            è¯åµŒå…¥å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, seq_len, d_model)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.lut(x) * math.sqrt(self.d_model)</span><br></pre></td></tr></table></figure><h3 id="1-2-Positional-Encoding-ä½ç½®ç¼–ç ">1.2 Positional Encoding ä½ç½®ç¼–ç </h3><p>Embeddingå±‚åªèƒ½è¡¨ç¤ºè¯çš„è¯­ä¹‰ä¿¡æ¯ï¼Œæ— æ³•è¡¨ç¤ºè¯çš„ä½ç½®ä¿¡æ¯ã€‚<br>Transformerä½¿ç”¨çš„æ˜¯è‡ªæ³¨æ„åŠ›æœºåˆ¶æ¥æå–ä¿¡æ¯ï¼Œä¸€ä¸ªå¥å­ä¸­çš„æ¯ä¸ªå­—/è¯æ˜¯å¹¶è¡Œè®¡ç®—ï¼Œè™½ç„¶å¤„ç†æ¯ä¸ªå­—çš„æ—¶å€™è€ƒè™‘åˆ°äº†æ‰€æœ‰å­—å¯¹å…¶çš„å½±å“ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è€ƒè™‘åˆ°å„ä¸ªå­—ç›¸äº’ä¹‹é—´çš„ä½ç½®ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥ä½ç½®ä¿¡æ¯</p><p>ä¸ºäº†è®©æ¨¡å‹å­¦ä¹ åˆ°åºåˆ—çš„ä½ç½®ä¿¡æ¯ï¼Œéœ€è¦åœ¨Embeddingå±‚çš„è¾“å‡ºä¸ŠåŠ ä¸Šä½ç½®ç¼–ç ï¼Œå¾—åˆ°å«æœ‰ä½ç½®ä¿¡æ¯çš„è¯å‘é‡$\alpha$ã€‚</p><p>Transformerä¸­ä½¿ç”¨Positional Encodingè¡¨ç¤ºæ¯ä¸ªå­—ã€è¯çš„ä½ç½®ä¿¡æ¯ï¼Œå…¬å¼å¦‚ä¸‹ï¼š</p><p>$$<br>PE_{(pos, i)} = \begin{cases}<br>sin(w_k \cdot pos), &amp; i = 2k \\<br>cos(w_k \cdot pos), &amp; i = 2k+1<br>\end{cases}<br>$$<br>$$<br>w_k = \dfrac{1}{10000^{2k/d_{model}}} \quad k = 0,1,2,â€¦,d_{model}-1<br>$$</p><p>å…¶ä¸­ï¼š</p><ul><li>$PE_{(pos, i)}$ï¼šè¡¨ç¤ºç¬¬$pos$ä¸ªå­—/è¯çš„Encodingå‘é‡ç¬¬$i$ç»´çš„ç¼–ç å€¼</li><li>$pos$ï¼šä½ç½®ä¿¡æ¯ï¼Œè¡¨ç¤ºå¥å­ä¸­çš„ç¬¬å‡ ä¸ªå­—/è¯ï¼Œä»0å¼€å§‹</li><li>$i$ï¼šä½ç½®ç¼–ç çš„ç»´åº¦ï¼Œä»0å¼€å§‹</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PositionalEncoding</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, d_model, dropout=<span class="number">0.1</span>, max_len=<span class="number">5000</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(PositionalEncoding, self).__init__()</span><br><span class="line">        self.dropout = nn.Dropout(p=dropout)</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªå½¢çŠ¶ä¸º(max_len, d_model)çš„ä½ç½®ç¼–ç çŸ©é˜µ</span></span><br><span class="line">        pe = torch.zeros(max_len, d_model)</span><br><span class="line">        <span class="comment"># position[i] = i</span></span><br><span class="line">        position = torch.arange(<span class="number">0</span>, max_len).unsqueeze(<span class="number">1</span>).<span class="built_in">float</span>()</span><br><span class="line">        <span class="comment"># w_k=e^(2k*-log10000/d_model)=1/(10000^(2k/d_model))</span></span><br><span class="line">        div_term = torch.exp(torch.arange(<span class="number">0</span>, d_model, <span class="number">2</span>).<span class="built_in">float</span>() * -(math.log(<span class="number">10000.0</span>) / d_model))</span><br><span class="line">        <span class="comment"># å¶æ•°åˆ—ä½¿ç”¨sinå‡½æ•°ç¼–ç ï¼Œå¥‡æ•°åˆ—ä½¿ç”¨coså‡½æ•°ç¼–ç </span></span><br><span class="line">        pe[:, <span class="number">0</span>::<span class="number">2</span>] = torch.sin(position * div_term)</span><br><span class="line">        pe[:, <span class="number">1</span>::<span class="number">2</span>] = torch.cos(position * div_term)</span><br><span class="line">        <span class="comment"># åœ¨ç¬¬0ç»´å¢åŠ ä¸€ä¸ªç»´åº¦ï¼Œå½¢çŠ¶å˜ä¸º(batch_size=1, max_len, d_model)</span></span><br><span class="line">        pe = pe.unsqueeze(<span class="number">0</span>)</span><br><span class="line">        self.register_buffer(<span class="string">&#x27;pe&#x27;</span>, pe)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä½ç½®ç¼–ç å±‚çš„å‰å‘ä¼ æ’­</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: è¾“å…¥çš„è¯åµŒå…¥å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, seq_len, d_model)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            æ·»åŠ äº†ä½ç½®ç¼–ç çš„è¯åµŒå…¥å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, seq_len, d_model)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        x = x + self.pe[:, :x.size(<span class="number">1</span>)].clone().detach()</span><br><span class="line">        <span class="keyword">return</span> self.dropout(x)</span><br></pre></td></tr></table></figure><h3 id="1-3-Self-Attention-è‡ªæ³¨æ„åŠ›æœºåˆ¶">1.3 Self Attention è‡ªæ³¨æ„åŠ›æœºåˆ¶</h3><p>ä¸€å¥è¯ä¸­ï¼Œä¸è¯­ä¹‰ç´§å¯†ç›¸å…³çš„å…³é”®è¯éœ€è¦äºˆä»¥æ›´å¤šçš„å…³æ³¨ï¼Œè€Œæ— å…³çš„è¿æ¥è¯å’Œè¾…åŠ©è¯åˆ™å¯ä»¥å¿½ç•¥ã€‚<br>åœ¨æœºå™¨ç¿»è¯‘æ—¶ï¼Œæ›´å¤šçš„æ³¨æ„è¡¨ç°ä¸ºæ›´å¤§çš„æƒé‡ï¼Œè¶Šé‡è¦çš„è¯æƒé‡è¶Šå¤§ã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/transformer/Self_Attention.webp" alt="Self Attention"></p><p>åŒ…å«ä½ç½®ä¿¡æ¯çš„è¯å‘é‡$\alpha^i$ï¼ˆå¥å­çš„ç¬¬i+1ä¸ªè¯çš„è¯å‘é‡ï¼‰ä½œä¸ºSelf Attentionçš„è¾“å…¥ï¼Œåˆ†åˆ«ä¹˜ä»¥ä¸‰ä¸ªæƒé‡çŸ©é˜µ$W^Q$ã€$W^K$ã€$W^V$ï¼Œå¾—åˆ°ï¼š</p><ul><li>$q^i$ï¼šQueryï¼ŒæŸ¥è¯¢å‘é‡</li><li>$k^i$ï¼šKeyï¼Œé”®å‘é‡ï¼Œâ€œè¢«æŸ¥â€æ—¶çš„å‘é‡</li><li>$v^i$ï¼šValueï¼Œå€¼å‘é‡ï¼Œâ€œå†…å®¹â€çš„å‘é‡</li></ul><p>ä»¥4ä¸ªå­—çš„å¥å­â€œæˆ‘æ˜¯å­¦ç”Ÿâ€ä¸ºä¾‹ï¼Œè®¡ç®—ç¬¬0ä¸ªå­—â€œæˆ‘â€çš„Self Attentionï¼š</p><ol><li>è®¡ç®— $q^0$ å’Œ $k^0,k^1,k^2,k^3$ çš„ç‚¹ç§¯ï¼Œå¾—åˆ°4ä¸ªæ³¨æ„åŠ›å€¼ $\alpha_{00},\alpha_{01},\alpha_{02},\alpha_{03}$</li></ol><ul><li>ç»è¿‡Softmaxå½’ä¸€åŒ–ï¼Œå¾—åˆ°4ä¸ªæ³¨æ„åŠ›åˆ†æ•° $\hat{\alpha_{00}},\hat{\alpha_{01}},\hat{\alpha_{02}},\hat{\alpha_{03}}$ ï¼Œå®ƒä»¬çš„å’Œä¸º1</li><li>å°†è¿™äº›åˆ†æ•°ä½œä¸ºæƒé‡ï¼Œå¯¹ $v^0,v^1,v^2,v^3$ è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°Self Attentionçš„è¾“å‡º</li><li>$b^0=\hat{\alpha_{00}}v^0+\hat{\alpha_{01}}v^1+\hat{\alpha_{02}}v^2+\hat{\alpha_{03}}v^3$</li></ul><p>ä¸ºäº†åŠ é€Ÿè®¡ç®—ï¼Œå¯ä»¥ä½¿ç”¨çŸ©é˜µè¿ç®—ï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/transformer/Self_Attention_Matrix.png" alt="Self AttentionçŸ©é˜µè¿ç®—"></p><ul><li>å…¶ä¸­$\alpha_{ij}=\dfrac{q_i * k_j^T}{\sqrt{d_k}}$ï¼Œ$d_k$æ˜¯è¯å‘é‡çš„ç»´åº¦<ul><li>ä¸ºä»€ä¹ˆè¦é™¤ä»¥$\sqrt{d_k}$ï¼Ÿå› ä¸ºå½“$d_k$å¾ˆå¤§æ—¶ï¼Œç‚¹ç§¯çš„å€¼ä¼šå¾ˆå¤§ï¼Œå¯¼è‡´Softmaxå‡½æ•°çš„æ¢¯åº¦æ¶ˆå¤±ï¼Œå½±å“æ¨¡å‹çš„è®­ç»ƒã€‚</li></ul></li><li>æœ€åè®¡ç®—$b^i=\sum_{j=0}^{n-1}\hat{\alpha_{ij}}v_j$</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ScaledDotProductAttention</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, scale_factor, dropout=<span class="number">0.0</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.scale_factor = scale_factor <span class="comment"># ç¼©æ”¾å› å­</span></span><br><span class="line">        <span class="comment"># Dropoutç”¨äºé˜²æ­¢è¿‡æ‹Ÿåˆ</span></span><br><span class="line">        self.dropout = nn.Dropout(dropout)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, Q, K, V, mask=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å‰å‘ä¼ æ’­</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        batch_size: æ‰¹å¤§å°</span></span><br><span class="line"><span class="string">        num_heads: å¤šå¤´æ³¨æ„åŠ›çš„å¤´æ•°ï¼Œè®ºæ–‡é»˜è®¤ä¸º8</span></span><br><span class="line"><span class="string">        seq_len: åºåˆ—é•¿åº¦</span></span><br><span class="line"><span class="string">        d_k, d_v: é”®å’Œå€¼çš„ç»´åº¦ï¼Œé»˜è®¤éƒ½æ˜¯64</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            Q: æŸ¥è¯¢å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, num_heads, seq_len, d_k)</span></span><br><span class="line"><span class="string">            K: é”®å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, num_heads, seq_len, d_k)</span></span><br><span class="line"><span class="string">            V: å€¼å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, num_heads, seq_len, d_v)</span></span><br><span class="line"><span class="string">            mask: æ©ç å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, seq_len, seq_len)ï¼Œé»˜è®¤ä¸ºNone</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            ä¸Šä¸‹æ–‡å¼ é‡å’Œæ³¨æ„åŠ›å¼ é‡</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        attn = torch.matmul(Q / self.scale_factor, K.transpose(<span class="number">2</span>, <span class="number">3</span>)) <span class="comment"># Kçš„ç¬¬2å’Œç¬¬3ç»´è½¬ç½®</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># if mask is not None:</span></span><br><span class="line">        <span class="comment">#     scores = scores.masked_fill(mask == 0, -1e9)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Softmaxè®¡ç®—æ³¨æ„åŠ›æƒé‡ï¼ŒDropoutå‡å°‘è¿‡æ‹Ÿåˆ</span></span><br><span class="line">        attn = self.dropout(torch.softmax(attn, dim=-<span class="number">1</span>))</span><br><span class="line">        output = torch.matmul(attn, V)</span><br><span class="line">        <span class="keyword">return</span> output, attn <span class="comment"># è¿”å›ä¸Šä¸‹æ–‡å¼ é‡å’Œæ³¨æ„åŠ›å¼ é‡</span></span><br></pre></td></tr></table></figure><h3 id="1-4-Multi-Head-Attention-å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶">1.4 Multi-Head Attention å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶</h3><p>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶å°±æ˜¯æŠŠ$q^i, k^i, v^i$ä¸‰ä¸ªçŸ©é˜µä»ç‰¹å¾ç»´åº¦ï¼ˆè¯å‘é‡é•¿åº¦ï¼‰æ–¹å‘ä¸Šæ‹†åˆ†æˆä¸ºå½¢çŠ¶ç›¸åŒçš„å°çŸ©é˜µã€‚<br>å†å°†æ¯ä¸ªHead Attentionçš„è¾“å‡ºæ‹¼æ¥èµ·æ¥ï¼Œå¾—åˆ°æœ€ç»ˆçš„Multi-Head Attentionè¾“å‡ºã€‚</p><p>ç†è§£ï¼šå¤šä¸ªå¤´åˆ†åˆ«å…³æ³¨ä¸åŒçš„ç‰¹å¾å­ç©ºé—´ï¼Œæœ€åå†å°†è¿™äº›å­ç©ºé—´çš„ä¿¡æ¯èåˆèµ·æ¥ã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/transformer/Multi_Head_Attention.webp" alt="Multi-Head Attention"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MultiHeadAttention</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, n_head=<span class="number">8</span>, d_model=<span class="number">512</span>, d_k=<span class="number">64</span>, d_v=<span class="number">64</span>, droupout=<span class="number">0.1</span></span>):</span><br><span class="line">        <span class="comment"># è®ºæ–‡ä¸­ï¼Œå‚æ•°åˆ†åˆ«ä¸ºï¼š8ã€512ã€64ã€64</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        self.n_head = n_head</span><br><span class="line">        self.d_k = d_k</span><br><span class="line">        self.d_v = d_v</span><br><span class="line"></span><br><span class="line">        self.w_qs = nn.Linear(d_model, n_head * d_k, bias=<span class="literal">False</span>)</span><br><span class="line">        self.w_ks = nn.Linear(d_model, n_head * d_k, bias=<span class="literal">False</span>)</span><br><span class="line">        self.w_vs = nn.Linear(d_model, n_head * d_v, bias=<span class="literal">False</span>)</span><br><span class="line">        self.fc = nn.Linear(n_head * d_v, d_model, bias=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        self.attention = ScaledDotProductAttention(scale_factor=d_k ** <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">        self.dropout = nn.Dropout(droupout)</span><br><span class="line">        self.layer_norm = nn.LayerNorm(d_model, eps=<span class="number">1e-6</span>) <span class="comment"># LayerNormå±‚ï¼Œç”¨äºå½’ä¸€åŒ–</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, Q, K, V, mask=<span class="literal">None</span></span>):</span><br><span class="line">        d_k, d_v, n_head = self.d_k, self.d_v, self.n_head</span><br><span class="line">        batch_size, len_q, len_k, len_v = Q.size(<span class="number">0</span>), Q.size(<span class="number">1</span>), K.size(<span class="number">1</span>), V.size(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        residual = Q <span class="comment"># ä¿ç•™è¾“å…¥ç”¨ä½œæ®‹å·®è¿æ¥</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†Qã€Kã€Vå½’ä¸€åŒ–åï¼Œåˆ†åˆ«é€šè¿‡çº¿æ€§æ˜ å°„åˆ°å¤šå¤´</span></span><br><span class="line">        <span class="comment"># Q: (batch_size, len_q, d_model) -&gt; (batch_size, len_q, n_head * d_k) -&gt; (batch_size, n_head, len_q, d_k)</span></span><br><span class="line">        <span class="comment"># Qï¼š(batch_size, len_q, 512) -&gt; (batch_size, len_q, 8*64) -&gt; (batch_size, len_q, 8, 64)</span></span><br><span class="line">        Q = self.layer_norm(Q)</span><br><span class="line">        K = self.layer_norm(K)</span><br><span class="line">        V = self.layer_norm(V)</span><br><span class="line">        Q = self.w_qs(Q).view(batch_size, len_q, n_head, d_k)</span><br><span class="line">        K = self.w_ks(K).view(batch_size, len_k, n_head, d_k)</span><br><span class="line">        V = self.w_vs(V).view(batch_size, len_v, n_head, d_v)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è½¬ç½®ï¼Œä½¿å¾—ç¬¬1å’Œç¬¬2ç»´äº¤æ¢ä½ç½®ï¼Œè¿›è¡ŒAttentionè®¡ç®—</span></span><br><span class="line">        <span class="comment"># Q: (batch_size, len_q, n_head, d_k) -&gt; (batch_size, n_head, len_q, d_k)</span></span><br><span class="line">        <span class="comment"># Qï¼š(batch_size, len_q, 8, 64) -&gt; (batch_size, 8, len_q, 64)</span></span><br><span class="line">        Q, K, V = Q.transpose(<span class="number">1</span>, <span class="number">2</span>), K.transpose(<span class="number">1</span>, <span class="number">2</span>), V.transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mask <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            mask = mask.unsqueeze(<span class="number">1</span>) <span class="comment"># å¢åŠ ä¸€ä¸ªHeadç»´åº¦</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Q=Softmax(Q*K/d + (1-S)Ïƒ)Vï¼Œattnæ˜¯QK/D</span></span><br><span class="line">        Q, attn = self.attention(Q, K, V, mask=mask) </span><br><span class="line"></span><br><span class="line">        <span class="comment"># Qçš„å½¢çŠ¶ï¼š[batch_size, n_head, len_q, d_v] [2,8,5,64]</span></span><br><span class="line">        Q = Q.transpose(<span class="number">1</span>, <span class="number">2</span>).contiguous().view(batch_size, len_q, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        Q = self.dropout(self.fc(Q))</span><br><span class="line"></span><br><span class="line">        Q += residual <span class="comment"># æ®‹å·®è¿æ¥Add</span></span><br><span class="line">        Q = self.layer_norm(Q) <span class="comment"># LayerNorm</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Q, attn</span><br></pre></td></tr></table></figure><h3 id="1-5-Add-Norm-æ®‹å·®è¿æ¥å’Œå±‚å½’ä¸€åŒ–">1.5 Add &amp; Norm æ®‹å·®è¿æ¥å’Œå±‚å½’ä¸€åŒ–</h3><p>Addæ®‹å·®é“¾æ¥å°±æ˜¯å°†ç½‘ç»œçš„è¾“å…¥å’Œè¾“å‡ºç›´æ¥ç›¸åŠ ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£å†³æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ã€‚</p><p>Layer Normalizationæ˜¯å¯¹ç½‘ç»œçš„è¾“å‡ºè¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼ŒåŠ é€Ÿè®­ç»ƒã€‚<br>ä½¿$b$çš„æ¯ä¸€è¡Œï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªå¥å­ï¼Œå½’ä¸€åŒ–ä¸ºæ ‡å‡†æ­£æ€åˆ†å¸ƒï¼Œè¾“å‡ºä¸º$\hat b$ï¼Œå½’ä¸€åŒ–å…¬å¼å¦‚ä¸‹ï¼š</p><ul><li>å‡å€¼ï¼š$\mu_i=\dfrac{1}{d}\sum_{j=1}^{d}b_{ij}$</li><li>æ–¹å·®ï¼š$\sigma_i^2=\dfrac{1}{d}\sum_{j=1}^{d}(b_{ij}-\mu_i)^2$</li><li>å½’ä¸€åŒ–ï¼š$\hat b_{ij}=\dfrac{b_{ij}-\mu_i}{\sqrt{\sigma_i^2+\epsilon}}*\gamma+\beta$</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LayerNorm</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, d_model, eps=<span class="number">1e-12</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(LayerNorm, self).__init__()</span><br><span class="line">        self.gamma = nn.Parameter(torch.ones(d_model))</span><br><span class="line">        self.beta = nn.Parameter(torch.zeros(d_model))</span><br><span class="line">        self.eps = eps <span class="comment"># é˜²æ­¢åˆ†æ¯ä¸º0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        mean = x.mean(-<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">        var = x.var(-<span class="number">1</span>, unbiased=<span class="literal">False</span>, keepdim=<span class="literal">True</span>) <span class="comment"># unbiased=Falseè¡¨ç¤ºæ–¹å·®è®¡ç®—éæ— åä¼°è®¡ï¼ˆé™¤ä»¥Nè€Œä¸æ˜¯N-1ï¼‰</span></span><br><span class="line"></span><br><span class="line">        out = (x - mean) / torch.sqrt(var + self.eps)</span><br><span class="line">        out = self.gamma * out + self.beta</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure><h3 id="1-6-Feed-Forward-å‰é¦ˆç¥ç»ç½‘ç»œ">1.6 Feed Forward å‰é¦ˆç¥ç»ç½‘ç»œ</h3><p>Add &amp; Normå±‚åæ¥ä¸€ä¸ªå…¨è¿æ¥çš„å‰é¦ˆç¥ç»ç½‘ç»œï¼Œç”¨äºå¯¹ç‰¹å¾è¿›è¡Œéçº¿æ€§å˜æ¢</p><p>å‰é¦ˆç¥ç»ç½‘ç»œçš„ç»“æ„æ˜¯ä¸¤ä¸ªå…¨è¿æ¥å±‚ï¼Œç¬¬ä¸€ä¸ªå…¨è¿æ¥å±‚çš„æ¿€æ´»å‡½æ•°æ˜¯ReLUï¼Œç¬¬äºŒä¸ªå…¨è¿æ¥å±‚æ²¡æœ‰æ¿€æ´»å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PositionwiseFeedForward</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(PositionwiseFeedForward, self).__init__()</span><br><span class="line">        self.fc = nn.Sequential(</span><br><span class="line">            nn.Linear(d_model, d_ff, bias=<span class="literal">False</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.Linear(d_ff, d_model, bias=<span class="literal">False</span>))</span><br><span class="line">        self.layer_norm = nn.LayerNorm(d_model, eps=<span class="number">1e-6</span>) <span class="comment"># LayerNormå±‚ï¼Œç”¨äºå½’ä¸€åŒ–</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, inputs</span>):</span><br><span class="line">        resdual = inputs</span><br><span class="line">        output = self.fc(inputs)</span><br><span class="line">        output = self.layer_norm(output + resdual)</span><br><span class="line">        <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure><h3 id="1-7-Maskæ‰-åœç”¨è¯">1.7 Maskæ‰ åœç”¨è¯</h3><p>å¥å­ä¸­æ²¡æœ‰æ„ä¹‰çš„å ä½ç¬¦ï¼Œä¾‹å¦‚â€œæˆ‘æ˜¯å­¦ç”ŸPâ€ä¸­çš„Pæ˜¯åœæ­¢ç¬¦ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ï¼Œéœ€è¦å°†å…¶maskæ‰ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_attn_pad_mask</span>(<span class="params">seq_q, seq_k</span>):</span><br><span class="line">    batch_size, len_q = seq_q.size()</span><br><span class="line">    batch_size, len_k = seq_k.size()</span><br><span class="line">    <span class="comment"># eq(zero)ç”¨äºåˆ¤æ–­ seq_k ä¸­å“ªäº›ä½ç½®æ˜¯å¡«å……ç¬¦ï¼ˆé€šå¸¸å¡«å……ç¬¦çš„å€¼æ˜¯ 0ï¼‰ï¼Œè¿”å›ä¸€ä¸ªByteTensor</span></span><br><span class="line">    pad_attn_mask = seq_k.data.eq(<span class="number">0</span>).unsqueeze(<span class="number">1</span>)  <span class="comment"># (N, 1, len_k)</span></span><br><span class="line">    <span class="keyword">return</span> pad_attn_mask.expand(batch_size, len_q, len_k)  <span class="comment"># (N, len_q, len_k)</span></span><br></pre></td></tr></table></figure><h3 id="1-8-EncoderLayer">1.8 EncoderLayer</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EncoderLayer</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(EncoderLayer, self).__init__()</span><br><span class="line">        self.enc_self_attn = MultiHeadAttention() <span class="comment"># å¤šå¤´è‡ªæ³¨æ„åŠ›</span></span><br><span class="line">        self.pos_ffn = PositionwiseFeedForward() <span class="comment"># å‰é¦ˆç¥ç»ç½‘ç»œ</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, enc_inputs, enc_self_attn_mask</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å‰å‘ä¼ æ’­</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            enc_inputs: ç¼–ç å™¨è¾“å…¥å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, seq_len, d_model)</span></span><br><span class="line"><span class="string">            enc_self_attn_mask: ç¼–ç å™¨è‡ªæ³¨æ„åŠ›æ©ç ï¼Œå½¢çŠ¶ä¸º(batch_size, seq_len, seq_len)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            ç¼–ç å™¨è¾“å‡ºå¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, seq_len, d_model)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        enc_outputs, attn = self.enc_self_attn(enc_inputs, enc_inputs, enc_inputs, enc_self_attn_mask)</span><br><span class="line">        enc_outputs = self.pos_ffn(enc_outputs)</span><br><span class="line">        <span class="keyword">return</span> enc_outputs, attn</span><br></pre></td></tr></table></figure><h3 id="1-9-Encoder">1.9 Encoder</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Encoder</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(Encoder, self).__init__()</span><br><span class="line"></span><br><span class="line">        self.src_emb = Embeddings(src_vocab_size, d_model)</span><br><span class="line">        self.pos_emb = PositionalEncoding(d_model)</span><br><span class="line">        self.layers = nn.ModuleList([EncoderLayer() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n_layers)])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, enc_inputs</span>):</span><br><span class="line">        <span class="comment"># 1. ä¸­æ–‡å­—ç´¢å¼•è¿›è¡ŒEmbeddingï¼Œè½¬æ¢ä¸º512ç»´çš„è¯å‘é‡</span></span><br><span class="line">        enc_outputs = self.src_emb(enc_inputs)</span><br><span class="line">        <span class="comment"># 2. åŠ ä¸Šä½ç½®ç¼–ç </span></span><br><span class="line">        enc_outputs = self.pos_emb(enc_outputs)</span><br><span class="line">        <span class="comment"># 3. maskæ‰paddingéƒ¨åˆ†</span></span><br><span class="line">        enc_self_attn_mask = get_attn_pad_mask(enc_inputs, enc_inputs)</span><br><span class="line">        enc_self_attns = []</span><br><span class="line">        <span class="comment"># 4. é€šè¿‡6å±‚EncoderLayerï¼Œä¸Šä¸€å±‚çš„è¾“å‡ºä½œä¸ºä¸‹ä¸€å±‚çš„è¾“å…¥</span></span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> self.layers:</span><br><span class="line">            enc_outputs, enc_self_attn = layer(enc_outputs, enc_self_attn_mask)</span><br><span class="line">            enc_self_attns.append(enc_self_attn)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> enc_outputs, enc_self_attns</span><br></pre></td></tr></table></figure><h2 id="2-Decoder">2.Decoder</h2><p>Masked Multi-Head Attentionï¼šä¸MultiHead Attentionç±»ä¼¼ï¼Œåªæ˜¯åœ¨è®¡ç®—Self Attentionæ—¶ï¼Œéœ€è¦maskæ‰æœªæ¥çš„ä¿¡æ¯</p><p>Multi-Head Attentionï¼šä¸Encoderä¸­çš„MultiHead Attentionç›¸åŒ</p><p>Decoderçš„è¾“å‡ºé¢„æµ‹ï¼šDecoderè¾“å‡ºçŸ©é˜µå½¢çŠ¶æ˜¯[seq_len, word_dim]ï¼Œç»è¿‡nn.Linearå…¨è¿æ¥å±‚ï¼Œå†é€šè¿‡softmaxå‡½æ•°å¾—åˆ°æ¯ä¸ªè¯çš„æ¦‚ç‡ï¼Œç„¶åé€‰æ‹©æ¦‚ç‡æœ€å¤§çš„è¯ä½œä¸ºé¢„æµ‹ç»“æœã€‚</p><h3 id="2-1-Decoder-Input-è¾“å…¥å¤„ç†">2.1 Decoder Input è¾“å…¥å¤„ç†</h3><p>Decoderçš„è¾“å…¥æ˜¯æœ€åä¸€ä¸ªEncoderçš„è¾“å‡ºï¼Œåœ¨è®­ç»ƒæ—¶ï¼ŒåŒæ—¶è¾“å…¥ç›®æ ‡å¥å­çš„è¯å‘é‡ï¼Œä»¥ä¾¿è®¡ç®—Lossã€‚</p><p>â€œæˆ‘æ˜¯å­¦ç”ŸEâ€-&gt;â€œS I am a studentâ€</p><ul><li>T0æ—¶åˆ»ï¼šè¾“å…¥å¼€å§‹ç¬¦â€œSâ€ï¼Œè¾“å‡ºé¢„æµ‹çš„ç¬¬ä¸€ä¸ªè¯â€œIâ€</li><li>T1æ—¶åˆ»ï¼šè¾“å…¥â€œS Iâ€ï¼Œè¾“å‡ºé¢„æµ‹çš„ç¬¬äºŒä¸ªè¯â€œamâ€</li><li>â€¦</li></ul><p>è¾“å…¥ä½¿ç”¨ä¸Šä¸‰è§’çŸ©é˜µè¿›è¡Œmaskï¼Œé¿å…Decoderçœ‹åˆ°æœªæ¥çš„ä¿¡æ¯ã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/papers/transformer/Input_Mask.webp" alt="Input Mask"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_attn_subsequent_mask</span>(<span class="params">seq</span>): <span class="comment"># seq: [batch_size, tgt_len]</span></span><br><span class="line">    attn_shape = [seq.size(<span class="number">0</span>), seq.size(<span class="number">1</span>), seq.size(<span class="number">1</span>)]</span><br><span class="line">    subsequent_mask = np.triu(np.ones(attn_shape), k=<span class="number">1</span>) <span class="comment"># è¿”å›ä¸Šä¸‰è§’çŸ©é˜µ</span></span><br><span class="line">    subsequent_mask = torch.from_numpy(subsequent_mask).byte() <span class="comment"># è½¬æ¢ä¸ºByteTensor</span></span><br><span class="line">    <span class="keyword">return</span> subsequent_mask</span><br></pre></td></tr></table></figure><h3 id="2-2-DecoderLayer">2.2 DecoderLayer</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DecoderLayer</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(DecoderLayer, self).__init__()</span><br><span class="line">        self.dec_self_attn = MultiHeadAttention()</span><br><span class="line">        self.dec_enc_attn = MultiHeadAttention() </span><br><span class="line">        self.pos_ffn = PositionwiseFeedForward()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, dec_inputs, enc_outputs, dec_self_attn_mask, dec_enc_attn_mask</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å‰å‘ä¼ æ’­</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            dec_inputs: è§£ç å™¨è¾“å…¥å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, tgt_len, d_model)</span></span><br><span class="line"><span class="string">            enc_outputs: ç¼–ç å™¨è¾“å‡ºå¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, seq_len, d_model)</span></span><br><span class="line"><span class="string">            dec_self_attn_mask: è§£ç å™¨è‡ªæ³¨æ„åŠ›æ©ç ï¼Œå½¢çŠ¶ä¸º(batch_size, tgt_len, tgt_len)</span></span><br><span class="line"><span class="string">            dec_enc_attn_mask: è§£ç å™¨-ç¼–ç å™¨æ³¨æ„åŠ›æ©ç ï¼Œå½¢çŠ¶ä¸º(batch_size, tgt_len, seq_len)</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            è§£ç å™¨è¾“å‡ºå¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, tgt_len, d_model)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        dec_outputs, dec_self_attn = self.dec_self_attn(dec_inputs, dec_inputs, dec_inputs, dec_self_attn_mask)</span><br><span class="line">        dec_outputs, dec_enc_attn = self.dec_enc_attn(dec_outputs, enc_outputs, enc_outputs, dec_enc_attn_mask)</span><br><span class="line">        dec_outputs = self.pos_ffn(dec_outputs)</span><br><span class="line">        <span class="keyword">return</span> dec_outputs, dec_self_attn, dec_enc_attn</span><br></pre></td></tr></table></figure><h3 id="2-3-Decoder">2.3 Decoder</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Decoder</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(Decoder, self).__init__()</span><br><span class="line">        </span><br><span class="line">        self.tgt_emb = Embeddings(tgt_vocab_size, d_model)</span><br><span class="line">        self.pos_emb = PositionalEncoding(d_model)</span><br><span class="line">        self.layers = nn.ModuleList([DecoderLayer() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n_layers)])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, dec_inputs, enc_inputs, enc_outputs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å‰å‘ä¼ æ’­</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            dec_inputs: è§£ç å™¨è¾“å…¥å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, tgt_len)</span></span><br><span class="line"><span class="string">            enc_inputs: ç¼–ç å™¨è¾“å…¥å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, seq_len)</span></span><br><span class="line"><span class="string">            enc_outputs: ç¼–ç å™¨è¾“å‡ºå¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, seq_len, d_model)</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            è§£ç å™¨è¾“å‡ºå¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, tgt_len, d_model)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è‹±æ–‡å­—ç´¢å¼•è¿›è¡ŒEmbeddingï¼Œè½¬æ¢ä¸º512ç»´çš„è¯å‘é‡ï¼ŒåŠ ä¸Šä½ç½®ç¼–ç </span></span><br><span class="line">        dec_outputs = self.tgt_emb(dec_inputs)</span><br><span class="line">        dec_outputs = self.pos_emb(dec_outputs)</span><br><span class="line">        <span class="comment"># maskæ‰paddingéƒ¨åˆ†</span></span><br><span class="line">        dec_self_attn_pad_mask = get_attn_pad_mask(dec_inputs, dec_inputs)</span><br><span class="line">        dec_self_attn_subsequent_mask = get_attn_subsequent_mask(dec_inputs)</span><br><span class="line">        dec_self_attn_mask = torch.gt((dec_self_attn_pad_mask + dec_self_attn_subsequent_mask), <span class="number">0</span>)</span><br><span class="line">        dec_enc_attn_mask = get_attn_pad_mask(dec_inputs, enc_inputs)</span><br><span class="line">        dec_self_attns, dec_enc_attns = [], []</span><br><span class="line">        <span class="comment"># é€šè¿‡6å±‚DecoderLayerï¼Œä¸Šä¸€å±‚çš„è¾“å‡ºä½œä¸ºä¸‹ä¸€å±‚çš„è¾“å…¥</span></span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> self.layers:</span><br><span class="line">            dec_outputs, dec_self_attn, dec_enc_attn = layer(dec_outputs, enc_outputs, dec_self_attn_mask, dec_enc_attn_mask)</span><br><span class="line">            dec_self_attns.append(dec_self_attn)</span><br><span class="line">            dec_enc_attns.append(dec_enc_attn)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> dec_outputs, dec_self_attns, dec_enc_attns</span><br></pre></td></tr></table></figure><h2 id="3-Transformerä»£ç å®ç°">3. Transformerä»£ç å®ç°</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Transformer</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(Transformer, self).__init__()</span><br><span class="line">        self.encoder = Encoder()</span><br><span class="line">        self.decoder = Decoder()</span><br><span class="line">        <span class="comment"># è§£ç å™¨æœ€åçš„åˆ†ç±»å™¨ï¼Œåˆ†ç±»å™¨çš„è¾“å…¥d_modelæ˜¯è§£ç å±‚æ¯ä¸ªtokençš„è¾“å‡ºç»´åº¦å¤§å°</span></span><br><span class="line">        <span class="comment"># éœ€è¦å°†å…¶è½¬ä¸ºè¯è¡¨å¤§å°ï¼Œå†è®¡ç®—softmaxï¼›è®¡ç®—å“ªä¸ªè¯å‡ºç°çš„æ¦‚ç‡æœ€å¤§</span></span><br><span class="line">        self.projection = nn.Linear(d_model, tgt_vocab_size, bias=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, enc_inputs, dec_inputs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å‰å‘ä¼ æ’­</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            enc_inputs: ç¼–ç å™¨è¾“å…¥å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, seq_len)</span></span><br><span class="line"><span class="string">            dec_inputs: è§£ç å™¨è¾“å…¥å¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size, tgt_len)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            è§£ç å™¨è¾“å‡ºå¼ é‡ï¼Œå½¢çŠ¶ä¸º(batch_size * tgt_len, tgt_vocab_size)</span></span><br><span class="line"><span class="string">            enc_self_attns: ç¼–ç å™¨è‡ªæ³¨æ„åŠ›å¼ é‡åˆ—è¡¨</span></span><br><span class="line"><span class="string">            dec_self_attns: è§£ç å™¨è‡ªæ³¨æ„åŠ›å¼ é‡åˆ—è¡¨</span></span><br><span class="line"><span class="string">            dec_enc_attns: è§£ç å™¨-ç¼–ç å™¨æ³¨æ„åŠ›å¼ é‡åˆ—è¡¨</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        enc_outputs, enc_self_attns = self.encoder(enc_inputs)</span><br><span class="line"></span><br><span class="line">        dec_outputs, dec_self_attns, dec_enc_attns = self.decoder(dec_inputs, enc_inputs, enc_outputs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># dec_logits : [batch_size x src_vocab_size x tgt_vocab_size]</span></span><br><span class="line">        dec_logits = self.projection(dec_outputs) </span><br><span class="line">        <span class="keyword">return</span> dec_logits.view(-<span class="number">1</span>, dec_logits.size(-<span class="number">1</span>)), enc_self_attns, dec_self_attns, dec_enc_attns</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="4-Transformeræ¨¡å‹è®­ç»ƒ">4. Transformeræ¨¡å‹è®­ç»ƒ</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¨¡å‹è®­ç»ƒ</span></span><br><span class="line">model = Transformer()</span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">optimizer = torch.optim.Adam(model.parameters(), lr=<span class="number">0.001</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯å…¸</span></span><br><span class="line">word2idx = &#123;</span><br><span class="line">    <span class="string">&quot;S&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;æˆ‘&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;æ˜¯&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;å­¦&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">&quot;ç”Ÿ&quot;</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="string">&quot;I&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="string">&quot;am&quot;</span>: <span class="number">6</span>,</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: <span class="number">7</span>,</span><br><span class="line">    <span class="string">&quot;student&quot;</span>: <span class="number">8</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">idx2word = &#123;i: w <span class="keyword">for</span> w, i <span class="keyword">in</span> word2idx.items()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å…¥æ•°æ®</span></span><br><span class="line">enc_inputs = torch.LongTensor([[word2idx[w] <span class="keyword">for</span> w <span class="keyword">in</span> [<span class="string">&quot;æˆ‘&quot;</span>, <span class="string">&quot;æ˜¯&quot;</span>, <span class="string">&quot;å­¦&quot;</span>, <span class="string">&quot;ç”Ÿ&quot;</span>, <span class="string">&quot;S&quot;</span>]]])</span><br><span class="line">dec_inputs = torch.LongTensor([[word2idx[w] <span class="keyword">for</span> w <span class="keyword">in</span> [<span class="string">&quot;S&quot;</span>, <span class="string">&quot;I&quot;</span>, <span class="string">&quot;am&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;student&quot;</span>]]])</span><br><span class="line">target_batch = torch.LongTensor([[word2idx[w] <span class="keyword">for</span> w <span class="keyword">in</span> [<span class="string">&quot;S&quot;</span>, <span class="string">&quot;I&quot;</span>, <span class="string">&quot;am&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;student&quot;</span>]]])</span><br><span class="line"><span class="built_in">print</span>(enc_inputs, dec_inputs, target_batch)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡å‹è®­ç»ƒ</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    optimizer.zero_grad()</span><br><span class="line">    outputs, enc_self_attns, dec_self_attns, dec_enc_attns = model(enc_inputs, dec_inputs)</span><br><span class="line">    loss = criterion(outputs, target_batch.view(-<span class="number">1</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Epoch:&#x27;</span>, <span class="string">&#x27;%04d&#x27;</span> % (epoch + <span class="number">1</span>), <span class="string">&#x27;cost =&#x27;</span>, <span class="string">&#x27;&#123;:.6f&#125;&#x27;</span>.<span class="built_in">format</span>(loss))</span><br><span class="line">    loss.backward()</span><br><span class="line">    optimizer.step()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡å‹é¢„æµ‹</span></span><br><span class="line">predict, _, _, _ = model(enc_inputs, dec_inputs)</span><br><span class="line">predict = predict.data.<span class="built_in">max</span>(<span class="number">1</span>, keepdim=<span class="literal">True</span>)[<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(enc_inputs, <span class="string">&#x27;-&gt;&#x27;</span>, [idx2word[n.item()] <span class="keyword">for</span> n <span class="keyword">in</span> predict.squeeze()])</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><code>tensor([[1, 2, 3, 4, 0]]) tensor([[0, 5, 6, 7, 8]]) tensor([[0, 5, 6, 7, 8]])Epoch: 0001 cost = 2.244576Epoch: 0002 cost = 0.970345Epoch: 0003 cost = 2.741649Epoch: 0004 cost = 3.185768Epoch: 0005 cost = 4.521887Epoch: 0006 cost = 3.544580Epoch: 0007 cost = 3.160498Epoch: 0008 cost = 2.823286Epoch: 0009 cost = 0.625107Epoch: 0010 cost = 0.672708Epoch: 0011 cost = 0.561514Epoch: 0012 cost = 0.959138Epoch: 0013 cost = 0.673696Epoch: 0014 cost = 0.326180Epoch: 0015 cost = 0.268545Epoch: 0016 cost = 0.215698Epoch: 0017 cost = 0.168979Epoch: 0018 cost = 0.057510Epoch: 0019 cost = 0.087601Epoch: 0020 cost = 0.056923tensor([[1, 2, 3, 4, 0]]) -&gt; ['S', 'I', 'am', 'a', 'student']</code></pre>]]></content>
    
    
    <summary type="html">å®ç°ä¸æµ‹è¯•Transformeræ¨¡å‹</summary>
    
    
    
    <category term="DLç¬”è®°" scheme="https://www.cclmsy.cc/categories/DL%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="https://www.cclmsy.cc/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="Pytorch" scheme="https://www.cclmsy.cc/tags/Pytorch/"/>
    
    <category term="è®ºæ–‡å¤ç°" scheme="https://www.cclmsy.cc/tags/%E8%AE%BA%E6%96%87%E5%A4%8D%E7%8E%B0/"/>
    
  </entry>
  
  <entry>
    <title>æ·±åº¦å­¦ä¹ ç¬”è®°4-å¾ªç¯ç¥ç»ç½‘ç»œRNN</title>
    <link href="https://www.cclmsy.cc/posts/deep_learning_4.html"/>
    <id>https://www.cclmsy.cc/posts/deep_learning_4.html</id>
    <published>2025-02-26T16:00:00.000Z</published>
    <updated>2025-08-12T00:19:26.816Z</updated>
    
    <content type="html"><![CDATA[<h2 id="4-1-å¾ªç¯ç¥ç»ç½‘ç»œ">4.1 å¾ªç¯ç¥ç»ç½‘ç»œ</h2><h3 id="4-1-1-åºåˆ—æ¨¡å‹">4.1.1 åºåˆ—æ¨¡å‹</h3><p>åºåˆ—æ¨¡å‹ï¼šè‡ªç„¶è¯­è¨€ã€éŸ³é¢‘ã€è§†é¢‘ç­‰åºåˆ—æ•°æ®çš„æ¨¡å‹</p><ul><li>åº”ç”¨ï¼šè¯­éŸ³è¯†åˆ«ã€æƒ…æ„Ÿåˆ†ç±»ã€æœºå™¨ç¿»è¯‘ç­‰</li></ul><p>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨CNNï¼Ÿ</p><ul><li>åºåˆ—æ•°æ®çš„å‰åä¹‹é—´å…·æœ‰å¼ºå…³è”æ€§</li><li>è¾“å…¥è¾“å‡ºé•¿åº¦ä¸å›ºå®š</li></ul><h3 id="4-1-2-å¾ªç¯ç¥ç»ç½‘ç»œ">4.1.2 å¾ªç¯ç¥ç»ç½‘ç»œ</h3><p>å¾ªç¯ï¼ˆé€’å½’ï¼‰ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Networkï¼ŒRNNï¼‰æ˜¯ç¥ç»ç½‘ç»œçš„ä¸€ç§ï¼Œå°†â€œçŠ¶æ€â€åœ¨è‡ªèº«ç½‘ç»œä¸­å¾ªç¯ä¼ é€’ï¼Œå¯ä»¥æ¥å—æ—¶é—´åºåˆ—ç»“æ„è¾“å…¥</p><h4 id="4-1-2-1-RNNç±»å‹">4.1.2.1 RNNç±»å‹</h4><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/RNN%E7%BB%93%E6%9E%84.png" alt="RNNç»“æ„"></p><ul><li>ä¸€å¯¹ä¸€ï¼šå›ºå®šè¾“å…¥åˆ°å›ºå®šè¾“å‡ºï¼Œå¦‚å›¾åƒåˆ†ç±»</li><li>ä¸€å¯¹å¤šï¼šå›ºå®šè¾“å…¥åˆ°åºåˆ—è¾“å‡ºï¼Œå¦‚å›¾åƒçš„æ–‡å­—æè¿°</li><li>å¤šå¯¹ä¸€ï¼šåºåˆ—è¾“å…¥åˆ°å›ºå®šè¾“å‡ºï¼Œå¦‚æƒ…æ„Ÿåˆ†ç±»</li><li>ï¼ˆå¼‚æ­¥ï¼‰å¤šå¯¹å¤šï¼šåºåˆ—è¾“å…¥åˆ°åºåˆ—è¾“å‡ºï¼Œå¦‚æœºå™¨ç¿»è¯‘ï¼Œç§°ä¸ºEncoder-Decoderï¼ˆç¼–ç -è§£ç ï¼‰ç»“æ„</li><li>åŒæ­¥å¤šå¯¹å¤šï¼šåŒæ­¥åºåˆ—åˆ°åŒæ­¥è¾“å‡ºï¼Œå¦‚æ–‡æœ¬ç”Ÿæˆã€è§†é¢‘å¸§åˆ†ç±»</li></ul><h4 id="4-1-2-2-åŸºç¡€å¾ªç¯ç¥ç»ç½‘ç»œ">4.1.2.2 åŸºç¡€å¾ªç¯ç¥ç»ç½‘ç»œ</h4><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E5%9F%BA%E7%A1%80RNN%E7%BB%93%E6%9E%84.png" alt="åŸºç¡€RNNç»“æ„"></p><ul><li>$x_t$ï¼štæ—¶åˆ»çš„è¾“å…¥</li><li>$o_t$ï¼štæ—¶åˆ»çš„è¾“å‡º</li><li>$s_t$ï¼štæ—¶åˆ»çš„éšå±‚è¾“å‡º</li><li>æ‰€æœ‰å•å…ƒçš„å‚æ•°$U, V, W$å…±äº«</li></ul><p>ç»Ÿä¸€å…¬å¼ï¼ˆ$f$é‡‡ç”¨TanH/RuLUï¼Œ$g$é‡‡ç”¨Softmax/Sigmoidï¼‰ï¼š</p><p>$$<br>\begin{split}<br>&amp; s_0 = 0 \\<br>&amp; s_t = f(Ux_t + Ws_{t-1}) \\<br>&amp; o_t = g(Vs_t)<br>\end{split}<br>$$</p><p>è¾“å‡ºçš„$o_t$å—å‰é¢æ—¶åˆ»çš„éšå±‚$s_{t-1}$å½±å“ï¼Œå³RNNå…·æœ‰è®°å¿†åŠŸèƒ½</p><h4 id="4-1-2-3-åºåˆ—ç”Ÿæˆæ¡ˆä¾‹">4.1.2.3 åºåˆ—ç”Ÿæˆæ¡ˆä¾‹</h4><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E5%BA%8F%E5%88%97%E4%BE%8B%E5%AD%90.png" alt="åºåˆ—ä¾‹å­"></p><ul><li>è¾“å…¥åˆ°ç½‘ç»œå½“ä¸­çš„æ˜¯ä¸€ä¸ªä¸ªçš„åˆ†è¯ç»“æœï¼Œæ¯ä¸€ä¸ªè¯çš„è¾“å…¥æ˜¯ä¸€ä¸ªæ—¶åˆ»</li><li>æ¯ä¸€ä¸ªæ—¶åˆ»æœ‰ä¸€ä¸ªè¾“å‡ºï¼Œè¡¨ç¤ºæœ€å¯èƒ½çš„ä¸‹ä¸€ä¸ªè¯</li></ul><h4 id="4-1-2-4-è¯çš„è¡¨ç¤º">4.1.2.4 è¯çš„è¡¨ç¤º</h4><p>ä¸ºäº†èƒ½å¤Ÿè®©ç½‘ç»œç†è§£è¾“å…¥ï¼Œéœ€è¦å°†è¯è¿›è¡Œå‘é‡è¡¨ç¤ºã€‚</p><ul><li>å»ºç«‹ä¸€ä¸ªåŒ…å«æ‰€æœ‰åºåˆ—è¯çš„è¯å…¸ï¼Œæ¯ä¸ªè¯åœ¨è¯å…¸ä¸­æœ‰å”¯ä¸€ç¼–å·</li><li>è®°è¯å…¸å¤§å°ä¸º$N$ï¼Œä»»æ„ä¸€ä¸ªè¯éƒ½å¯ä»¥ç”¨ä¸€ä¸ª$N$ç»´çš„One-Hotå‘é‡è¡¨ç¤º</li><li>å¾—åˆ°ä¸€ä¸ªé«˜ç»´ç¨€ç–çŸ©é˜µ</li></ul><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E8%AF%8D%E5%90%91%E9%87%8F%E8%A1%A8%E7%A4%BA.png" alt="è¯å‘é‡è¡¨ç¤º"></p><h4 id="4-1-2-4-è¾“å‡ºçš„è¡¨ç¤º-Softmax">4.1.2.4 è¾“å‡ºçš„è¡¨ç¤º-Softmax</h4><p>RNNè¿™ç§æ¨¡å‹ï¼Œæ¯ä¸€ä¸ªæ—¶åˆ»çš„è¾“å‡ºæ˜¯ä¸‹ä¸€ä¸ªæœ€å¯èƒ½çš„è¯ï¼Œå¯ä»¥ç”¨æ¦‚ç‡è¡¨ç¤ºï¼Œæ€»é•¿åº¦ä¸ºè¯çš„æ€»æ•°é•¿åº¦</p><ul><li>æ¯ä¸ªæ—¶åˆ»çš„éšå±‚è¾“å‡º$s_t$ç»è¿‡Softmaxå‡½æ•°ï¼Œå¾—åˆ°æ¦‚ç‡åˆ†å¸ƒ</li></ul><h4 id="4-1-2-5-äº¤å‰ç†µæŸå¤±">4.1.2.5 äº¤å‰ç†µæŸå¤±</h4><p>æ€»æŸå¤±å®šä¹‰ï¼šä¸€æ•´ä¸ªåºåˆ—ï¼ˆä¸€ä¸ªå¥å­ï¼‰ä½œä¸ºä¸€ä¸ªè®­ç»ƒå®ä¾‹ï¼Œæ€»è¯¯å·®æ˜¯å„ä¸ªæ—¶åˆ»è¯¯å·®çš„å’Œ</p><p>$$<br>\begin{split}<br>&amp; E_t(y_t, \hat{y}_t) = -y_t \log(\hat{y}_t) \\<br>&amp; E(y, \hat{y}) = \sum_t E_t(y_t, \hat{y}_t) = -\sum_t y_t \log(\hat{y}_t)<br>\end{split}<br>$$</p><ul><li>$y_t$ï¼šæ—¶åˆ»tä¸Šæ­£ç¡®çš„è¾“å‡º</li><li>$\hat{y}_t$ï¼šæ—¶åˆ»tä¸Šé¢„æµ‹çš„è¾“å‡º</li></ul><h4 id="4-1-2-6-æ—¶åºåå‘ä¼ æ’­ç®—æ³•ï¼ˆBPTTï¼‰">4.1.2.6 æ—¶åºåå‘ä¼ æ’­ç®—æ³•ï¼ˆBPTTï¼‰</h4><p>Backpropagation Through Timeï¼Œæ—¶åºåå‘ä¼ æ’­ç®—æ³•ï¼šå¯¹äºRNNæœ‰ä¸€ä¸ªæ—¶é—´æ¦‚å¿µï¼Œéœ€è¦æŠŠæ¢¯åº¦æ²¿æ—¶é—´é€šé“è¿›è¡Œåå‘ä¼ æ’­</p><p>éœ€è¦æ›´æ–°çš„å‚æ•°ï¼š$U, V, W, b_x, b_y$</p><ul><li>è®¡ç®—æ¯ä¸ªæ—¶é—´çš„æ¢¯åº¦$dW_t$ï¼Œç›¸åŠ ä½œä¸ºæ¯æ¬¡$W$æ›´æ–°çš„æ¢¯åº¦å€¼</li><li>$s_t=tanh(Ux_t+Ws_{t-1}+b_x)$ï¼Œ$o_t=Softmax(Vs_t+b_y)$</li><li>åˆ©ç”¨é“¾å¼æ³•åˆ™ï¼Œè®¡ç®—å‡ºæ¯ä¸ªæ—¶é—´ä¸‹å„å‚æ•°çš„æ¢¯åº¦</li></ul><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/RNN%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD%E6%80%BB%E7%BB%93.png" alt="RNNåå‘ä¼ æ’­æ€»ç»“"></p><h4 id="4-1-2-7-æ¢¯åº¦æ¶ˆå¤±ä¸æ¢¯åº¦çˆ†ç‚¸">4.1.2.7 æ¢¯åº¦æ¶ˆå¤±ä¸æ¢¯åº¦çˆ†ç‚¸</h4><p>ç”±äºRNNä¸­ä¹Ÿå­˜åœ¨é“¾å¼æ±‚å¯¼æ³•åˆ™ï¼Œå› æ­¤ä¹Ÿä¼šå‘ç”Ÿæ¢¯åº¦æ¶ˆå¤±ä¸æ¢¯åº¦çˆ†ç‚¸çš„é—®é¢˜</p><h3 id="4-1-8-RNNæ”¹è¿›">4.1.8 RNNæ”¹è¿›</h3><p>é€šè¿‡é—¨æ§æœºåˆ¶æ§åˆ¶ä¿¡æ¯çš„æµåŠ¨</p><h4 id="4-1-8-1-é—¨æ§å¾ªç¯å•å…ƒGRU">4.1.8.1 é—¨æ§å¾ªç¯å•å…ƒGRU</h4><p>Gated Recurrent Unitï¼Œé—¨æ§å¾ªç¯å•å…ƒ</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/GRU%E5%8D%95%E5%85%83.png" alt="GRUå•å…ƒ"></p><p>GRUå¢åŠ äº†ä¸¤ä¸ªé—¨ï¼Œä¸€ä¸ªé‡ç½®é—¨ï¼ˆreset gateï¼‰å’Œä¸€ä¸ªæ›´æ–°é—¨ï¼ˆupdate gateï¼‰</p><ul><li>é‡ç½®é—¨ï¼šå†³å®šå¦‚ä½•å°†æ–°çš„è¾“å…¥å’Œå‰ä¸€æ—¶åˆ»çš„è¾“å‡ºç›¸ç»“åˆ</li><li>æ›´æ–°é—¨ï¼šå®šä¹‰å‰é¢çš„è®°å¿†ä¿å­˜åˆ°å½“å‰æ—¶é—´çš„é‡</li><li>é‡ç½®é—¨1ï¼Œæ›´æ–°é—¨0ï¼Œå³ä¸ºæ ‡å‡†RNNæ¨¡å‹</li></ul><p>GRUæœ¬è´¨è§£å†³çš„é—®é¢˜ï¼š</p><ul><li>è§£å†³çŸ­æœŸé—®é¢˜ï¼Œæ¯ä¸ªé€’å½’å•å…ƒèƒ½å¤Ÿè‡ªé€‚åº”æ•æ‰ä¸åŒå°ºåº¦çš„ä¾èµ–å…³ç³»</li><li>å¤„ç†äº†éšå±‚è¾“å‡ºï¼Œ$h_t=(1-z_t)<em>h_{t-1}+z_t</em>\tilde{h}_t$ï¼Œè§£å†³äº†æ¢¯åº¦æ¶ˆå¤±é—®é¢˜</li></ul><h4 id="4-1-8-2-é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œLSTM">4.1.8.2 é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œLSTM</h4><p>Long Short Term Memoryï¼Œé•¿çŸ­è®°å¿†ç½‘ç»œ</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/LSTM.png" alt="LSTM"></p><ul><li>$h_t$ï¼šå½“å‰cellçš„è¾“å‡º</li><li>$c_t$ï¼šéšå±‚çš„è®°å¿†</li><li>ä¸‰ä¸ªé—¨ï¼šé—å¿˜é—¨fï¼Œè¾“å…¥é—¨uï¼Œè¾“å‡ºé—¨o</li></ul><p>ä½œç”¨ï¼šä¾¿äºè®°å¿†é•¿æ›´é•¿è·ç¦»çš„çŠ¶æ€</p><h2 id="4-2-è¯åµŒå…¥ä¸NLP">4.2 è¯åµŒå…¥ä¸NLP</h2><h3 id="4-2-1-åœ¨RNNä¸­ä½¿ç”¨one-hotè¡¨ç¤ºçš„é—®é¢˜">4.2.1 åœ¨RNNä¸­ä½¿ç”¨one-hotè¡¨ç¤ºçš„é—®é¢˜</h3><ul><li>å‡è®¾æœ‰nä¸ªè¯ï¼Œæ¯ä¸ªè¯çš„one-hotè¡¨ç¤ºæ˜¯nç»´çš„ï¼Œæ•´ä½“å¤§å°ä¸º$n*n$ï¼Œéå¸¸ç¨€ç–</li><li>æ— æ³•è¡¨ç¤ºè¯ä¹‹é—´çš„ç›¸ä¼¼æ€§ï¼Œä¾‹å¦‚Appleå¯¹Bananaçš„ç›¸ä¼¼æ€§è¿œé«˜äºMonkey</li></ul><h3 id="4-2-2-è¯åµŒå…¥ï¼ˆWord-Embeddingï¼‰">4.2.2 è¯åµŒå…¥ï¼ˆWord Embeddingï¼‰</h3><p>æŠŠä¸€ä¸ªç»´æ•°ä¸º$N$çš„é«˜ç»´ç©ºé—´åµŒå…¥åˆ°ä¸€ä¸ªç»´æ•°ä½çš„å¤šçš„è¿ç»­å‘é‡ç©ºé—´ä¸­ï¼Œæ¯ä¸ªå•è¯æˆ–è¯ç»„è¢«æ˜ å°„ä¸ºå®æ•°åŸŸä¸Šçš„å‘é‡ï¼Œä¾‹å¦‚ï¼š</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">Man</th><th style="text-align:center">Woman</th><th style="text-align:center">King</th><th style="text-align:center">Queen</th><th style="text-align:center">Apple</th><th style="text-align:center">Banana</th></tr></thead><tbody><tr><td style="text-align:center">Gender</td><td style="text-align:center">1</td><td style="text-align:center">-1</td><td style="text-align:center">-0.95</td><td style="text-align:center">0.97</td><td style="text-align:center">0.01</td><td style="text-align:center">-0.02</td></tr><tr><td style="text-align:center">Royal</td><td style="text-align:center">0.01</td><td style="text-align:center">0.02</td><td style="text-align:center">0.98</td><td style="text-align:center">0.99</td><td style="text-align:center">-0.03</td><td style="text-align:center">0.04</td></tr><tr><td style="text-align:center">Age</td><td style="text-align:center">0.01</td><td style="text-align:center">0.02</td><td style="text-align:center">0.75</td><td style="text-align:center">0.69</td><td style="text-align:center">0.03</td><td style="text-align:center">-0.04</td></tr><tr><td style="text-align:center">Food</td><td style="text-align:center">0.01</td><td style="text-align:center">0.02</td><td style="text-align:center">-0.03</td><td style="text-align:center">0.04</td><td style="text-align:center">0.95</td><td style="text-align:center">0.97</td></tr></tbody></table><p>è¯åµŒå…¥çš„ç‰¹ç‚¹ï¼šèƒ½å¤Ÿä½“ç°è¯ä¸è¯ä¹‹é—´çš„å…³ç³»</p><p>Man-Womanâ‰ˆKing-?(Queen!)</p><p>ç®—æ³•/å·¥å…·ï¼šSkip-gramã€CBOWã€GenSim</p><h2 id="4-3-Seq2Seqä¸Attentionæœºåˆ¶">4.3 Seq2Seqä¸Attentionæœºåˆ¶</h2><h3 id="4-3-1-Seq2Seq">4.3.1 Seq2Seq</h3><p>Seq2Seqï¼šSequence to Sequenceï¼Œç”±Google Brainå›¢é˜Ÿå’ŒYoshua Bengio ä¸¤ä¸ªå›¢é˜Ÿå„è‡ªç‹¬ç«‹çš„æå‡ºæ¥</p><h4 id="4-3-1-1-å®šä¹‰">4.3.1.1 å®šä¹‰</h4><p>Seq2Seqæ¨¡å‹æ˜¯ä¸€ä¸ªEncoder-Decoderç»“æ„çš„æ¨¡å‹ï¼Œè¾“å…¥æ˜¯ä¸€ä¸ªåºåˆ—ï¼Œè¾“å‡ºä¹Ÿæ˜¯ä¸€ä¸ªåºåˆ—</p><p>Encoderä¸­å°†ä¸€ä¸ªå¯å˜é•¿åº¦çš„ä¿¡å·åºåˆ—å˜ä¸ºå›ºå®šé•¿åº¦çš„å‘é‡è¡¨è¾¾ï¼Œ<br>Decoderä¸­å°†è¿™ä¸ªå›ºå®šé•¿åº¦çš„å‘é‡è¡¨è¾¾å˜ä¸ºå¯å˜é•¿åº¦çš„ç›®æ ‡ä¿¡å·åºåˆ—</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/seq2seq.png" alt="seq2seq"></p><ul><li>ç›¸å½“äºæŠŠRNNæ¨¡å‹çš„$s_0$è¾“å…¥å˜æˆä¸€ä¸ªEncoder</li></ul><h4 id="4-3-1-2-æ¡ä»¶è¯­è¨€æ¨¡å‹">4.3.1.2 æ¡ä»¶è¯­è¨€æ¨¡å‹</h4><p>Encoderç¼–ç å™¨çš„ä½œç”¨ï¼š</p><ul><li>å°†ä¸€ä¸ªè¾¹é•¿è¾“å…¥åºåˆ—è¾“å‡ºåˆ°ä¸€ä¸ªç¼–ç çŠ¶æ€$C$</li><li>è§£ç å™¨è¾“å‡º$y_t$çš„æ¡ä»¶æ¦‚ç‡åŸºäºä¹‹å‰çš„è¾“å‡ºåºåˆ—$y_1y_2â€¦y_{t-1}$å’Œç¼–ç çŠ¶æ€$C$</li><li>$argmaxP(y_1,y_2,â€¦,y_T|x_1,x_2,â€¦,x_T)$ï¼Œç»™å®šè¾“å…¥çš„åºåˆ—ï¼Œæœ€å¤§åŒ–è¾“å‡ºåºåˆ—çš„æ¦‚ç‡</li></ul><p>æ ¹æ®æœ€å¤§ä¼¼ç„¶ä¼°è®¡ï¼Œæœ€å¤§åŒ–è¾“å‡ºåºåˆ—çš„æ¦‚ç‡</p><p>$$<br>\begin{split}<br>&amp; P(y_1,y_2,â€¦,y_T|x_1,x_2,â€¦,x_T) \\<br>&amp; = \prod_{t=1}^T P(y_t|y_1,y_2,â€¦,y_{t-1},x_1,x_2,â€¦,x_T) \\<br>&amp; = \prod_{t=1}^T P(y_t|y_1,y_2,â€¦,y_{t-1},C)<br>\end{split}<br>$$</p><p>è¿™ä¸ªå…¬å¼éœ€è¦æ±‚å‡º$P(y_1|C),P(y_2|y_1,C),â€¦,P(y_T|y_1,y_2,â€¦,y_{T-1},C)$ï¼Œæ¦‚ç‡è¿ä¹˜æå°ï¼Œä¸åˆ©äºå­˜å‚¨ï¼Œå› æ­¤å–å¯¹æ•°è¿›è¡Œè®¡ç®—ï¼Œè¿™æ ·å°±å°†è¿ä¹˜å¼è½¬æ¢ä¸ºç´¯åŠ å¼</p><p>$$<br>\log P(y_1,y_2,â€¦,y_T|x_1,x_2,â€¦,x_T) = \sum_{t=1}^T \log P(y_t|y_1,y_2,â€¦,y_{t-1},C)<br>$$</p><p>åº”ç”¨åœºæ™¯ï¼šæœºå™¨ç¿»è¯‘ï¼ˆNMTï¼‰</p><h3 id="4-3-2-Attentionæœºåˆ¶">4.3.2 Attentionæœºåˆ¶</h3><h4 id="4-3-2-1-é•¿å¥å­é—®é¢˜">4.3.2.1 é•¿å¥å­é—®é¢˜</h4><p>å¯¹äºé•¿å¥å­ï¼ŒSeq2Seqæ¨¡å‹çš„æ€§èƒ½ä¼šä¸‹é™ï¼Œæ— æ³•åšåˆ°å‡†ç¡®ç¿»è¯‘ã€‚<br>å¥å­éå¸¸é•¿æ—¶ï¼ŒBLEUï¼ˆBilingual Evaluation Understudyï¼‰è¯„ä»·å¾—åˆ†ä¼šå¾ˆä½</p><p>æœ¬è´¨åŸå› ï¼šåœ¨Encoder-Decoderç»“æ„ä¸­ï¼ŒEncoderæŠŠæ‰€æœ‰çš„è¾“å…¥åºåˆ—éƒ½ç¼–ç æˆä¸€ä¸ªç»Ÿä¸€çš„è¯­ä¹‰ç‰¹å¾$C$å†è§£ç ï¼Œ$C$ä¸­å¿…é¡»åŒ…å«åŸå§‹åºåˆ—ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå®ƒçš„é•¿åº¦å°±æˆäº†æ¨¡å‹æ€§èƒ½çš„ç“¶é¢ˆã€‚<br>å½“éœ€è¦ç¿»è¯‘çš„å¥å­å¾ˆé•¿æ—¶ï¼Œä¸€ä¸ª$C$å¯èƒ½å­˜ä¸ä¸‹é‚£ä¹ˆå¤šä¿¡æ¯ï¼Œå°±ä¼šé€ æˆç¿»è¯‘ç²¾åº¦çš„ä¸‹é™ã€‚</p><h4 id="4-3-2-2-Attentionæœºåˆ¶">4.3.2.2 Attentionæœºåˆ¶</h4><ul><li>æŠŠEncoderçš„æ‰€æœ‰éšå±‚è¾“å‡º$s_1,s_2,â€¦,s_T$éƒ½ä¿ç•™ä¸‹æ¥ï¼Œä¸å†åªä¿ç•™æœ€åä¸€ä¸ªéšå±‚è¾“å‡º$C$</li><li>å°†è¿™äº›ä¿¡æ¯æä¾›ç»™Decoder</li></ul><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/Attention%E6%9C%BA%E5%88%B6.png" alt="Attentionæœºåˆ¶"></p><h4 id="4-3-2-3-Attentionæœºåˆ¶çš„è®¡ç®—">4.3.2.3 Attentionæœºåˆ¶çš„è®¡ç®—</h4><p>å‡è®¾Encoderçš„æ—¶åˆ»ä¸º$t$ï¼ŒDecoderçš„æ—¶åˆ»ä¸º$tâ€™$</p><ol><li>$c_{tâ€™}=\sum_{t=1}^T \alpha_{tâ€™t}s_t$<ul><li>$\alpha_{tâ€™t}$ï¼šå‚æ•°ï¼Œè®­ç»ƒå¾—åˆ°ï¼Œè¡¨ç¤ºDecoderçš„$tâ€™$æ—¶åˆ»å¯¹Encoderçš„$t$æ—¶åˆ»çš„æ³¨æ„åŠ›æƒé‡</li><li>ç†è§£ï¼šEncoderçš„æ¯ä¸ªæ—¶åˆ»åŠ æƒæ±‚å’Œï¼Œå¾—åˆ°Decoderçš„$tâ€™$æ—¶åˆ»çš„è¾“å…¥</li><li>$c_4=\alpha_{41}s_1+\alpha_{42}s_2+â€¦+\alpha_{4T}s_T$</li></ul></li><li>$\alpha_{tâ€™t}$çš„$N$ä¸ªæƒé‡ç³»æ•°çš„ç”±æ¥<ul><li>æƒé‡ç³»æ•°é€šè¿‡Softmaxå‡½æ•°å¾—åˆ°ï¼Œ$\alpha_{tâ€™t}=\frac{exp(e_{tâ€™t})}{\sum_{k=1}^T exp(e_{tâ€™k})}$</li><li>$e_{tâ€™t}=g(s_{tâ€™-1},h_t)=v^T \tanh(W_ss+W_hh)$<ul><li>$e_{tâ€™t}$ï¼šç”±tæ—¶åˆ»çš„ç¼–ç å™¨éšå±‚çŠ¶æ€è¾“å‡ºå’Œtâ€™-1æ—¶åˆ»çš„è§£ç å™¨éšå±‚çŠ¶æ€è¾“å‡ºè®¡ç®—å¾—åˆ°çš„ä¸€ä¸ªå€¼</li><li>sä¸ºDecoderçš„éšå±‚è¾“å‡ºï¼Œhä¸ºEncoderçš„éšå±‚è¾“å‡º</li><li>$W_s, W_h, v$ï¼šå‚æ•°ï¼Œè®­ç»ƒå¾—åˆ°</li></ul></li></ul></li></ol>]]></content>
    
    
    <summary type="html">æŠŠè¾“å‡ºå’Œæ–°çš„è¾“å…¥æ··åˆæ¥å¤„ç†åºåˆ—æ•°æ®çš„ç½‘ç»œ</summary>
    
    
    
    <category term="DLç¬”è®°" scheme="https://www.cclmsy.cc/categories/DL%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="https://www.cclmsy.cc/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>DLç¬”è®°3|å·ç§¯ç¥ç»ç½‘ç»œCNN</title>
    <link href="https://www.cclmsy.cc/posts/deep_learning_3.html"/>
    <id>https://www.cclmsy.cc/posts/deep_learning_3.html</id>
    <published>2025-02-21T16:00:00.000Z</published>
    <updated>2025-08-12T00:19:29.652Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€å·ç§¯ç¥ç»ç½‘ç»œåŸºç¡€">ä¸€ã€å·ç§¯ç¥ç»ç½‘ç»œåŸºç¡€</h2><h3 id="1-1-è®¡ç®—æœºè§†è§‰ï¼ˆComputer-Visionï¼ŒCVï¼‰">1.1 è®¡ç®—æœºè§†è§‰ï¼ˆComputer Visionï¼ŒCVï¼‰</h3><p>åœ¨CVé¢†åŸŸï¼Œé€šå¸¸è¦åšçš„æ˜¯ç”¨æœºå™¨ç¨‹åºä»£æ›¿äººçœ¼å¯¹ç›®æ ‡å›¾åƒè¿›è¡Œè¯†åˆ«ã€åˆ†æã€å¤„ç†ã€‚<br>æ·±åº¦å­¦ä¹ åœ¨CVé¢†åŸŸçš„åº”ç”¨éå¸¸å¹¿æ³›ã€‚</p><p>å‡è®¾éœ€è¦å¤„ç†1024x1024çš„å½©è‰²å›¾åƒï¼Œæ¯ä¸ªåƒç´ æœ‰RGBä¸‰ä¸ªé€šé“ï¼Œå…±æœ‰1024x1024x3=3,145,728ä¸ªç‰¹å¾ã€‚<br>å‡è®¾ç¬¬ä¸€ä¸ªéšè—å±‚æœ‰10ä¸ªç¥ç»å…ƒï¼Œé‚£ä¹ˆç¬¬ä¸€å±‚çš„æƒé‡çŸ©é˜µæœ‰3,145,728x10=31,457,280ä¸ªå‚æ•°ï¼Œè®¡ç®—é‡æå¤§ï¼Œéš¾ä»¥è¾¾åˆ°å¥½çš„æ•ˆæœã€‚</p><p>ç›¸æ¯”å¤šå±‚ç¥ç»ç½‘ç»œï¼Œå·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰æ›´é€‚åˆå¤„ç†å›¾åƒæ•°æ®ã€‚</p><p>1962å¹´Hubelå’ŒWieselé€šè¿‡å¯¹çŒ«è§†è§‰çš®å±‚ç»†èƒçš„ç ”ç©¶ï¼Œæå‡ºäº†æ„Ÿå—é‡çš„æ¦‚å¿µã€‚<br>FukushimaåŸºäºæ„Ÿå—é‡æ¦‚å¿µæå‡ºçš„ç¥ç»è®¤çŸ¥æœº(Neocognitron)å¯ä»¥çœ‹ä½œæ˜¯å·ç§¯ç¥ç»ç½‘ç»œçš„ç¬¬ä¸€ä¸ªå®ç°ç½‘ç»œã€‚</p><p>å•ä¸ªæ„Ÿå—å™¨ä¸è®¸å¤šæ„Ÿè§‰ç¥ç»çº¤ç»´ç›¸è”ç³»ï¼Œæ„Ÿè§‰ä¿¡æ¯æ˜¯é€šè¿‡è®¸å¤šæ„Ÿå—ç¥ç»çº¤ç»´å‘æ”¾æ€»å’Œæ€§çš„ç©ºé—´ä¸æ—¶é—´ç±»å‹ä¸åŒçš„å†²åŠ¨ï¼Œç›¸å½“äºç»è¿‡ç¼–ç æ¥ä¼ é€’ã€‚</p><h3 id="1-2-è¾¹ç¼˜æ£€æµ‹">1.2 è¾¹ç¼˜æ£€æµ‹</h3><p>ä¸ºäº†ä½¿ç”¨æ›´å°‘çš„å‚æ•°æ£€æµ‹å‡ºæ›´å¤šçš„ä¿¡æ¯ï¼Œé€šå¸¸ç¥ç»ç½‘ç»œéœ€è¦æ£€æµ‹å‡ºç‰©ä½“æœ€æ˜æ˜¾çš„å‚ç›´å’Œæ°´å¹³è¾¹ç¼˜æ¥åŒºåˆ†ç‰©ä½“ã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B.png" alt="è¾¹ç¼˜æ£€æµ‹"></p><p>éšç€æ·±åº¦å­¦ä¹ çš„å‘å±•ï¼Œæˆ‘ä»¬éœ€è¦æ£€æµ‹æ›´å¤æ‚çš„å›¾åƒä¸­çš„è¾¹ç¼˜ã€‚<br>ä¸å…¶ä½¿ç”¨ç”±äººæ‰‹å·¥è®¾è®¡çš„è¿‡æ»¤å™¨ï¼Œè¿˜å¯ä»¥å°†è¿‡æ»¤å™¨ä¸­çš„æ•°å€¼ä½œä¸ºå‚æ•°ï¼Œé€šè¿‡åå‘ä¼ æ’­æ¥å­¦ä¹ å¾—åˆ°ã€‚</p><p>ç®—æ³•å¯ä»¥æ ¹æ®å®é™…æ•°æ®æ¥é€‰æ‹©åˆé€‚çš„æ£€æµ‹ç›®æ ‡ï¼Œæ— è®ºæ˜¯æ£€æµ‹æ°´å¹³è¾¹ç¼˜ã€å‚ç›´è¾¹ç¼˜è¿˜æ˜¯å…¶ä»–è§’åº¦çš„è¾¹ç¼˜ï¼Œå¹¶ä¹ å¾—å›¾åƒçš„ä½å±‚ç‰¹å¾ã€‚</p><h2 id="äºŒã€å·ç§¯ç¥ç»ç½‘ç»œåŸç†">äºŒã€å·ç§¯ç¥ç»ç½‘ç»œåŸç†</h2><h3 id="2-1-å·ç§¯ç¥ç»ç½‘ç»œçš„ç»„æˆ">2.1 å·ç§¯ç¥ç»ç½‘ç»œçš„ç»„æˆ</h3><p>CNNç”±ä¸€ä¸ªæˆ–å¤šä¸ªå·ç§¯å±‚ï¼ˆConvolutionsï¼‰ã€æ± åŒ–å±‚ï¼ˆPoolingï¼‰ã€å…¨è¿æ¥å±‚ï¼ˆFull Connectionï¼‰ç»„æˆã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/CNN%E7%BB%93%E6%9E%84.png" alt="CNNç»“æ„"></p><p>ä¸å…¶ä»–æ·±åº¦å­¦ä¹ ç»“æ„ç›¸æ¯”ï¼ŒCNNåœ¨å›¾åƒç­‰æ–¹é¢èƒ½å¤Ÿç»™å‡ºæ›´å¥½çš„ç»“æœã€‚<br>CNNä¹Ÿå¯ä»¥ç”¨åå‘ä¼ æ’­ç®—æ³•è¿›è¡Œè®­ç»ƒã€‚<br>ä¸å…¶ä»–æµ…å±‚æˆ–æ·±å±‚ç¥ç»ç½‘ç»œç›¸æ¯”ï¼ŒCNNçš„å‚æ•°æ›´å°‘ï¼Œæ›´å®¹æ˜“è®­ç»ƒã€‚</p><h3 id="2-2-å·ç§¯å±‚ï¼ˆConvolutionsï¼‰">2.2 å·ç§¯å±‚ï¼ˆConvolutionsï¼‰</h3><ul><li>ç›®çš„ï¼šæå–è¾“å…¥çš„ä¸åŒç‰¹å¾<ul><li>æŸäº›å·ç§¯å±‚å¯èƒ½åªèƒ½æå–ä¸€äº›ä½çº§ç‰¹å¾ï¼Œå¦‚çº¿æ¡ã€è¾¹ç¼˜ç­‰ï¼Œæ›´å¤šå±‚çš„ç½‘ç»œèƒ½ä»ä½çº§ç‰¹å¾ä¸­æå–æ›´é«˜çº§æ›´å¤æ‚çš„ç‰¹å¾ã€‚</li></ul></li><li>å‚æ•°<ul><li>sizeï¼šå·ç§¯æ ¸ï¼ˆfilterï¼‰å¤§å°ï¼Œå¦‚3x3ã€5x5ç­‰</li><li>paddingï¼š0å¡«å……ï¼Œä¿æŒè¾“å‡ºå’Œè¾“å…¥çš„å¤§å°ä¸€è‡´ï¼ŒValid/Same</li><li>strideï¼šæ­¥é•¿ï¼Œå·ç§¯æ ¸æ¯æ¬¡ç§»åŠ¨çš„è·ç¦»ï¼Œé€šå¸¸ä¸º1</li></ul></li><li>è®¡ç®—å…¬å¼<ul><li>å››ä¸ªè¶…å‚æ•°ï¼šFilteræ•°é‡$K$ã€Filterå¤§å°$F$ã€æ­¥é•¿$S$ã€0å¡«å……å¤§å°$P$</li><li>è¾“å…¥ä½“ç§¯ï¼š$H_1 \times W_1 \times D_1$</li><li>è¾“å‡ºä½“ç§¯ï¼š$H_2 \times W_2 \times D_2$<ul><li>$H_2 = \dfrac{H_1-F+2P}{S}+1$</li><li>$W_2 = \dfrac{W_1-F+2P}{S}+1$</li><li>$D_2 = K$</li></ul></li></ul></li></ul><h4 id="2-2-1-å·ç§¯è¿ç®—">2.2.1 å·ç§¯è¿ç®—</h4><p>å·ç§¯è¿ç®—ï¼ˆç¬¦å·$\ast$ï¼‰ï¼šå°†ä¸€ä¸ªçŸ©é˜µï¼ˆå·ç§¯æ ¸ï¼‰åº”ç”¨åˆ°å¦ä¸€ä¸ªçŸ©é˜µçš„æ‰€æœ‰ä½ç½®ï¼Œæ±‚å‡ºæ¯ä¸ªä½ç½®çš„ç‚¹ç§¯ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„çŸ©é˜µã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E5%8D%B7%E7%A7%AF%E8%BF%90%E7%AE%97.png" alt="å·ç§¯è¿ç®—"></p><p>åœ¨è¿™ä¸ª6x6çš„çŸ©é˜µä¸­ï¼Œå·¦è¾¹ä¸€åŠéƒ½æ˜¯1ï¼Œå³è¾¹ä¸€åŠéƒ½æ˜¯0ï¼Œä¸­é—´æ˜¯ä¸€æ¡éå¸¸æ˜æ˜¾çš„å‚ç›´è¾¹ç¼˜ã€‚<br>ç»è¿‡å·ç§¯åï¼Œå¾—åˆ°ä¸€ä¸ª4x4çš„çŸ©é˜µï¼Œä¸­é—´çš„å€¼éå¸¸å¤§ï¼Œå…¶ä»–å€¼éå¸¸å°ï¼Œè¡¨æ˜æ£€æµ‹åˆ°äº†å‚ç›´è¾¹ç¼˜ã€‚</p><p>å·ç§¯è¿ç®—çš„äº§ç”Ÿçš„é—®é¢˜ï¼šè¾¹ç¼˜åƒç´ çš„ä¿¡æ¯ä¸¢å¤±ã€è¾“å‡ºçš„å›¾åƒå°ºå¯¸å˜å°</p><h4 id="2-2-2-padding-é›¶å¡«å……">2.2.2 padding-é›¶å¡«å……</h4><p>åœ¨å›¾ç‰‡åƒç´ çš„æœ€å¤–å±‚åŠ ä¸Š$P$å±‚0ï¼Œä½¿å¾—å·ç§¯åçš„è¾“å‡ºå’Œè¾“å…¥çš„å°ºå¯¸ä¸€è‡´ã€‚</p><p>0å¯¹æœ€ç»ˆç»“æœä¸äº§ç”Ÿå½±å“ï¼Œé¿å…å›¾ç‰‡å¢åŠ å™ªå£°ã€‚</p><ul><li>Validå·ç§¯ï¼šä¸å¡«å……ï¼Œè¾“å‡ºå°ºå¯¸å‡å°</li><li>Sameå·ç§¯ï¼ˆä¸€èˆ¬é‡‡ç”¨ï¼‰ï¼šå¡«å……0ä»¥ç»´æŒè¾“å‡ºå°ºå¯¸ä¸åŸå›¾ä¸€è‡´</li></ul><h4 id="2-2-3-size-å·ç§¯æ ¸å¤§å°">2.2.3 size-å·ç§¯æ ¸å¤§å°</h4><p>å·ç§¯æ ¸å¤§å°$F$é€šå¸¸ä¸º3x3ã€5x5ã€7x7ç­‰å¥‡æ•°ï¼Œä¿è¯èƒ½å¤Ÿç¡®å®šä¸€ä¸ªä¸­å¿ƒç‚¹ã€‚</p><p>å°å·ç§¯æ ¸å¯ä»¥ä¿ç•™æ›´å¤šçš„ä¿¡æ¯ï¼Œå¤§å·ç§¯æ ¸å¯ä»¥æ£€æµ‹æ›´å¤§çš„ç‰¹å¾ã€‚</p><h4 id="2-2-4-stride-æ­¥é•¿">2.2.4 stride-æ­¥é•¿</h4><p>æ­¥é•¿$S$é€šå¸¸ä¸º1ï¼Œå³å·ç§¯æ ¸æ¯æ¬¡ç§»åŠ¨ä¸€ä¸ªåƒç´ ã€‚</p><p>æ­¥é•¿ä¸º2æ—¶ï¼Œå·ç§¯æ ¸æ¯æ¬¡ç§»åŠ¨ä¸¤ä¸ªåƒç´ ï¼Œè¾“å‡ºå°ºå¯¸å‡å°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/2%E6%AD%A5%E9%95%BF%E5%8D%B7%E7%A7%AF.png" alt="2æ­¥é•¿å·ç§¯"></p><h4 id="2-2-5-å¤šé€šé“å·ç§¯">2.2.5 å¤šé€šé“å·ç§¯</h4><p>å½“è¾“å…¥æœ‰å¤šä¸ªé€šé“ï¼ˆChannelï¼‰æ—¶ï¼ˆä¾‹å¦‚å›¾ç‰‡å¯ä»¥æœ‰ RGB ä¸‰ä¸ªé€šé“ï¼‰ï¼Œå·ç§¯æ ¸éœ€è¦æ‹¥æœ‰ç›¸åŒçš„é€šé“æ•°</p><p>ä½†æœ€ç»ˆçš„è¾“å‡ºåªæœ‰ä¸€ä¸ªé€šé“ï¼Œå…¶ç»“æœæ˜¯å¤šä¸ªé€šé“çš„å·ç§¯ç»“æœçš„å’Œã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E5%A4%9A%E9%80%9A%E9%81%93%E5%8D%B7%E7%A7%AF.png" alt="å¤šé€šé“å·ç§¯"></p><h4 id="2-2-6-å¤šå·ç§¯æ ¸">2.2.6 å¤šå·ç§¯æ ¸</h4><p>å½“æœ‰å¤šä¸ªå·ç§¯æ ¸æ—¶ï¼Œå¯ä»¥å­¦ä¹ åˆ°å¤šç§ä¸åŒçš„ç‰¹å¾ï¼Œè¾“å‡ºç»“æœçš„é€šé“æ•°ç­‰äºå·ç§¯æ ¸çš„æ•°é‡ï¼Œå¤šå·ç§¯æ ¸å¯ä»¥ç†è§£ä¸ºå¤šç¥ç»å…ƒ</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E5%A4%9A%E5%8D%B7%E7%A7%AF%E6%A0%B8.png" alt="å¤šå·ç§¯æ ¸"></p><h4 id="2-2-7-å·ç§¯å±‚çš„è¿ç®—ç»“æœ">2.2.7 å·ç§¯å±‚çš„è¿ç®—ç»“æœ</h4><p>$$<br>\begin{split}<br>&amp;Z^{[l]} = W^{[l]} \ast A^{[l-1]} + b^{[l]} \\<br>&amp;A^{[l]} = g(Z^{[l]})<br>\end{split}<br>$$</p><h3 id="2-3-æ± åŒ–å±‚ï¼ˆPoolingï¼‰">2.3 æ± åŒ–å±‚ï¼ˆPoolingï¼‰</h3><p>æ± åŒ–å±‚ä¸»è¦å¯¹å·ç§¯å±‚çš„è¾“å‡ºè¿›è¡Œä¸‹é‡‡æ ·ï¼ˆSubsamplingï¼‰å¤„ç†ï¼Œä¸»è¦åˆ†ä¸ºï¼š</p><ul><li>æœ€å¤§æ± åŒ–ï¼ˆMax Poolingï¼‰ï¼šå–æ± åŒ–çª—å£ä¸­çš„æœ€å¤§å€¼</li><li>å¹³å‡æ± åŒ–ï¼ˆAverage Poolingï¼‰ï¼šå–æ± åŒ–çª—å£ä¸­çš„å¹³å‡å€¼</li></ul><p>æ± åŒ–é€šå¸¸ä¸º2x2çš„filterï¼Œæ­¥é•¿ä¸º2ï¼Œå³æ¯æ¬¡å–2x2çš„çª—å£ä¸­çš„æœ€å¤§å€¼æˆ–å¹³å‡å€¼ã€‚</p><p>ç‰¹ç‚¹ï¼šæ²¡æœ‰å‚æ•°ï¼Œä¸éœ€è¦å­¦ä¹ ï¼Œåªæ˜¯å¯¹è¾“å…¥æ•°æ®è¿›è¡Œç®€å•çš„å¤„ç†ã€‚</p><p>ç›®çš„ï¼šé™ä½æ•°æ®ç»´åº¦ï¼›å‡å°‘è®¡ç®—é‡ã€æé«˜è®¡ç®—é€Ÿåº¦ï¼›é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œæé«˜äº†é²æ£’æ€§ã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E6%B1%A0%E5%8C%96%E5%B1%82.png" alt="æ± åŒ–å±‚"></p><h3 id="2-4-å…¨è¿æ¥å±‚ï¼ˆFully-Connectedï¼‰ä¸CNNç»“æ„">2.4 å…¨è¿æ¥å±‚ï¼ˆFully Connectedï¼‰ä¸CNNç»“æ„</h3><p>å…¨è¿æ¥å±‚å³æ­¤å‰æåˆ°çš„å¤šå±‚ç¥ç»ç½‘ç»œï¼Œæ¯ä¸ªç¥ç»å…ƒä¸ä¸Šä¸€å±‚çš„æ‰€æœ‰ç¥ç»å…ƒç›¸è¿ã€‚</p><p>å·ç§¯å±‚+æ¿€æ´»å±‚+æ± åŒ–å±‚å¯ä»¥çœ‹æˆæ˜¯CNNçš„ç‰¹å¾å­¦ä¹ /ç‰¹å¾æå–å±‚ï¼Œå­¦ä¹ åˆ°çš„ç‰¹å¾ï¼ˆFeature Mapï¼‰æœ€ç»ˆåº”ç”¨äºæ¨¡å‹ä»»åŠ¡ï¼ˆåˆ†ç±»ã€å›å½’ï¼‰</p><ul><li>å…ˆå¯¹æ‰€æœ‰Feature Mapè¿›è¡Œæ‰å¹³åŒ–ï¼ˆFlattenï¼‰ï¼Œå³è½¬åŒ–ä¸ºä¸€ç»´å‘é‡</li><li>å†è¿æ¥åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå…¨è¿æ¥å±‚ï¼Œè¿›è¡Œåˆ†ç±»æˆ–å›å½’ä»»åŠ¡</li></ul><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/CNN%E7%BB%93%E6%9E%842.png" alt="CNNç»“æ„2"></p><h2 id="ä¸‰ã€ç»å…¸åˆ†ç±»ç½‘ç»œç»“æ„">ä¸‰ã€ç»å…¸åˆ†ç±»ç½‘ç»œç»“æ„</h2><p>é€šå¸¸é‡‡ç”¨ä»ç°æˆçš„ç»å…¸ç½‘ç»œç»“æ„è¿›è¡Œä¼˜åŒ–ï¼Œè€Œä¸æ˜¯ä»å¤´å¼€å§‹è®¾è®¡ç½‘ç»œç»“æ„ã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E7%BB%8F%E5%85%B8%E7%BD%91%E7%BB%9C%E7%BB%93%E6%9E%84.png" alt="ç»å…¸ç½‘ç»œç»“æ„"></p><ul><li>NINï¼šå¼•å…¥äº†1x1å·ç§¯æ ¸</li><li>VGGï¼šå‚æ•°é‡å·¨å¤§ï¼ˆ1.4äº¿ï¼‰ï¼Œ19å±‚ç½‘ç»œ</li><li>GoogleNetï¼š500ä¸‡å‚æ•°ï¼Œ22å±‚ç½‘ç»œ<ul><li>2014å¹´æ¯”èµ›å† å†›çš„modelï¼Œè¯æ˜äº†ç”¨æ›´å¤šçš„å·ç§¯ã€æ›´æ·±çš„å±‚æ¬¡å¯ä»¥å¾—åˆ°æ›´å¥½çš„ç»“æ„</li><li>å¼•å…¥äº†Inceptionæ¨¡å—ï¼Œå¤šä¸ªä¸åŒå¤§å°çš„å·ç§¯æ ¸</li></ul></li></ul><h3 id="3-1-LeNet-5">3.1 LeNet-5</h3><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/LeNet5.png" alt="LeNet-5"></p><p>LeNet-5æœ€åˆçš„ç›®çš„ç”¨äºæ‰‹å†™æ•°å­—è¯†åˆ«ï¼Œå½“æ—¶ä½¿ç”¨çš„æ¿€æ´»å‡½æ•°æ˜¯Sigmoidå’ŒTanhï¼Œè¿˜æ²¡æœ‰å‡ºç°Relu</p><h4 id="å‚æ•°å½¢çŠ¶">å‚æ•°å½¢çŠ¶</h4><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">Shape</th><th style="text-align:center">Size</th><th style="text-align:center">Params</th></tr></thead><tbody><tr><td style="text-align:center">Input</td><td style="text-align:center">(32, 32, 1)</td><td style="text-align:center">1024</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">Conv1(f=5,s=1)</td><td style="text-align:center">(28, 28, 6)</td><td style="text-align:center">4704</td><td style="text-align:center">5x5ï¼ˆå·ç§¯æ ¸å¤§å°ï¼‰x3ï¼ˆé€šé“æ•°ï¼‰x6ï¼ˆå·ç§¯æ ¸æ•°é‡ï¼‰+6ï¼ˆåç½®ï¼‰=456</td></tr><tr><td style="text-align:center">Pool1</td><td style="text-align:center">(14, 14, 6)</td><td style="text-align:center">1176</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">Conv2(f=5,s=1)</td><td style="text-align:center">(10, 10, 16)</td><td style="text-align:center">1600</td><td style="text-align:center">5x5x6x16+16=2416</td></tr><tr><td style="text-align:center">Pool2</td><td style="text-align:center">(5, 5, 16)</td><td style="text-align:center">400</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">FC3</td><td style="text-align:center">(120, 1)</td><td style="text-align:center">120</td><td style="text-align:center">400x120+120=48120</td></tr><tr><td style="text-align:center">FC4</td><td style="text-align:center">(84, 1)</td><td style="text-align:center">84</td><td style="text-align:center">120x84+84=10164</td></tr><tr><td style="text-align:center">Output:Sofmax</td><td style="text-align:center">(10, 1)</td><td style="text-align:center">10</td><td style="text-align:center">84x10+10=850</td></tr></tbody></table><ul><li>ä¸­é—´ç‰¹å¾å€¼çš„å¤§å°å˜åŒ–ä¸å®œè¿‡å¤§ï¼Œå¦åˆ™ä¼šå¯¼è‡´ä¿¡æ¯ä¸¢å¤±</li></ul><h3 id="3-2-AlexNet">3.2 AlexNet</h3><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/AlexNet.png" alt="AlexNet"></p><ul><li>æ€»å‚æ•°é‡ï¼š6000ä¸‡ï¼Œ8å±‚ç¥ç»ç½‘ç»œï¼Œ5ä¸ªå·ç§¯å±‚+3ä¸ªå…¨è¿æ¥å±‚</li><li>ä½¿ç”¨äº†éçº¿æ€§æ¿€æ´»å‡½æ•°ReLU</li><li>ä½¿ç”¨Dropouté˜²æ­¢è¿‡æ‹Ÿåˆï¼Œæ•°æ®æ‰©å……</li><li>ä½¿ç”¨æ‰¹æ ‡å‡†åŒ–ï¼ˆBatch Normalizationï¼‰åŠ é€Ÿè®­ç»ƒ</li></ul><h4 id="å‚æ•°å½¢çŠ¶-2">å‚æ•°å½¢çŠ¶</h4><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">Shape</th><th style="text-align:center">Size</th><th style="text-align:center">Params</th></tr></thead><tbody><tr><td style="text-align:center">Input</td><td style="text-align:center">(227, 227, 3)</td><td style="text-align:center">154,587</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">Conv1(f=11,s=4)</td><td style="text-align:center">(55, 55, 96)</td><td style="text-align:center">290,400</td><td style="text-align:center">11Ã—11Ã—3Ã—96 + 96 = 34,944</td></tr><tr><td style="text-align:center">Pool1</td><td style="text-align:center">(27, 27, 96)</td><td style="text-align:center">69,984</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">Conv2(f=5,s=1)</td><td style="text-align:center">(27, 27, 256)</td><td style="text-align:center">186,624</td><td style="text-align:center">5Ã—5Ã—48Ã—256 + 256 = 307,456ï¼ˆgroupå·ç§¯ï¼‰</td></tr><tr><td style="text-align:center">Pool2</td><td style="text-align:center">(13, 13, 256)</td><td style="text-align:center">43,264</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">Conv3(f=3,s=1)</td><td style="text-align:center">(13, 13, 384)</td><td style="text-align:center">64,896</td><td style="text-align:center">3Ã—3Ã—256Ã—384 + 384 = 885,120</td></tr><tr><td style="text-align:center">Conv4(f=3,s=1)</td><td style="text-align:center">(13, 13, 384)</td><td style="text-align:center">64,896</td><td style="text-align:center">3Ã—3Ã—192Ã—384 + 384 = 663,936ï¼ˆgroupå·ç§¯ï¼‰</td></tr><tr><td style="text-align:center">Conv5(f=3,s=1)</td><td style="text-align:center">(13, 13, 256)</td><td style="text-align:center">43,264</td><td style="text-align:center">3Ã—3Ã—192Ã—256 + 256 = 442,624ï¼ˆgroupå·ç§¯ï¼‰</td></tr><tr><td style="text-align:center">Pool3</td><td style="text-align:center">(6, 6, 256)</td><td style="text-align:center">9,216</td><td style="text-align:center">0</td></tr><tr><td style="text-align:center">FC6</td><td style="text-align:center">(4096, 1)</td><td style="text-align:center">4096</td><td style="text-align:center">6Ã—6Ã—256Ã—4096 + 4096 = 37,752,832</td></tr><tr><td style="text-align:center">FC7</td><td style="text-align:center">(4096, 1)</td><td style="text-align:center">4096</td><td style="text-align:center">4096Ã—4096 + 4096 = 16,781,312</td></tr><tr><td style="text-align:center">FC8</td><td style="text-align:center">(1000, 1)</td><td style="text-align:center">1000</td><td style="text-align:center">4096Ã—1000 + 1000 = 4,097,000</td></tr><tr><td style="text-align:center">Output:Softmax</td><td style="text-align:center">(1000, 1)</td><td style="text-align:center">1000</td><td style="text-align:center">0</td></tr></tbody></table><h3 id="3-3-Inceptionç»“æ„">3.3 Inceptionç»“æ„</h3><p>Inceptionç»“æ„æ˜¯GoogleNetä¸­çš„ä¸€ä¸ªæ¨¡å—ï¼Œç”±å¤šä¸ªä¸åŒå¤§å°çš„å·ç§¯æ ¸ç»„æˆï¼Œå¯ä»¥æå–ä¸åŒå°ºåº¦çš„ç‰¹å¾ã€‚</p><h4 id="3-1-MLPå·ç§¯ï¼ˆ1x1å·ç§¯ï¼‰">3.1 MLPå·ç§¯ï¼ˆ1x1å·ç§¯ï¼‰</h4><p>ä¸€ç§æ–°çš„æ·±åº¦ç½‘ç»œç»“æ„Network in Networkï¼ˆNINï¼‰æå‡ºäº†MLPå·ç§¯å–ä»£ä¼ ç»Ÿçº¿æ€§å·ç§¯æ ¸</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/MLP%E5%8D%B7%E7%A7%AF.png" alt="MLPå·ç§¯"></p><ul><li>1x1å·ç§¯æ ¸å¯¹æ¯ä¸ªåƒç´ ç‚¹çš„æ‰€æœ‰é€šé“è¿›è¡Œäº†çº¿æ€§ç»„åˆ</li><li>æ¿€æ´»å‡½æ•°å°†feature mapç”±å¤šé€šé“çš„çº¿æ€§ç»„åˆå˜ä¸ºéçº¿æ€§ç»„åˆï¼ˆä¿¡æ¯æ•´åˆï¼‰</li><li>æé«˜ç‰¹å¾æŠ½è±¡èƒ½åŠ›ï¼ˆMultilayer Perceptronï¼Œç¼©å†™MLPï¼Œå°±æ˜¯ä¸€ä¸ªå¤šå±‚ç¥ç»ç½‘ç»œï¼‰</li><li>ä¸»è¦ä½œç”¨ï¼šè°ƒæ•´é€šé“æ•°ï¼ˆå‡ç»´é™ç»´ï¼‰ã€å‡å°‘å‚æ•°é‡</li></ul><h4 id="3-2-Inceptionå±‚">3.2 Inceptionå±‚</h4><p>ä¹Ÿç§°ç›—æ¢¦ç©ºé—´ç»“æ„ï¼‰</p><p>ç›®çš„ï¼šä»£æ›¿äººå†³å®šï¼Œä½¿ç”¨å“ªç§å·ç§¯æ ¸ï¼Œæˆ–æ˜¯éœ€è¦MaxPoolå±‚ï¼Œç”±ç½‘ç»œè‡ªå·±å­¦ä¹ å¯»æ‰¾åˆé€‚çš„ç»“æ„ï¼ŒèŠ‚çœè®¡ç®—</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/Inception%E5%B1%82.png" alt="Inceptionå±‚"></p><p>æä¾›ä»¥ä¸‹4ç§ä¸åŒçš„å·ç§¯æ ¸ï¼š</p><ul><li>1x1å·ç§¯æ ¸ï¼ˆ64ä¸ªï¼‰</li><li>3x3å·ç§¯æ ¸ï¼ˆ128ä¸ªï¼‰ï¼Œpadding=same</li><li>5x5å·ç§¯æ ¸ï¼ˆ32ä¸ªï¼‰ï¼Œpadding=same</li><li>2x2æœ€å¤§æ± åŒ–ï¼ˆ32ä¸ªï¼‰ï¼Œstride=1ï¼Œpadding=same</li><li>æœ€ç»ˆç»“æœä¸ºè¿™4ç§å·ç§¯æ ¸çš„æ‹¼æ¥ï¼Œ27x27x256ï¼Œä½¿ç”¨æ›´å°‘çš„å‚æ•°è¾¾åˆ°å’ŒAlexNetç›¸å½“çš„æ•ˆæœ</li></ul><h4 id="3-3-Inceptionæ”¹è¿›">3.3 Inceptionæ”¹è¿›</h4><p>ä¸Šä¸€èŠ‚ä¸­ï¼Œè®¡ç®—é‡è¿˜æ˜¯å¤ªå¤§ï¼Œå‚æ•°è¿˜æ˜¯å¤ªå¤šï¼Œéœ€è¦è¿›ä¸€æ­¥æ”¹è¿›ã€‚ä»¥5x5å·ç§¯æ ¸ä¸ºä¾‹ï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/Inception%E6%94%B9%E8%BF%9B.png" alt="Inceptionæ”¹è¿›"></p><ul><li>ä¸Šé¢ä¸ºåŸæ–¹æ³•ï¼Œå‚æ•°ï¼š$5\times5\times192\times32=153600$</li><li>ä¸‹é¢ä¸ºæ”¹è¿›æ–¹æ³•ï¼Œç½‘ç»œç¼©å°åå†æ‰©å¤§ï¼Œå‚æ•°ï¼š$1\times1\times192\times16+5\times5\times16\times32=15872$</li></ul><h4 id="3-4-GoogleNet">3.4 GoogleNet</h4><p>Inceptionæ¨¡å—çš„å †å ï¼Œå½¢æˆGoogleNetç½‘ç»œç»“æ„</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/Inception%E6%A8%A1%E5%9D%97.png" alt="Inceptionæ¨¡å—"></p><p>è¯¦ç»†ç»“æ„ç•¥</p><h2 id="å››ã€å·ç§¯ç¥ç»ç½‘ç»œå®æˆ˜æŠ€å·§">å››ã€å·ç§¯ç¥ç»ç½‘ç»œå®æˆ˜æŠ€å·§</h2><h3 id="4-1-å­¦ä¹ ç‰¹å¾å¯è§†åŒ–">4.1 å­¦ä¹ ç‰¹å¾å¯è§†åŒ–</h3><p>å¯ä»¥å°†ç½‘ç»œå­¦ä¹ è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç‰¹å¾å›¾å¯è§†åŒ–å‡ºæ¥ï¼Œå¹¶ä¸”å¯¹æ¯”åŸå›¾æ¥çœ‹çœ‹æ¯ä¸€å±‚éƒ½å¹²äº†ä»€ä¹ˆ</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/LeNet5%E4%BE%8B.webp" alt="LeNet5ä¾‹"></p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E5%AD%A6%E4%B9%A0%E7%89%B9%E5%BE%81%E5%8F%AF%E8%A7%86%E5%8C%96.png" alt="å­¦ä¹ ç‰¹å¾å¯è§†åŒ–"></p><ul><li>Layer1,2ï¼šé¢œè‰²ã€è¾¹ç¼˜ç­‰åŸºæœ¬ç‰¹å¾</li><li>Layer3ï¼šçº¹ç†ã€å½¢çŠ¶ç­‰ä¸­çº§ç‰¹å¾</li><li>Layer4ï¼šç¨å¤æ‚çš„ç‰¹å¾ï¼Œå¦‚ç‹—çš„å¤´éƒ¨å½¢çŠ¶</li><li>Layer5ï¼šé«˜çº§ç‰¹å¾ï¼Œå¦‚å…³é”®æ€§åŒºåˆ†ç‰¹å¾</li></ul><h3 id="4-2-è¿ç§»å­¦ä¹ ï¼ˆTransfer-Learningï¼‰">4.2 è¿ç§»å­¦ä¹ ï¼ˆTransfer Learningï¼‰</h3><p>å¦‚æœéœ€è¦åšä¸€ä¸ªå…·ä½“åœºæ™¯çš„è®¡ç®—æœºè§†è§‰ä»»åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨å·²ç»è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œå¾®è°ƒã€‚</p><h4 id="4-2-1-ä»‹ç»">4.2.1 ä»‹ç»</h4><p>è¿ç§»å­¦ä¹ å°±æ˜¯åˆ©ç”¨æ•°æ®ã€ä»»åŠ¡æˆ–æ¨¡å‹ä¹‹é—´çš„ç›¸ä¼¼æ€§ï¼ˆä¾‹å¦‚éƒ½æ˜¯å›¾åƒåˆ†ç±»ä»»åŠ¡ï¼‰ï¼Œå°†åœ¨æ—§çš„é¢†åŸŸå­¦ä¹ è¿‡æˆ–è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œåº”ç”¨äºæ–°çš„é¢†åŸŸçš„è¿‡ç¨‹ã€‚</p><p>ä»ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢è€ƒè™‘è®­ç»ƒæ¨¡å‹çš„ç°å®é—®é¢˜ï¼š</p><ol><li>æ•°æ®é›†å¤§å°ï¼šå¦‚æœæ–°ä»»åŠ¡çš„æ•°æ®é›†å¾ˆå°ï¼Œè¿ç§»å­¦ä¹ å¯ä»¥å¸®åŠ©æé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›<ul><li>å¦‚æœæœ‰æµ·é‡çš„æ•°æ®é›†æ”¯æŒï¼Œå¯ä»¥ä¸éœ€è¦è¿ç§»å­¦ä¹ ï¼Œç›´æ¥ä»æµ·é‡æ•°æ®ä¸­è®­ç»ƒå‡ºä¸€ä¸ªå­¦ä¹ åˆ°ä¸€ä¸ªé²æ£’æ€§å¾ˆå¼ºçš„æ¨¡å‹</li><li>ä½†æ˜¯ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œéœ€è¦ç ”ç©¶çš„é¢†åŸŸæ•°æ®é›†éå¸¸æœ‰é™ï¼Œå¯¼è‡´æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›æå·®</li></ul></li><li>è®­ç»ƒæˆæœ¬ï¼šä»å¤´å¼€å§‹è®­ç»ƒä¸€ä¸ªCNNæ¨¡å‹éœ€è¦å¤§é‡çš„æ—¶é—´å’Œè®¡ç®—èµ„æº</li></ol><h4 id="4-2-2-å¾®è°ƒï¼ˆFine-tuningï¼‰">4.2.2 å¾®è°ƒï¼ˆFine-tuningï¼‰</h4><p>åœ¨ä¸€ä¸ªå·²ç»è®­ç»ƒå¥½çš„æ¨¡å‹ï¼ˆPre-trained Modelï¼‰ä¸Šè¿›è¡Œé’ˆå¯¹æ€§ä¼˜åŒ–ï¼Œä»¥æå‡æ¨¡å‹åœ¨ç‰¹å®šä»»åŠ¡ä¸Šçš„æ€§èƒ½ã€‚</p><p>å‡è®¾æœ‰ä¸¤ä¸ªä»»åŠ¡$A$å’Œ$B$ã€‚<br>ä»»åŠ¡$A$æ‹¥æœ‰æµ·é‡æ•°æ®ï¼Œä»¥$a$ä¸ºæ¡ä»¶åŒºåˆ†1000ä¸ªç±»åˆ«ï¼Œå·²ç»è®­ç»ƒå¥½äº†ä¸€ä¸ªæ¨¡å‹ã€‚<br>ç›®æ ‡ä»»åŠ¡ä¸º$B$ï¼Œä»¥$b$ä¸ºæ¡ä»¶åŒºåˆ†250ä¸ªç±»åˆ«ï¼Œæ•°æ®é›†å¾ˆå°ã€‚</p><p>æ­¥éª¤ï¼š</p><ol><li>åœ¨$A$æ¨¡å‹çš„åŸºç¡€ä¸Šï¼Œå°†æœ€åä¸€å±‚çš„è¾“å‡ºå±‚æ›¿æ¢ä¸º250ä¸ªç±»åˆ«çš„è¾“å‡ºå±‚ï¼Œä¿æŒå‰é¢çš„å‚æ•°ä¸å˜</li><li>æ ¹æ®æ•°æ®é‡ï¼Œå†³å®šæ˜¯å¦å†»ç»“ï¼ˆFreezeï¼‰å‰é¢çš„å±‚ï¼ˆæƒé‡ä¸å˜ï¼‰ï¼Œåªè®­ç»ƒæœ€åè‹¥å¹²å±‚å¹¶æ›´æ–°å‚æ•°<ul><li>æ•°æ®è¶Šå¤šï¼Œå°±ä¿ç•™è¶Šå¤šçš„å±‚ï¼Œä»åå¾€å‰é€æ¸è§£å†»</li><li>æ•°æ®å¾ˆå°‘ï¼Œåªä¿ç•™è¾“å‡ºå±‚ï¼Œå…¶ä»–å±‚å…¨éƒ¨è§£å†»</li></ul></li><li>é‡æ–°è®­ç»ƒæ¨¡å‹</li></ol>]]></content>
    
    
    <summary type="html">åˆ©ç”¨å·ç§¯è¿ç®—å¤„ç†å›¾åƒæ•°æ®æå–ç‰¹å¾çš„ç½‘ç»œ</summary>
    
    
    
    <category term="DLç¬”è®°" scheme="https://www.cclmsy.cc/categories/DL%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="https://www.cclmsy.cc/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Pytorch|Dataset&amp;DataLoader</title>
    <link href="https://www.cclmsy.cc/posts/dataset&amp;dataloader.html"/>
    <id>https://www.cclmsy.cc/posts/dataset&amp;dataloader.html</id>
    <published>2025-02-21T16:00:00.000Z</published>
    <updated>2025-07-18T12:42:11.061Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Dataset-æ•°æ®é›†">Dataset æ•°æ®é›†</h2><p>Pytorchä¸­è¡¨ç¤ºæ•°æ®é›†çš„æŠ½è±¡ç±»//</p><p>ä»»ä½•è‡ªå®šä¹‰çš„æ•°æ®é›†éƒ½éœ€è¦ç»§æ‰¿è¿™ä¸ªç±»å¹¶è¦†å†™ç›¸å…³æ–¹æ³•</p><p>Datasetçš„æè¿°ï¼š</p><blockquote><p>æ‰€æœ‰è¡¨ç¤ºä»é”®åˆ°æ•°æ®æ ·æœ¬çš„æ˜ å°„çš„æ•°æ®é›†éƒ½åº”ç»§æ‰¿å®ƒã€‚<br>æ‰€æœ‰å­ç±»éƒ½åº”è¦†å†™__getitem__ï¼Œä»¥æ”¯æŒè·å–ç»™å®šé”®çš„æ•°æ®æ ·æœ¬ã€‚<br>å­ç±»è¿˜å¯ä»¥é€‰æ‹©æ€§åœ°è¦†ç›–__len__ï¼Œè®¸å¤š~torch.utils.data.Samplerç±»å®ç°å’Œ~torch.utils.data.DataLoaderç±»çš„é»˜è®¤é€‰é¡¹éƒ½å¸Œæœ›å®ƒè¿”å›æ•°æ®é›†çš„å¤§å°ã€‚<br>å­ç±»ä¹Ÿå¯ä»¥é€‰æ‹©å®ç°__getitems__ï¼Œä»¥åŠ å¿«æˆæ‰¹æ ·æœ¬çš„åŠ è½½é€Ÿåº¦ã€‚<br>æ­¤æ–¹æ³•æ¥å—æ‰¹æ¬¡æ ·æœ¬çš„ç´¢å¼•åˆ—è¡¨ï¼Œå¹¶è¿”å›æ ·æœ¬åˆ—è¡¨ã€‚</p></blockquote><p>å‡è®¾éœ€è¦åŠ è½½çš„æ˜¯å½“å‰ç›®å½•ä¸‹<code>images</code>æ–‡ä»¶å¤¹ä¸­çš„42å¼ pngå›¾ç‰‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset, DataLoader</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, path, processor=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Datasetç±»çš„åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            path: æ•°æ®è·¯å¾„åˆ—è¡¨</span></span><br><span class="line"><span class="string">            processor: æ•°æ®é¢„å¤„ç†çš„å‡½æ•°ï¼Œf:æ•°æ®è·¯å¾„-&gt;ç›®æ ‡æ•°æ®</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.path = path</span><br><span class="line">        self.processor = processor</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¿”å›æ•°æ®é›†çš„å¤§å°&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, idx</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ ¹æ®ç´¢å¼•è¿”å›å¤„ç†åçš„æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        data_path = self.path[idx]</span><br><span class="line">        data = self.processor(data_path)</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">processor</span>(<span class="params">data_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;é¢„å¤„ç†å‡½æ•°ï¼Œè¿™é‡Œ&quot;&quot;&quot;</span></span><br><span class="line">    img = Image.<span class="built_in">open</span>(data_path).size</span><br><span class="line">    <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_images_path</span>(<span class="params">data_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è·å–data_dirç›®å½•ä¸‹æ‰€æœ‰pngå›¾ç‰‡çš„è·¯å¾„ï¼Œä¸å«å­ç›®å½•&quot;&quot;&quot;</span></span><br><span class="line">    images_path = [os.path.join(data_dir,image)</span><br><span class="line">                   <span class="keyword">for</span> image <span class="keyword">in</span> os.listdir(data_dir)</span><br><span class="line">                   <span class="keyword">if</span> image.endswith(<span class="string">&#x27;.png&#x27;</span>)]</span><br><span class="line">    <span class="keyword">return</span> images_path</span><br><span class="line"></span><br><span class="line">data_dir = <span class="string">&#x27;images&#x27;</span> <span class="comment"># æ•°æ®ç›®å½•</span></span><br><span class="line">images_path = get_images_path(data_dir) <span class="comment"># è·å–æ•°æ®è·¯å¾„</span></span><br><span class="line">dataset = MyDataset(images_path, processor=processor) <span class="comment"># åˆ›å»ºæ•°æ®é›†</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(dataset[<span class="number">0</span>]) <span class="comment"># æ‰“å°ç¬¬ä¸€ä¸ªæ•°æ®</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(dataset)) <span class="comment"># æ‰“å°æ•°æ®é›†å¤§å°</span></span><br></pre></td></tr></table></figure><pre><code>(367, 126)42</code></pre><h2 id="DataLoader-æ•°æ®è¿­ä»£å™¨">DataLoader æ•°æ®è¿­ä»£å™¨</h2><p>PytorchåŠ è½½å’Œå¤„ç†æ•°æ®é›†çš„å¯è¿­ä»£å¯¹è±¡//</p><table><thead><tr><th style="text-align:center">å‚æ•°</th><th style="text-align:center">Default</th><th style="text-align:center">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center">dataset</td><td style="text-align:center">å¿…é€‰</td><td style="text-align:center">ç”¨äºåŠ è½½æ•°æ®çš„æ•°æ®é›†<br>å¿…é¡»æ˜¯torch.utils.data.Datasetçš„å­ç±»å®ä¾‹</td></tr><tr><td style="text-align:center">batch_size</td><td style="text-align:center">1</td><td style="text-align:center">æ¯ä¸ªbatchçš„æ ·æœ¬æ•°</td></tr><tr><td style="text-align:center">shuffle</td><td style="text-align:center">False</td><td style="text-align:center">æ˜¯å¦åœ¨æ¯ä¸ªepochå¼€å§‹æ—¶æ‰“ä¹±æ•°æ®</td></tr><tr><td style="text-align:center">sampler</td><td style="text-align:center">None</td><td style="text-align:center">å®šä¹‰ä»æ•°æ®é›†ä¸­æå–æ ·æœ¬çš„ç­–ç•¥<br>å¦‚æœæŒ‡å®šè¿™ä¸ªå‚æ•°ï¼Œåˆ™å¿½ç•¥shuffleå‚æ•°</td></tr><tr><td style="text-align:center">batch_sampler</td><td style="text-align:center">None</td><td style="text-align:center">ä¸samplerç±»ä¼¼ï¼Œä½†è¿”å›çš„æ˜¯ä¸€ä¸ªbatchçš„ç´¢å¼•<br>ä¸èƒ½ä¸batch_sizeã€shuffleã€sampleråŒæ—¶ä½¿ç”¨</td></tr><tr><td style="text-align:center">num_workers</td><td style="text-align:center">0</td><td style="text-align:center">ç”¨äºæ•°æ®åŠ è½½çš„å­è¿›ç¨‹æ•°</td></tr><tr><td style="text-align:center">collate_fn</td><td style="text-align:center">None</td><td style="text-align:center">å°†å¤šä¸ªæ ·æœ¬ç»„åˆæˆä¸€ä¸ªmini-batchçš„å‡½æ•°</td></tr><tr><td style="text-align:center">drop_last</td><td style="text-align:center">False</td><td style="text-align:center">å¦‚æœæ•°æ®é›†å¤§å°ä¸èƒ½è¢«batch_sizeæ•´é™¤ï¼Œæ˜¯å¦ä¸¢å¼ƒæœ€åä¸€ä¸ªä¸å®Œæ•´çš„batch</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line">data_loader = DataLoader(dataset,batch_size=<span class="number">5</span>,shuffle=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> data_loader:</span><br><span class="line">        <span class="built_in">print</span>(data)</span><br></pre></td></tr></table></figure><pre><code>[tensor([1866,  439,  970, 1378, 1416]), tensor([660, 159, 354, 554, 498])][tensor([2018, 1116, 1720,  812, 1500]), tensor([ 968,  556, 1302,  465, 1168])][tensor([2260, 1378, 1046, 1774, 1521]), tensor([648, 612, 514, 524, 375])][tensor([ 956,  962,  412, 1700,  978]), tensor([530, 542, 640, 904, 465])][tensor([1202, 1434, 1686, 1583, 3873]), tensor([1006,  598,  540,  844, 5041])][tensor([1402, 1824, 1580, 1422, 1638]), tensor([1414, 1454,  630,  570, 1044])][tensor([1944, 1390, 1408,  367, 1320]), tensor([592, 568, 864, 126, 364])][tensor([1983, 1844,  912, 1400, 1564]), tensor([482, 866, 501, 602, 514])][tensor([1144, 1594]), tensor([718, 494])]</code></pre>]]></content>
    
    
    <summary type="html">Pytorchä¸­çš„æ•°æ®å¤„ç†ç±»</summary>
    
    
    
    <category term="DLç¬”è®°" scheme="https://www.cclmsy.cc/categories/DL%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Pytorch" scheme="https://www.cclmsy.cc/tags/Pytorch/"/>
    
  </entry>
  
  <entry>
    <title>DLç¬”è®°2|æ”¹å–„æ·±å±‚ç¥ç»ç½‘ç»œ</title>
    <link href="https://www.cclmsy.cc/posts/deep_learning_2.html"/>
    <id>https://www.cclmsy.cc/posts/deep_learning_2.html</id>
    <published>2025-02-20T16:00:00.000Z</published>
    <updated>2025-07-20T12:54:24.596Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€ç¥ç»ç½‘ç»œå®è·µç›¸å…³">ä¸€ã€ç¥ç»ç½‘ç»œå®è·µç›¸å…³</h2><h3 id="1-1-æ•°æ®é›†åˆ’åˆ†">1.1 æ•°æ®é›†åˆ’åˆ†</h3><p>æ•°æ®é›†ï¼š</p><ul><li>è®­ç»ƒé›†ï¼ˆTraining Setï¼‰ï¼šç”¨äºæ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹</li><li>éªŒè¯é›†ï¼ˆValidation Setï¼‰ï¼šåˆ©ç”¨éªŒè¯é›†ï¼ˆåˆç§°ä¸ºç®€å•äº¤å‰éªŒè¯é›†ï¼Œhold-out cross validation setï¼‰è¿›è¡Œäº¤å‰éªŒè¯ï¼Œé€‰æ‹©å‡ºæœ€å¥½çš„æ¨¡å‹</li><li>æµ‹è¯•é›†ï¼ˆTest Setï¼‰ï¼šç”¨äºè¯„ä¼°æ¨¡å‹çš„èƒ½åŠ›</li></ul><p>æ•°æ®é›†åˆ’åˆ†æ¯”ä¾‹ï¼š</p><ul><li>å°æ•°æ®é‡ï¼ˆå°äº10ä¸‡ï¼‰æ¯”ä¾‹ï¼šæ— éªŒè¯é›†7:3ï¼Œæœ‰éªŒè¯é›†6:2:2</li><li>å¤§æ•°æ®é‡æ¯”ä¾‹ï¼š98:1:1ã€99.5:0.25:0.25ã€99.5:0.4:0.1</li></ul><h3 id="1-2-åå·®å’Œæ–¹å·®">1.2 åå·®å’Œæ–¹å·®</h3><p>â€œåå·®-æ–¹å·®åˆ†è§£â€ï¼ˆbias-variance decompositionï¼‰æ˜¯è§£é‡Šå­¦ä¹ ç®—æ³•æ³›åŒ–æ€§èƒ½çš„ä¸€ç§é‡è¦å·¥å…·ã€‚</p><p>æ³›åŒ–è¯¯å·®å¯åˆ†è§£ä¸ºåå·®ã€æ–¹å·®ä¸å™ªå£°ï¼Œæ³›åŒ–æ€§èƒ½æ˜¯ç”±å­¦ä¹ ç®—æ³•çš„èƒ½åŠ›ã€æ•°æ®çš„å……åˆ†æ€§ä»¥åŠå­¦ä¹ ä»»åŠ¡æœ¬èº«çš„éš¾åº¦æ‰€å…±åŒå†³å®šçš„ã€‚</p><ul><li>åå·®ï¼ˆBiasï¼‰ï¼šåº¦é‡å­¦ä¹ ç®—æ³•çš„æœŸæœ›é¢„æµ‹ä¸çœŸå®ç»“æœçš„åç¦»ç¨‹åº¦ï¼Œåæ˜ äº†<strong>æ¨¡å‹æœ¬èº«çš„æ‹Ÿåˆèƒ½åŠ›</strong></li><li>æ–¹å·®ï¼ˆVarianceï¼‰ï¼šåº¦é‡åŒæ ·å¤§å°çš„è®­ç»ƒé›†çš„å˜åŠ¨æ‰€å¯¼è‡´çš„å­¦ä¹ æ€§èƒ½çš„å˜åŒ–ï¼Œåæ˜ äº†<strong>æ¨¡å‹çš„ç¨³å®šæ€§</strong></li><li>å™ªå£°ï¼šå½“å‰ä»»åŠ¡ä¸‹ä»»ä½•å­¦ä¹ ç®—æ³•æ‰€èƒ½è¾¾åˆ°çš„æœŸæœ›æ³›åŒ–è¯¯å·®çš„ä¸‹ç•Œï¼Œåæ˜ äº†<strong>é—®é¢˜æœ¬èº«çš„éš¾åº¦</strong></li></ul><p>åå·®ã€æ–¹å·®ä¸æ•°æ®é›†åˆ’åˆ†çš„å…³ç³»åŠè§£å†³æ–¹æ³•ï¼š</p><ol><li>è®­ç»ƒé›†é”™è¯¯ç‡å°ã€æµ‹è¯•é›†é”™è¯¯ç‡å¤§ï¼šé«˜æ–¹å·®ï¼Œå¯èƒ½å‡ºç°äº†<strong>è¿‡æ‹Ÿåˆ</strong><ul><li>å¢å¤§æ•°æ®é›†ï¼Œä½¿è®­ç»ƒå°½å¯èƒ½åŒ…å«æ‰€æœ‰æƒ…å†µ</li><li>å¯»æ‰¾æ›´åˆé€‚çš„ç½‘ç»œç»“æ„</li><li>æ­£åˆ™åŒ–</li></ul></li><li>è®­ç»ƒé›†é”™è¯¯ç‡å¤§ã€æµ‹è¯•é›†é”™è¯¯ç‡å¤§ï¼šé«˜åå·®ï¼Œå¯èƒ½å‡ºç°äº†<strong>æ¬ æ‹Ÿåˆ</strong><ul><li>æ‰©å¤§ç½‘ç»œè§„æ¨¡ï¼Œä¾‹å¦‚å¢åŠ éšè—å±‚æˆ–ç¥ç»å…ƒæ•°é‡</li><li>å¯»æ‰¾æ›´åˆé€‚çš„ç½‘ç»œç»“æ„ï¼Œä½¿ç”¨æ›´å¤§çš„ç½‘ç»œ</li><li>å¢åŠ è®­ç»ƒæ—¶é—´ã€è¿­ä»£æ¬¡æ•°</li></ul></li><li>è®­ç»ƒé›†é”™è¯¯ç‡å°ã€æµ‹è¯•é›†é”™è¯¯ç‡å°ï¼šæ–¹å·®å’Œåå·®éƒ½å°ï¼Œæ¨¡å‹æ•ˆæœè¾ƒå¥½</li></ol><h3 id="1-3-é€»è¾‘å›å½’çš„L1å’ŒL2æ­£åˆ™åŒ–">1.3 é€»è¾‘å›å½’çš„L1å’ŒL2æ­£åˆ™åŒ–</h3><p><strong>æ­£åˆ™åŒ–ï¼ˆRegularizationï¼‰</strong>ï¼šåœ¨æˆæœ¬å‡½æ•°ä¸­åŠ å…¥ä¸€ä¸ªæ­£åˆ™åŒ–é¡¹ï¼ˆæƒ©ç½šé¡¹ï¼‰ï¼Œæƒ©ç½šæ¨¡å‹çš„å¤æ‚åº¦ï¼Œé˜²æ­¢ç½‘ç»œè¿‡æ‹Ÿåˆ</p><p>é€»è¾‘å›å½’ä¸­ï¼Œå‚æ•°$W$çš„æ•°é‡ç”±ç‰¹å¾æ•°å†³å®šï¼Œæ­£åˆ™åŒ–å¦‚ä¸‹ï¼š</p><ul><li>L1æ­£åˆ™åŒ–ï¼š$J(W,b) = \dfrac{1}{m}\sum\limits_{i=1}^{m}L(\hat{y}^{(i)},y^{(i)})+\dfrac{\lambda}{2m}||W||_1$</li><li>L2æ­£åˆ™åŒ–ï¼š$J(W,b) = \dfrac{1}{m}\sum\limits_{i=1}^{m}L(\hat{y}^{(i)},y^{(i)})+\dfrac{\lambda}{2m}||W||_2^2$<ul><li>L2èŒƒæ•°ï¼š$\dfrac{\lambda}{2m}||W||<em>2^2 = \dfrac{\lambda}{2m}\sum\limits</em>{i=1}^{n}W_i^2=\dfrac{\lambda}{2m}W^TW$</li><li>è§£é‡Šï¼šæ‰€æœ‰Wå‚æ•°çš„å¹³æ–¹å’Œ</li></ul></li></ul><p>æ­£åˆ™åŒ–å› å­$\lambda$ï¼šè¶…å‚æ•°ï¼Œæ§åˆ¶æ­£åˆ™åŒ–é¡¹çš„æƒé‡ï¼Œ$\lambda$è¶Šå¤§ï¼Œæ­£åˆ™åŒ–é¡¹çš„å½±å“è¶Šå¤§ï¼Œæ¨¡å‹è¶Šç®€å•ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆã€‚</p><p>L1æ­£åˆ™åŒ–åï¼Œ$W$çš„æŸäº›å‚æ•°ä¼šå˜ä¸º0ï¼Œä½¿æ¨¡å‹å˜ç¨€ç–ï¼Œå› æ­¤L2æ­£åˆ™åŒ–æ›´å¸¸ç”¨ã€‚</p><p>æ¢¯åº¦ä¸‹é™çš„ç›®çš„æ˜¯å‡å°æŸå¤±å‡½æ•°$J(W,b)$å€¼çš„å¤§å°ã€‚<br>åœ¨æŸå¤±å‡½æ•°ä¸­å¢åŠ äº†ä¸€é¡¹ï¼Œå¯¼è‡´$dW$å¢å¤§ï¼Œ$W$å‡å°çš„æ›´å¤šï¼ˆå¤šå‡å»ä¸€é¡¹ï¼‰ï¼Œå› æ­¤L2èŒƒæ•°ä¹Ÿç§°ä¸ºæƒé‡è¡°å‡ï¼ˆWeight Decayï¼‰ã€‚</p><h3 id="1-4-ç¥ç»ç½‘ç»œä¸­çš„L2æ­£åˆ™åŒ–ã€FrobeniusèŒƒæ•°">1.4 ç¥ç»ç½‘ç»œä¸­çš„L2æ­£åˆ™åŒ–ã€FrobeniusèŒƒæ•°</h3><p>å¯¹æ¯ä¸€å±‚çš„æƒé‡çŸ©é˜µ$W^{[l]}$è¿›è¡Œæ­£åˆ™åŒ–ï¼Œæ¯ä¸€å±‚éƒ½æœ‰è‹¥å¹²ä¸ªæƒé‡ï¼Œå¯ä»¥ç†è§£ä¸ºçŸ©é˜µ</p><p>$$<br>J(W^{[1]},b^{[1]},â€¦,W^{[L]},b^{[L]}) = \dfrac{1}{m}\sum\limits_{i=1}^{m}L(\hat{y}^{(i)},y^{(i)})+\dfrac{\lambda}{2m}\sum\limits_{l=1}^{L}||W^{[l]}||_F^2<br>$$</p><p>å…¶ä¸­ï¼Œ$||W^{[l]}||_F^2$ä¸ºFrobeniusèŒƒæ•°ï¼Œè¡¨ç¤ºçŸ©é˜µçš„æ‰€æœ‰å…ƒç´ çš„å¹³æ–¹å’Œã€‚</p><h3 id="1-5-æ­£åˆ™åŒ–å‡å°‘è¿‡æ‹Ÿåˆçš„åŸç†">1.5 æ­£åˆ™åŒ–å‡å°‘è¿‡æ‹Ÿåˆçš„åŸç†</h3><p>æ­£åˆ™åŒ–å› å­è®¾ç½®çš„è¶³å¤Ÿå¤§çš„æƒ…å†µä¸‹ï¼Œä¸ºäº†ä½¿æŸå¤±å‡½æ•°æœ€å°åŒ–ï¼Œæƒé‡çŸ©é˜µä¼šè¶‹å‘äº0ï¼Œå‰Šå¼±éšè—å±‚å½±å“ï¼Œä½¿å¾—æ¨¡å‹å˜å¾—ç®€å•ã€‚</p><p>é€‰å–ä¸€ä¸ªé€‚åˆçš„$\lambda$ï¼Œå¯ä»¥ä½¿å¾—æ¨¡å‹çš„å¤æ‚åº¦é€‚ä¸­ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆã€‚</p><h3 id="1-6-Dropoutæ­£åˆ™åŒ–">1.6 Dropoutæ­£åˆ™åŒ–</h3><p>Dropoutæ­£åˆ™åŒ–ï¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œéšæœºå…³é—­ä¸€äº›ç¥ç»å…ƒï¼Œå‡å°‘ç¥ç»å…ƒä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆã€‚</p><p>Inverted Dropoutï¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¯¹æ¯ä¸€å±‚çš„ç¥ç»å…ƒï¼Œä»¥æ¦‚ç‡$keep_prob$ä¿ç•™ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">keep_prob = <span class="number">0.8</span>  <span class="comment"># ä¿ç•™æ¦‚ç‡</span></span><br><span class="line">dl = np.random.rand(A.shape[<span class="number">0</span>], A.shape[<span class="number">1</span>]) &lt; keep_prob  </span><br><span class="line">A = np.multiply(A, dl)  <span class="comment"># ä¿ç•™ç¥ç»å…ƒ</span></span><br><span class="line"></span><br><span class="line"> éƒ¨åˆ†ç¥ç»å…ƒè¢«å…³é—­ï¼ŒæœŸæœ›å€¼é¢„è®¡ä¸‹é™ä¸ºåŸæ¥çš„$keep_prob$ï¼Œéœ€è¦ç¼©æ”¾æ¿€æ´»å€¼ä¿æŒæœŸæœ›å€¼ä¸å˜</span><br><span class="line">A = A / keep_prob </span><br></pre></td></tr></table></figure><p>åŠ å…¥äº†Droupoutåï¼Œè¾“å…¥çš„ç‰¹å¾éƒ½å­˜åœ¨è¢«éšæœºæ¸…é™¤çš„å¯èƒ½ï¼Œæ‰€ä»¥è¯¥ç¥ç»å…ƒä¸ä¼šå†ç‰¹åˆ«ä¾èµ–äºä»»ä½•ä¸€ä¸ªè¾“å…¥ç‰¹å¾ã€‚<br>é€šè¿‡ä¼ æ’­è¿‡ç¨‹ï¼ŒDropoutå°†äº§ç”Ÿå’ŒL2æ­£åˆ™åŒ–ç›¸åŒçš„æ”¶ç¼©æƒé‡çš„æ•ˆæœã€‚</p><p>å¯¹äºç¥ç»å…ƒè¾ƒå¤šçš„å±‚ï¼Œè®¾ç½®è¾ƒå°çš„keep_probï¼Œå¯¹äºç¥ç»å…ƒè¾ƒå°‘çš„å±‚ï¼Œè®¾ç½®keep_prob=1ã€‚</p><p>åœ¨CVé¢†åŸŸï¼Œå›¾åƒå…·æœ‰æ›´å¤šçš„ç‰¹å¾ï¼ŒDropoutæ˜¯ä¸€ç§éå¸¸æœ‰æ•ˆçš„æ­£åˆ™åŒ–æ–¹æ³•ã€‚</p><p>ç¼ºç‚¹ï¼š</p><ol><li>å› ä¸ºæ¯æ¬¡ä¼šéšæœºæ¶ˆé™¤ä¸€éƒ¨åˆ†ç¥ç»å…ƒï¼Œæˆæœ¬å‡½æ•°æ— æ³•è¢«æ˜ç¡®å®šä¹‰</li><li>å‚æ•°æ— æ³•ç¡®å®šå…·ä½“æ˜¯å“ªäº›ï¼Œåœ¨åå‘ä¼ æ’­çš„æ—¶å€™å¸¦æ¥è®¡ç®—ä¸Šçš„éº»çƒ¦ï¼Œæ— æ³•ä¿è¯å½“å‰ç½‘ç»œæ˜¯å¦æŸå¤±å‡½æ•°ä¸‹é™çš„</li></ol><h3 id="1-7-å…¶ä»–æ­£åˆ™åŒ–æ–¹æ³•">1.7 å…¶ä»–æ­£åˆ™åŒ–æ–¹æ³•</h3><h4 id="æ—©åœæ­¢æ³•ï¼ˆEarly-Stoppingï¼‰">æ—©åœæ­¢æ³•ï¼ˆEarly Stoppingï¼‰</h4><p>å¦‚æœè®­ç»ƒè¿­ä»£çš„æ¬¡æ•°è¿‡é«˜ï¼Œä¼šå‘ç”Ÿè¿‡æ‹Ÿåˆï¼ŒæŸå¤±å‡½æ•°å›¾åƒå¦‚ä¸‹ï¼š</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E6%97%A9%E5%81%9C%E6%AD%A2%E6%B3%95.png" alt="æ—©åœæ­¢æ³•"></p><p>æ—©åœæ­¢æ³•ï¼šåœ¨æµ‹è¯•é›†ä¸Šçš„æŸå¤±å‡å°‘åˆ°ä¸€å®šç¨‹åº¦åï¼Œåœæ­¢è®­ç»ƒï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆã€‚</p><p>è¿™ç§æ–¹æ³•æ²»æ ‡ä¸æ²»æœ¬ï¼Œè¿˜æ˜¯éœ€è¦ä»æ ¹æœ¬ä¸Šè§£å†³æ•°æ®æˆ–æ¨¡å‹çš„é—®é¢˜ã€‚</p><h4 id="æ•°æ®å¢å¼ºï¼ˆData-Augmentationï¼‰">æ•°æ®å¢å¼ºï¼ˆData Augmentationï¼‰</h4><p>ç®—æ³•åœ¨å­¦ä¹ åŒºåˆ†ä¸¤ç§ç±»åˆ«æ—¶ï¼Œå¯èƒ½ä¼šå¯»æ‰¾åˆ°ä¸€ä¸ªæœ€æ˜æ˜¾çš„ç‰¹å¾ã€‚</p><p>ä¾‹å¦‚åœ¨åŒºåˆ†ä¸¤ç§ä¸åŒå‹å·çš„è½¦æ—¶ï¼Œå¦‚æœè®­ç»ƒé›†ä¸­ï¼Œå‹å·1çš„è½¦éƒ½æœå·¦ï¼Œå‹å·2çš„è½¦éƒ½æœå³ï¼Œé‚£ä¹ˆæ¨¡å‹å¯èƒ½ä¼šè®¤ä¸ºè½¦çš„æœå‘æ˜¯åŒºåˆ†ä¸¤ç§è½¦çš„æœ€é‡è¦ç‰¹å¾ã€‚<br>åœ¨æµ‹è¯•é›†ä¸­ï¼Œå¦‚æœå‡ºç°äº†æœå³çš„å‹å·1è½¦ï¼Œæ¨¡å‹å¯èƒ½è®¤ä¸ºæ˜¯å‹å·2è½¦ã€‚<br>å› æ­¤ï¼Œéœ€è¦å‡å°‘æ•°æ®é›†ä¸­ä¸ç›¸å…³çš„ç‰¹å¾çš„æ•°é‡ã€‚</p><p>æ•°æ®å¢å¼ºï¼šé€šè¿‡å¯¹è®­ç»ƒé›†è¿›è¡Œä¸€ç³»åˆ—çš„éšæœºå˜æ¢ï¼ˆå¦‚å‰ªåˆ‡ã€æ—‹è½¬ã€ç¿»è½¬ã€ç¼©æ”¾ç­‰ï¼‰ï¼Œå¢åŠ è®­ç»ƒé›†çš„æ ·æœ¬æ•°é‡ï¼Œæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</p><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¯ä»¥é€šè¿‡æ°´å¹³ç¿»è½¬å›¾åƒï¼Œä»¥é˜²æ­¢æ¨¡å‹å­¦ä¹ åˆ°ä¸ç›¸å…³çš„æ¨¡å¼ã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E6%95%B0%E6%8D%AE%E5%A2%9E%E5%BC%BA.png" alt="æ•°æ®å¢å¼º"></p><ul><li>ç¦»çº¿å¢å¼ºï¼šé¢„å…ˆè¿›è¡Œæ‰€æœ‰çš„å¿…è¦è½¬æ¢ï¼Œä»æ ¹æœ¬ä¸Šå¢å¤§æ•°æ®é›†è§„æ¨¡ï¼ˆå¦‚æ°´å¹³ç¿»è½¬åï¼Œä¿å­˜ä¸ºæ–°çš„å›¾åƒï¼Œæ•°æ®é›†å¢å¤§ä¸ºåŸæ¥çš„ä¸¤å€ï¼‰</li><li>åœ¨çº¿å¢å¼ºï¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¯¹å³å°†è¾“å…¥æ¨¡å‹çš„å°æ‰¹é‡æ•°æ®è¿›è¡Œç›¸åº”å˜æ¢ï¼ŒåŒä¸€å¼ å›¾æ¯æ¬¡è®­ç»ƒè¢«éšæœºæ‰§è¡Œä¸€äº›å˜åŒ–æ“ä½œï¼Œç›¸å½“äºä¸åŒæ•°æ®é›†</li></ul><p>æ•°æ®å¢å¼ºçš„æ•ˆæœå¦‚ä¸‹</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E6%95%B0%E6%8D%AE%E5%A2%9E%E5%BC%BA%E7%9A%84%E6%95%88%E6%9E%9C.png" alt="æ•°æ®å¢å¼ºçš„æ•ˆæœ"></p><h3 id="1-8-æ­£åˆ™åŒ–è¾“å…¥">1.8 æ­£åˆ™åŒ–è¾“å…¥</h3><p>å¯¹äºè¾“å…¥æ•°æ®è¿›è¡Œæ­£åˆ™åŒ–å¤„ç†ï¼Œä½¿æ•°æ®éƒ½æœä»åŒä¸€åˆ†å¸ƒï¼Œèƒ½å¤Ÿç¼“è§£æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸é—®é¢˜ï¼Œå¹¶ä¸”åŠ é€Ÿç®—æ³•çš„æ”¶æ•›ã€‚</p><ul><li>æ­£åˆ™åŒ–å…¬å¼ï¼š$X = \dfrac{X-\mu}{\sigma}$ï¼Œå…¶ä¸­$\mu$ä¸ºå‡å€¼ï¼Œ$\sigma$ä¸ºæ ‡å‡†å·®</li></ul><h3 id="1-9-æ¢¯åº¦æ¶ˆå¤±ä¸æ¢¯åº¦çˆ†ç‚¸">1.9 æ¢¯åº¦æ¶ˆå¤±ä¸æ¢¯åº¦çˆ†ç‚¸</h3><p>ç”±äºé“¾å¼æ³•åˆ™æ˜¯ä¸€ä¸ªè¿ä¹˜çš„è¿‡ç¨‹ï¼Œå½“å±‚æ•°è¶Šæ·±æ—¶ï¼Œæ¢¯åº¦ä»¥æŒ‡æ•°é€Ÿåº¦å¢é•¿ä¼ æ’­ã€‚</p><ul><li>æ¢¯åº¦æ¶ˆå¤±ï¼šæ¢¯åº¦å°äº1ï¼Œå¤šæ¬¡è¿ä¹˜åï¼Œæ¢¯åº¦è¶‹è¿‘äº0ï¼Œå¯¼è‡´å‚æ•°å‡ ä¹ä¸æ›´æ–°ã€æ¨¡å‹éš¾æ”¶æ•›</li><li>æ¢¯åº¦çˆ†ç‚¸ï¼šæ¢¯åº¦å¤§äº1ï¼Œå¤šæ¬¡è¿ä¹˜åï¼Œæ¢¯åº¦è¶‹è¿‘äºæ— ç©·ï¼Œå¯¼è‡´å‚æ•°æ›´æ–°è¿‡å¤§ç”šè‡³æº¢å‡º</li></ul><p>å±€éƒ¨æœ€ä¼˜è§£ï¼šæŸå¤±å‡½æ•°å¯èƒ½å­˜åœ¨éç‚¹/å±€éƒ¨æœ€å°å€¼</p><ul><li>è¾ƒå¤§çš„ç¥ç»ç½‘ç»œï¼Œå±€éƒ¨æœ€ä¼˜è§£çš„å¯èƒ½æ€§è¾ƒå°</li><li>éç‚¹é™„è¿‘çš„å¹³ç¨³æ®µä¼šä½¿å¾—å­¦ä¹ éå¸¸ç¼“æ…¢ï¼Œéœ€è¦ä¼˜åŒ–ç®—æ³•åŠ é€Ÿå­¦ä¹ </li></ul><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E5%B1%80%E9%83%A8%E6%9C%80%E4%BC%98%E8%A7%A3.gif" alt="å±€éƒ¨æœ€ä¼˜è§£"></p><p>è§£å†³æ–¹æ³•ï¼š</p><ol><li>åˆå§‹åŒ–å‚æ•°ç­–ç•¥ï¼šå°†æƒé‡åˆå§‹åŒ–ä¸ºè¾ƒå°çš„éšæœºæ•°</li><li>æ‰¹æ¢¯åº¦ä¸‹é™ã€Mini-batchæ¢¯åº¦ä¸‹é™ã€éšæœºæ¢¯åº¦ä¸‹é™</li><li>æ¢¯åº¦ä¸‹é™ç®—æ³•å†…éƒ¨ä¼˜åŒ–ï¼šåŠ¨é‡æ¢¯åº¦ä¸‹é™ã€RMSPropç®—æ³•ã€Adamç®—æ³•</li><li>å­¦ä¹ ç‡è¡°å‡</li><li>æ ‡å‡†åŒ–è¾“å…¥</li></ol><h3 id="1-10-æƒé‡åˆå§‹åŒ–">1.10 æƒé‡åˆå§‹åŒ–</h3><p>ä¸ºäº†é¿å…å¯¹ç§°æ€§ï¼Œæƒé‡åˆå§‹åŒ–ä¸èƒ½å…¨ä¸º0ï¼Œé€šå¸¸ä½¿ç”¨è¾ƒå°çš„éšæœºæ•°è¿›è¡Œåˆå§‹åŒ–ã€‚</p><p>åœ¨é€»è¾‘å›å½’çš„ç¬”è®°ä¸­ï¼Œæƒé‡åˆå§‹åŒ–ä¸º<code>np.random.randn(k, n) * 0.01</code>ã€‚</p><p>Xavieråˆå§‹åŒ–ï¼š$w^{[l]} = np.random.randn(k, n) \times \sqrt{\dfrac{1}{n^{[l-1]}}}$ï¼Œå…¶ä¸­$n^{[l-1]}$ä¸ºä¸Šä¸€å±‚çš„ç¥ç»å…ƒæ•°é‡ã€‚</p><p>å¦‚æœä½¿ç”¨ReLUæ¿€æ´»å‡½æ•°ï¼Œæƒé‡åˆå§‹åŒ–ä¸º $w^{[l]} = np.random.randn(k, n) \times \sqrt{\dfrac{2}{n^{[l-1]}}}$ã€‚</p><h2 id="äºŒã€ä¼˜åŒ–ç®—æ³•">äºŒã€ä¼˜åŒ–ç®—æ³•</h2><h3 id="2-1-æ‰¹æ¢¯åº¦ä¸‹é™ã€Mini-batchæ¢¯åº¦ä¸‹é™ã€éšæœºæ¢¯åº¦ä¸‹é™">2.1 æ‰¹æ¢¯åº¦ä¸‹é™ã€Mini-batchæ¢¯åº¦ä¸‹é™ã€éšæœºæ¢¯åº¦ä¸‹é™</h3><p>æ‰¹æ¢¯åº¦ä¸‹é™ï¼ˆBatch Gradient Descentï¼‰ï¼šåŒæ—¶å¤„ç†æ•´ä¸ªè®­ç»ƒé›†</p><ul><li>åœ¨æ›´æ–°å‚æ•°å‰ï¼Œå¿…é¡»å…ˆå¤„ç†æ•´ä¸ªè®­ç»ƒå‚æ•°é›†ï¼Œæ‰èƒ½è¿›è¡Œä¸€æ­¥æ¢¯åº¦ä¸‹é™</li><li>å¦‚æœè®­ç»ƒé›†å¾ˆå¤§ï¼Œè®¡ç®—é‡ä¼šå¾ˆå¤§ï¼Œè®­ç»ƒé€Ÿåº¦å¾ˆæ…¢</li><li>å™ªå£°ä½ï¼Œä»£ä»·å‡½æ•°å€¼å¹³æ»‘å‡å°</li><li>è®­ç»ƒæ ·æœ¬çš„å¤§å°è¾ƒå°ï¼ˆå°äº2048ï¼‰æ—¶ï¼Œé€‰æ‹©Batchæ¢¯åº¦ä¸‹é™</li></ul><p>Mini-batchæ¢¯åº¦ä¸‹é™ï¼šå°†è®­ç»ƒé›†åˆ†ä¸ºå¤šä¸ªå›ºå®šå¤§å°çš„æ‰¹æ¬¡ï¼Œæ¯æ¬¡åªå¤„ç†ä¸€ä¸ªæ‰¹æ¬¡çš„æ•°æ®</p><ul><li>è®­ç»ƒæ ·æœ¬çš„å¤§å°è¾ƒå¤§æ—¶ï¼Œé€‰æ‹©Mini-batchæ¢¯åº¦ä¸‹é™ï¼Œé€šå¸¸ä¸º64ã€128ã€256ã€512ç­‰</li></ul><p>éšæœºæ¢¯åº¦ä¸‹é™ï¼ˆStochastic Gradient Descent, SGDï¼‰ï¼šmini-batchå¤§å°ä¸º1ï¼Œæ¯æ¬¡åªå¤„ç†ä¸€ä¸ªæ ·æœ¬</p><ul><li>è®­ç»ƒé€Ÿåº¦å¿«ï¼Œä½†ä¸¢å¤±äº†å‘é‡åŒ–ç¼–ç¨‹çš„ä¼˜åŠ¿</li><li>ä»£ä»·å‡½æ•°å€¼æ³¢åŠ¨å¤§ï¼Œå™ªå£°å¤§ï¼Œæ€»ä½“å‘å…¨å±€æœ€å°å€¼é è¿‘ï¼Œä½†éš¾ä»¥æ”¶æ•›ï¼Œå®¹æ˜“åœ¨éç‚¹éœ‡è¡</li></ul><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E4%BB%A3%E4%BB%B7%E5%87%BD%E6%95%B0%E5%80%BC%E5%8F%98%E5%8C%96%E8%B6%8B%E5%8A%BF.png" alt="æ¢¯åº¦ä¸‹é™ä»£ä»·å‡½æ•°å€¼å˜åŒ–è¶‹åŠ¿"></p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E4%BB%A3%E4%BB%B7%E5%87%BD%E6%95%B0%E5%80%BC%E5%8F%98%E5%8C%96%E8%B6%8B%E5%8A%BF2.png" alt="æ¢¯åº¦ä¸‹é™ä»£ä»·å‡½æ•°å€¼å˜åŒ–è¶‹åŠ¿2"></p><h3 id="2-2-æŒ‡æ•°åŠ æƒå¹³å‡">2.2 æŒ‡æ•°åŠ æƒå¹³å‡</h3><p>æŒ‡æ•°åŠ æƒå¹³å‡ï¼ˆExponentially Weight Averageï¼‰æ˜¯ä¸€ç§å¸¸ç”¨çš„åºåˆ—æ•°æ®å¤„ç†æ–¹å¼ï¼Œé€šå¸¸ç”¨åœ¨åºåˆ—åœºæ™¯ï¼Œå¦‚é‡‘èåºåˆ—åˆ†æã€æ¸©åº¦å˜åŒ–åºåˆ—åˆ†æã€‚</p><p>$$<br>S_t = \begin{cases}<br>x_t &amp;, t=1 \\<br>\beta S_{t-1}+(1-\beta)x_t &amp;, t&gt;1<br>\end{cases}<br>$$</p><p>ç†è§£ï¼šä¸Šä¸€ç»“æœçš„æƒé‡ä¸º$\beta$ï¼Œå½“å‰æ•°æ®çš„æƒé‡ä¸º$1-\beta$ã€‚</p><p>ä¸‹å›¾ï¼Œé»„è‰²$\beta=0.5$ï¼Œçº¢è‰²$\beta=0.9$ï¼Œç»¿è‰²$\beta=0.98$</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E6%8C%87%E6%95%B0%E5%8A%A0%E6%9D%83%E5%B9%B3%E5%9D%87.png" alt="æŒ‡æ•°åŠ æƒå¹³å‡"></p><h3 id="2-3-åŠ¨é‡æ¢¯åº¦ä¸‹é™">2.3 åŠ¨é‡æ¢¯åº¦ä¸‹é™</h3><p>åŠ¨é‡æ¢¯åº¦ä¸‹é™ï¼ˆMomentum Gradient Descentï¼‰ï¼šåˆ©ç”¨æ¢¯åº¦çš„æŒ‡æ•°åŠ æƒå¹³å‡æ¥æ›´æ–°å‚æ•°</p><p>$$<br>\begin{split}<br>&amp;S_{dW} = \beta S_{dW}+(1-\beta)dW \\<br>&amp;S_{db} = \beta S_{db}+(1-\beta)db \\<br>&amp;W = W-\alpha S_{dW} \\<br>&amp;b = b-\alpha S_{db}<br>\end{split}<br>$$</p><p>åˆ©ç”¨ç´¯åŠ çš„æ¢¯åº¦å€¼ï¼Œå‡å°‘æ¢¯åº¦ä¸‹é™çš„éœ‡è¡ï¼ŒåŠ é€Ÿæ”¶æ•›</p><ul><li>å‰åæ¢¯åº¦æ–¹å‘ä¸ä¸€è‡´æ—¶ï¼Œæ¢¯åº¦å€¼å‡å°ï¼Œå‡å°‘éœ‡è¡</li><li>å‰åæ¢¯åº¦æ–¹å‘ä¸€è‡´æ—¶ï¼Œæ¢¯åº¦å€¼å¢å¤§ï¼ŒåŠ é€Ÿæ”¶æ•›</li></ul><h3 id="2-2-5-RMSPropç®—æ³•">2.2.5 RMSPropç®—æ³•</h3><p>RMSPropç®—æ³•ï¼ˆRoot Mean Square Propagationï¼‰ï¼šå†å¯¹æ¢¯åº¦è¿›è¡ŒæŒ‡æ•°åŠ æƒå¹³å‡çš„åŸºç¡€ä¸Šï¼Œå¼•å…¥å¹³æ–¹å’Œå¹³æ–¹æ ¹</p><p>$$<br>\begin{split}<br>&amp;S_{dW} = \beta S_{dW}+(1-\beta)dW^2 \\<br>&amp;S_{db} = \beta S_{db}+(1-\beta)db^2 \\<br>&amp;W = W-\alpha \dfrac{dW}{\sqrt{S_{dW}+\epsilon}} \\<br>&amp;b = b-\alpha \dfrac{db}{\sqrt{S_{db}+\epsilon}}<br>\end{split}<br>$$</p><p>å…¶ä¸­ï¼Œ$\epsilon$æ˜¯ä¸€ä¸ªå¾ˆå°çš„æ•°ï¼Œé¿å…åˆ†æ¯è¿‡å°å¯¼è‡´æ•°å€¼ä¸ç¨³å®šã€‚</p><p>RMSProp æœ‰åŠ©äºå‡å°‘æŠµè¾¾æœ€å°å€¼è·¯å¾„ä¸Šçš„æ‘†åŠ¨ï¼Œå¹¶å…è®¸ä½¿ç”¨ä¸€ä¸ªæ›´å¤§çš„å­¦ä¹ ç‡$\alpha$ï¼ŒåŠ å¿«ç®—æ³•å­¦ä¹ é€Ÿåº¦ã€‚</p><h3 id="2-2-6-Adamç®—æ³•">2.2.6 Adamç®—æ³•</h3><p>Adamç®—æ³•ï¼ˆAdaptive Moment Estimationï¼Œè‡ªé€‚åº”çŸ©ä¼°è®¡ï¼‰ï¼šç»“åˆäº†Momentumå’ŒRMSPropç®—æ³•ï¼ŒåŒæ—¶è€ƒè™‘æ¢¯åº¦çš„ä¸€é˜¶çŸ©ä¼°è®¡å’ŒäºŒé˜¶çŸ©ä¼°è®¡</p><p>å‡è®¾ç”¨ä¸€ä¸ªmini-batchè®¡ç®—$dW$å’Œ$db$ï¼Œç¬¬$t$æ¬¡è¿­ä»£æ—¶ï¼Œè®¡ç®—åŠ¨é‡æ¢¯åº¦ç»“æœï¼š</p><p>$$<br>\begin{split}<br>&amp;V_{dW} = \beta_1 V_{dW}+(1-\beta_1)dW \\<br>&amp;V_{db} = \beta_1 V_{db}+(1-\beta_1)db \\<br>&amp;V_{dW}^{corrected} = \dfrac{V_{dW}}{1-\beta_1^t}<br>\end{split}<br>$$</p><p>è®¡ç®—RMSPropç»“æœï¼š</p><p>$$<br>\begin{split}<br>&amp;S_{dW} = \beta_2 S_{dW}+(1-\beta_2)dW^2 \\<br>&amp;S_{db} = \beta_2 S_{db}+(1-\beta_2)db^2 \\<br>&amp;S_{dW}^{corrected} = \dfrac{S_{dW}}{1-\beta_2^t}<br>\end{split}<br>$$</p><p>è®¡ç®—ç§»åŠ¨å¹³å‡æ•°æ—¶ï¼Œä½¿ç”¨ç³»æ•°$\dfrac{1}{1-\beta_1^t}$è¿›è¡Œä¿®æ­£ã€‚<br>ä¾‹å¦‚$m_0=0,m_1=0.9m_0+0.1m_1$ï¼Œå¯¼è‡´$m_1$çš„å€¼è¿‡å°ï¼Œä¿®æ­£åæ°å¥½ä¸º$m_1$çš„å€¼ã€‚<br>éšç€è¿­ä»£æ¬¡æ•°å¢åŠ ï¼Œä¿®æ­£ç³»æ•°è¶‹è¿‘äº1ï¼Œä¿è¯äº†ç§»åŠ¨å¹³å‡æ•°çš„å‡†ç¡®æ€§ã€‚</p><p>Adamç®—æ³•æ›´æ–°å‚æ•°ï¼š</p><p>$$<br>\begin{split}<br>&amp;W = W-\alpha \dfrac{V_{dW}^{corrected}}{\sqrt{S_{dW}^{corrected}}+\epsilon} \\<br>&amp;b = b-\alpha \dfrac{V_{db}^{corrected}}{\sqrt{S_{db}^{corrected}}+\epsilon}<br>\end{split}<br>$$</p><h3 id="2-2-7-å­¦ä¹ ç‡è¡°å‡">2.2.7 å­¦ä¹ ç‡è¡°å‡</h3><p>å¦‚æœéšç€æ—¶é—´æ…¢æ…¢å‡å°‘å­¦ä¹ ç‡$\alpha$çš„å¤§å°ï¼Œåœ¨åˆæœŸ$\alpha$è¾ƒå¤§æ—¶ï¼Œä¸‹é™çš„æ­¥é•¿è¾ƒå¤§ï¼Œèƒ½ä»¥è¾ƒå¿«çš„é€Ÿåº¦è¿›è¡Œæ¢¯åº¦ä¸‹é™ï¼›è€ŒåæœŸé€æ­¥å‡å°$\alpha$çš„å€¼ï¼Œå³å‡å°æ­¥é•¿ï¼Œæœ‰åŠ©äºç®—æ³•çš„æ”¶æ•›ï¼Œæ›´å®¹æ˜“æ¥è¿‘æœ€ä¼˜è§£ã€‚</p><p>æœ€å¸¸ç”¨çš„å­¦ä¹ ç‡è¡°å‡æ–¹æ³•ï¼š$\alpha = \dfrac{1}{1+decay_ rate \times epoch_ num} \times \alpha_0$</p><ul><li>$\alpha_0$ï¼šåˆå§‹å­¦ä¹ ç‡</li><li>$decay_ rate$ï¼šè¡°å‡ç‡ï¼Œè¶…å‚æ•°</li><li>$epoch_ num$ï¼šè¿­ä»£æ¬¡æ•°</li></ul><p>ä¸€ç§æŒ‡æ•°è¡°å‡å­¦ä¹ ç‡ï¼š$\alpha = 0.95^{epoch_ num} \times \alpha_0$</p><h2 id="ä¸‰ã€è¶…å‚æ•°è°ƒè¯•ã€Batchæ­£åˆ™åŒ–å’Œç¼–ç¨‹æ¡†æ¶">ä¸‰ã€è¶…å‚æ•°è°ƒè¯•ã€Batchæ­£åˆ™åŒ–å’Œç¼–ç¨‹æ¡†æ¶</h2><h3 id="3-1-ç¥ç»ç½‘ç»œè°ƒä¼˜">3.1 ç¥ç»ç½‘ç»œè°ƒä¼˜</h3><p>ç®—æ³•å±‚é¢ï¼š</p><ul><li>å­¦ä¹ ç‡$\alpha$</li><li>$\beta_1,\beta_2,\epsilon$ï¼šAdamç®—æ³•çš„è¶…å‚æ•°ï¼Œå¸¸ç”¨å€¼$\beta_1=0.9,\beta_2=0.999,\epsilon=10^{-8}$</li><li>æ­£åˆ™åŒ–å‚æ•°$\lambda$</li></ul><p>æ¨¡å‹å±‚é¢ï¼š</p><ul><li>hidden unitsï¼šéšè—å±‚ç¥ç»å…ƒæ•°</li><li>layersï¼šéšè—å±‚å±‚æ•°</li></ul><p>è°ƒå‚æŠ€å·§</p><ul><li>ç½‘æ ¼æœç´¢ï¼šéå†æ‰€æœ‰å¯èƒ½çš„å‚æ•°ç»„åˆï¼Œæµ‹è¯•æ¯ä¸€ç»„çš„æ•ˆæœï¼Œé€‰æ‹©æ•ˆæœæœ€å¥½çš„å‚æ•°ç»„åˆã€‚</li><li>å°½é‡è®©æ¯ä¸€ç»„å·®åˆ«æ˜æ˜¾ï¼Œé¿å…é‡å¤æµ‹è¯•</li><li>åˆç†çš„å‚æ•°è®¾ç½®ï¼šä¸ºè¶…å‚æ•°é€‰æ‹©åˆé€‚çš„èŒƒå›´<ul><li>å­¦ä¹ ç‡$\alpha$ï¼šé€šå¸¸è®¾ç½®ä¸º0.0001ã€0.001ã€0.01ã€0.1ç­‰</li><li>åŠ¨é‡æ¢¯åº¦å› å­$\beta$: é€šå¸¸è®¾ç½®ä¸º0.999ã€0.9995ã€0.9999ç­‰ï¼Œå°½å¯èƒ½æ¥è¿‘1ï¼ˆæŒ‡æ•°å¢åŠ æ•ˆåº”ï¼‰</li></ul></li></ul><p>é—®é¢˜ï¼šè°ƒå‚è¿‡ç¨‹éº»çƒ¦ã€è®­ç»ƒæ—¶é—´é•¿</p><h3 id="2-4-2-æ‰¹æ ‡å‡†åŒ–ï¼ˆæ‰¹æ ‡å‡†åŒ–ï¼‰">2.4.2 æ‰¹æ ‡å‡†åŒ–ï¼ˆæ‰¹æ ‡å‡†åŒ–ï¼‰</h3><p>è®ºæ–‡åœ°å€ï¼š<a href="https://arxiv.org/abs/1502.03167">æ‰¹æ ‡å‡†åŒ–: Accelerating Deep Network Training by Reducing Internal Covariate Shift</a></p><blockquote><p>è®­ç»ƒæ·±åº¦ç¥ç»ç½‘ç»œå¾ˆå¤æ‚ï¼Œå› ä¸ºåœ¨è®­ç»ƒæœŸé—´æ¯å±‚è¾“å…¥çš„åˆ†å¸ƒå‘ç”Ÿå˜åŒ–ï¼Œå› ä¸ºå‰ä¸€å±‚çš„å‚æ•°å‘ç”Ÿäº†å˜åŒ–ã€‚<br>è¿™é€šè¿‡è¦æ±‚è¾ƒä½çš„å­¦ä¹ ç‡å’Œä»”ç»†çš„å‚æ•°åˆå§‹åŒ–æ¥å‡æ…¢è®­ç»ƒé€Ÿåº¦ï¼Œå¹¶ä¸”ä½¿å¾—è®­ç»ƒå…·æœ‰é¥±å’Œéçº¿æ€§çš„æ¨¡å‹å˜å¾—éå¸¸å›°éš¾ã€‚<br>æˆ‘ä»¬å°†è¿™ç§ç°è±¡ç§°ä¸º<strong>å†…éƒ¨åå˜é‡åç§»</strong>ï¼Œå¹¶é€šè¿‡<strong>æ ‡å‡†åŒ–å±‚</strong>è¾“å…¥æ¥è§£å†³é—®é¢˜ã€‚<br>æˆ‘ä»¬çš„æ–¹æ³•çš„ä¼˜åŠ¿åœ¨äºä½¿æ ‡å‡†åŒ–æˆä¸ºæ¨¡å‹ä½“ç³»ç»“æ„çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸ºæ¯ä¸ªåŸ¹è®­å°æ‰¹é‡æ‰§è¡Œæ ‡å‡†åŒ–ã€‚<br>æ‰¹æ ‡å‡†åŒ–å…è®¸æˆ‘ä»¬ä½¿ç”¨æ›´é«˜çš„å­¦ä¹ ç‡å¹¶ä¸”ä¸å¤ªå…³å¿ƒåˆå§‹åŒ–ã€‚<br>å®ƒè¿˜å¯ä»¥å……å½“è°ƒèŠ‚å™¨ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥æ¶ˆé™¤å¯¹Dropoutçš„éœ€æ±‚ã€‚<br>åº”ç”¨äºæœ€å…ˆè¿›çš„å›¾åƒåˆ†ç±»æ¨¡å‹ï¼Œæ‰¹é‡æ ‡å‡†åŒ–å®ç°äº†ç›¸åŒçš„ç²¾åº¦ï¼ŒåŸ¹è®­æ­¥éª¤å‡å°‘äº†14å€ï¼Œå¹¶ä¸”æ˜¾ç€åœ°è¶…è¿‡äº†åŸå§‹æ¨¡å‹ã€‚<br>ä½¿ç”¨æ‰¹é‡æ ‡å‡†åŒ–ç½‘ç»œçš„é›†åˆï¼Œæˆ‘ä»¬æ”¹è¿›äº†ImageNetåˆ†ç±»çš„æœ€ä½³å‘å¸ƒç»“æœï¼šè¾¾åˆ°4.9ï¼…çš„å‰5ä¸ªéªŒè¯é”™è¯¯ï¼ˆå’Œ4.8ï¼…çš„æµ‹è¯•é”™è¯¯ï¼‰ï¼Œè¶…å‡ºäº†äººç±»è¯„ä¼°è€…çš„å‡†ç¡®æ€§ã€‚</p></blockquote><p>æ‰¹æ ‡å‡†åŒ–ï¼šåœ¨ç¥ç»ç½‘ç»œçš„æ¯ä¸€å±‚çš„<strong>æ¿€æ´»å‡½æ•°ä¹‹å‰</strong>ï¼Œå¯¹æ¯ä¸€å±‚çš„<strong>è¾“å…¥</strong>è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†ï¼Œä½¿å¾—æ¯ä¸€å±‚çš„è¾“å…¥æ•°æ®æœä»å‡å€¼ä¸º0ã€æ–¹å·®ä¸º1çš„æ­£æ€åˆ†å¸ƒã€‚</p><p>æ‰¹æ ‡å‡†åŒ–å…¬å¼ï¼š</p><p>$$<br>\begin{split}<br>&amp;\mu = \dfrac{1}{m}\sum\limits_{i=1}^{m}Z^{(i)} \\<br>&amp;\sigma^2 = \dfrac{1}{m}\sum\limits_{i=1}^{m}(Z^{(i)}-\mu)^2 \\<br>&amp;Z_{norm}^{(i)} = \dfrac{Z^{(i)}-\mu}{\sqrt{\sigma^2+\epsilon}}<br>\end{split}<br>$$</p><p>å…¶ä¸­ï¼Œ$\mu$ä¸ºå‡å€¼ï¼Œ$\sigma^2$ä¸ºæ–¹å·®ï¼Œ$\epsilon$ä¸ºä¸€ä¸ªå¾ˆå°çš„æ•°ï¼Œé¿å…åˆ†æ¯ä¸º0ã€‚</p><p>å¦‚æœå„éšè—å±‚çš„è¾“å…¥å‡å€¼åœ¨é è¿‘0çš„åŒºåŸŸï¼Œå³å¤„äºæ¿€æ´»å‡½æ•°çš„çº¿æ€§åŒºåŸŸï¼Œä¸åˆ©äºè®­ç»ƒéçº¿æ€§ç¥ç»ç½‘ç»œï¼Œä»è€Œå¾—åˆ°æ•ˆæœè¾ƒå·®çš„æ¨¡å‹ã€‚<br>å› æ­¤æ·»åŠ ä¸¤ä¸ªå¯å­¦ä¹ çš„å‚æ•°$\gamma$å’Œ$\beta$ï¼Œå¯¹æ ‡å‡†åŒ–åçš„æ•°æ®è¿›è¡Œç¼©æ”¾å’Œå¹³ç§»ã€‚</p><p>$$<br>\tilde{Z}^{(i)} = \gamma Z_{norm}^{(i)}+\beta<br>$$</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E6%89%B9%E6%A0%87%E5%87%86%E5%8C%96%E8%BF%87%E7%A8%8B.png" alt="æ‰¹æ ‡å‡†åŒ–è¿‡ç¨‹"></p><p>æ‰¹æ ‡å‡†åŒ–ä¼˜åŒ–è®­ç»ƒè¿‡ç¨‹çš„åŸç†ï¼š</p><p>æ•°æ®çš„åˆ†å¸ƒä¼šéšç€ä¸åŒæ•°æ®é›†æ”¹å˜ã€‚<br>ç½‘ç»œçš„å‚æ•°ä¼šå› è®­ç»ƒé›†æ•°æ®åˆ†å¸ƒçš„å˜åŒ–è€Œå˜åŒ–ï¼›æµ‹è¯•çš„æ•°æ®åˆ†å¸ƒä¸è®­ç»ƒé›†çš„æ•°æ®åˆ†å¸ƒä¸åŒï¼Œä¹Ÿä¼šå¯¼è‡´å‡†ç¡®æ€§ä¸‹é™ã€‚</p><p>æ‰¹æ ‡å‡†åŒ–çš„ä½œç”¨å°±æ˜¯å‡å°äº†æ•°æ®åˆ†å¸ƒçš„å˜åŒ–å¸¦æ¥çš„å½±å“ï¼Œè®©æ¨¡å‹æ›´å¥å£®ï¼Œé²æ£’æ€§æ›´å¼ºã€‚<br>å³ä½¿è¾“å…¥çš„å€¼æ”¹å˜ï¼Œç”±äºæ‰¹æ ‡å‡†åŒ–çš„ä½œç”¨ï¼Œå‡å€¼å’Œæ–¹å·®çš„å˜åŒ–ä¼šè¢«æ¶ˆé™¤ï¼Œåç»­çš„å­¦ä¹ æ›´åŠ å®¹æ˜“ã€‚<br>æ‰¹æ ‡å‡†åŒ–å‡å°‘äº†å„å±‚Wå’Œbä¹‹é—´çš„è€¦åˆæ€§ï¼Œè®©å„å±‚æ›´åŠ ç‹¬ç«‹ï¼Œå®ç°è‡ªæˆ‘è®­ç»ƒå­¦ä¹ çš„æ•ˆæœ</p><p>æ‰¹æ ‡å‡†åŒ–ä¹Ÿèµ·åˆ°å¾®å¼±çš„æ­£åˆ™åŒ–æ•ˆæœï¼Œä½†æ˜¯ä¸èƒ½å°†æ‰¹æ ‡å‡†åŒ–ä½œä¸ºæ­£åˆ™åŒ–çš„æ‰‹æ®µï¼Œè€Œæ˜¯å½“ä½œåŠ é€Ÿå­¦ä¹ çš„æ–¹å¼ã€‚<br>æ‰¹æ ‡å‡†åŒ– ä¸»è¦è§£å†³çš„è¿˜æ˜¯åå‘ä¼ æ’­è¿‡ç¨‹ä¸­çš„æ¢¯åº¦é—®é¢˜ï¼ˆæ¢¯åº¦æ¶ˆå¤±å’Œçˆ†ç‚¸ï¼‰ã€‚</p>]]></content>
    
    
    <summary type="html">è¶…å‚æ•°è°ƒè¯•ã€æ­£åˆ™åŒ–ä»¥åŠä¼˜åŒ–</summary>
    
    
    
    <category term="DLç¬”è®°" scheme="https://www.cclmsy.cc/categories/DL%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="https://www.cclmsy.cc/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>DLç¬”è®°1|ç¥ç»ç½‘ç»œå’Œæ·±åº¦å­¦ä¹ </title>
    <link href="https://www.cclmsy.cc/posts/deep_learning_1.html"/>
    <id>https://www.cclmsy.cc/posts/deep_learning_1.html</id>
    <published>2025-02-19T16:00:00.000Z</published>
    <updated>2025-07-20T12:54:25.950Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€æ·±åº¦å­¦ä¹ æ¦‚è®º">ä¸€ã€æ·±åº¦å­¦ä¹ æ¦‚è®º</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ">1.1 ä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ </h3><p>ç®€å•æ¥è¯´ï¼Œæ·±åº¦å­¦ä¹ ï¼ˆDeep Learningï¼‰å°±æ˜¯æ›´å¤æ‚çš„ç¥ç»ç½‘ç»œï¼ˆNeural Networkï¼‰</p><p>äººå·¥ç¥ç»ç½‘ç»œåŒ…å«ï¼šè¾“å…¥å±‚ã€éšè—å±‚ã€è¾“å‡ºå±‚ï¼Œæ¯å±‚åŒ…å«å¤šä¸ªç¥ç»å…ƒï¼Œæ¯ä¸ªç¥ç»å…ƒåŒ…å«æ¿€æ´»å‡½æ•°</p><p>ç¥ç»ç½‘ç»œéœ€è¦ä»å¤§é‡çš„æ•°æ®ä¸­å­¦ä¹ ï¼Œå­¦ä¹ çš„è¿‡ç¨‹å°±æ˜¯è°ƒæ•´ç½‘ç»œä¸­çš„å‚æ•°ï¼Œä½¿å¾—ç½‘ç»œçš„è¾“å‡ºç»“æœä¸å®é™…ç»“æœå°½å¯èƒ½æ¥è¿‘ã€‚</p><p>å­¦ä¹ çš„ç›®æ ‡æ˜¯ï¼Œå»ºç«‹èµ·ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°ï¼Œè¾“å…¥ä¸€äº›æ•°æ®å°±èƒ½è¾“å‡ºæƒ³è¦çš„ç»“æœã€‚</p><h3 id="1-2-æ·±åº¦å­¦ä¹ çš„åº”ç”¨">1.2 æ·±åº¦å­¦ä¹ çš„åº”ç”¨</h3><p>ç›‘ç£å­¦ä¹ ï¼ˆSupervised Learningï¼‰ä¸æ— ç›‘ç£å­¦ä¹ æœ¬è´¨åŒºåˆ«å°±æ˜¯ï¼šè®­ç»ƒæ ·æœ¬æ˜¯å¦å·²çŸ¥çš„è¾“å‡ºy</p><p>ä¸åŒçš„ä»»åŠ¡é€šå¸¸äº¤ç»™ä¸åŒçš„ç¥ç»ç½‘ç»œï¼š</p><ul><li>åˆ†ç±»/å›å½’ä»»åŠ¡ï¼šç¥ç»ç½‘ç»œï¼ˆNeural Network, NNï¼‰</li><li>å›¾åƒè¯†åˆ«ä»»åŠ¡ï¼šå·ç§¯ç¥ç»ç½‘ç»œï¼ˆConvolutional Neural Network, CNNï¼‰</li><li>æ–‡æœ¬/è¯­éŸ³ç­‰åºåˆ—ä»»åŠ¡ï¼šå¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Network, RNNï¼‰</li><li>ç”Ÿæˆä»»åŠ¡ï¼šç”Ÿæˆå¯¹æŠ—ç½‘ç»œï¼ˆGenerative Adversarial Network, GANï¼‰</li></ul><p>æœºå™¨å­¦ä¹ åº”ç”¨äºç»“æ„åŒ–æ•°æ®ï¼ˆStructured Dataï¼‰å’Œéç»“æ„åŒ–æ•°æ®ï¼ˆUnstructured Dataï¼‰</p><ul><li>ç»“æ„åŒ–æ•°æ®ï¼šæ•°æ®çš„æ•°æ®åº“ï¼Œæ„å‘³ç€æ¯ä¸ªç‰¹å¾éƒ½æœ‰æ¸…æ™°çš„å®šä¹‰ï¼Œæ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚</li><li>éç»“æ„åŒ–æ•°æ®ï¼šé€šå¸¸æŒ‡çš„æ˜¯æ¯”è¾ƒæŠ½è±¡çš„æ•°æ®ï¼Œæ¯”å¦‚éŸ³é¢‘ã€åŸå§‹éŸ³é¢‘ã€å›¾åƒã€æ–‡æœ¬ã€‚</li></ul><p>æ­£æ˜¯å› ä¸ºç¥ç»ç½‘ç»œï¼Œè®¡ç®—æœºç°åœ¨èƒ½æ›´å¥½åœ°è§£é‡Šéç»“æ„åŒ–æ•°æ®ï¼Œç”šè‡³åœ¨æŸäº›æ–¹é¢ä¼˜äºäººç±»ã€‚ä¾‹å¦‚ï¼Œè¯­éŸ³è¯†åˆ«ï¼Œå›¾åƒè¯†åˆ«ï¼Œè‡ªç„¶è¯­éŸ³å¤„ç†ç­‰ã€‚</p><h3 id="1-3-æ·±åº¦å­¦ä¹ çš„ä¼˜ç‚¹">1.3 æ·±åº¦å­¦ä¹ çš„ä¼˜ç‚¹</h3><p>æ·±åº¦å­¦ä¹ å…´èµ·çš„åŸå› ï¼šæ•°æ®ï¼ˆDataï¼‰ã€è®¡ç®—ï¼ˆComputationï¼‰ã€ç®—æ³•ï¼ˆAlgorithmï¼‰</p><p>æ·±åº¦å­¦ä¹ çš„ä¼˜ç‚¹ï¼š</p><ul><li>ä¸éœ€è¦äººå·¥å¤„ç†è®¾è®¡ç‰¹å¾ï¼Œåªéœ€é€šè¿‡ç¥ç»ç½‘ç»œè¾“å‡ºç»“æœ</li><li>æ›´é€‚ç”¨äºéš¾æå–ç‰¹å¾çš„ä»»åŠ¡ï¼šå›¾åƒã€è¯­éŸ³ã€è‡ªç„¶è¯­è¨€å¤„ç†</li><li>èƒ½å¤Ÿåº”å¯¹å¤„ç†æ›´å¤§è§„æ¨¡æ•°æ®</li></ul><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/data_performance.jpeg" alt="æ€§èƒ½éšæ•°æ®é‡å¢å¤§çš„å˜åŒ–"></p><h2 id="äºŒã€ç¥ç»ç½‘ç»œåŸºç¡€">äºŒã€ç¥ç»ç½‘ç»œåŸºç¡€</h2><h3 id="2-1-é€»è¾‘å›å½’ï¼ˆLogistic-Regression-LRï¼‰">2.1 é€»è¾‘å›å½’ï¼ˆLogistic Regression, LRï¼‰</h3><p>é€»è¾‘å›å½’æ˜¯ä¸€ç§ç”¨äºè§£å†³äºŒåˆ†ç±»é—®é¢˜çš„åˆ†ç±»ç®—æ³•ï¼Œç»™å®šä¸€ä¸ªè¾“å…¥xï¼Œè¾“å‡ºy=1çš„é¢„æµ‹æ¦‚ç‡ $\hat{y}=P(y=1|x)$</p><p>è®°è¾“å…¥å±‚ç‰¹å¾æ•°$n$ï¼Œå‚æ•°ï¼š</p><ul><li>è¾“å…¥$x \in R^{n}$ï¼Œxæ˜¯ä¸€ä¸ªnç»´çš„ç‰¹å¾å‘é‡</li><li>æƒé‡$w \in R^{n}$ï¼Œwæ˜¯ä¸€ä¸ªnç»´çš„æƒé‡å‘é‡</li><li>æ ‡ç­¾$y \in {0,1}$ï¼Œyæ˜¯ä¸€ä¸ªäºŒåˆ†ç±»æ ‡ç­¾</li><li>åç½®$b \in R$ï¼Œbæ˜¯ä¸€ä¸ªæ ‡é‡</li><li>è¾“å‡º$\hat{y} = \sigma(w^{T}x+b)=\sigma(w_1x_1+w_2x_2+â€¦+w_nx_n+b)$<ul><li>æ¿€æ´»å‡½æ•°ï¼šSigmoidå‡½æ•°ï¼š$\sigma(t)=\dfrac{1}{1+e^{-t}}$</li><li>téå¸¸å¤§æ—¶ï¼Œsæ¥è¿‘1ï¼›téå¸¸å°æ—¶ï¼Œsæ¥è¿‘0ï¼›t=0æ—¶ï¼Œsç­‰äº0.5</li></ul></li></ul><h3 id="2-2-ä¸æ¢¯åº¦ä¸‹é™ç®—æ³•ï¼ˆGradient-Descentï¼‰">2.2 ä¸æ¢¯åº¦ä¸‹é™ç®—æ³•ï¼ˆGradient Descentï¼‰</h3><p>é€šè¿‡è¿­ä»£æ›´æ–°å‚æ•°wå’Œbï¼Œä½¿æˆæœ¬å‡½æ•°$J(w,b)$æ‰¾åˆ°æœ€å°å€¼ï¼ˆæŸå¤±å‡½æ•°å’Œæˆæœ¬å‡½æ•°è§2.7ï¼‰</p><p>æ¢¯åº¦ä¸‹é™ç®—æ³•ï¼šå‡½æ•°çš„æ¢¯åº¦ï¼ˆgradientï¼‰æŒ‡å‡ºäº†å‡½æ•°çš„æœ€é™¡å¢é•¿æ–¹å‘ã€‚æ¢¯åº¦çš„æ–¹å‘èµ°ï¼Œå‡½æ•°å¢é•¿å¾—å°±è¶Šå¿«ã€‚é‚£ä¹ˆæŒ‰æ¢¯åº¦çš„è´Ÿæ–¹å‘èµ°ï¼Œå‡½æ•°å€¼è‡ªç„¶å°±é™ä½å¾—æœ€å¿«äº†</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0%E5%9B%BE.png" alt="æŸå¤±å‡½æ•°å›¾"></p><p>å‚æ•°æ›´æ–°ï¼š</p><ul><li>$w:=w-\alpha \dfrac{\partial J(w,b)}{\partial w}$</li><li>$b:=b-\alpha \dfrac{\partial J(w,b)}{\partial b}$</li><li>$\alpha$ï¼šå­¦ä¹ ç‡ï¼ˆLearning Rateï¼‰ï¼Œæ§åˆ¶å‚æ•°æ›´æ–°çš„æ­¥é•¿ï¼Œå¤ªå¤§ä¼šå¯¼è‡´éœ‡è¡ï¼Œå¤ªå°ä¼šå¯¼è‡´æ”¶æ•›é€Ÿåº¦æ…¢</li></ul><h3 id="2-3-é€»è¾‘å›å½’çš„æ¢¯åº¦ä¸‹é™">2.3 é€»è¾‘å›å½’çš„æ¢¯åº¦ä¸‹é™</h3><p>ä»¥2ç»´æ ·æœ¬ $x_1,x_2$ ä¸ºä¾‹ï¼Œå‚æ•°$w_1,w_2,b$ï¼Œè®¡ç®—æ¢¯åº¦ä¸‹é™</p><p>å·²çŸ¥ï¼š<br>$$<br>\begin{split}<br>&amp;z = w_1x_1+w_2x_2+b \\<br>&amp;è®° a = \hat{y} = \sigma(z) \\<br>&amp;J(a,y) = -y\log(a)-(1-y)\log(1-a) \\<br>\end{split}<br>$$</p><p>è®¡ç®—Jå¯¹zçš„å¯¼æ•°ï¼š</p><p>$$<br>\begin{split}<br>&amp;\frac{\partial J}{\partial a} = \frac{-y}{a}+\frac{1-y}{1-a} \\<br>&amp;\frac{\partial a}{\partial z} = a(1-a) \\<br>&amp;dz = \frac{\partial J}{\partial a} \cdot \frac{\partial a}{\partial z} = a-y<br>\end{split}<br>$$</p><p>è¿™æ ·å¯ä»¥æ±‚å‡ºæ€»æŸå¤±ç›¸å¯¹äº$w_1,w_2,b$çš„å¯¼æ•°</p><ul><li>$dw_1 = \frac{\partial J}{\partial z} \cdot \frac{\partial z}{\partial w_1} = x_1(a-y)$</li><li>$dw_2 = \frac{\partial J}{\partial z} \cdot \frac{\partial z}{\partial w_2} = x_2(a-y)$</li><li>$db = \frac{\partial J}{\partial z} \cdot \frac{\partial z}{\partial b} = a-y = dz$</li></ul><p>ç„¶åæ›´æ–°å‚æ•°ï¼š</p><ul><li>$w_1:=w_1-\alpha dw_1$</li><li>$w_2:=w_2-\alpha dw_1$</li><li>$b:=b-\alpha dw_1$</li></ul><h3 id="2-4-å‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­">2.4 å‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­</h3><ul><li>å‰å‘ä¼ æ’­ï¼šä»å‰å¾€åè®¡ç®—æ¢¯åº¦å’ŒæŸå¤±çš„è¿‡ç¨‹</li><li>åå‘ä¼ æ’­ï¼šä»åå¾€å‰è®¡ç®—å‚æ•°çš„æ›´æ–°æ¢¯åº¦å€¼</li></ul><h3 id="2-5-å‘é‡åŒ–-é€»è¾‘å›å½’å®ç°">2.5 å‘é‡åŒ–/é€»è¾‘å›å½’å®ç°</h3><p>å‘é‡åŒ–ç¼–ç¨‹çš„ä¼˜ç‚¹ï¼šå¤šæ ·æœ¬ä¸‹ï¼Œå‘é‡è®¡ç®—æ¯”å¾ªç¯è®¡ç®—å¿«çš„å¤šï¼Œä»£ç æ›´ç®€æ´</p><ol><li>è¾“å…¥å±‚$X$ï¼šå½¢çŠ¶$n \times m$ï¼Œ$n$ä¸ºç‰¹å¾æ•°ï¼Œ$m$ä¸ºæ ·æœ¬æ•°</li><li>æƒé‡å‚æ•°$W$ï¼šå½¢çŠ¶$n \times 1$</li><li>åç½®å‚æ•°$b$ï¼šæ ‡é‡</li><li>è¾“å‡ºå±‚$Z$ï¼š$Z=W^{T}X+b$ï¼Œå½¢çŠ¶$(1,n) \times (n,m) + b = (1,m)$</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">n = <span class="number">20</span>  <span class="comment"># ç‰¹å¾æ•°</span></span><br><span class="line">m = <span class="number">100</span>  <span class="comment"># æ ·æœ¬æ•°</span></span><br><span class="line">alpha = <span class="number">0.001</span>  <span class="comment"># å­¦ä¹ ç‡</span></span><br><span class="line">iterations = <span class="number">1000</span>  <span class="comment"># è¿­ä»£æ¬¡æ•°</span></span><br><span class="line"></span><br><span class="line">X = np.random.randn(n, m)  <span class="comment"># ç”Ÿæˆç‰¹å¾çŸ©é˜µ</span></span><br><span class="line">Y = np.random.randint(<span class="number">0</span>, <span class="number">2</span>, [<span class="number">1</span>, m])  <span class="comment"># ç”Ÿæˆæ ‡ç­¾</span></span><br><span class="line"></span><br><span class="line">J = <span class="number">0</span>  <span class="comment"># æŸå¤±å‡½æ•°å€¼</span></span><br><span class="line"></span><br><span class="line"> åˆå§‹åŒ–æƒé‡å’Œåç½®</span><br><span class="line">W = np.random.randn(n, <span class="number">1</span>) * <span class="number">0.01</span></span><br><span class="line">b = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sigmoid</span>(<span class="params">t</span>): <span class="comment"># Sigmoidå‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> / (<span class="number">1</span> + np.exp(-t))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_loss</span>(<span class="params">A, Y</span>):  <span class="comment"># å¯¹æ•°æŸå¤±å‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span> / m * np.<span class="built_in">sum</span>(Y * np.log(A) + (<span class="number">1</span> - Y) * np.log(<span class="number">1</span> - A))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_accuracy</span>(<span class="params">A, Y</span>):  <span class="comment"># è®¡ç®—å‡†ç¡®ç‡</span></span><br><span class="line">    A = np.where(A &gt; <span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> np.mean(A == Y)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(iterations):</span><br><span class="line">    <span class="comment"># å‰å‘ä¼ æ’­</span></span><br><span class="line">    Z = np.dot(W.T, X) + b</span><br><span class="line">    A = sigmoid(Z)  <span class="comment"># æ¿€æ´»å€¼ï¼ˆé¢„æµ‹ï¼‰</span></span><br><span class="line">    J = log_loss(A, Y)  <span class="comment"># è®¡ç®—æŸå¤±å‡½æ•°å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åå‘ä¼ æ’­</span></span><br><span class="line">    <span class="comment"># è®¡ç®—æ¢¯åº¦</span></span><br><span class="line">    dZ = A - Y</span><br><span class="line">    dW = <span class="number">1</span> / m * np.dot(X, dZ.T) <span class="comment"># 1/m * X * dZ</span></span><br><span class="line">    db = <span class="number">1</span> / m * np.<span class="built_in">sum</span>(dZ) <span class="comment"># 1/m * dZ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ›´æ–°æƒé‡å’Œåç½®</span></span><br><span class="line">    W = W - alpha * dW</span><br><span class="line">    b = b - alpha * db</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Loss:&quot;</span>, J)  <span class="comment"># æ‰“å°æŸå¤±å‡½æ•°å€¼</span></span><br><span class="line"></span><br><span class="line"> è®­ç»ƒé›†ä¸Šçš„å‡†ç¡®ç‡</span><br><span class="line">Z = np.dot(W.T, X) + b</span><br><span class="line">A = <span class="number">1</span> / (<span class="number">1</span> + np.exp(-Z))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Accuracy:&quot;</span>, calc_accuracy(A, Y))</span><br></pre></td></tr></table></figure><h3 id="2-6-æ¿€æ´»å‡½æ•°ï¼ˆActivation-Functionï¼‰">2.6 æ¿€æ´»å‡½æ•°ï¼ˆActivation Functionï¼‰</h3><p>æ¶‰åŠåˆ°ç½‘ç»œçš„ä¼˜åŒ–æ—¶å€™ï¼Œä¼šæœ‰ä¸åŒçš„æ¿€æ´»å‡½æ•°é€‰æ‹©ã€‚<br>æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ç¥ç»ç½‘ç»œçš„éšè—å±‚å’Œè¾“å‡ºå•å…ƒç”¨ä»€ä¹ˆæ¿€æ´»å‡½æ•°ã€‚<br>åœ¨é€»è¾‘å›å½’ä¸­é€‰ç”¨äº†Sigmoidå‡½æ•°ï¼Œä½†æœ‰æ—¶å…¶ä»–å‡½æ•°çš„æ•ˆæœä¼šå¥½å¾—å¤šã€‚<br>å¤§å¤šæ•°ç»“è®ºé€šè¿‡å®è·µå¾—æ¥ï¼Œæ²¡æœ‰å¾ˆå¥½çš„è§£é‡Šæ€§ã€‚</p><p>ä¸ºä»€ä¹ˆä½¿ç”¨éçº¿æ€§çš„æ¿€æ´»å‡½æ•°ï¼šä½¿ç”¨çº¿æ€§å‡½æ•°ï¼Œåœ¨è¿™ä¸€å±‚ä¸Šçš„ç¥ç»å…ƒçš„è¾“å‡ºä»…ä»…æ˜¯è¾“å…¥çš„çº¿æ€§ç»„åˆï¼Œå¤±å»äº†æ•ˆæœã€‚</p><p>$$a^{[1]} = W^{[1]}x+b^{[1]}$$</p><p>$$<br>\begin{align}<br>b^{[1]} &amp;= W^{[2]}a^{[1]}+b^{[2]} \\<br>&amp;= W^{[2]}(W^{[1]}x+b^{[1]})+b^{[2]} \\<br>&amp;= (W^{[2]}W^{[1]})x+(W^{[2]}b^{[1]}+b^{[2]}) \\<br>&amp;= Wx+b<br>\end{align}<br>$$</p><p>æœ¬èŠ‚æåŠçš„å‡ ç§å¸¸ç”¨æ¿€æ´»å‡½æ•°ï¼šSigmoidå‡½æ•°ã€tanHå‡½æ•°ã€ReLUå‡½æ•°</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B0.png" alt="æ¿€æ´»å‡½æ•°"></p><p>Sigmoidå‡½æ•°</p><p>$$<br>\begin{split}<br>&amp;\sigma(t)=\dfrac{1}{1+e^{-t}} \\<br>&amp;\sigmaâ€™(t)=\sigma(t)(1-\sigma(t)) \\<br>&amp;t\in(-\infty,+\infty), \sigma(t)\in(0,1)<br>\end{split}<br>$$</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/Sigmoid%E5%87%BD%E6%95%B0.png" alt="Sigmoidå‡½æ•°"></p><p>åŒæ›²æ­£åˆ‡å‡½æ•°ï¼ˆHyperbolic Tangent, tanHï¼‰</p><p>æ•ˆæœæ¯”Sigmoidå‡½æ•°å¥½ï¼Œå› ä¸ºå‡½æ•°è¾“å‡ºåœ¨(-1,1)ä¹‹é—´ï¼Œæ”¶æ•›é€Ÿåº¦æ›´å¿«</p><p>å­˜åœ¨å’ŒSigmoidå‡½æ•°ä¸€æ ·çš„ç¼ºç‚¹ï¼šå½“tè¶‹ç´§æ— ç©·ï¼Œå¯¼æ•°çš„æ¢¯åº¦ï¼ˆå³å‡½æ•°çš„æ–œç‡ï¼‰å°±è¶‹ç´§äº 0ï¼Œè¿™ä½¿å¾—æ¢¯åº¦ç®—æ³•çš„é€Ÿåº¦ä¼šå‡æ…¢ã€‚</p><p>$$<br>\begin{split}<br>&amp;tanh(t)=\dfrac{e^{t}-e^{-t}}{e^{t}+e^{-t}} \\<br>&amp;tanhâ€™(t)=1-tanh^2(t)<br>\end{split}<br>$$</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/tanH%E5%87%BD%E6%95%B0.png" alt="tanHå‡½æ•°"></p><p>ReLUå‡½æ•°ï¼šä¿®æ­£çº¿æ€§å•å…ƒï¼ˆRectified Linear Unit, ReLUï¼‰</p><p>å½“ $t&gt;0$ æ—¶ï¼Œæ¢¯åº¦å§‹ç»ˆä¸º1ï¼Œä»è€Œæé«˜ç¥ç»ç½‘ç»œåŸºäºæ¢¯åº¦ç®—æ³•çš„è¿ç®—é€Ÿåº¦ï¼Œæ”¶æ•›é€Ÿåº¦è¿œå¤§äºSigmoidå’ŒtanHå‡½æ•°</p><p>$$<br>\begin{split}<br>&amp;f(t)=max(0,t) \\<br>&amp;fâ€™(t)=\begin{cases}<br>0 &amp; \text{if } t&lt;0 \\<br>1 &amp; \text{if } t \geq 0<br>\end{cases}<br>\end{split}<br>$$</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/ReLU%E5%87%BD%E6%95%B0.png" alt="ReLUå‡½æ•°"></p><h3 id="2-7-æŸå¤±å‡½æ•°ï¼ˆLoss-Functionï¼‰ä¸æˆæœ¬å‡½æ•°ï¼ˆCost-Functionï¼‰">2.7 æŸå¤±å‡½æ•°ï¼ˆLoss Functionï¼‰ä¸æˆæœ¬å‡½æ•°ï¼ˆCost Functionï¼‰</h3><p>æŸå¤±å‡½æ•°ç”¨äºè¡¡é‡é¢„æµ‹ç»“æœä¸çœŸå®å€¼ä¹‹é—´çš„è¯¯å·®ã€‚</p><p>å¹³æ–¹å·®æŸå¤±å‡½æ•°ï¼š$L(\hat{y},y)=\frac{1}{2}(\hat{y}-y)^2$</p><ul><li>æœ€ç®€å•çš„æŸå¤±å‡½æ•°</li><li>å…·æœ‰å¤šä¸ªå±€éƒ¨æœ€å°å€¼ï¼Œä¸é€‚åˆé€»è¾‘å›å½’</li></ul><p>å¯¹æ•°æŸå¤±å‡½æ•°ï¼š$L(\hat{y},y)=-(y\log(\hat{y})+(1-y)\log(1-\hat{y}))$</p><ul><li>é€»è¾‘å›å½’é€šå¸¸é‡‡ç”¨çš„æŸå¤±å‡½æ•°</li><li>y=1æ—¶ï¼ŒæŸå¤±å‡½æ•°ä¸º$-log(\hat{y})$ï¼Œ$\hat{y}$è¶Šå¤§ï¼ŒæŸå¤±è¶Šå°</li><li>y=0æ—¶ï¼ŒæŸå¤±å‡½æ•°ä¸º$log(1-\hat{y})$ï¼Œ$\hat{y}$è¶Šå°ï¼ŒæŸå¤±è¶Šå°</li></ul><p>æŸå¤±å‡½æ•°ï¼šè¡¡é‡äº†åœ¨å•ä¸ªè®­ç»ƒæ ·æœ¬ä¸Šçš„è¡¨ç°</p><p>æˆæœ¬å‡½æ•°ï¼ˆCost Functionï¼‰ï¼š$J(w,b)=\dfrac{1}{m}\sum\limits_{i=1}^{m}L(\hat{y}^{(i)},y^{(i)})$</p><ul><li>æ‰€æœ‰è®­ç»ƒæ ·æœ¬çš„æŸå¤±å¹³å‡å€¼</li><li>è¡¡é‡åœ¨å…¨ä½“è®­ç»ƒæ ·æœ¬ä¸Šçš„è¡¨ç°ã€å‚æ•°wå’Œbçš„æ•ˆæœ</li></ul><h2 id="ä¸‰ã€æµ…å±‚ç¥ç»ç½‘ç»œ">ä¸‰ã€æµ…å±‚ç¥ç»ç½‘ç»œ</h2><h3 id="3-1-æµ…å±‚ç¥ç»ç½‘ç»œ">3.1 æµ…å±‚ç¥ç»ç½‘ç»œ</h3><p>ç¥ç»ç½‘ç»œï¼ˆNeural Network, NNï¼‰æ˜¯ä¸€ç§æ¨¡æ‹Ÿäººè„‘ç¥ç»å…ƒå·¥ä½œæ–¹å¼çš„è®¡ç®—æ¨¡å‹ï¼ŒåŒ…å«è¾“å…¥å±‚ã€éšè—å±‚ã€è¾“å‡ºå±‚ï¼Œæ¯å±‚åŒ…å«å¤šä¸ªç¥ç»å…ƒ</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E6%B5%85%E5%B1%82%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C.png" alt="æµ…å±‚ç¥ç»ç½‘ç»œ"></p><p>ä»¥ä¸Šå›¾ï¼ˆå•éšè—å±‚ç¥ç»ç½‘ç»œï¼‰ä¸ºä¾‹ï¼Œè¾“å…¥å±‚æœ‰$n=3$ä¸ªç‰¹å¾ï¼Œéšè—å±‚ä¸€å±‚ï¼Œæœ‰$4$ä¸ªç¥ç»å…ƒã€‚è®°éšè—å±‚ $[1]$ ï¼Œè¾“å‡ºå±‚ $[2]$ ï¼Œåˆ™ï¼š</p><ul><li>è¾“å…¥å±‚ï¼š$x \in R^{3}$ï¼Œ$x$æ˜¯ä¸€ä¸ª$3$ç»´çš„ç‰¹å¾å‘é‡<ul><li>å½¢çŠ¶ï¼š(3, m)ï¼Œ$m$ä¸ºæ ·æœ¬æ•°</li></ul></li><li>éšè—å±‚å…·æœ‰4è¡Œ3åˆ—çš„æƒé‡çŸ©é˜µ$W^{[1]} \in R^{4 \times 3}$ï¼Œåç½®å‘é‡$b^{[1]} \in R^{4}$<ul><li>éšè—å±‚çš„æ¯ä¸ªç¥ç»å…ƒ$i$å…·æœ‰æƒé‡$W^{[1]}<em>{i} \in R^{3}$ï¼Œåç½®$b^{[1]}</em>{i} \in R$</li><li>å½¢çŠ¶ï¼šè¾“å…¥(3, m) * æƒé‡(4, 3) + åç½®(4, 1) = è¾“å‡º(4, m)</li></ul></li><li>è¾“å‡ºå±‚å…·æœ‰1è¡Œ4åˆ—çš„æƒé‡çŸ©é˜µ$W^{[2]} \in R^{1 \times 4}$ï¼Œåç½®$b^{[2]} \in R$<ul><li>å½¢çŠ¶ï¼šè¾“å…¥(4, m) * æƒé‡(1, 4) + åç½®(1, 1) = è¾“å‡º(1, m)ã€</li></ul></li></ul><p>æ€»ç»“ï¼šç¬¬iå±‚çš„æƒé‡çŸ©é˜µ$W^{[i]}$çš„å½¢çŠ¶ä¸º$(n^{[i]}, n^{[i-1]})$ï¼Œåç½®$b^{[i]}$çš„å½¢çŠ¶ä¸º$(n^{[i]}, 1)$</p><h3 id="3-2-å‰å‘ä¼ æ’­">3.2 å‰å‘ä¼ æ’­</h3><p>$$<br>\begin{split}<br>&amp;Z^{[1]} = W^{[1]}X+b^{[1]} \\<br>&amp;A^{[1]} = tanh(Z^{[1]}) \\<br>&amp;Z^{[2]} = W^{[2]}A^{[1]}+b^{[2]} \\<br>&amp;A^{[2]} = \sigma(Z^{[2]})<br>\end{split}<br>$$</p><h3 id="3-3-åå‘ä¼ æ’­">3.3 åå‘ä¼ æ’­</h3><p>è¾“å‡ºå±‚ä»¥Sigmoidå‡½æ•°ä½œä¸ºæ¿€æ´»å‡½æ•°ï¼Œæ ¹æ®<a href="#14-%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E7%9A%84%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D">é€»è¾‘å›å½’çš„æ¢¯åº¦ä¸‹é™</a>çš„æ¨å¯¼ï¼Œå¯ä»¥å¾—åˆ°ï¼š</p><p>$$<br>\begin{split}<br>&amp;dZ^{[2]} = A^{[2]}-Y \\<br>&amp;dW^{[2]} = \dfrac{1}{m}dZ^{[2]}A^{[1]T} \\<br>&amp;db^{[2]} = \dfrac{1}{m}np.sum(dZ^{[2]}, axis=1)<br>\end{split}<br>$$</p><p>éšè—å±‚ä»¥tanhå‡½æ•°ä½œä¸ºæ¿€æ´»å‡½æ•°ï¼Œå·²çŸ¥ï¼š</p><p>$$<br>\begin{split}<br>&amp;tanhâ€™(t) = 1-tanh^2(t) \\<br>&amp;Z^{[1]} = W^{[1]}X+b^{[1]} \\<br>&amp;A^{[1]} = tanh(Z^{[1]}) \\<br>&amp;J(A^{[2]},Y) = -Y\log(A^{[2]})-(1-Y)\log(1-A^{[2]})<br>\end{split}<br>$$</p><p>æ ¹æ®é“¾å¼æ±‚å¯¼æ³•åˆ™ï¼ˆæ­¥éª¤ç•¥ï¼‰ï¼Œå¯ä»¥å¾—åˆ°ï¼š</p><p>$$<br>\begin{split}<br>&amp;dZ^{[1]} = \frac{\partial J}{\partial A^{[2]}} \cdot \frac{\partial A^{[2]}}{\partial Z^{[2]}} \cdot \frac{\partial Z^{[2]}}{\partial A^{[1]}} \cdot \frac{\partial A^{[1]}}{\partial Z^{[1]}} = W^{[2]T}dZ^{[2]} \cdot (1-A^{[1]2}) \\<br>&amp;dW^{[1]} = \dfrac{1}{m}dZ^{[1]}X^T \\<br>&amp;db^{[1]} = \dfrac{1}{m}np.sum(dZ^{[1]}, axis=1)<br>\end{split}<br>$$</p><h3 id="å®è·µï¼šæµ…å±‚ç¥ç»ç½‘ç»œå®ç°">å®è·µï¼šæµ…å±‚ç¥ç»ç½‘ç»œå®ç°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">n = <span class="number">20</span>  <span class="comment"># ç‰¹å¾æ•°</span></span><br><span class="line">m = <span class="number">100</span>  <span class="comment"># æ ·æœ¬æ•°</span></span><br><span class="line">k = <span class="number">4</span>  <span class="comment"># éšè—å±‚ç¥ç»å…ƒæ•°</span></span><br><span class="line">alpha = <span class="number">0.001</span>  <span class="comment"># å­¦ä¹ ç‡</span></span><br><span class="line">iterations = <span class="number">1000</span>  <span class="comment"># è¿­ä»£æ¬¡æ•°</span></span><br><span class="line"></span><br><span class="line">X = np.random.randn(n, m)  <span class="comment"># ç”Ÿæˆç‰¹å¾çŸ©é˜µ</span></span><br><span class="line">Y = np.random.randint(<span class="number">0</span>, <span class="number">2</span>, [<span class="number">1</span>, m])  <span class="comment"># ç”Ÿæˆæ ‡ç­¾</span></span><br><span class="line"></span><br><span class="line">J = <span class="number">0</span>  <span class="comment"># æŸå¤±å‡½æ•°å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éšè—å±‚æƒé‡å’Œåç½®ï¼ˆéšæœºåˆå§‹åŒ–ï¼‰</span></span><br><span class="line">W1 = np.random.randn(k, n) * <span class="number">0.01</span></span><br><span class="line">b1 = np.zeros([k, <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºå±‚æƒé‡å’Œåç½®</span></span><br><span class="line">W2 = np.random.randn(<span class="number">1</span>, k) * <span class="number">0.01</span></span><br><span class="line">b2 = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sigmoid</span>(<span class="params">t</span>): <span class="comment"># Sigmoidå‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> / (<span class="number">1</span> + np.exp(-t))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tanh</span>(<span class="params">t</span>): <span class="comment"># tanHå‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> (np.exp(t) - np.exp(-t)) / (np.exp(t) + np.exp(-t))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_loss</span>(<span class="params">A, Y</span>):  <span class="comment"># å¯¹æ•°æŸå¤±å‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span> / m * np.<span class="built_in">sum</span>(Y * np.log(A) + (<span class="number">1</span> - Y) * np.log(<span class="number">1</span> - A))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_accuracy</span>(<span class="params">A, Y</span>):  <span class="comment"># è®¡ç®—å‡†ç¡®ç‡</span></span><br><span class="line">    A = np.where(A &gt; <span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> np.mean(A == Y)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(iterations):</span><br><span class="line">    <span class="comment"># å‰å‘ä¼ æ’­</span></span><br><span class="line">    Z1 = np.dot(W1, X) + b1 <span class="comment"># [k, m]</span></span><br><span class="line">    A1 = tanh(Z1)  <span class="comment"># éšè—å±‚æ¿€æ´»å€¼ [k, m]</span></span><br><span class="line">    Z2 = np.dot(W2, A1) + b2 <span class="comment"># [1, m]</span></span><br><span class="line">    A2 = sigmoid(Z2)  <span class="comment"># è¾“å‡ºå±‚æ¿€æ´»å€¼ï¼ˆé¢„æµ‹ï¼‰ [1, m]</span></span><br><span class="line">    J = log_loss(A2, Y)  <span class="comment"># è®¡ç®—æŸå¤±å‡½æ•°å€¼ </span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åå‘ä¼ æ’­</span></span><br><span class="line">    <span class="comment"># è¾“å‡ºå±‚</span></span><br><span class="line">    dZ2 = A2 - Y <span class="comment"># [1, m]</span></span><br><span class="line">    dW2 = <span class="number">1</span> / m * np.dot(dZ2, A1.T) <span class="comment"># [1, k]</span></span><br><span class="line">    db2 = <span class="number">1</span> / m * np.<span class="built_in">sum</span>(dZ2) <span class="comment"># [1, 1]</span></span><br><span class="line">    <span class="comment"># éšè—å±‚</span></span><br><span class="line">    dZ1 = np.dot(W2.T, dZ2) * (<span class="number">1</span> - A1 ** <span class="number">2</span>)</span><br><span class="line">    dW1 = <span class="number">1</span> / m * np.dot(dZ1, X.T)</span><br><span class="line">    db1 = <span class="number">1</span> / m * np.<span class="built_in">sum</span>(dZ1)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ›´æ–°æƒé‡å’Œåç½®</span></span><br><span class="line">    W1 = W1 - alpha * dW1</span><br><span class="line">    b1 = b1 - alpha * db1</span><br><span class="line">    W2 = W2 - alpha * dW2</span><br><span class="line">    b2 = b2 - alpha * db2</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Loss:&quot;</span>, J)  <span class="comment"># æ‰“å°æŸå¤±å‡½æ•°å€¼</span></span><br><span class="line"></span><br><span class="line"> è®­ç»ƒé›†ä¸Šçš„å‡†ç¡®ç‡</span><br><span class="line">Z1 = np.dot(W1, X) + b1</span><br><span class="line">A1 = tanh(Z1)</span><br><span class="line">Z2 = np.dot(W2, A1) + b2</span><br><span class="line">A2 = <span class="number">1</span> / (<span class="number">1</span> + np.exp(-Z2))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Accuracy:&quot;</span>, calc_accuracy(A2, Y))</span><br></pre></td></tr></table></figure><h2 id="å››ã€æ·±å±‚ç¥ç»ç½‘ç»œ">å››ã€æ·±å±‚ç¥ç»ç½‘ç»œ</h2><h3 id="4-1-æ·±å±‚ç¥ç»ç½‘ç»œ">4.1 æ·±å±‚ç¥ç»ç½‘ç»œ</h3><p>ä¸ºä»€ä¹ˆéœ€è¦æ·±å±‚ç¥ç»ç½‘ç»œï¼š</p><ul><li>ç¥ç»ç½‘ç»œä»ç¬¬ä¸€å±‚å¼€å§‹ï¼Œä»åŸå§‹æ•°æ®ä¸­æå–ç‰¹å¾</li><li>ä¸‹ä¸€å±‚å°†ä¸Šä¸€å±‚ä¹ å¾—çš„ä¿¡æ¯ç»„åˆèµ·æ¥ï¼Œå½¢æˆæ›´é«˜çº§çš„ç‰¹å¾</li><li>éšç€å±‚æ•°å¢å¤šï¼Œç‰¹å¾ä»ç®€å•åˆ°å¤æ‚ï¼Œå­¦ä¹ çš„èƒ½åŠ›æ›´å¼º</li></ul><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E6%B7%B1%E5%B1%82%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C.jpeg" alt="æ·±å±‚ç¥ç»ç½‘ç»œ"></p><h3 id="4-2-å‰å‘ä¼ æ’­">4.2 å‰å‘ä¼ æ’­</h3><p>$$<br>\begin{split}<br>&amp;x=a^{[0]} \\<br>&amp;z^{[L]}=W^{[L]}a^{[L-1]}+b^{[L]} \\<br>&amp;a^{[L]}=g^{[L]}(z^{[L]})<br>\end{split}<br>$$</p><p>è¾“å…¥$a^{[L-1]}$ï¼Œè¾“å‡º$a^{[L]}$</p><h3 id="4-3-åå‘ä¼ æ’­">4.3 åå‘ä¼ æ’­</h3><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E6%B7%B1%E5%B1%82%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD.png" alt="æ·±å±‚ç¥ç»ç½‘ç»œåå‘ä¼ æ’­"></p><p>$$<br>\begin{split}<br>&amp;dZ^{[L]} = \frac{\partial J}{\partial A^{[L]}} \cdot \frac{\partial A^{[L]}}{\partial Z^{[L]}} = dA^{[L]} \cdot g^{[L]'}(Z^{[L]}) \\<br>&amp;dW^{[L]} = \frac{\partial J}{\partial Z^{[L]}} \cdot \frac{\partial Z^{[L]}}{\partial W^{[L]}} = \frac{1}{m}dZ^{[L]}A^{[L-1]T} \\<br>&amp;db^{[L]} = \frac{1}{m}np.sum(dZ^{[L]}, axis=1) \\<br>&amp;dA^{[L]} = W^{[L+1]T}dZ^{[L+1]}<br>\end{split}<br>$$</p><h3 id="4-4-å‚æ•°å’Œè¶…å‚æ•°">4.4 å‚æ•°å’Œè¶…å‚æ•°</h3><p>å‚æ•°ï¼ˆParametersï¼‰ï¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å¸Œæœ›æ¨¡å‹å­¦ä¹ åˆ°çš„ä¿¡æ¯ï¼Œæ¨¡å‹è‡ªå·±è°ƒæ•´çš„å‚æ•°</p><ul><li>æƒé‡Wé€šå¸¸ä½¿ç”¨éšæœºåˆå§‹åŒ–ï¼Œé¿å…å¯¹ç§°æ€§ï¼Œ$randn*0.01$<ul><li>å¯¹ç§°æ€§ï¼šå¦‚æœæ‰€æœ‰çš„ç¥ç»å…ƒéƒ½å…·æœ‰ç›¸åŒçš„æƒé‡ï¼Œé‚£ä¹ˆåœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰çš„ç¥ç»å…ƒéƒ½ä¼šå­¦ä¹ åˆ°ç›¸åŒçš„ç‰¹å¾</li><li>ä¹˜ç³»æ•°0.01ï¼šä½¿ç”¨Sigmoidå‡½æ•°æˆ–è€…tanHå‡½æ•°ä½œä¸ºæ¿€æ´»å‡½æ•°æ—¶ï¼ŒWæ¯”è¾ƒå°ï¼Œåˆ™Z=WX+bæ‰€å¾—çš„å€¼è¶‹è¿‘äº0ï¼Œæ¢¯åº¦è¾ƒå¤§ï¼Œèƒ½å¤Ÿæé«˜ç®—æ³•çš„æ›´æ–°é€Ÿåº¦ï¼›ReLUå‡½æ•°åˆ™æ²¡æœ‰è¿™ä¸ªé—®é¢˜</li></ul></li><li>åç½®bæ²¡æœ‰å¯¹ç§°æ€§é—®é¢˜ï¼Œé€šå¸¸åˆå§‹åŒ–ä¸º0</li></ul><p>è¶…å‚æ•°ï¼ˆHyper parametersï¼‰ï¼šé€šè¿‡äººçš„ç»éªŒåˆ¤æ–­ã€æ‰‹åŠ¨è°ƒæ•´çš„ç½‘ç»œä¿¡æ¯ï¼Œä¼šå½±å“æœ€ç»ˆçš„å‚æ•°</p><ul><li>å…¸å‹çš„è¶…å‚æ•°ï¼šå­¦ä¹ é€Ÿç‡$\alpha$ã€è¿­ä»£æ¬¡æ•°$N$ã€éšè—å±‚æ•°$L$ã€æ¯å±‚ç¥ç»å…ƒæ•°$n_i$ã€æ¿€æ´»å‡½æ•°$g^{[i]}()$çš„é€‰æ‹©</li><li>å¼€å‘æ–°åº”ç”¨æ—¶ï¼Œå¾ˆéš¾é¢„å…ˆå‡†ç¡®çŸ¥é“æœ€ä½³çš„è¶…å‚æ•°ï¼Œéœ€è¦é€šè¿‡ä¸åŒçš„å°è¯•å’Œè°ƒæ•´æ¥æ‰¾åˆ°æœ€ä½³çš„è¶…å‚æ•°</li></ul><h2 id="äº”ã€å¤šåˆ†ç±»ä¸Softmaxå›å½’">äº”ã€å¤šåˆ†ç±»ä¸Softmaxå›å½’</h2><h3 id="5-1-Softmaxå›å½’">5.1 Softmaxå›å½’</h3><p>å¯¹äºå¤šåˆ†ç±»é—®é¢˜ï¼Œç§ç±»ä¸ªæ•°Cï¼Œåˆ™è¾“å‡ºå±‚çš„ç¥ç»å…ƒä¸ªæ•°å¿…é¡»ä¸ºCï¼Œæ¯ä¸ªç¥ç»å…ƒçš„è¾“å‡ºä¾æ¬¡å¯¹åº”ä¸ºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ã€‚</p><p><img src="https://source.cclmsy.cc/posts/notes/deep_learning/%E5%A4%9A%E5%88%86%E7%B1%BB%E9%97%AE%E9%A2%98.png" alt="å¤šåˆ†ç±»é—®é¢˜"></p><p>è¾“å‡ºå±‚ï¼š$Z^{[L]}=W^{[L]}A^{[L-1]}+b^{[L]}$$</p><p>Softmaxå…¬å¼ï¼š$a_i^{[L]} = \dfrac{e^{Z_i^{[L]}}}{\sum\limits_{j=1}^{C}e^{Z_j^{[L]}}}$ï¼Œæ»¡è¶³$\sum\limits_{i=1}^{C}a_i^{[L]}=1$</p><p>ç†è§£ï¼š$e^{z_i}$çš„å æ¯”</p><h3 id="5-2-äº¤å‰ç†µæŸå¤±ä¸One-hotç¼–ç ">5.2 äº¤å‰ç†µæŸå¤±ä¸One-hotç¼–ç </h3><p>å¯¹äºSoftmaxå›å½’ï¼Œä½¿ç”¨äº¤å‰ç†µæŸå¤±ï¼ˆCross Entropy Lossï¼‰å‡½æ•°ï¼š</p><p>$$<br>L(\hat{y},y)=-\sum\limits_{i=1}^{C}y_i\log(\hat{y}_i)<br>$$</p><p>$C=2$æ—¶ï¼Œå³å¯¹åº”é€»è¾‘å›å½’çš„å¯¹æ•°æŸå¤±å‡½æ•°$L(\hat{y},y)=-(y\log(\hat{y})+(1-y)\log(1-\hat{y}))$</p><p>one-hotç¼–ç ï¼ˆç‹¬çƒ­ç¼–ç ï¼‰ï¼šå°†æ ‡ç­¾è½¬æ¢ä¸ºå‘é‡ï¼Œåªæœ‰ä¸€ä¸ªå…ƒç´ ä¸º1ï¼Œå…¶ä»–å…ƒç´ ä¸º0ã€‚</p><p>ä»¥å›¾2.1.1ä¸ºä¾‹ï¼Œ$y=7$ï¼Œåˆ™one-hotç¼–ç å¯¹åº”ä¸º$y=[0,0,0,0,0,0,0,1,0,0]$ã€‚</p><p>ç”±äºé™¤äº†æ­£ç¡®ç±»åˆ«å¤–ï¼Œå…¶ä»–ç±»åˆ«$y_i=0$ï¼Œå› æ­¤å¯ä»¥ç®€å•è®¡ç®—äº¤å‰ç†µï¼š$L(\hat{y},y)=-1\times\log(0.10)$</p><p>è¿™ä¸€é¡¹çš„é¢„æµ‹å€¼è¶Šæ¥è¿‘1ï¼Œäº¤å‰ç†µè¶Šæ¥è¿‘0ï¼Œæ¨¡å‹æ•ˆæœè¶Šå¥½</p>]]></content>
    
    
    <summary type="html">æ·±åº¦å­¦ä¹ åŸºç¡€ã€ä»æµ…å±‚ç½‘ç»œåˆ°æ·±å±‚ç½‘ç»œ</summary>
    
    
    
    <category term="DLç¬”è®°" scheme="https://www.cclmsy.cc/categories/DL%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="ç¥ç»ç½‘ç»œ" scheme="https://www.cclmsy.cc/tags/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/"/>
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="https://www.cclmsy.cc/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>STè¡¨</title>
    <link href="https://www.cclmsy.cc/posts/st.html"/>
    <id>https://www.cclmsy.cc/posts/st.html</id>
    <published>2025-02-07T16:00:00.000Z</published>
    <updated>2025-07-18T11:14:52.562Z</updated>
    
    <content type="html"><![CDATA[<h2 id="STè¡¨">STè¡¨</h2><p>å®ç°çš„åŠŸèƒ½ï¼šå›ºå®šæ•°ç»„è¯¢é—®åŒºé—´æœ€å€¼RMQ/åŒºé—´GCD</p><p>åŸæ•°ç»„vä¸‹æ ‡ä»0å¼€å§‹ï¼›STè¡¨ä¸‹æ ‡ä»1å¼€å§‹ï¼Œé¦–å…ƒç´ ä¸º0</p><p>æ´›è°·æ¨¡æ¿é¢˜ï¼š<a href="https://www.luogu.com.cn/problem/P3865">Luogu P3865</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> int long long</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> endl <span class="string">&#x27;\n&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// STè¡¨</span></span><br><span class="line"><span class="comment">// å®ç°çš„åŠŸèƒ½ï¼šå›ºå®šæ•°ç»„ åŒºé—´æœ€å€¼è¯¢é—®RMQ/åŒºé—´GCD</span></span><br><span class="line"><span class="comment">// ä¸‹æ ‡ä»0å¼€å§‹</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SparseTable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    vector&lt;T&gt; a; <span class="comment">// åŸæ•°ç»„</span></span><br><span class="line">    vector&lt;vector&lt;T&gt;&gt; st; <span class="comment">// st[i][j]è¡¨ç¤º[i,i+2^j-1]çš„æœ€å€¼</span></span><br><span class="line">    <span class="function">T <span class="title">op</span><span class="params">(<span class="type">const</span> T &amp;a, <span class="type">const</span> T &amp;b)</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">max</span>(a, b); &#125; <span class="comment">// å¯é€‰ï¼šmax,min,__gcd</span></span><br><span class="line">    <span class="built_in">SparseTable</span>(vector&lt;T&gt; _v)&#123;</span><br><span class="line">        a = _v;</span><br><span class="line">        n = a.<span class="built_in">size</span>();</span><br><span class="line">        st.<span class="built_in">resize</span>(n+<span class="number">5</span>);</span><br><span class="line">        <span class="type">int</span> len = <span class="built_in">log2</span>(n)+<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;n; i++) st[i].<span class="built_in">resize</span>(<span class="number">21</span>, <span class="number">0</span>); <span class="comment">// n&lt;=2e6å¼€21</span></span><br><span class="line">        <span class="built_in">solve</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">solve</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) st[i][<span class="number">0</span>] = a[i];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; (<span class="number">1</span> &lt;&lt; j) &lt;= n; j++)&#123;</span><br><span class="line">            <span class="type">int</span> len = (<span class="number">1</span> &lt;&lt; j);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i + len - <span class="number">1</span> &lt; n; i++)&#123;</span><br><span class="line">                st[i][j] = <span class="built_in">op</span>(st[i][j - <span class="number">1</span>], st[i + (<span class="number">1</span> &lt;&lt; (j - <span class="number">1</span>))][j - <span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">T <span class="title">query</span><span class="params">(<span class="type">int</span> l, <span class="type">int</span> r)</span></span>&#123;</span><br><span class="line">        <span class="type">int</span> j = <span class="built_in">log2</span>(r - l + <span class="number">1</span>);<span class="comment">//å·²å‘ä¸‹å–æ•´</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">op</span>(st[l][j], st[r - (<span class="number">1</span> &lt;&lt; j) + <span class="number">1</span>][j]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ios::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="number">0</span>); cout.<span class="built_in">tie</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> n, q;</span><br><span class="line">    cin &gt;&gt; n &gt;&gt; q;</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">v</span><span class="params">(n)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;i : v) cin &gt;&gt; i;</span><br><span class="line">    <span class="function">SparseTable&lt;<span class="type">int</span>&gt; <span class="title">st</span><span class="params">(v)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (q--)&#123;</span><br><span class="line">        <span class="type">int</span> l, r;</span><br><span class="line">        cin &gt;&gt; l &gt;&gt; r;</span><br><span class="line">        cout &lt;&lt; st.<span class="built_in">query</span>(l<span class="number">-1</span>, r<span class="number">-1</span>) &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">æ±‚åŒºé—´æœ€å¤§/æœ€å°/GCD</summary>
    
    
    
    <category term="ç®—æ³•æ¨¡æ¿" scheme="https://www.cclmsy.cc/categories/%E7%AE%97%E6%B3%95%E6%A8%A1%E6%9D%BF/"/>
    
    
    <category term="ç®—æ³•æ¨¡æ¿" scheme="https://www.cclmsy.cc/tags/%E7%AE%97%E6%B3%95%E6%A8%A1%E6%9D%BF/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="https://www.cclmsy.cc/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>ACè‡ªåŠ¨æœº</title>
    <link href="https://www.cclmsy.cc/posts/ac_auto.html"/>
    <id>https://www.cclmsy.cc/posts/ac_auto.html</id>
    <published>2025-01-21T16:00:00.000Z</published>
    <updated>2025-07-18T11:14:52.108Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ACè‡ªåŠ¨æœº">ACè‡ªåŠ¨æœº</h2><p>è§£å†³çš„é—®é¢˜ï¼š<strong>å†™é¢˜è‡ªåŠ¨AC</strong>ç»Ÿè®¡å¤šä¸ªæ¨¡å¼ä¸²åœ¨ä¸»ä¸²ä¸­å‡ºç°çš„æ¬¡æ•°</p><p>M(26)*N(2e5)-&gt;Luogu150ms/60MB</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="comment">//å­—ç¬¦è½¬æ¢ä¸ºæ•°å­—ï¼Œä»¥å…¨62å­—ç¬¦ä¸ºä¾‹ï¼Œæ ¹æ®é¢˜æ„ä¿®æ”¹</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">trans</span><span class="params">(<span class="type">char</span> c)</span></span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(c&gt;=<span class="string">&#x27;a&#x27;</span>&amp;&amp;c&lt;=<span class="string">&#x27;z&#x27;</span>) <span class="keyword">return</span> c-<span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(c&gt;=<span class="string">&#x27;A&#x27;</span>&amp;&amp;c&lt;=<span class="string">&#x27;Z&#x27;</span>) <span class="keyword">return</span> c-<span class="string">&#x27;A&#x27;</span>+<span class="number">26</span>;</span><br><span class="line">    <span class="keyword">return</span> c-<span class="string">&#x27;0&#x27;</span>+<span class="number">52</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">const</span> ll N = <span class="number">2e5</span>+<span class="number">5</span>; <span class="comment">//ï¼ˆæœ¬é¢˜å•ä¸ªæ•°æ®ï¼‰**å­—å…¸**å­—ç¬¦ä¸²æœ€å¤§æ€»é•¿åº¦</span></span><br><span class="line"><span class="type">const</span> ll M = <span class="number">26</span>; <span class="comment">//å­—ç¬¦é›†å¤§å°</span></span><br><span class="line"><span class="comment">// ACè‡ªåŠ¨æœº</span></span><br><span class="line"><span class="comment">// è§£å†³çš„é—®é¢˜ï¼šç»Ÿè®¡å¤šä¸ªæ¨¡å¼ä¸²åœ¨ä¸»ä¸²ä¸­å‡ºç°çš„æ¬¡æ•°</span></span><br><span class="line"><span class="comment">// M(26)*N(2e5)-&gt;Luogu150ms/60MB</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ACauto</span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Node</span>&#123;</span><br><span class="line">        ll  nxt[M], <span class="comment">//ç»è¿‡å­—ç¬¦è¾¹åˆ°è¾¾çš„ä¸‹ä¸€çŠ¶æ€</span></span><br><span class="line">            fail, <span class="comment">//å¤±é…æŒ‡é’ˆ</span></span><br><span class="line">            flag, <span class="comment">//flag</span></span><br><span class="line">            ans, <span class="comment">//ä¸´æ—¶ç­”æ¡ˆ</span></span><br><span class="line">            rev, <span class="comment">//åå‘flag</span></span><br><span class="line">            indeg, <span class="comment">//å…¥åº¦</span></span><br><span class="line">            cnt; <span class="comment">//å‡ºç°çš„æ¬¡æ•°</span></span><br><span class="line">        <span class="built_in">Node</span>():nxt&#123;<span class="number">0</span>&#125;,<span class="built_in">fail</span>(<span class="number">0</span>),<span class="built_in">flag</span>(<span class="number">0</span>),<span class="built_in">ans</span>(<span class="number">0</span>),<span class="built_in">rev</span>(<span class="number">0</span>),<span class="built_in">indeg</span>(<span class="number">0</span>),<span class="built_in">cnt</span>(<span class="number">0</span>)&#123;&#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="built_in">memset</span>(nxt,<span class="number">0</span>,<span class="built_in">sizeof</span>(nxt));</span><br><span class="line">            fail=flag=ans=rev=indeg=cnt=<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;trie[N]; <span class="comment">//trieæ ‘</span></span><br><span class="line">    ll curn,cnts; <span class="comment">//curnæ˜¯å½“å‰èŠ‚ç‚¹æ•°ï¼Œcntsæ˜¯æ¨¡å¼ä¸²ä¸ªæ•°</span></span><br><span class="line">    <span class="built_in">ACauto</span>():<span class="built_in">curn</span>(<span class="number">0</span>),<span class="built_in">cnts</span>(<span class="number">0</span>)&#123;&#125;</span><br><span class="line">    <span class="comment">// é‡ç½®ACè‡ªåŠ¨æœº</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(ll i=<span class="number">0</span>;i&lt;=curn;i++) trie[i].<span class="built_in">clear</span>();</span><br><span class="line">        <span class="keyword">for</span>(ll i=<span class="number">1</span>;i&lt;N;i++) trie[i].cnt=<span class="number">0</span>;</span><br><span class="line">        curn=<span class="number">1</span>; cnts=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŠ å…¥æ¨¡å¼ä¸²sï¼Œç¼–å·ä¸ºnum</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string s,ll num)</span></span>&#123;</span><br><span class="line">        ll u=<span class="number">1</span>,len=s.<span class="built_in">length</span>();</span><br><span class="line">        <span class="keyword">for</span>(ll i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">            ll v=<span class="built_in">trans</span>(s[i]);</span><br><span class="line">            <span class="keyword">if</span>(!trie[u].nxt[v]) trie[u].nxt[v]=++curn;</span><br><span class="line">            u=trie[u].nxt[v];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!trie[u].flag) trie[u].flag=num;</span><br><span class="line">        trie[num].rev=trie[u].flag;</span><br><span class="line">        cnts++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ„é€ å¤±é…æŒ‡é’ˆ</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">getfail</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(ll i=<span class="number">0</span>;i&lt;M;i++) trie[<span class="number">0</span>].nxt[i]=<span class="number">1</span>;</span><br><span class="line">        queue&lt;ll&gt; q; q.<span class="built_in">push</span>(<span class="number">1</span>);</span><br><span class="line">        trie[<span class="number">1</span>].fail=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>())&#123;</span><br><span class="line">            ll u=q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            ll Fail=trie[u].fail;</span><br><span class="line">            <span class="keyword">for</span>(ll i=<span class="number">0</span>;i&lt;M;i++)&#123;</span><br><span class="line">                ll v=trie[u].nxt[i];</span><br><span class="line">                <span class="keyword">if</span>(!v)&#123;</span><br><span class="line">                    trie[u].nxt[i]=trie[Fail].nxt[i];</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                trie[v].fail=trie[Fail].nxt[i];</span><br><span class="line">                trie[trie[Fail].nxt[i]].indeg++;</span><br><span class="line">                q.<span class="built_in">push</span>(v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‹“æ‰‘æ’åºä¼˜åŒ–å»ºå›¾</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">topu</span><span class="params">()</span></span>&#123;</span><br><span class="line">        queue&lt;ll&gt; q;</span><br><span class="line">        <span class="keyword">for</span>(ll i=<span class="number">1</span>;i&lt;=curn;i++)</span><br><span class="line">            <span class="keyword">if</span>(!trie[i].indeg) q.<span class="built_in">push</span>(i);</span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>())&#123;</span><br><span class="line">            ll fr=q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            trie[trie[fr].flag].cnt=trie[fr].ans;</span><br><span class="line">            ll u=trie[fr].fail;</span><br><span class="line">            trie[u].ans+=trie[fr].ans;</span><br><span class="line">            trie[u].indeg--;</span><br><span class="line">            <span class="keyword">if</span>(!trie[u].indeg) q.<span class="built_in">push</span>(u);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åœ¨ä¸»ä¸²sä¸­åŒ¹é…æ¨¡å¼ä¸²</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">solve</span><span class="params">(string s)</span></span>&#123;</span><br><span class="line">        <span class="built_in">getfail</span>();</span><br><span class="line">        ll u=<span class="number">1</span>,len=s.<span class="built_in">length</span>();</span><br><span class="line">        <span class="keyword">for</span>(ll i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">            ll v=<span class="built_in">trans</span>(s[i]);</span><br><span class="line">            u=trie[u].nxt[v];</span><br><span class="line">            trie[u].ans++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">topu</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// O(1)æŸ¥è¯¢ç¼–å·ä¸ºidxçš„æ¨¡å¼ä¸²å‡ºç°çš„æ¬¡æ•°</span></span><br><span class="line">    <span class="function">ll <span class="title">query</span><span class="params">(ll idx)</span></span>&#123; <span class="keyword">return</span> trie[trie[idx].rev].cnt; &#125;</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢å‡ºç°è¿‡çš„æ¨¡å¼ä¸²ä¸ªæ•°</span></span><br><span class="line">    <span class="function">ll <span class="title">count</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ll ret=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(ll i=<span class="number">1</span>;i&lt;=curn;i++) </span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">query</span>(i)) ret++;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;ac;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">solve</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ll n; cin &gt;&gt; n;</span><br><span class="line">    ac.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">s</span><span class="params">(n+<span class="number">1</span>)</span></span>;</span><br><span class="line">    string ts;</span><br><span class="line">    <span class="keyword">for</span>(ll i=<span class="number">1</span>;i&lt;=n;i++)&#123;</span><br><span class="line">        cin &gt;&gt; ts;</span><br><span class="line">        ac.<span class="built_in">insert</span>(ts,i);</span><br><span class="line">        s[i]=ts;</span><br><span class="line">    &#125;</span><br><span class="line">    cin &gt;&gt; ts;</span><br><span class="line">    ac.<span class="built_in">solve</span>(ts);</span><br><span class="line">    <span class="comment">// Luogu P5357</span></span><br><span class="line">    <span class="keyword">for</span>(ll i=<span class="number">1</span>;i&lt;=n;i++) cout &lt;&lt; ac.<span class="built_in">query</span>(i) &lt;&lt; endl;</span><br><span class="line">    <span class="comment">// Luogu P3808</span></span><br><span class="line">    <span class="comment">// cout &lt;&lt; ac.count() &lt;&lt; endl;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*----------Code Area----------*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ios::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    cin.<span class="built_in">tie</span>(<span class="number">0</span>);</span><br><span class="line">    cout.<span class="built_in">tie</span>(<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    ll T=<span class="number">1</span>; <span class="comment">// cin &gt;&gt; T;</span></span><br><span class="line">    <span class="keyword">while</span>(T--) <span class="built_in">solve</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ç»Ÿè®¡å¤šä¸ªæ¨¡å¼ä¸²åœ¨ä¸»ä¸²ä¸­å‡ºç°çš„æ¬¡æ•°</summary>
    
    
    
    <category term="ç®—æ³•æ¨¡æ¿" scheme="https://www.cclmsy.cc/categories/%E7%AE%97%E6%B3%95%E6%A8%A1%E6%9D%BF/"/>
    
    
    <category term="ç®—æ³•æ¨¡æ¿" scheme="https://www.cclmsy.cc/tags/%E7%AE%97%E6%B3%95%E6%A8%A1%E6%9D%BF/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="https://www.cclmsy.cc/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
    <category term="å­—ç¬¦ä¸²" scheme="https://www.cclmsy.cc/tags/%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    
  </entry>
  
  <entry>
    <title>Pythonå¯¹æ‹å™¨</title>
    <link href="https://www.cclmsy.cc/posts/python_check.html"/>
    <id>https://www.cclmsy.cc/posts/python_check.html</id>
    <published>2025-01-09T16:00:00.000Z</published>
    <updated>2025-07-18T11:14:52.548Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Pythonå¯¹æ‹å™¨">Pythonå¯¹æ‹å™¨</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¹æ‹å™¨</span></span><br><span class="line"><span class="comment"># ç”¨gen.cppç”Ÿæˆæ•°æ®ï¼Œç”¨std.cppç”Ÿæˆæ ‡å‡†ç­”æ¡ˆï¼Œç”¨test.cppç”Ÿæˆæµ‹è¯•ç­”æ¡ˆï¼Œç”¨check.pyå¯¹æ‹</span></span><br><span class="line"><span class="comment"># æ‰€æœ‰æ–‡ä»¶éƒ½åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€ç›´å¾ªç¯ï¼Œç›´åˆ°å¯¹æ‹å‡ºé”™</span></span><br><span class="line"><span class="comment"># æ­£ç¡®è¾“å‡ºï¼š#åºå· Accepted</span></span><br><span class="line"><span class="comment"># é”™è¯¯è¾“å‡ºï¼š#åºå· Wrong Answer!!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸å«åç¼€çš„æ–‡ä»¶å</span></span><br><span class="line">filename_mycode = <span class="string">&#x27;test&#x27;</span> <span class="comment"># æµ‹è¯•ä»£ç </span></span><br><span class="line">filename_std = <span class="string">&#x27;std&#x27;</span> <span class="comment"># æ ‡å‡†ç­”æ¡ˆ</span></span><br><span class="line">filename_generate = <span class="string">&#x27;gen&#x27;</span> <span class="comment"># ç”Ÿæˆæ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤æ–‡ä»¶å­˜åœ¨ï¼Œå¦åˆ™æŠ¥é”™</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">checkfile</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Checking&#x27;</span>, filename)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(filename):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;File not found:&#x27;</span>, filename)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">checkfile(filename_mycode + <span class="string">&#x27;.cpp&#x27;</span>)</span><br><span class="line">checkfile(filename_std + <span class="string">&#x27;.cpp&#x27;</span>)</span><br><span class="line">checkfile(filename_generate + <span class="string">&#x27;.cpp&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compile</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Compiling&#x27;</span>, filename)</span><br><span class="line">    os.system(<span class="string">&#x27;g++ &#x27;</span> + filename + <span class="string">&#x27;.cpp -o &#x27;</span> + filename )</span><br><span class="line"></span><br><span class="line"><span class="built_in">compile</span>(filename_mycode)</span><br><span class="line"><span class="built_in">compile</span>(filename_std)</span><br><span class="line"><span class="built_in">compile</span>(filename_generate)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆæ•°æ®å’Œç­”æ¡ˆ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate</span>():</span><br><span class="line">    os.system(<span class="string">&#x27;.\\&#x27;</span> + filename_generate + <span class="string">&#x27; &gt; in.txt&#x27;</span>)</span><br><span class="line">    os.system(<span class="string">&#x27;.\\&#x27;</span> + filename_std + <span class="string">&#x27; &lt; in.txt &gt; std.txt&#x27;</span>)</span><br><span class="line">    os.system(<span class="string">&#x27;.\\&#x27;</span> + filename_mycode + <span class="string">&#x27; &lt; in.txt &gt; out.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¯”è¾ƒ2ä¸ªæ–‡ä»¶æ˜¯å¦ç›¸åŒï¼Œä¸åŒåˆ™è¿”å›è¡Œåˆ—å·</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compare</span>(<span class="params">file1, file2</span>):</span><br><span class="line">    f1 = <span class="built_in">open</span>(file1, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    f2 = <span class="built_in">open</span>(file2, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    lines1 = f1.readlines()</span><br><span class="line">    lines2 = f2.readlines()</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">len</span>(lines1) != <span class="built_in">len</span>(lines2)):</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(lines1)):</span><br><span class="line">        obj1 = lines1[i].split()</span><br><span class="line">        obj2 = lines2[i].split()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(obj1) != <span class="built_in">len</span>(obj2):</span><br><span class="line">            <span class="keyword">return</span> i, lines1[i], lines2[i]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(obj1)):</span><br><span class="line">            <span class="keyword">if</span> obj1[j] != obj2[j]:</span><br><span class="line">                <span class="keyword">return</span> i, obj1[j], obj2[j]</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹æ‹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>():</span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        generate()</span><br><span class="line">        line, line1, line2 = compare(<span class="string">&#x27;std.txt&#x27;</span>, <span class="string">&#x27;out.txt&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> line == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;#&#x27;</span>, i, <span class="string">&#x27;Accepted&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> line == -<span class="number">1</span>: <span class="comment"># è¡Œæ•°ä¸åŒ</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;#&#x27;</span>, i, <span class="string">&#x27;Wrong Answer!!&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Line:&#x27;</span>, <span class="string">&#x27;Different number of lines&#x27;</span>) </span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># å†…å®¹ä¸åŒ</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;#&#x27;</span>, i, <span class="string">&#x27;Wrong Answer!!&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Line:&#x27;</span>, line)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Standard:&#x27;</span>, line1)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Output:&#x27;</span>, line2)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">check()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ç”Ÿæˆæ•°æ®ï¼Œå°†ä»£ç å’Œæš´åŠ›ç®—æ³•æ¯”è¾ƒ</summary>
    
    
    
    <category term="ç®—æ³•æ¨¡æ¿" scheme="https://www.cclmsy.cc/categories/%E7%AE%97%E6%B3%95%E6%A8%A1%E6%9D%BF/"/>
    
    
    <category term="ç®—æ³•æ¨¡æ¿" scheme="https://www.cclmsy.cc/tags/%E7%AE%97%E6%B3%95%E6%A8%A1%E6%9D%BF/"/>
    
  </entry>
  
</feed>
